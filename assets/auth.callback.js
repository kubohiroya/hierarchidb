import{b,u as _,d as E,a as m}from"./vendor-react-c8TNKgLa.js";import{j as i}from"./jsx-runtime-ByjDy5UU.js";import"./OIDCAuthContext-7dr30yBZ.js";import{B as f,T as w,C as y}from"./Box-DQW1lwiN.js";import{A as U}from"./Alert-B9WXhFNI.js";import"./createSvgIcon-DbIrl0lZ.js";import"./DefaultPropsProvider-3wsUTpNh.js";import"./createSimplePaletteValueFilter-D46oDSVH.js";const d=(u,...n)=>console.error(u,...n),v="multi-auth-user",g="multi-auth-provider",k="multi-auth-redirect",S="";class R{static async handleCallback(){const n=new URLSearchParams(window.location.search),r=new URLSearchParams(window.location.hash.substring(1)),t=localStorage.getItem(g);if(!t)return d("No auth provider found in storage"),!1;let a=null,o=null;if(t==="google"?a=r.get("access_token"):o=n.get("code"),!a&&!o)return d("No token or code found in callback"),!1;try{let e;if(a)e={access_token:a,token_type:"Bearer",expires_in:parseInt(r.get("expires_in")||"3600")};else if(o)e=await this.exchangeCodeForToken(o,t);else throw new Error("No authentication data found");const s={...await this.fetchUserInfo(e.access_token,t),access_token:e.access_token,id_token:e.id_token,expires_at:Date.now()+(e.expires_in||3600)*1e3,provider:t};localStorage.setItem(v,JSON.stringify(s)),localStorage.setItem(g,t);const l=localStorage.getItem(k);return l&&(localStorage.removeItem(k),window.location.href=l),!0}catch(e){return d("Auth callback error:",e),!1}}static async exchangeCodeForToken(n,r){const t=window.location.origin+window.location.pathname;let a,o;switch(r){case"microsoft":a="https://login.microsoftonline.com/common/oauth2/v2.0/token",o=new URLSearchParams({client_id:"",code:n,redirect_uri:t,grant_type:"authorization_code"});break;case"github":a=`${S}/?url=${encodeURIComponent("https://github.com/login/oauth/access_token")}`,o=new URLSearchParams({client_id:"",client_secret:"",code:n,redirect_uri:t});break;default:throw new Error(`Unsupported provider: ${r}`)}const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:o.toString()});if(!e.ok)throw new Error(`Token exchange failed: ${e.statusText}`);return await e.json()}static async fetchUserInfo(n,r){var c;let t;const a={Authorization:`Bearer ${n}`};switch(r){case"google":t="https://www.googleapis.com/oauth2/v2/userinfo";break;case"microsoft":t="https://graph.microsoft.com/v1.0/me";break;case"github":t="https://api.github.com/user",a.Accept="application/vnd.github.v3+json";break;default:throw new Error(`Unsupported provider: ${r}`)}const o=await fetch(t,{headers:a});if(!o.ok)throw new Error(`Failed to fetch user info: ${o.statusText}`);const e=await o.json();switch(r){case"google":return{id:e.id,email:e.email,name:e.name,picture:e.picture};case"microsoft":return{id:e.id,email:e.userPrincipalName||e.mail,name:e.displayName,picture:void 0};case"github":{let s=e.email;if(!s){const l=await fetch("https://api.github.com/user/emails",{headers:a});if(l.ok){const p=await l.json(),h=p.find(x=>x.primary);s=(h==null?void 0:h.email)||((c=p[0])==null?void 0:c.email)}}return{id:e.id.toString(),email:s||"",name:e.name||e.login,picture:e.avatar_url}}default:throw new Error(`Unsupported provider: ${r}`)}}}const O=b(function(){const n=_(),[r]=E(),[t,a]=m.useState(null);return m.useEffect(()=>{async function o(){try{const e=r.get("code"),c=r.get("error");if(c)throw new Error(`Authentication error: ${c}`);if(!e)throw new Error("No authorization code received");await R.handleCallback();const s=sessionStorage.getItem("auth.returnUrl")||"/";sessionStorage.removeItem("auth.returnUrl"),n(s,{replace:!0})}catch(e){console.error("Auth callback error:",e),a(e instanceof Error?e.message:"Authentication failed")}}o()},[r,n]),m.useEffect(()=>{if(window.opener){const o=Object.fromEntries(r.entries());window.opener.postMessage({type:"auth-callback",params:o},window.location.origin),window.close()}},[r]),t?i.jsxs(f,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",p:3},children:[i.jsx(U,{severity:"error",sx:{mb:2},children:t}),i.jsx(w,{children:i.jsx("a",{href:"/",children:"Return to Home"})})]}):i.jsxs(f,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh"},children:[i.jsx(y,{size:60}),i.jsx(w,{variant:"h6",sx:{mt:3},children:"Completing authentication..."})]})});export{O as default};
