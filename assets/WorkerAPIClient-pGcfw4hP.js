var L=Object.defineProperty;var N=(e,r,t)=>r in e?L(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t;var m=(e,r,t)=>N(e,typeof r!="symbol"?r+"":r,t);import"./logger-Dd_sLh6l.js";class M{static getSingleton(r,t){return!this.instances.has(r)&&t&&this.instances.set(r,t()),this.instances.get(r)}static terminate(r){this.instances.delete(r)}static terminateAll(){this.instances.clear()}}m(M,"instances",new Map);/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const I=Symbol("Comlink.proxy"),V=Symbol("Comlink.endpoint"),j=Symbol("Comlink.releaseProxy"),b=Symbol("Comlink.finalizer"),k=Symbol("Comlink.thrown"),R=e=>typeof e=="object"&&e!==null||typeof e=="function",D={canHandle:e=>R(e)&&e[I],serialize(e){const{port1:r,port2:t}=new MessageChannel;return O(e,r),[t,[t]]},deserialize(e){return e.start(),C(e)}},F={canHandle:e=>R(e)&&k in e,serialize({value:e}){let r;return e instanceof Error?r={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:r={isError:!1,value:e},[r,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},T=new Map([["proxy",D],["throw",F]]);function U(e,r){for(const t of e)if(r===t||t==="*"||t instanceof RegExp&&t.test(r))return!0;return!1}function O(e,r=globalThis,t=["*"]){r.addEventListener("message",function y(n){if(!n||!n.data)return;if(!U(t,n.origin)){console.warn(`Invalid origin '${n.origin}' for comlink proxy`);return}const{id:a,type:f,path:c}=Object.assign({path:[]},n.data),u=(n.data.argumentList||[]).map(g);let s;try{const o=c.slice(0,-1).reduce((i,h)=>i[h],e),l=c.reduce((i,h)=>i[h],e);switch(f){case"GET":s=l;break;case"SET":o[c.slice(-1)[0]]=g(n.data.value),s=!0;break;case"APPLY":s=l.apply(o,u);break;case"CONSTRUCT":{const i=new l(...u);s=$(i)}break;case"ENDPOINT":{const{port1:i,port2:h}=new MessageChannel;O(e,h),s=X(i,[i])}break;case"RELEASE":s=void 0;break;default:return}}catch(o){s={value:o,[k]:0}}Promise.resolve(s).catch(o=>({value:o,[k]:0})).then(o=>{const[l,i]=p(o);r.postMessage(Object.assign(Object.assign({},l),{id:a}),i),f==="RELEASE"&&(r.removeEventListener("message",y),z(r),b in e&&typeof e[b]=="function"&&e[b]())}).catch(o=>{const[l,i]=p({value:new TypeError("Unserializable return value"),[k]:0});r.postMessage(Object.assign(Object.assign({},l),{id:a}),i)})}),r.start&&r.start()}function _(e){return e.constructor.name==="MessagePort"}function z(e){_(e)&&e.close()}function C(e,r){const t=new Map;return e.addEventListener("message",function(n){const{data:a}=n;if(!a||!a.id)return;const f=t.get(a.id);if(f)try{f(a)}finally{t.delete(a.id)}}),x(e,t,[],r)}function d(e){if(e)throw new Error("Proxy has been released and is not useable")}function W(e){return w(e,new Map,{type:"RELEASE"}).then(()=>{z(e)})}const P=new WeakMap,E="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const r=(P.get(e)||0)-1;P.set(e,r),r===0&&W(e)});function G(e,r){const t=(P.get(r)||0)+1;P.set(r,t),E&&E.register(e,r,e)}function Y(e){E&&E.unregister(e)}function x(e,r,t=[],y=function(){}){let n=!1;const a=new Proxy(y,{get(f,c){if(d(n),c===j)return()=>{Y(a),W(e),r.clear(),n=!0};if(c==="then"){if(t.length===0)return{then:()=>a};const u=w(e,r,{type:"GET",path:t.map(s=>s.toString())}).then(g);return u.then.bind(u)}return x(e,r,[...t,c])},set(f,c,u){d(n);const[s,o]=p(u);return w(e,r,{type:"SET",path:[...t,c].map(l=>l.toString()),value:s},o).then(g)},apply(f,c,u){d(n);const s=t[t.length-1];if(s===V)return w(e,r,{type:"ENDPOINT"}).then(g);if(s==="bind")return x(e,r,t.slice(0,-1));const[o,l]=S(u);return w(e,r,{type:"APPLY",path:t.map(i=>i.toString()),argumentList:o},l).then(g)},construct(f,c){d(n);const[u,s]=S(c);return w(e,r,{type:"CONSTRUCT",path:t.map(o=>o.toString()),argumentList:u},s).then(g)}});return G(a,e),a}function q(e){return Array.prototype.concat.apply([],e)}function S(e){const r=e.map(p);return[r.map(t=>t[0]),q(r.map(t=>t[1]))]}const H=new WeakMap;function X(e,r){return H.set(e,r),e}function $(e){return Object.assign(e,{[I]:!0})}function p(e){for(const[r,t]of T)if(t.canHandle(e)){const[y,n]=t.serialize(e);return[{type:"HANDLER",name:r,value:y},n]}return[{type:"RAW",value:e},H.get(e)||[]]}function g(e){switch(e.type){case"HANDLER":return T.get(e.name).deserialize(e.value);case"RAW":return e.value}}function w(e,r,t,y){return new Promise(n=>{const a=v();r.set(a,n),e.start&&e.start(),e.postMessage(Object.assign({id:a},t),y)})}function v(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function B(e){return new Worker("/hierarchidb/worker.js",{type:"module",name:e==null?void 0:e.name})}function J(){return new B}class A{constructor(){m(this,"worker");m(this,"workerAPIProxy")}static async getSingleton(){return M.getSingleton(A.name,async()=>{const r=new A;return r.worker=J(),r.workerAPIProxy=C(r.worker),await r.workerAPIProxy.initialize(),r})}async ping(){if(!this.workerAPIProxy)return!1;try{return await this.workerAPIProxy.initialize(),!0}catch{return!1}}async cleanup(){if(this.workerAPIProxy)try{await this.workerAPIProxy.dispose()}catch(r){console.error("Error disposing worker proxy:",r)}this.worker&&(this.worker.terminate(),this.worker=void 0),this.workerAPIProxy=void 0}getAPI(){if(!this.workerAPIProxy)throw new Error("Worker not initialized");return this.workerAPIProxy}}export{A as W};
