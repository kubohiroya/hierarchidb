import{h as v,u as P,a as o,w as U}from"./vendor-react-CDvDc01k.js";import{j as O}from"./vendor-mui-BsvZ856x.js";import"./OIDCAuthContext-CLcNXUrY.js";const x=(r,e)=>console.log(r,e),k=(r,e)=>console.warn(r,e),w="eria-popup-capability",D=2e3;class T{constructor(){this.capability="unknown",this.loadCapability()}static getInstance(){return this.instance||(this.instance=new T),this.instance}loadCapability(){const e=localStorage.getItem(w);(e==="supported"||e==="blocked")&&(this.capability=e,x(`Loaded popup capability: ${e}`))}saveCapability(e){this.capability=e,e!=="unknown"&&localStorage.setItem(w,e)}updateCapability(e){this.saveCapability(e)}getCapability(){return this.capability}async testPopupCapability(){return this.capability==="blocked"?"blocked":new Promise(e=>{try{const a=window.open("data:text/html,<html><body><script>window.close();<\/script></body></html>","popup-test","width=100,height=100,left=-1000,top=-1000");if(!a){k("Popup blocked by browser"),this.saveCapability("blocked"),e("blocked");return}let i=!1;try{a.closed!==void 0||(i=!0)}catch(d){k("COOP restrictions detected:",d),i=!0}if(i){try{a.close()}catch{}this.saveCapability("blocked"),e("blocked");return}const n=setInterval(()=>{try{a.closed&&(clearInterval(n),clearTimeout(l),this.saveCapability("supported"),e("supported"))}catch{clearInterval(n),clearTimeout(l),this.saveCapability("blocked"),e("blocked")}},100),l=setTimeout(()=>{clearInterval(n);try{a.closed||a.close(),this.saveCapability("supported"),e("supported")}catch{this.saveCapability("blocked"),e("blocked")}},D)}catch(s){k("Popup test failed:",s),this.saveCapability("blocked"),e("blocked")}})}isPotentiallyBlocked(){const e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),s=window!==window.top,a=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);return e||s||a&&this.capability!=="supported"}clearCapability(){this.capability="unknown",localStorage.removeItem(w)}}const c={REDIRECT_URL:"bff-auth-redirect-url",USER_DATA:"bff-auth-user",REFRESH_TOKEN:"bff-auth-refresh-token",AUTH_METHOD:"bff-auth-method"},R=300*1e3,F=()=>{const[r,e]=o.useState(()=>{const i=localStorage.getItem(c.USER_DATA);if(i)try{return JSON.parse(i)}catch{return null}return null}),[s,a]=o.useState(!1);return{isAuthenticated:!!r&&r.expires_at>Date.now(),isLoading:s,user:r,signIn:async i=>{a(!0);try{const l=await(await fetch("/api/auth/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();e(l.user),localStorage.setItem(c.USER_DATA,JSON.stringify(l.user))}finally{a(!1)}},signOut:async()=>{await fetch("/api/auth/signout",{method:"POST"}),e(null),localStorage.removeItem(c.USER_DATA)},refreshToken:async()=>{const i=await fetch("/api/auth/refresh",{method:"POST",credentials:"include"});if(i.ok){const n=await i.json();return e(n.user),localStorage.setItem(c.USER_DATA,JSON.stringify(n.user)),n.user}return null},getIdToken:()=>r==null?void 0:r.access_token,getAccessToken:()=>r==null?void 0:r.access_token,currentProvider:(r==null?void 0:r.provider)||"google"}};function L(r="/"){var S;const e=F(),s=v(),a=P(),i=T.getInstance(),n=o.useRef(null),[l,d]=o.useState(!1),g=o.useCallback(()=>{var t;return(t=e.user)!=null&&t.expires_at?e.user.expires_at-Date.now():0},[e.user]),I=o.useCallback(()=>{const t=g();return t>0&&t<=R},[g]),p=o.useCallback(async()=>{if(!l){d(!0);try{console.log("[BFF Auth] Refreshing token...");const t=await e.refreshToken();if(t){console.log("[BFF Auth] Token refreshed successfully");const u=t.expires_at-Date.now()-R;u>0&&(n.current=setTimeout(p,u))}else{console.warn("[BFF Auth] Token refresh failed, user needs to re-authenticate");const u=s.pathname+s.search;localStorage.setItem(c.REDIRECT_URL,u),localStorage.removeItem(c.USER_DATA),confirm("Your session has expired. Would you like to sign in again?")&&await m({returnUrl:u})}}catch(t){console.error("[BFF Auth] Token refresh error:",t)}finally{d(!1)}}},[e,l,s.pathname,s.search]);o.useEffect(()=>{if(!e.user){n.current&&(clearTimeout(n.current),n.current=null);return}if(I())p();else{const t=g()-R;t>0&&(n.current=setTimeout(p,t))}return()=>{n.current&&(clearTimeout(n.current),n.current=null)}},[e.user,I,p,g]);const m=o.useCallback(async t=>{const u=s.pathname+s.search,y=(t==null?void 0:t.returnUrl)||u;(!(t!=null&&t.isUserInitiated)||(t==null?void 0:t.forceMethod)==="redirect")&&localStorage.setItem(c.REDIRECT_URL,y);let h=(t==null?void 0:t.forceMethod)||"popup";t!=null&&t.forceMethod||i.getCapability()==="blocked"&&(h="redirect");try{await e.signIn({returnUrl:y,method:h,provider:t==null?void 0:t.provider}),h==="popup"&&i.saveCapability("supported"),h==="popup"&&localStorage.removeItem(c.REDIRECT_URL)}catch(f){if(h==="popup"&&f instanceof Error&&(f.message.includes("popup")||f.message.includes("blocked")))console.warn("[BFF Auth] Popup blocked, falling back to redirect"),i.saveCapability("blocked"),await e.signIn({returnUrl:y,method:"redirect",provider:t==null?void 0:t.provider});else throw f}},[e,s.pathname,s.search,i]),b=o.useCallback(async()=>{localStorage.removeItem(c.REDIRECT_URL),localStorage.removeItem(c.USER_DATA),localStorage.removeItem(c.REFRESH_TOKEN),n.current&&(clearTimeout(n.current),n.current=null),await e.signOut(),a(r,{replace:!0})},[e,a,r]),A=o.useCallback((t=r)=>{const u=localStorage.getItem(c.REDIRECT_URL);if(s.pathname+s.search===u){localStorage.removeItem(c.REDIRECT_URL);return}u?(localStorage.removeItem(c.REDIRECT_URL),a(u,{replace:!0})):a(t,{replace:!0})},[a,s.pathname,s.search,r]),C=o.useCallback(()=>e.getIdToken(),[e]),E=e.user?{profile:{sub:e.user.id,email:e.user.email,name:e.user.name,picture:e.user.picture,preferred_username:e.user.email},access_token:e.user.access_token,refresh_token:e.user.refresh_token,expires_at:e.user.expires_at/1e3}:null,_={isAuthenticated:e.isAuthenticated,isLoading:e.isLoading||l,user:E,error:null,signinRedirect:()=>m({forceMethod:"redirect"}),signoutRedirect:()=>b(),signinPopup:()=>m({forceMethod:"popup"}),signinSilent:()=>p(),signoutSilent:()=>b(),removeUser:()=>b(),events:{addAccessTokenExpiring:t=>{},removeAccessTokenExpiring:t=>{}},settings:{}};return{user:E,isAuthenticated:e.isAuthenticated,isLoading:e.isLoading||l,signIn:m,signOut:b,resumeAfterSignIn:A,getIdToken:C,getAccessToken:e.getAccessToken,refreshToken:p,currentProvider:e.currentProvider,auth:_,isRefreshing:l,tokenExpiresAt:(S=e.user)==null?void 0:S.expires_at}}const j=U(function(){const{resumeAfterSignIn:e}=L();return o.useEffect(()=>{async function s(){try{e(),window.parent!==window&&window.parent.postMessage({type:"silent-renew-success"},window.location.origin)}catch(a){console.error("Silent renew failed:",a),window.parent!==window&&window.parent.postMessage({type:"silent-renew-error",error:a==null?void 0:a.toString()},window.location.origin)}}s()},[e]),O.jsx("div",{})});export{j as default};
