# 5.2 コア（core モジュール）

本章では、アプリ全体で共有されるデータモデル・定数・ユーティリティ、命名/型安全ポリシー、DB スキーマ型とマイグレーション方針をまとめる。

## 5.2.1 役割
- UI/worker/api から共通利用される型・列挙・ユーティリティを提供。
- DB スキーマの型（CoreDB/EphemeralDB の行型）を定義。

## 5.2.2 型と命名の原則
- any 禁止、unknown→ナローイング、never で到達不能検知。
- 非 null 断言 `!` 原則禁止。ガード関数で安全化。
- `as` キャスト最小化。実データは Zod/typia 等で検証。
- リテラル型/列挙型を積極活用し、コンパイル時にバグを捕捉。
- `readonly` を活用し不変データを優先。
- 魔法の文字列/数値禁止。すべて定数化（as const）。

## 5.2.3 データモデル（抜粋）

- 用語
  - UUID, Timestamp（number）
  - TreeId（opaque）, TreeNodeId（opaque 合成: Root/Trash/SuperRoot/Regular）
  - TreeRootNodeType: SuperRoot | Root | TrashRoot

- Tree/TreeNode（要点）
  - Tree は treeId と各 Root 系 ID（Root/Trash/SuperRoot）を持つ。
  - TreeNode は以下を保持: treeNodeType, treeNodeId, parentTreeNodeId, name, createdAt, updatedAt, version。
  - 拡張: hasChild, references, TrashItemProperties（originalParentTreeNodeId/removedAt 等）。
  - 同一 parentTreeNodeId 配下で name はユニーク（兄弟名ユニーク制約）。

- 状態モデル
  - TreeRootState: ルートごとの展開状態（expanded は true または Record）。
  - ExpandedStateChanges, SubTreeChanges: 差分通知のペイロード。

## 5.2.4 DB スキーマ（型）
- CoreDB（長命/原子性必要）
  - trees: &treeId, ほか Root/SuperRoot ID。
  - nodes: &treeNodeId, parentTreeNodeId, &[parentTreeNodeId+name]（兄弟名ユニーク）, [parentTreeNodeId+updatedAt], removedAt, originalParentTreeNodeId, *references。
  - rootStates: &[treeId+treeRootNodeType]。
- EphemeralDB（短命/高頻度）
  - workingCopies: &workingCopyId, workingCopyOf, parentTreeNodeId, updatedAt。
  - views: &treeViewId, updatedAt, [treeId+treeRootNodeType], [treeId+pageNodeId]。

代表クエリとインデックスの対応は 5.3 を参照。

## 5.2.5 マイグレーション方針
- DB スキーマ変更はバージョンで管理し、移行関数を実装。
- 破壊的変更は極力回避し、必要時はメジャーバージョンアップで告知。

## 5.2.6 一貫性と制約
- 保存時正規化: `normalize('NFC')(name).trim()`。
- 参照整合性: inbound refs のあるノードは Trash へ移動不可（エラー）。
- クロスツリー禁止: 親は同一 SuperRoot 系であること。

関連: 5-architecture.md, 5.3-api-worker.md（API/Worker 側の詳細）。