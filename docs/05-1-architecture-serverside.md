## 5.1 サーバサイド（Cloudflare Workers）

本章では、Cloudflare 上で稼働するサーバサイドモジュール（bff, cors-proxy）の役割、API 境界、設定値管理、セキュリティ指針をまとめる。

### 5.1.1 概要
- bff: OAuth2 認証仲介（Google/Microsoft/GitHub）。
- cors-proxy: 外部オープンデータ/API への CORS 制約回避プロキシ（bff 認証必須）。

### 5.1.2 bff（Backends For Frontends）

#### 目的
- クライアント（UI層）と外部APIサービス（Google/Microsoft/GitHub）間のOAuth2認証を仲介。
- UI と外部 OAuth2/OIDC プロバイダの間で認証を仲介し、UI 側に機密を持たせない。
- クライアントからはBFF経由でのみ外部APIにアクセスできるようにする。
- UI側で認証処理や機密キー管理を行わないようにし、セキュリティを確保。
- 認証状態を短期セッション化し、クッキー（HTTP-only）で安全に返却(TODO: 実装との対応関係を確認、HTTP POSTで返却するのではないのか？)。

#### 機能要件
- OAuth2 認証フローの開始/コールバックハンドリング。
- アクセストークン・リフレッシュトークンの安全な管理（Cloudflare KV/Secrets）。
- 認証済みユーザのセッション発行（短期トークン）。
- 認証済みセッションの発行と検証 API。

#### 実装上のポイント
- HTTP-only クッキーで XSS からトークンを保護（上でも書いたように、本当にクッキーでの実装？）
- 認証結果はHTTP-onlyクッキーで返却（XSS対策）。
- 認証フローは外部リダイレクトを伴うため、stateパラメータを利用してCSRF防止。
- Cloudflare Workerとして実装し、軽量・低レイテンシで動作させる。
- **設定値管理方針**
    - クライアントID・リダイレクトURLなどの非機密設定値は、プロジェクトルートの `.env` ファイルで管理する。
    - クライアントシークレットや署名鍵などの機密情報は、CloudflareのSecrets機能（`wrangler secret put`）を用いて登録し、Worker内で参照する。
    - `.env` ファイルは `.gitignore` に必ず登録する。

## 5.1.3 cors-proxy
### 目的
- 外部のオープンデータ/APIを利用する際に、CORS制約を回避する。
- 利用時にはbffモジュールによる認証を必須とし、不正利用を防ぐ。

### 機能要件
- 任意 URL への HTTP リクエストを代理送信（メソッド/ヘッダ/ボディ/クエリ透過）。
- レスポンスに適切な `Access-Control-Allow-Origin` を付与。
- 事前許可リスト（ホワイトリスト）による転送先制限。

### 実装上のポイント
- 大容量レスポンス/ストリーミングは対象外（リソース保護）。
- キャッシュ制御で重複取得を最適化。
- 転送先 URL は事前定義 or 署名付きで制御。

### 設定値管理方針
    - API利用時の許可リストURLやCORS設定値は `.env` に記載（非機密のみ）。
    - 認証トークンや署名用秘密鍵は Cloudflare Secrets に保存し、Worker内で利用。

## 5.1.4 セキュリティ/プライバシ指針
- 最小権限: 必要なスコープのみ要求。
- ログに機微情報を残さない（マスキング/削除）。
- 監査: 依存パッケージは `pnpm audit`。

## 5.1.5 運用
- 認証/プロキシのバージョン管理とロールバック手順を用意。
- 監視: エラー率/レイテンシの計測、閾値でアラート。
