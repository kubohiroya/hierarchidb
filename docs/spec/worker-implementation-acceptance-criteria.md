# Worker実装 受け入れ基準

## 概要

このドキュメントはWorker層実装の受け入れ基準とテスト項目を記載します。

## 機能テスト基準

### REQ-001: データベース管理の受け入れ基準

**Given（前提条件）**: 🟢
- ブラウザがIndexedDBをサポートしている
- Dexieライブラリが正しくインポートされている

**When（実行条件）**: 🟢
- WorkerAPIImpl.initialize()を実行する
- データベース名として'hierarchidb'を指定する

**Then（期待結果）**: 🟢
- CoreDBインスタンスが作成される
- EphemeralDBインスタンスが作成される
- 両データベースが正常に開かれる

**テストケース**:
- [ ] 正常系: 初回起動時のDB作成
- [ ] 正常系: 2回目以降の起動時の既存DB接続
- [ ] 異常系: IndexedDB容量制限時のエラーハンドリング
- [ ] 境界値: データベース名が空文字列の場合

### REQ-004: コマンド処理の受け入れ基準

**Given（前提条件）**: 🟢
- Workerが初期化済み
- UI層からComlink経由で接続済み

**When（実行条件）**: 🟢
- createWorkingCopyForCreateコマンドを送信
- 必須パラメータ（workingCopyId, parentTreeNodeId, name）を含む

**Then（期待結果）**: 🟢
- コマンドが順序付けて処理される
- Working CopyがEphemeralDBに保存される
- 処理完了のPromiseが解決される

**テストケース**:
- [ ] 正常系: 有効なパラメータでのWorking Copy作成
- [ ] 異常系: 必須パラメータ不足
- [ ] 異常系: 無効なparentTreeNodeId
- [ ] 境界値: 255文字の名前

### REQ-007: 購読管理の受け入れ基準

**Given（前提条件）**: 🟢
- ツリーデータがCoreDBに存在
- pageNodeIdが有効なTreeNodeId

**When（実行条件）**: 🟢
- subscribeSubTreeを呼び出す
- コールバック関数を2つ（expanded用、subtree用）渡す

**Then（期待結果）**: 🟢
- initialSubTreeのPromiseが返される
- unsubscribeSubTree関数が返される
- 初期データがコールバックで通知される

**テストケース**:
- [ ] 正常系: ルートノードの購読開始
- [ ] 正常系: 深い階層のノードの購読開始
- [ ] 異常系: 存在しないノードIDでの購読
- [ ] 境界値: 1000件の同時購読

### REQ-103: 楽観的ロックの受け入れ基準

**Given（前提条件）**: 🟢
- 既存ノードのWorking Copyが作成済み
- 元ノードのupdatedAtタイムスタンプを保持

**When（実行条件）**: 🟢
- commitWorkingCopyコマンドを送信
- expectedUpdatedAtパラメータを含む

**Then（期待結果）**: 🟢
- タイムスタンプが一致する場合、コミット成功
- タイムスタンプが不一致の場合、STALE_VERSIONエラー
- エラー時はWorking Copyが残る

**テストケース**:
- [ ] 正常系: タイムスタンプ一致でのコミット
- [ ] 異常系: タイムスタンプ不一致（競合検出）
- [ ] 異常系: 削除済みノードへのコミット
- [ ] 境界値: ミリ秒単位の競合

## 非機能テスト基準

### パフォーマンステスト

**NFR-001: コマンド処理時間** 🟢

- [ ] 応答時間: 100ms以内
- [ ] スループット: 100コマンド/秒以上
- [ ] 同時処理: 10コマンドの並行処理
- [ ] リソース使用量: メモリ使用量100MB以下

**テスト方法**:
- 負荷テストツール: Performance.now()で計測
- テストシナリオ: 1000回の連続コマンド送信
- 合格基準: 95パーセンタイルが100ms以内

### セキュリティテスト

**NFR-101: データ保護** 🟡

- [ ] 認証: Worker内でのデータアクセス制限なし（ブラウザサンドボックス依存）
- [ ] 認可: すべての操作が同一権限
- [ ] データ保護: IndexedDBの暗号化なし（ブラウザ依存）
- [ ] 脆弱性: XSS攻撃への耐性

## ユーザビリティテスト基準

### エラーメッセージテスト

- [ ] 直感的エラーコード: NAME_NOT_UNIQUE等の自明なコード
- [ ] 詳細メッセージ: 問題の原因と解決方法を含む
- [ ] 多言語対応: エラーコードベースでUI側で翻訳可能
- [ ] スタックトレース: 開発モードでのデバッグ情報

**テスト方法**:
- エラー注入テスト: 各種エラー条件を意図的に発生
- メッセージ確認: ユーザー理解度テスト
- ログ確認: console.errorへの適切な出力

## Edgeケーステスト基準

### EDGE-001: IndexedDB容量制限の受け入れ基準 🟡

**テストシナリオ**:
- IndexedDBの容量を意図的に埋める
- 新規データ保存を試みる
- QuotaExceededErrorの発生を確認

**合格基準**:
- [ ] システムがクラッシュしない
- [ ] 適切なエラーメッセージが表示される
- [ ] データの整合性が保たれる
- [ ] 復旧可能な状態を維持する

### EDGE-101: 楽観的ロック競合の受け入れ基準 🟢

**テストシナリオ**:
- 同一ノードを2つのWorking Copyで編集
- 両方を同時にコミット
- 後発のコミットが失敗することを確認

**合格基準**:
- [ ] 先着のコミットが成功
- [ ] 後発にSTALE_VERSIONエラー
- [ ] 後発のWorking Copyが保持される
- [ ] 再取得と再編集が可能

### EDGE-201: 大規模データの受け入れ基準 🔴

**テストシナリオ**:
- 10万ノードのツリーを作成
- 全ノードの展開/折りたたみ
- 検索とフィルタリング

**合格基準**:
- [ ] 展開操作が200ms以内
- [ ] 検索が1秒以内
- [ ] メモリ使用量が500MB以下
- [ ] UIのレスポンシブ性維持

## 統合テスト基準

### システム間連携テスト

- [ ] Comlink通信: UI-Worker間のRPC通信
- [ ] Dexie連携: トランザクション処理の整合性
- [ ] 購読システム: 差分検出と通知の正確性

### データベース操作テスト

- [ ] トランザクション: 複数テーブルの原子性
- [ ] インデックス: 検索性能の確認
- [ ] マイグレーション: スキーマ変更時の互換性

## リグレッションテスト基準

### 既存機能影響確認

- [ ] 既存API互換性: 後方互換性の維持
- [ ] パフォーマンス: 新機能追加による劣化なし
- [ ] メモリリーク: 長時間動作でのメモリ増加なし

## 受け入れテスト実行チェックリスト

### テスト実行前

- [ ] テスト環境の準備完了
  - [ ] Chrome/Firefox/Safari最新版
  - [ ] IndexedDBクリア
  - [ ] コンソールログ記録開始
- [ ] テストデータの準備完了
  - [ ] 小規模（100ノード）
  - [ ] 中規模（1000ノード）
  - [ ] 大規模（10000ノード）
- [ ] テストツールの準備完了
  - [ ] Vitest設定
  - [ ] Playwright設定
  - [ ] Performance計測ツール

### テスト実行中

- [ ] 全機能テストの実行
  - [ ] CRUD操作
  - [ ] 購読管理
  - [ ] Undo/Redo
- [ ] 全非機能テストの実行
  - [ ] パフォーマンス
  - [ ] セキュリティ
  - [ ] ユーザビリティ
- [ ] 問題発見時の記録
  - [ ] エラーログ収集
  - [ ] 再現手順記録
  - [ ] スクリーンショット
- [ ] 修正後の再テスト
  - [ ] 修正確認
  - [ ] 回帰テスト

### テスト完了後

- [ ] テスト結果の記録
  - [ ] 実行したテストケース数
  - [ ] 成功/失敗の内訳
  - [ ] カバレッジレポート
- [ ] 残存問題の整理
  - [ ] 優先度付け
  - [ ] 回避策の文書化
- [ ] 受け入れ可否の判定
  - [ ] 必須要件の充足確認
  - [ ] リスク評価
- [ ] ステークホルダーへの報告
  - [ ] テストサマリー作成
  - [ ] デモ実施
  - [ ] フィードバック収集