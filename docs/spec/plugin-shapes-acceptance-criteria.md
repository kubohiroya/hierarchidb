# Plugin Shapes 受け入れ基準

## 概要

このドキュメントはShapesプラグインの各要件に対する具体的な受け入れ基準を定義します。WebWorkerによるバッチ処理、ベクトルマップ生成、地理空間データ管理の機能完成度を客観的に評価するための明確な基準を提供します。

**【信頼性レベル】**: 🟡 既存のBaseMapプラグイン実装とeria-cartographの地図処理パターンから妥当な推測

## 関連文書

- **要件定義**: [📋 plugin-shapes-requirements.md](plugin-shapes-requirements.md)
- **ユーザストーリー**: [📖 plugin-shapes-user-stories.md](plugin-shapes-user-stories.md)
- **参考実装**: `/packages/plugins/basemap/` - BaseMapプラグイン実装

## 受け入れ基準記法の説明

各受け入れ基準は以下の構造で記載されます：

```
✅ 前提条件 (Given)
🎯 実行動作 (When)  
🎉 期待結果 (Then)
🚫 否定テスト (But not)
```

## REQ-001: ShapesエンティティCRUD操作

### 作成 (Create)

**AC-001-01: 新規Shapes作成**
```
✅ ユーザーが階層ツリーでShapesを作成可能な位置にいる
🎯 Shapesノード作成を実行する
🎉 新しいShapesエンティティが作成される
🎉 空のGeoJSONFeatureCollectionが初期化される
🎉 デフォルトスタイル設定が適用される
🎉 作成日時・更新日時が自動設定される
🚫 不正な位置（他のShapesの子など）には作成できない
```

**AC-001-02: 名前重複処理**
```
✅ 同じ親ノード下に「Shapes」という名前のノードが既に存在する
🎯 新しいShapesを「Shapes」という名前で作成する
🎉 自動的に「Shapes (1)」という名前で作成される
🎉 既存のShapesは影響を受けない
🚫 同じ名前で上書きされない
```

### 読み取り (Read)

**AC-001-03: Shapes取得**
```
✅ 有効なShapesエンティティが存在する
🎯 nodeIdを指定してShapesを取得する
🎉 完全なShapesエンティティデータが返される
🎉 GeoJSONデータ、スタイル設定、レイヤー設定がすべて含まれる
🎉 レスポンス時間が200ms以下である
🚫 存在しないnodeIdでエラーが発生しない（undefinedを返す）
```

### 更新 (Update)

**AC-001-04: Shapes更新**
```
✅ 既存のShapesエンティティが存在する
🎯 図形データ（GeoJSON）を変更する
🎉 変更内容がデータベースに保存される
🎉 updatedAtが自動更新される
🎉 関連するBaseMapで自動的に表示が反映される
🎉 統計情報（feature数、vertices数）が再計算される
🚫 不正なGeoJSON形式は受け入れられない
```

### 削除 (Delete)

**AC-001-05: Shapes削除**
```
✅ 削除対象のShapesエンティティが存在する
🎯 Shapesノードを削除する
🎉 Shapesエンティティがデータベースから削除される
🎉 関連するWorking Copyもすべて削除される
🎉 関連するベクトルタイルキャッシュが削除される
🎉 関連するBaseMapからレイヤーが除去される
🚫 他のShapesや無関係なデータは影響を受けない
```

## REQ-002: GeoJSONインポート・エクスポート

### インポート機能

**AC-002-01: GeoJSONファイルインポート**
```
✅ 有効なGeoJSONファイルが選択されている
🎯 ファイルインポートを実行する
🎉 GeoJSONデータが正しく解析される
🎉 各Featureがshapes.geojsonに格納される
🎉 座標系情報（CRS）が適切に処理される
🎉 統計情報が自動計算される
🚫 不正なJSON形式ファイルは受け入れられない
```

**AC-002-02: 大容量ファイルのストリーミング処理**
```
✅ 10MB以上のGeoJSONファイルが選択されている
🎯 ファイルインポートを実行する
🎉 WebWorkerによるストリーミング処理が開始される
🎉 進行状況がリアルタイムで表示される
🎉 メモリ使用量が5MB以下に制限される
🎉 処理完了まで他の操作が可能である
🚫 ブラウザがフリーズしない
```

### エクスポート機能

**AC-002-03: GeoJSONエクスポート**
```
✅ 図形データを含むShapesエンティティが存在する
🎯 GeoJSONエクスポートを実行する
🎉 RFC 7946準拠のGeoJSONファイルが生成される
🎉 すべてのFeatureとPropertiesが含まれる
🎉 座標系情報（CRS）が正しく設定される
🎉 ファイルサイズが適切に最適化される
🚫 データの欠損や破損が発生しない
```

## REQ-003: 座標系変換

**AC-003-01: 自動座標系検出**
```
✅ 座標系情報を含むGeoJSONファイルがインポートされる
🎯 座標系の自動検出を実行する
🎉 CRSプロパティから座標系が正しく識別される
🎉 WGS84以外の座標系が検出された場合、変換オプションが表示される
🎉 一般的な座標系（UTM、Web Mercatorなど）が正しく認識される
🚫 不明な座標系でもエラーが発生しない（警告表示のみ）
```

**AC-003-02: 座標系変換実行**
```
✅ 異なる座標系のGeoJSONデータが存在する
🎯 WGS84への座標系変換を実行する
🎉 すべての座標が正しく変換される
🎉 変換精度が0.1メートル以内である
🎉 変換後のデータが地理的に正しい位置に表示される
🎉 変換処理が2秒以内に完了する（1000個のFeature）
🚫 変換によりデータの構造が破損しない
```

## REQ-005: Working Copy機能

### Working Copy作成

**AC-005-01: Working Copy作成**
```
✅ 編集対象のShapesエンティティが存在する
🎯 Working Copy作成を実行する
🎉 元のShapesの完全なコピーがEphemeralDBに作成される
🎉 Working Copy固有のIDが生成される
🎉 workingCopyOfプロパティが元のnodeIdを参照する
🎉 copiedAtプロパティに作成時刻が設定される
🚫 元のShapesは変更されない
```

### Working Copy編集

**AC-005-02: Working Copy編集**
```
✅ Working Copyが作成済みである
🎯 Working Copyの図形データを変更する
🎉 変更内容がWorking Copyにのみ反映される
🎉 リアルタイムプレビューで変更結果を確認できる
🎉 元のShapesは影響を受けない
🎉 編集履歴が記録される
🚫 変更内容が他のWorking Copyに影響しない
```

### Working Copyコミット

**AC-005-03: Working Copyコミット**
```
✅ 編集済みのWorking Copyが存在する
🎯 Working Copyをコミットする
🎉 Working Copyの内容が元のShapesに反映される
🎉 元のShapesのupdatedAtが更新される
🎉 Working CopyがEphemeralDBから削除される
🎉 関連するBaseMapで新しい図形が表示される
🚫 コミット失敗時にデータの整合性が保たれる
```

## REQ-501-507: WebWorkerバッチ処理

### バッチダウンロード

**AC-501-01: 複数ファイル並行ダウンロード**
```
✅ 複数の外部GeoJSONファイルのURLリストが提供されている
🎯 バッチダウンロード処理を開始する
🎉 WebWorkerによる並行ダウンロードが実行される
🎉 最大4つの同時接続でダウンロードが行われる
🎉 各ファイルの進行状況が個別に表示される
🎉 失敗したファイルは自動的に最大3回リトライされる
🚫 ネットワークエラーでも全体処理が中断しない
```

**AC-501-02: バッチ処理進行状況管理**
```
✅ バッチ処理が実行中である
🎯 進行状況を確認する
🎉 全体の進行状況（X/Y個完了）が表示される
🎉 現在の処理段階（ダウンロード、解析、変換等）が表示される
🎉 推定残り時間が表示される
🎉 処理をキャンセルすることができる
🚫 進行状況の表示が500ms以上遅延しない
```

### エラーハンドリング

**AC-501-03: WebWorkerエラー処理**
```
✅ WebWorkerによるバッチ処理中にエラーが発生する
🎯 エラーハンドリング機能が作動する
🎉 エラーの詳細情報が記録される
🎉 処理済みのデータは保持される
🎉 新しいWorkerが自動的に起動される
🎉 ユーザーに分かりやすいエラーメッセージが表示される
🚫 Worker クラッシュによりアプリケーション全体が停止しない
```

## REQ-601-605: ベクトルタイル生成

### QuadTreeアルゴリズム

**AC-601-01: QuadTree階層化**
```
✅ 大量の図形データを含むShapesが存在する
🎯 ベクトルタイル生成処理を開始する
🎉 QuadTreeアルゴリズムにより空間インデックスが作成される
🎉 各ズームレベルで適切なタイル分割が行われる
🎉 タイル境界での図形クリッピングが正しく処理される
🎉 生成されたタイルがMapbox Vector Tile (MVT)形式に準拠する
🚫 タイル境界で図形が欠損しない
```

**AC-601-02: ズームレベル別最適化**
```
✅ 複雑な図形データが存在する
🎯 異なるズームレベルでのベクトルタイルを生成する
🎉 ズームレベルが低いほど図形が簡素化される
🎉 簡素化により視覚的品質が著しく劣化しない
🎉 各ズームレベルでファイルサイズが適切に最適化される
🎉 生成処理が1平方キロメートルあたり500ms以内で完了する
🚫 簡素化により図形の基本形状が失われない
```

### 圧縮・最適化

**AC-601-03: ベクトルタイル圧縮**
```
✅ ベクトルタイルが生成されている
🎯 タイル圧縮処理を実行する
🎉 gzip圧縮により元サイズの70%以下に圧縮される
🎉 圧縮されたタイルが正しく展開される
🎉 圧縮処理により視覚的品質が劣化しない
🎉 圧縮タイルがWebブラウザで正しく表示される
🚫 圧縮によりデータが破損しない
```

## REQ-101-105: 条件付き要件

### デフォルトスタイル適用

**AC-101-01: デフォルトスタイル設定**
```
✅ ユーザーが新しいShapesを作成する
🎯 Shapes作成処理が完了する
🎉 図形タイプに応じたデフォルトスタイルが適用される
🎉 ポイント：青色、サイズ8pxのCircleスタイル
🎉 ライン：青色、幅2pxのLineスタイル
🎉 ポリゴン：青色、透明度50%のFillスタイル
🚫 空の設定や不正な値が設定されない
```

### バッチ処理条件

**AC-102-01: 大量データ時のバッチ処理切り替え**
```
✅ 1000個以上の図形を含むGeoJSONファイルがインポートされる
🎯 インポート処理を実行する
🎉 自動的にWebWorkerによるバッチ処理に切り替わる
🎉 段階的読み込み（100個ずつ）が実行される
🎉 UIの応答性が保たれる
🎉 メモリ使用量が制限値以内に保たれる
🚫 大量データによりブラウザがフリーズしない
```

## 非機能要件の受け入れ基準

### NFR-001: パフォーマンス（図形表示）

**AC-NFR-001-01: 表示応答時間**
```
✅ 1000個以下の図形データを含むShapesが存在する
🎯 BaseMapでShapesレイヤーを表示する
🎉 初期表示が2秒以内に完了する
🎉 ズーム・パン操作が滑らかに動作する（60fps）
🎉 図形のホバー効果が100ms以内で反応する
🎉 レイヤーの表示/非表示切り替えが500ms以内で完了する
🚫 大量データ表示により他の機能が影響を受けない
```

### NFR-101: スケーラビリティ

**AC-NFR-101-01: 大規模データサポート**
```
✅ 10,000個の図形要素を含むShapesが作成されている
🎯 各種操作を実行する
🎉 図形データの表示が安定して動作する
🎉 編集操作のレスポンス時間が1秒以内である
🎉 メモリ使用量が500MB以下に制限される
🎉 WebWorker処理が正常に完了する
🚫 大規模データによりブラウザクラッシュが発生しない
```

### NFR-201: セキュリティ（CSP対応）

**AC-NFR-201-01: CSP準拠**
```
✅ Content Security Policyが設定されている環境で動作している
🎯 外部GeoJSONファイルをダウンロードする
🎉 CSP違反エラーが発生しない
🎉 許可されたドメインからのみファイルがダウンロードされる
🎉 悪意のあるスクリプトの実行が防止される
🎉 WebWorkerがサンドボックス環境で正しく動作する
🚫 セキュリティポリシーを回避する動作をしない
```

### NFR-301: ユーザビリティ

**AC-NFR-301-01: 直感的操作**
```
✅ 図形編集画面が表示されている
🎯 マウスドラッグによる図形操作を行う
🎉 ドラッグ操作が直感的に図形を移動させる
🎉 コントロールポイントで図形の形状を変更できる
🎉 操作中のフィードバックが視覚的に分かりやすい
🎉 操作を元に戻す（Undo）ことができる
🚫 操作により予期しない図形変更が発生しない
```

## Edgeケース受け入れ基準

### EDGE-001: 不正GeoJSON処理

**AC-EDGE-001-01: 不正データ処理**
```
✅ 不正なGeoJSON形式のファイルがアップロードされる
🎯 インポート処理を実行する
🎉 具体的なエラー箇所を指摘するエラーメッセージが表示される
🎉 修正提案が提供される（可能な場合）
🎉 アプリケーションがクラッシュしない
🎉 部分的に正しいデータは保持される
🚫 不正データが無視されてそのまま処理される
```

### EDGE-101: 座標境界値処理

**AC-EDGE-101-01: 座標範囲外処理**
```
✅ 有効範囲外の座標（経度>180度、緯度>90度）を含むデータがある
🎯 座標データを処理する
🎉 範囲外の座標が有効範囲内にクランプされる
🎉 クランプ処理が実行されたことがユーザーに通知される
🎉 元データの変更有無を記録する
🎉 クランプされた座標でも地理的に意味のある表示になる
🚫 範囲外座標によりエラーが発生しない
```

### EDGE-102: 大量頂点処理

**AC-EDGE-102-01: 頂点数制限処理**
```
✅ 10,000個以上の頂点を持つ複雑な図形が存在する
🎯 図形表示・編集を実行する
🎉 自動的に図形簡素化が適用される
🎉 簡素化レベルがユーザーに表示される
🎉 元の詳細度を保持するオプションが提供される
🎉 簡素化後も図形の基本特徴が保持される
🚫 簡素化により図形が認識できなくなることはない
```

## WebWorker専用テスト基準

### Worker通信テスト

**AC-WORKER-001: メッセージ送受信**
```
✅ WebWorkerが起動している
🎯 バッチ処理タスクを送信する
🎉 Workerが正しくメッセージを受信する
🎉 処理進行状況が定期的に通知される
🎉 処理完了時に結果が正しく返される
🎉 通信エラー時に適切にタイムアウトする
🚫 メッセージの順序が入れ替わらない
```

### Worker並行処理テスト

**AC-WORKER-002: 複数Worker管理**
```
✅ 複数のバッチ処理タスクが同時に実行される
🎯 Worker並行処理を実行する
🎉 最大4つのWorkerが同時に動作する
🎉 各Workerが独立してタスクを処理する
🎉 一つのWorkerの失敗が他に影響しない
🎉 Workerのリソース使用量が適切に制限される
🚫 Worker間でのリソース競合が発生しない
```

## テスト実行ガイドライン

### 自動テスト要件

各受け入れ基準について以下のテストタイプを実装する必要があります：

1. **単体テスト**: エンティティハンドラー、座標変換関数、図形簡素化アルゴリズム
2. **統合テスト**: WebWorker通信、バッチ処理フロー、BaseMap連携
3. **E2Eテスト**: ユーザーシナリオ、ファイルインポートフロー
4. **パフォーマンステスト**: 大量データ処理、メモリ使用量、応答時間
5. **WebWorkerテスト**: 並行処理、エラーハンドリング、メッセージ通信

### テストデータ要件

- **最小構成**: 5個のFeatureを含むGeoJSON
- **標準構成**: 1000個のFeatureを含むGeoJSON、複数図形タイプ
- **大規模構成**: 10,000個のFeature、複雑なポリゴン、外部URL参照
- **異常系**: 不正GeoJSON、範囲外座標、巨大ファイル、ネットワークエラー

### 手動テスト要件

すべてのユーザビリティ関連の受け入れ基準は手動テストで検証し、以下を確認する：

- **操作性**: ドラッグ&ドロップ、図形編集の直感性
- **視覚性**: 図形表示品質、スタイル適用、色彩効果
- **応答性**: リアルタイムプレビュー、進行状況表示
- **エラー処理**: エラーメッセージの分かりやすさ、回復手順

### WebWorker専用テスト環境

WebWorker機能のテストには以下の特別な考慮が必要：

- **Worker実行環境**: Node.js環境でのWorkerテスト設定
- **メッセージモック**: Comlink通信のモック実装  
- **並行処理テスト**: 複数Workerの同期・競合状態テスト
- **メモリ制限テスト**: Worker内メモリ使用量の監視・制限テスト

これらの受け入れ基準を満たすことで、Shapesプラグインの地理空間データ処理能力とWebWorkerによる高性能バッチ処理機能が保証されます。