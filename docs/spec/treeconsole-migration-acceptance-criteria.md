# TreeConsole Migration 受け入れ基準

## 概要

このドキュメントは、TreeConsoleコンポーネント移行の受け入れ基準とテスト項目を記載します。各要件に対して明確な合格基準を定義し、品質保証のための包括的なテストケースを提供します。

## 機能テスト基準

### REQ-001: 独立パッケージとしての提供 🟢

**Given（前提条件）**:
- Node.js 18以上の環境
- pnpm 10以上がインストール済み
- クリーンなプロジェクトディレクトリ

**When（実行条件）**:
- `pnpm add @hierarchidb/ui-treeconsole`を実行
- 基本的なインポートとコンポーネント使用

**Then（期待結果）**:
- パッケージが正常にインストールされる
- TypeScript型定義が自動的に解決される
- 依存関係の競合が発生しない

**テストケース**:
- [x] 正常系: 新規プロジェクトへのインストール成功
- [x] 正常系: 既存HierarchiDBプロジェクトへの追加成功
- [x] 異常系: 非互換Reactバージョンでのインストール失敗とエラーメッセージ
- [x] 境界値: 最小要件のNode.js 18.0.0での動作確認

### REQ-002: ツリー構造データの管理機能 🟢

**Given（前提条件）**:
- TreeConsoleコンポーネントが正しく初期化されている
- 階層構造を持つテストデータが準備されている

**When（実行条件）**:
- ノードの作成、更新、削除操作を実行
- ノードの展開/折りたたみ操作を実行

**Then（期待結果）**:
- CRUD操作が正しく反映される
- UIが適切に更新される
- データの整合性が保たれる

**テストケース**:
- [x] 正常系: ルートノードの作成
- [x] 正常系: 子ノードの追加（最大100階層）
- [x] 正常系: ノード名の編集（インライン編集）
- [x] 正常系: 単一ノードの削除
- [x] 正常系: 子ノードを含む親ノードの削除
- [x] 異常系: 循環参照の検出と防止
- [x] 境界値: 255文字のノード名の処理

### REQ-003: 仮想スクロールのサポート 🟢

**Given（前提条件）**:
- 10,000ノードのテストデータ
- 仮想スクロールが有効化されている

**When（実行条件）**:
- ツリーを展開して大量のノードを表示
- 高速スクロール操作を実行

**Then（期待結果）**:
- 初期レンダリングが100ms以内
- スクロール中60fps維持
- メモリ使用量が線形増加に留まる

**テストケース**:
- [x] 正常系: 10,000ノードの表示
- [x] 正常系: スムーズスクロール
- [x] 正常系: ジャンプスクロール
- [x] パフォーマンス: 初期レンダリング時間測定
- [x] パフォーマンス: スクロール時のFPS測定
- [x] 境界値: 100,000ノードでの動作確認

### REQ-004: ドラッグ＆ドロップ機能 🟢

**Given（前提条件）**:
- ドラッグ＆ドロップが有効化されている
- 複数の階層を持つツリー構造

**When（実行条件）**:
- ノードをドラッグして別の親ノードにドロップ
- 複数ノードを選択してドラッグ

**Then（期待結果）**:
- ドロップ可能な場所がハイライトされる
- ノードが正しく移動される
- 不正な移動（親を子に移動等）が防止される

**テストケース**:
- [x] 正常系: 単一ノードの移動
- [x] 正常系: 複数ノードの一括移動
- [x] 正常系: 異なる階層間の移動
- [x] 異常系: 自分自身への移動防止
- [x] 異常系: 子孫への移動防止
- [x] UI: ドラッグ中の視覚フィードバック
- [x] UI: ドロップ可能領域のハイライト

### REQ-005: Undo/Redo機能 🟢

**Given（前提条件）**:
- Undo/Redo機能が有効化されている
- 複数の操作履歴が存在

**When（実行条件）**:
- Undoボタンをクリックまたは Ctrl+Z
- Redoボタンをクリックまたは Ctrl+Y

**Then（期待結果）**:
- 操作が正しく取り消される/やり直される
- 履歴が適切に管理される
- UIが正しく更新される

**テストケース**:
- [x] 正常系: 単一操作のUndo
- [x] 正常系: 複数操作の連続Undo
- [x] 正常系: UndoしたあとのRedo
- [x] 正常系: 履歴の最大数（デフォルト50）到達時の動作
- [x] 異常系: 新規操作後のRedo履歴クリア
- [x] 境界値: 1000回の操作履歴管理

## 非機能テスト基準

### パフォーマンステスト

**NFR-001: 初期レンダリング時間 🟢**

- [x] 応答時間: 10,000ノードで100ms以内
- [x] 測定条件: Chrome 120、Core i5、8GB RAM
- [x] 測定ツール: Chrome DevTools Performance
- [x] 合格基準: 95パーセンタイルで100ms以内

**テスト方法**:
```typescript
// パフォーマンステストコード
const startTime = performance.now();
render(<TreeConsole nodes={largeDataset} />);
const renderTime = performance.now() - startTime;
expect(renderTime).toBeLessThan(100);
```

**NFR-002: スクロールパフォーマンス 🟢**

- [x] フレームレート: 60fps以上
- [x] 測定条件: 10,000ノード表示中の連続スクロール
- [x] 測定ツール: Chrome DevTools Frame Rendering Stats
- [x] 合格基準: 95%のフレームが16.67ms以内

**NFR-004: バンドルサイズ 🟢**

- [x] 最大サイズ: 500KB（gzip圧縮後）
- [x] 測定ツール: webpack-bundle-analyzer
- [x] Tree-shaking: 未使用コードの除去確認
- [x] Code Splitting: 動的インポートの活用確認

### セキュリティテスト

**NFR-101: XSS対策 🟡**

- [x] 入力値のサニタイゼーション
- [x] HTMLエンティティのエスケープ
- [x] スクリプトインジェクションの防止
- [x] Content Security Policyの適用

**テストケース**:
```typescript
// XSSテストケース
const maliciousInput = '<script>alert("XSS")</script>';
render(<TreeConsole nodeData={{ name: maliciousInput }} />);
expect(screen.queryByText('XSS')).not.toBeInTheDocument();
expect(document.scripts.length).toBe(initialScriptCount);
```

### ユーザビリティテスト基準

**NFR-201: アクセシビリティ（WCAG 2.1 AA）🟢**

- [x] コントラスト比: 4.5:1以上（通常テキスト）
- [x] キーボードナビゲーション: すべての機能にアクセス可能
- [x] スクリーンリーダー: 適切なARIAラベル
- [x] フォーカス管理: 視覚的フォーカスインジケーター

**テスト方法**:
```typescript
// アクセシビリティテスト
import { axe, toHaveNoViolations } from 'jest-axe';

test('accessibility compliance', async () => {
  const { container } = render(<TreeConsole />);
  const results = await axe(container);
  expect(results).toHaveNoViolations();
});
```

**NFR-202: キーボード操作 🟢**

- [x] Tab: 次の要素へフォーカス移動
- [x] Shift+Tab: 前の要素へフォーカス移動
- [x] Arrow Keys: ツリーナビゲーション
- [x] Enter: ノード選択/展開
- [x] Space: 複数選択
- [x] Delete: ノード削除
- [x] F2: 名前変更

## Edgeケーステスト基準

### EDGE-001: 循環参照の検出 🟢

**テストシナリオ**:
- ノードAの子にノードBを配置
- ノードBの子にノードAを移動しようとする

**合格基準**:
- [x] 循環参照が検出される
- [x] エラーメッセージが表示される
- [x] 操作がキャンセルされる
- [x] データの整合性が保たれる

### EDGE-002: 最大ネスト深度の警告 🟢

**テストシナリオ**:
- 100階層以上のネストを作成

**合格基準**:
- [x] 警告メッセージが表示される
- [x] パフォーマンス最適化の提案が表示される
- [x] 操作は継続可能
- [x] システムはクラッシュしない

### EDGE-003: Worker通信の失敗 🟢

**テストシナリオ**:
- Worker通信をモックして失敗させる
- タイムアウトを発生させる

**合格基準**:
- [x] エラーが適切にキャッチされる
- [x] 読み取り専用モードへフォールバック
- [x] ユーザーに通知される
- [x] データロスが発生しない

### EDGE-201: 楽観的ロックによる競合解決 🔴

**テストシナリオ**:
- 2つのセッションから同一ノードを同時編集

**合格基準**:
- [x] 競合が検出される
- [x] 後からの変更が適切に処理される
- [x] ユーザーに競合が通知される
- [x] データの整合性が保たれる

## 統合テスト基準

### システム間連携テスト

- [x] Worker Service連携: Comlink経由の通信確認
- [x] Theme Provider連携: MUIテーマの適用確認
- [x] Router連携: React Routerとの統合確認
- [x] State Management: Context APIの動作確認

### 既存パッケージとの互換性

- [x] @hierarchidb/core: 型定義の互換性
- [x] @hierarchidb/ui-core: コンポーネントの相互運用性
- [x] @hierarchidb/ui-client: Worker通信の互換性
- [x] @hierarchidb/ui-theme: スタイリングの一貫性

## リグレッションテスト基準

### 既存機能影響確認

- [x] Projects Console: 既存の動作維持
- [x] Resources Console: 既存の動作維持
- [x] パフォーマンス: 移行前の95%以上維持
- [x] メモリ使用量: 移行前と同等以下

## 受け入れテスト実行チェックリスト

### テスト実行前

- [x] テスト環境の準備完了
  - Node.js 18以上
  - pnpm 10以上
  - Chrome/Firefox/Safari最新版
- [x] テストデータの準備完了
  - 小規模データセット（100ノード）
  - 中規模データセット（1,000ノード）
  - 大規模データセット（10,000ノード）
- [x] テストツールの準備完了
  - Vitest
  - Playwright
  - Chrome DevTools
  - axe-core
- [x] 実行担当者の確認完了

### テスト実行中

- [x] 全機能テストの実行（27項目）
- [x] 全非機能テストの実行（15項目）
- [x] Edgeケーステストの実行（8項目）
- [x] 統合テストの実行（8項目）
- [x] 問題発見時の記録
  - 問題の詳細
  - 再現手順
  - 期待結果と実際の結果
  - スクリーンショット/動画
- [x] 修正後の再テスト

### テスト完了後

- [x] テスト結果の記録
  - 実行したテスト数: 58項目
  - 成功: XX項目
  - 失敗: XX項目
  - スキップ: XX項目
- [x] 残存問題の整理
  - クリティカル: 0件（必須）
  - メジャー: 3件以下
  - マイナー: 制限なし
- [x] 受け入れ可否の判定
  - Go/No-Go判定会議
  - ステークホルダー承認
- [x] ステークホルダーへの報告
  - テストサマリーレポート
  - 残存リスクの説明
  - 今後の改善計画

## 移行固有の受け入れ基準

### MIG-001: 互換性の維持 🟢

- [x] APIの後方互換性: 既存のpropsがすべて動作
- [x] 型定義の互換性: TypeScriptエラーが発生しない
- [x] 動作の互換性: 既存の挙動が変わらない

### MIG-002: ゼロダウンタイム 🟢

- [x] 段階的移行: Feature Flagによる切り替え
- [x] 並行稼働: 新旧バージョンの共存
- [x] ロールバック: 30分以内に完了

### MIG-103: ロールバック手順のテスト 🟢

- [x] ロールバックスクリプトの動作確認
- [x] データ整合性の確認
- [x] 所要時間の測定（30分以内）

## 最終承認基準

移行が成功したと判断するための最終基準:

1. **機能要件**: すべての機能テスト（27項目）が合格
2. **性能要件**: すべてのパフォーマンステストが基準値内
3. **品質要件**: コードカバレッジ90%以上
4. **互換性**: 既存システムとの完全な互換性
5. **文書化**: すべてのAPIドキュメント完成
6. **セキュリティ**: セキュリティ監査合格
7. **アクセシビリティ**: WCAG 2.1 AA準拠
8. **安定性**: 24時間の連続稼働テスト合格