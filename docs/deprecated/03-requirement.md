# 3. 非機能要件

## 3.1 性能要件

### 3.1.1 応答時間
- **UI操作 → 表示更新** は、通常条件下で **100ms以内** を目標とする。
- Undo/Redo の適用は **200ms以内** を目標とする。
- 大規模データセット（10万ノード規模）でも、表示対象ノードの展開・折りたたみは遅延なく動作すること。

### 3.1.2 ストレージ使用量
- IndexedDB(CoreDB/EphemeralDB) の総容量は、通常利用で 100MB 以下に収まることを目安とする。
- EphemeralDB のデータはセッション単位で破棄可能であり、容量を圧迫しない設計とする。

### 3.1.3 同時購読数
- 単一UIセッションにおける購読ノード数は、1,000件までを推奨上限とする。
- 購読状態の差分送信を最適化（16msコアレス、去重、changed fields のみ送信）し、通信負荷を低減する。

---

## 3.2 可用性要件

### 3.2.1 単一ブラウザセッション前提
- 異なる端末や複数ブラウザ間でのリアルタイム同期は行わない（仕様上非対応）。
- ワーカとの通信失敗時は再試行せず、**ユーザにページリロードまたはブラウザ再起動を促す**。

### 3.2.2 データ保全
- CoreDB のデータは、ブラウザの IndexedDB に永続保存される。
- EphemeralDB のデータは短期保持であり、消失しても致命的ではない設計とする。

### 3.2.3 ブラウザ対応
- **Chromium, Firefox, WebKit** ベースのモダンブラウザを対象とする。
- 後方互換性は考慮しない（古いブラウザ・非標準実装ブラウザはサポート対象外）。

---

## 3.3 拡張性要件

### 3.3.1 モジュール拡張
- core/api/worker/ui の4層すべてで拡張ポイントを設ける。
- 拡張モジュールはAOP的に機能追加でき、ベースモジュールを直接改変しない。

### 3.3.2 データスキーマ拡張とエンティティ関係

- **基本モジュール**では `TreeNode` のようにシンプルな型名を用い、複雑なエンティティ用語は使用しない。
- **拡張モジュール**側では、以下のエンティティ関係用語を使用して開発者の理解を助ける：

#### エンティティの2×3分類

エンティティは、ツリーノードに紐づけられた情報で、紐付けの種類に応じて次のような分類があります：

**ノードとの紐付けの数の構造に応じた分類：**

1. **Peer（1対1）**
   - TreeNodeと1対1で対応するエンティティ
   - 各TreeNodeに対して必ず1つのPeerエンティティが存在
   - 例：StyleMapEntity, BaseMapEntity

2. **Group（1対N）**
   - TreeNodeと1対Nで対応するエンティティ
   - 1つのTreeNodeに対して複数のGroupエンティティが存在可能
   - 例：FeatureSubEntity（GeoJSONの個別フィーチャー）

3. **Relation（N対N）**
   - 複数のTreeNodeとN対Nで対応するエンティティ
   - リファレンスカウントによるライフサイクル管理
   - 最後の参照が削除されたときに自動削除される
   - 例：TableMetadataEntity（複数のStyleMapで共有される表データ）

**ノードのライフサイクルに応じた分類：**

- **Persistent（永続的）**: CoreDBに保存、ノードのライフサイクルと一致
- **Ephemeral（一時的）**: EphemeralDBに保存、ダイアログ内で一時的に生成

#### ワーキングコピーとドラフト

**ワーキングコピー：**
- オブジェクトの編集時に自動的に作成される一時的なコピー
- EphemeralDB（一時データベース）に保存
- オリジナルと同じIDを使用し、編集完了時にオリジナルに反映

**ドラフト状態：**
- 編集中断時に未完成状態として保存可能（ノードタイプによる）
- TreeNodeのisDraftプロパティで管理
- ドラフト状態では一部機能に制限

---

## 3.4 保守性要件

### 3.4.1 テスト
- Vitestでの単体テストとPlaywrightでのE2Eテストを導入。
- 主要機能の回帰バグ防止を目的に、最低限のカバレッジ基準を確保。

### 3.4.2 スキーマ管理
- Dexieスキーマは `core` モジュール内で一元管理し、バージョン番号でマイグレーションを制御。
- DBの破棄・再生成手順を開発者ドキュメントに明記。

---

## 3.5 セキュリティ要件

### 3.5.1 認証・認可
- Cloudflare上のBFFモジュールでOAuth2（Google, Microsoft, GitHub）を仲介。
- CORS-proxy利用時はBFF経由の認証を必須とする。
- 外部APIや外部ダウンロードサイトを利用しない場合、ユーザ認証は不要。

### 3.5.2 データ保護
- IndexedDBデータはブラウザのサンドボックス内に格納され、外部から直接アクセスできない。
- 機微情報はCoreDBには格納せず、外部安全ストレージと連携する。

---

## 3.6 運用要件

### 3.6.1 ブラウザファースト・オフライン利用
- 本システムはブラウザファーストで動作し、外部APIや外部ダウンロードサイトを利用しない場合は**完全オフライン利用**が可能。
- IndexedDBを利用したローカルデータ保持により、ネットワーク接続なしでも全機能を利用できる。

### 3.6.2 デプロイ
- Cloudflare Pages / Workers によるBFF・CORS-proxy運用。
- GitHub Pages によるUI/Workerアプリの静的ホスティング。

### 3.6.3 バージョン管理
- GitHub上でOSSとして公開。
- mainブランチは常に安定版、developブランチでの統合テスト後にマージ。

## 3.7 非機能要件図

```mermaid
mindmap
  root((非機能要件))
    性能
      応答時間 < 100ms
      Undo/Redo < 200ms
      大規模データ対応
    可用性
      単一ブラウザセッション
      通信失敗時はリロード促し
      対応ブラウザ: Chromium / Firefox / WebKit
    拡張性
      core/api/worker/ui拡張
      基本モジュールはEntity用語非使用
      拡張モジュールでEntity/SubEntity使用
    保守性
      コード品質ルール
      テスト体制
      スキーマ管理
    セキュリティ
      OAuth2認証(BFF)
      オフライン時は認証不要
      IndexedDB保護
    運用
      ブラウザファースト
      完全オフライン利用可能
      Cloudflare+GitHub Pages
      Git運用ルール
```