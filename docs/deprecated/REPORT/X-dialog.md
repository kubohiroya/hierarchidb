# Plugin によるダイアログUI仕様書

## 1. 概要

HierarchiDB は、さまざまな問題ドメインに応じた問題の情報構造を、ツリー状の階層的なオブジェクトの形に分解して記述し、問題に取り組むことができる。
ひとつのオブジェクトは、多様な問題の要素的内容を表現するものとなる。　
HierarchiDB は、プラグイン機構により、オブジェクトの種類に応じた可視化を行ったり、作成や表示に関わるUI部品を提供する。
ここでは、そうしたオブジェクトのCRUD操作のうち、Create/Updateを行うためのダイアログ状のUIのデザインについて説明する。
ダイアログは、Reactコンポーネントとして実現し、Material UIコンポーネントを部品として構成する。

## 2. 内部構造

### 2.1 オブジェクト、ツリーノード、2x3のエンティティ
「オブジェクト」は、次の２種類の組み合わせで定義される
1. 「ツリーノード」
   - ツリーノードは、ツリーの階層構造を表現するための基本単位であり、各ノードは一意の識別子（ID）を持つ。
   - ツリーノードは、ツリーのルートノードから始まり、子ノードを持つことができる。
   - ツリーノードは、親ツリーノードのIDを参照することで、階層的な構造を形成する。
   - ツリーノードは、nameとdescription, treeNodtType, createdAt, updatedAtなどの基本情報を管理する。
2. 「エンティティ」
    - エンティティは、ツリーノードに紐づけられた情報である。紐付けの種類に応じて次のような2x3の内部的な種類のエンティティがある。
      - ノードとの紐付けの数の構造に応じた分類： 
        - Peer: 1対1
        - Group: 1対N
        - Relation: N対N
      - ノードのライフサイクルに応じた分類：
        - Persistent: ノードのライフサイクルと一致
        - Ephemeral: ノードのCreate/Editダイアログ内で一時的に生成されノードを閉じると削除される
    - エンティティは、紐づけられたツリーノードの種類およびライフサイクルに応じて、ツリーノードと一体的に管理される。

### 2.2 ワーキングコピー

- オブジェクトの編集が開始されると、オブジェクトの「ワーキングコピー」が作成され、ストレージ上で永続化状態となる。
  - ワーキングコピーのツリーノードは、オリジナルとのツリーノードとは別の、もうひとつのツリーノードである。
    - オリジナルに対して、ワーキングコピーは、0個または1個が存在できる。ワーキングコピーが2個以上が作成されることはない。
    - ワーキングコピーは、オリジナルのツリーノードが保存されているデータベース(CoreDB)とは別のデータベース(EphemeralDB)に保存される。
    - ワーキングコピーでは、オリジナルのツリーノードのIDと同じIDを用いる。これにより、ワーキングコピーのツリーノードが、オリジナルのツリーノードのIDを参照できる。
  - ワーキングコピーにおけるPeerPersistentEntity, PersistentGroupEntity, PersistentRelationEntityは、コピーオンライト方式で、必要に応じて作成される。
  - オブジェクトの生成や編集が指示されると、次のような手順で処理がなされる。
    - ワーキングコピーが作成される（新規作成の場合はデフォルトの内容、編集の場合はオリジナルのノード内容をもとにする。）
      - 編集の場合は、ワーキングコピーのtreeNodeIdプロパティにオリジナルのツリーノードのIDがセットされる。
      - 新規作成の場合は、ワーキングコピーのtreeNodeIdプロパティには新規に採番されたUUIDがセットされる。
    - オリジナルのツリーノードのIDが含まれる作成または編集用URLへと遷移することで、実質的に作業が開始される。
      - このURLをダイレクトリンクで開くと、そのノードのワーキングコピーの編集を再開できる。

- ワーキングコピーを編集中のブラウザが、画面を遷移するたびに、編集中の内容が、ワーキングコピーの永続化内容に反映される。
- ワーキングコピーの編集作業を中断するときには、ワーキングコピーは破棄される。
    - 編集作業を中断する際に、ワーキングコピーを破棄せずにそのまま残しておける場合がある。2.3ドラフトを参照すること。
- ワーキングコピーの編集完了時には、ワーキングコピーのツリーノードは、その内容をオリジナルのツリーノードに反映された上で、破棄される。
  - ワーキングコピーのエンティティがある場合には、ワーキングコピーのIDではなくオリジナルのツリーノードのIDを参照をするものとして、繋ぎ直される。このとき、オリジナルのツリーノードのIDから参照されていたオリジナルのエンティティは破棄される。
- オブジェクトの削除の際には、オブジェクトに紐づけられたワーキングコピーは、一括で破棄される。
- オブジェクトの複製・コピー貼り付けの際には、オブジェクトに紐づけられたワーキングコピーは、元のワーキングコピーとは別のワーキングコピーとして複製される。

### 2.3 ドラフト

- 編集作業を中断する際に、ワーキングコピーを破棄せずに未完成な状態「ドラフト状態」として、そのまま残しておける場合がある。
  - ドラフト状態として保存できるかどうかは、ツリーノードの種類による。 
  - ドラフト状態とは、ツリーノードのisDraftプロパティがtrueにセットされている場合のことである。
    - ドラフト状態のオブジェクトは、通常のオブジェクトとしての表示などの利用には制限が生じる。
  - ドラフト状態として保存できる場合には、Discard確認ダイアログにおいて、「Save as Draft」ボタンが表示される。
  - Save as Draftボタンを押下した場合には、基本的には、通常の編集完了と同様の処理＋isDraftプロパティのセットが行われる。
- 編集作業を完了する場合には、保存されるツリーノードのisDraftプロパティにはundefinedがセットされる。 



## 3. ダイアログ

ダイアログの種類は次の3つに大別される。

- **プラグインダイアログ**(※このドキュメントで説明する)
    - ツリーノードの種類ごとの、新規作成または編集用のダイアログ
  
- オブジェクトダイアログから開かれる子ダイアログ
    - **discard確認ダイアログ**(※このドキュメントで説明する)

- その他のシステム系ダイアログ
    - ログインの際の認証プロバイダーの選択ダイアログ
    - ログアウト確認ダイアログ


### 3.1 プラグインダイアログのプロパティ
- **モード**: create（新規作成）/ edit（編集）
- **ステップ数**: 任意ステップ(1ステップまたはそれ以上)
- **最大幅**: lg（large）
- **アイコン**: Material Iconからそのうちひとつを選択したものの名前

### 3.2 プラグインダイアログのレイアウト

#### ヘッダー部
- **MUI Stepper**:
    - 各ステップのタイトルと進捗状況を表示
    - 条件を満たす場合は他のステップへのダイレクトジャンプが可能
    - クリックによるステップ間の移動をサポート

#### フッター部
- **左下ボタン**:
    - Step 1の場合: 「Cancel」ボタン
    - Step 2以降: 「Back」ボタン（前のステップに戻る）

- **右下ボタン**:
    - 最終ステップ以外: 「Next」ボタン
    - 最終ステップ: 「Save」ボタン
    - バリデーション成功時のみ有効化（enabled）

### コンテント部
- 各ステップに応じた入力フォームや情報表示をする
    - 入力項目はステップごとに異なるが、基本的なレイアウトは共通である

### 3.3 プラグインダイアログ内のフォームに応じた動作

- 入力項目数が多い場合には、コンテント内部やその一部をスクロール可能な領域としたり、アコーディオンやタブによるフォームや情報表示の区分け可視化制御をすることができる
- フォームの入力必須項目は明示的に表示される
- フォームの入力内容のバリデーションを随時実施し、その結果をユーザに随時提示することができる
- フォームの入力内容などに応じた特別な通知が必要な場合には、ダイアログ画面外でユーザに情報を提示するためのスナックバーを用いることができる
- フォームの入力内容などに応じて、ユーザ認証が必要となった場合には、ユーザ認証画面のポップアップまたは画面リダイレクトが行われることがある
- フォームの入力内容に応じて、次のステップへの遷移の可否（右下ボタンの有効化/無効化）が変化する

### 3.4 プラグインダイアログの閉じる動作

#### 編集内容がある場合
1. Cancelボタンまたはbackdrop領域をクリックした場合に
2. **Discard確認ダイアログ**が表示される
    - タイトル: "Discard Shapes Configuration?"
    - メッセージ: "You have unsaved shapes configuration. Are you sure you want to discard your changes?"
    - ボタン:
        - 「Cancel」: 確認ダイアログを閉じて編集を継続
        - 「Discard」: 両ダイアログを閉じて編集内容を破棄

#### 編集内容がない場合
- 未入力または保存済みで変更なしの状態
- Discard警告なしで直接ダイアログを閉じる

### 3.4 プラグインダイアログのステップ構成

#### Step 1: 基本情報（Basic Information）

- **目的**: このオブジェクトのツリーノードの名前と説明を設定
- **入力項目**:
    - 名前（Name）: 必須、テキストフィールド
    - 説明（Description）: 任意、複数行テキストフィールド（3行）

#### Step 2以降

- **目的**: このオブジェクトのエンティティの内容を作成し設定する
- **入力項目**:
    - オブジェクトの種類によって異なる
