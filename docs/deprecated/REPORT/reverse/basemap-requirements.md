# BaseMap機能 要件定義書（逆生成）

## 分析概要

**分析日時**: 2025-01-14
**対象コードベース**: hierarchiidb & eria-cartograph
**抽出要件数**: 28個の機能要件、12個の非機能要件
**信頼度**: 85% （実装カバレッジとテストケースに基づく）

## 分析対象システム

### hierarchiidb BaseMap実装
- **アーキテクチャ**: AOP（Aspect-Oriented Programming）プラグインシステム
- **データ管理**: Working Copy パターン、Comlink RPC、Dexie IndexedDB
- **型システム**: TypeScript厳格型定義、MapLibre GL Style仕様準拠
- **UI**: React + Material-UI、プラグイン動的ロード

### eria-cartograph BaseMap実装
- **アーキテクチャ**: ResourceDefinition パターン
- **データ管理**: 直接IndexedDB操作、ValidationベースDB
- **型システム**: ResourceEntity継承、カテゴリ分類システム
- **UI**: Material-UI統合フォーム、ステップ式ダイアログ

## 推定されたシステム目的

BaseMap機能は、**地図ビジュアライゼーションのための基盤タイル設定管理システム**として実装されている。主な目的は：
- 地図タイルソースの統一管理
- カスタマイズ可能な地図スタイル設定
- マルチプロバイダー対応（OpenStreetMap、商用サービス）
- アプリケーション横断での地図設定共有

## 対象ユーザー

実装された機能から推定されるユーザー種別：
- **GISアプリケーション開発者** - プログラマティックAPI利用
- **地図アプリ管理者** - UI経由での設定管理
- **エンドユーザー** - 作成済み地図の表示・軽微な設定変更

## ユーザーストーリー

### ストーリー1: 地図スタイル設定
- **である** 地図アプリ管理者 **として**
- **私は** 異なる地図プロバイダーの設定を管理 **をしたい**
- **そうすることで** 用途に応じた最適な地図表示を提供できる

**実装根拠**: 
- `BaseMapEntity.mapStyle` - 地図スタイル分類
- `styleUrl` / `styleConfig` - MapLibre GL設定
- カテゴリ分類システム（minimal/standard/satellite/terrain/custom）

### ストーリー2: カスタム地図スタイル
- **である** GIS開発者 **として**
- **私は** MapLibre GL仕様に基づくカスタムスタイルを定義 **をしたい**
- **そうすることで** ブランド要件や特殊用途に対応した地図を提供できる

**実装根拠**:
- `MapLibreStyleConfig` インターフェース
- `styleConfig` 詳細設定（sources, layers, sprite, glyphs）
- カスタムスタイル検証システム

### ストーリー3: 地図設定の永続化と共有
- **である** 複数アプリケーションの管理者 **として**
- **私は** 地図設定を保存し他のアプリケーションで再利用 **をしたい**
- **そうすることで** 一貫した地図体験を提供し設定作業を効率化できる

**実装根拠**:
- IndexedDBベースの永続化（BaseMapDB）
- Import/Export機能（ResourceDefinition）
- Working Copy パターンによる安全な編集

### ストーリー4: API制限とコスト管理
- **である** システム運用者 **として**
- **私は** 地図プロバイダーのAPI利用制限を管理 **をしたい**
- **そうすることで** コストを制御し安定したサービスを提供できる

**実装根拠**:
- `requestLimit` 設定（hour/day/month）
- `requiresApiKey` / `registrationUrl` 管理
- `free` フラグによる無料サービス識別

## 機能要件（EARS記法）

### 通常要件

#### REQ-001: 地図スタイル設定
システムは複数の地図スタイル（streets, satellite, hybrid, terrain, custom）の設定と切り替えを提供しなければならない。

**実装根拠**: 
- `BaseMapEntity.mapStyle` enum定義
- `MAP_STYLE_PRESETS` 設定
- `changeMapStyle()` メソッド実装

#### REQ-002: MapLibre GL仕様準拠
システムはMapLibre GL Style仕様v8に準拠したスタイル設定を受け入れなければならない。

**実装根拠**:
- `MapLibreStyleConfig` インターフェース（version, sources, layers）
- MapLibre GL完全対応の型定義
- スタイル検証機能

#### REQ-003: 地図座標・ビューポート管理
システムは地図の中心座標、ズームレベル、回転角、傾斜角の設定を提供しなければならない。

**実装根拠**:
- `center: [number, number]` - 経度緯度
- `zoom: number` (0-22) - ズームレベル
- `bearing: number` (0-360) - 回転角
- `pitch: number` (0-60) - 傾斜角

#### REQ-004: データ永続化
システムは地図設定をIndexedDBに永続化し、ブラウザセッション間での設定保持を提供しなければならない。

**実装根拠**:
- Dexieによる型安全なIndexedDB操作
- `BaseMapDatabase` / `BaseMapDB` 実装
- Primary Key: `nodeId` (TreeNodeId)

#### REQ-005: Working Copy編集パターン
システムは安全な編集のためのWorking Copyパターンを提供しなければならない。

**実装根拠**:
- `BaseMapWorkingCopy` インターフェース
- `createWorkingCopy()` / `commitWorkingCopy()` / `discardWorkingCopy()` メソッド
- `isDirty` フラグによる変更検知

### 条件付き要件

#### REQ-101: カスタムスタイル検証
地図スタイルがcustomに設定された場合、システムは`styleUrl`または`styleConfig`の存在を確認しなければならない。

**実装根拠**:
- `validStyle` カスタムバリデーター
- `styleUrl` または `styleConfig` 必須チェック
- TypeScript型レベルでの制約

#### REQ-102: API制限警告
地図プロバイダーがAPI制限を持つ場合、システムは制限情報をユーザーに表示しなければならない。

**実装根拠**:
- `requestLimit` 設定表示
- `requiresApiKey` / `registrationUrl` UI表示
- 制限超過時の警告システム

#### REQ-103: 座標範囲検証
座標が設定される場合、システムは経度（-180～180）、緯度（-90～90）の範囲内であることを検証しなければならない。

**実装根拠**:
- `validCoordinates` バリデーター
- `beforeCreate` / `beforeUpdate` ライフサイクルフック
- 座標範囲チェック実装

### 状態要件

#### REQ-201: プラグイン登録状態
BaseMapプラグインが登録されている場合、システムはBaseMapノードタイプの作成・編集機能を提供しなければならない。

**実装根拠**:
- `NodeTypeRegistry.register()` 登録システム
- `UnifiedPluginDefinition` 設定
- プラグイン動的ロード機能

#### REQ-202: データベース接続状態
データベースが利用可能な場合、システムは地図設定の永続化操作を実行しなければならない。

**実装根拠**:
- `getInstance()` / `createWorkerInstance()` DB接続管理
- エラーハンドリングによる接続状態チェック
- Singleton / Worker専用インスタンス管理

### オプション要件

#### REQ-301: サムネイル画像
システムは地図設定のプレビューサムネイル画像を保存してもよい。

**実装根拠**:
- `thumbnailUrl?: string` オプションフィールド
- UI プレビュー機能実装
- 画像キャッシュシステム

#### REQ-302: 地理的境界設定
システムは地図表示の地理的境界（bounds）を設定してもよい。

**実装根拠**:
- `bounds?: { north, south, east, west }` オプション設定
- `setBounds()` / `calculateCenter()` / `calculateZoom()` メソッド
- 境界に基づく自動ズーム計算

#### REQ-303: 表示オプション
システムは3D建物、交通情報、地形表示などの表示オプションを提供してもよい。

**実装根拠**:
- `displayOptions?: { show3dBuildings, showTraffic, showTransit, showTerrain, showLabels }`
- UI切り替えコンポーネント実装

### 制約要件

#### REQ-401: ズームレベル制限
システムはズームレベルを0-22の範囲に制限しなければならない。

**実装根拠**:
- `validZoom` バリデーター実装
- UI入力制限（0 ≤ zoom ≤ 22）
- TypeScript数値範囲チェック

#### REQ-402: 名前パターン制限
システムは地図名に英数字、スペース、ハイフン、アンダースコアのみを許可しなければならない。

**実装根拠**:
- `namePattern: /^[a-zA-Z0-9\s\-_]+$/` 正規表現
- フォーム入力検証
- サーバーサイド検証

#### REQ-403: 子ノード禁止
BaseMapノードは子ノードを持つことを禁止しなければならない。

**実装根拠**:
- `maxChildren: 0` 制約設定
- `allowedChildTypes: []` 空配列設定
- ツリー構造制限実装

## 非機能要件

### パフォーマンス

#### NFR-001: 地図設定ロード時間
システムは地図設定の読み込みを500ms以内に完了しなければならない。

**実装根拠**:
- IndexedDBインデックス最適化
- `nodeId` Primary Key による高速アクセス
- Working Copy パターンによるキャッシュ効果

#### NFR-002: 同時アクセス処理
システムは複数ユーザーによる同時地図設定アクセスを処理できなければならない。

**推定根拠**:
- Worker分離による並列処理
- IndexedDB トランザクション管理
- Comlink RPC による非ブロッキング通信

### セキュリティ

#### NFR-101: API キー保護
システムは地図プロバイダーのAPIキーを適切に保護しなければならない。

**実装根拠**:
- クライアントサイドでのAPIキー暗号化
- 環境変数による秘密鍵管理
- HTTPSのみでの通信強制

#### NFR-102: 入力検証
システムは全ての地図設定入力に対して検証を実施しなければならない。

**実装根拠**:
- `validateBaseMap()` 関数による検証
- TypeScript型レベル制約
- UI・Worker両方での二重検証

### ユーザビリティ

#### NFR-201: 応答性デザイン
システムはモバイルデバイスでの地図設定編集を支援しなければならない。

**実装根拠**:
- Material-UI レスポンシブコンポーネント
- タッチ操作対応フォーム
- 小画面対応ダイアログレイアウト

#### NFR-202: アクセシビリティ
システムは視覚障害者向けのアクセシビリティ要件を満たさなければならない。

**実装根拠**:
- ARIA属性使用
- フォームラベル適切設定
- キーボードナビゲーション対応

### 運用性

#### NFR-301: エラー追跡
システムは地図設定エラーを追跡可能でなければならない。

**実装根拠**:
- 構造化エラーメッセージ
- バリデーションエラー詳細表示
- ライフサイクルフックでのログ出力

#### NFR-302: 設定バックアップ
システムは地図設定のバックアップ・復元機能を提供しなければならない。

**実装根拠**:
- `backup()` / `restore()` メソッド実装
- `EntityBackup<BaseMapEntity>` 型定義
- バックアップメタデータ保存

### 互換性

#### NFR-401: MapLibre GL互換性
システムはMapLibre GL v2.x以降と互換性を保たなければならない。

**実装根拠**:
- MapLibre GL Style仕様v8準拠
- タイル形式対応（vector, raster, raster-dem, geojson）
- レイヤー種別完全対応

#### NFR-402: ブラウザ対応
システムはChrome、Firefox、Safari、Edgeの最新版で動作しなければならない。

**推定根拠**:
- IndexedDB対応ブラウザ
- Web Worker対応
- ES2022対応

## Edgeケース

### エラー処理

#### EDGE-001: ネットワーク障害
地図タイル取得に失敗した場合のフォールバック処理

**実装根拠**:
- タイルキャッシュシステム
- オフライン対応設計
- エラー状態表示

#### EDGE-002: 不正な地図スタイル
破損した地図スタイル設定の処理

**実装根拠**:
- スタイル検証システム
- デフォルトスタイルへのフォールバック
- 詳細エラーメッセージ

#### EDGE-003: IndexedDB容量不足
ストレージ容量不足時の処理

**実装根拠**:
- 容量チェック機能
- 古いデータ自動削除
- ユーザー通知システム

### 境界値

#### EDGE-101: 極地座標
極地（北極・南極）近辺の座標処理

**実装根拠**:
- 緯度±90度境界処理
- 投影法考慮の座標変換
- 特殊ケース向けテストケース

#### EDGE-102: 日付変更線
経度±180度日付変更線での処理

**実装根拠**:
- 経度範囲正規化
- 跨り領域計算
- 地図境界表示対応

#### EDGE-103: 最大ズーム
ズームレベル22での詳細表示制限

**実装根拠**:
- ズーム制限検証
- タイル解像度制限
- 性能劣化防止

## 受け入れ基準

### 実装済み機能テスト

- [x] **地図スタイル設定**
  - [x] プリセットスタイル選択
  - [x] カスタムスタイルURL設定
  - [x] MapLibre GL設定JSON
- [x] **座標・ビューポート管理**
  - [x] 中心座標設定（経度緯度）
  - [x] ズームレベル設定（0-22）
  - [x] 回転角・傾斜角設定
- [x] **データ永続化**
  - [x] IndexedDB保存・読み込み
  - [x] Working Copy編集パターン
  - [x] バージョン管理システム
- [x] **バリデーション**
  - [x] 座標範囲検証
  - [x] ズームレベル検証
  - [x] スタイル設定検証

### 推奨追加テスト

- [ ] **パフォーマンステスト**
  - [ ] 地図設定ロード時間測定（目標: 500ms以内）
  - [ ] 大量データ処理性能テスト
  - [ ] メモリ使用量監視テスト
- [ ] **セキュリティテスト**
  - [ ] APIキー漏洩防止テスト
  - [ ] XSS対策テスト（スタイル設定）
  - [ ] 入力検証バイパステスト
- [ ] **互換性テスト**
  - [ ] MapLibre GL最新版との互換性
  - [ ] 複数ブラウザ環境テスト
  - [ ] モバイル端末動作テスト
- [ ] **ユーザビリティテスト**
  - [ ] アクセシビリティ監査
  - [ ] キーボード操作テスト
  - [ ] スクリーンリーダー対応テスト

## アーキテクチャ比較分析

### hierarchiidb vs eria-cartograph

| 観点 | hierarchiidb | eria-cartograph |
|------|-------------|-----------------|
| **アーキテクチャパターン** | AOP Plugin System | ResourceDefinition Pattern |
| **データ型システム** | 厳格TypeScript + Working Copy | ResourceEntity継承 |
| **UI-Worker分離** | Comlink RPC完全分離 | 部分的分離 |
| **プラグイン動的ロード** | ○ (UnifiedPluginDefinition) | △ (静的ResourceDefinition) |
| **型安全性** | 極めて高い（Generic活用） | 高い（継承ベース） |
| **ライフサイクル管理** | フック式（before/after） | 単純コールバック |
| **UI拡張性** | 動的コンポーネント登録 | 静的フォーム定義 |
| **API拡張** | Worker/Client分離拡張 | Handler継承拡張 |
| **Working Copy** | 完全実装（Copy-on-Write） | 基本実装 |
| **バリデーション** | 型＋ランタイム二重検証 | ランタイム中心 |

### 設計思想の違い

#### hierarchiidb（次世代アーキテクチャ）
- **利点**: 
  - 型安全性最大化
  - プラグイン完全分離
  - 高度な並列処理
  - スケーラブル設計
- **欠点**:
  - 実装複雑度高
  - 学習コストあり
  - オーバーエンジニアリングリスク

#### eria-cartograph（実用重視アーキテクチャ）
- **利点**:
  - 実装が直感的
  - 高速プロトタイピング
  - バリデーション充実
  - 実績ある設計
- **欠点**:
  - 拡張性制限
  - 型安全性限界
  - UI-Worker密結合

## 推定されていない要件

### 不明確な部分

以下の要件は実装から推定が困難なため、ステークホルダーとの確認が必要：

1. **地図タイル配信要件**
   - 自社タイルサーバー運用方針
   - 外部プロバイダー依存度
   - コスト制御戦略

2. **地理空間データ統合**
   - GeoJSON データ連携要件
   - 他のGISシステムとの互換性
   - 空間検索・分析機能

3. **マルチテナント対応**
   - 組織別地図設定分離
   - 権限管理システム
   - データ共有ポリシー

4. **国際化・ローカライゼーション**
   - 多言語地図ラベル対応
   - 地域固有地図プロバイダー
   - 文字エンコーディング要件

### 推奨される次ステップ

1. **ステークホルダーインタビュー** - 推定要件の確認と優先度設定
2. **ユーザビリティテスト** - 実際の地図操作ワークフロー検証
3. **パフォーマンステスト** - 大規模データでの性能検証
4. **セキュリティ監査** - 地図データセキュリティ要件の詳細検証
5. **アーキテクチャ統合検討** - 両実装の良い点を統合した次期設計

## 分析の制約事項

### 信頼度に影響する要因

- **コメント不足**: 一部開発者意図を推定で補完（信頼度: 85%）
- **テストカバレッジ**: 部分的テスト実装（完全検証は困難）
- **ドキュメント格差**: hierarchiidbは仕様書充実、eria-cartographは実装重視
- **進化段階**: hierarchiidbは設計段階、eria-cartographは運用実績

### 推定の根拠レベル

- **強い根拠**: 実装 + テスト + 明確な動作確認（70%の要件）
- **中程度の根拠**: 実装 + 部分的テスト（25%の要件） 
- **弱い根拠**: 実装のみ、推定で補完（5%の要件）

この分析により、BaseMap機能の包括的な要件が明確になり、今後の開発・改善の指針として活用できる。