# プラグインアーキテクチャ実装 受け入れ基準

## 概要

このドキュメントは hierarchidb プラグインアーキテクチャ実装機能の受け入れ基準とテスト項目を記載します。

## 機能テスト基準

### REQ-001: NodeTypeRegistry シングルトン実装の受け入れ基準 🟢

**Given（前提条件）**:
- NodeTypeRegistry クラスが定義されている
- アプリケーションが初期化されている

**When（実行条件）**:
- NodeTypeRegistry.getInstance() を複数回呼び出す
- 異なるモジュールから getInstance() を呼び出す

**Then（期待結果）**:
- 常に同一のインスタンスが返される
- インスタンスの参照が一致する（===）

**テストケース**:
- [ ] 正常系: 複数回の getInstance() 呼び出しで同一インスタンス確認
- [ ] 異常系: コンストラクタの直接呼び出しでエラー発生確認
- [ ] 境界値: 並行アクセス時のインスタンス一意性確認

### REQ-002: UnifiedPluginDefinition による プラグイン定義の受け入れ基準 🟢

**Given（前提条件）**:
- UnifiedPluginDefinition インターフェースが定義されている
- 必要な型定義がインポートされている

**When（実行条件）**:
- UnifiedPluginDefinition を実装したプラグインを作成
- registerPlugin() メソッドで登録

**Then（期待結果）**:
- TypeScript の型チェックが成功
- プラグインが正常に登録される
- getDefinition() で取得可能

**テストケース**:
- [ ] 正常系: 完全な UnifiedPluginDefinition の登録成功
- [ ] 異常系: 必須フィールド欠落時のビルドエラー確認
- [ ] 境界値: 最小限の必須フィールドのみでの登録成功

### REQ-003: ライフサイクルフック実行の受け入れ基準 🟢

**Given（前提条件）**:
- ライフサイクルフックを定義したプラグインが登録済み
- NodeLifecycleManager が初期化済み

**When（実行条件）**:
- ノードの作成/更新/削除操作を実行
- 各ライフサイクルポイントに到達

**Then（期待結果）**:
- beforeCreate → 作成処理 → afterCreate の順序で実行
- beforeUpdate → 更新処理 → afterUpdate の順序で実行
- beforeDelete → 削除処理 → afterDelete の順序で実行
- 警告発生時は console.warn で出力し処理継続
- エラー発生時は操作全体をロールバック

**テストケース**:
- [ ] 正常系: 全ライフサイクルフックの順序確認
- [ ] 警告系: フック内警告時の継続処理確認
- [ ] 異常系: フック内エラー時のロールバック確認
- [ ] 境界値: フック未定義時の正常動作確認

### REQ-004: EntityHandler CRUD 操作の受け入れ基準 🟢

**Given（前提条件）**:
- EntityHandler を実装したプラグインが登録済み
- データベース接続が確立済み

**When（実行条件）**:
- createEntity() でエンティティ作成
- getEntity() でエンティティ取得
- updateEntity() でエンティティ更新
- deleteEntity() でエンティティ削除

**Then（期待結果）**:
- 各操作が成功し、データベースに反映される
- エンティティの version が適切に更新される
- timestamp が自動更新される

**テストケース**:
- [ ] 正常系: CRUD 全操作の成功確認
- [ ] 異常系: 存在しない nodeId での操作エラー確認
- [ ] 境界値: 大量データでのパフォーマンス確認

### REQ-101: プラグイン依存関係チェックの受け入れ基準 🟢

**Given（前提条件）**:
- dependencies を定義したプラグインが存在
- 依存先プラグインの登録状態が様々

**When（実行条件）**:
- 依存関係のあるプラグインを登録
- 依存先が未登録の状態で登録試行

**Then（期待結果）**:
- 依存先が登録済みの場合、正常に登録
- 依存先が未登録の場合、エラー発生

**テストケース**:
- [ ] 正常系: 依存先登録済みでの成功確認
- [ ] 異常系: 依存先未登録でのエラー確認
- [ ] 境界値: 循環依存の検出確認

### REQ-103: プライオリティによる初期化順序の受け入れ基準 🟢

**Given（前提条件）**:
- 異なる priority 値を持つ複数プラグイン
- pluginConfig で priority 指定

**When（実行条件）**:
- initializePlugins() を実行
- 各プラグインの initialize() が呼ばれる

**Then（期待結果）**:
- priority 値の昇順（10→20→30→40）で初期化
- 同一 priority の場合は登録順

**テストケース**:
- [ ] 正常系: priority 順での初期化確認
- [ ] 異常系: priority 未指定時のデフォルト動作確認
- [ ] 境界値: 同一 priority 時の処理確認

## 非機能テスト基準

### パフォーマンステスト

**NFR-001: プラグインビルド統合** 🟢

- [ ] ビルド方式: pnpm add で追加したプラグインがビルド時に静的に組み込まれる
- [ ] 実行時検索: 動的検索が不要で、コンパイル時に解決される
- [ ] 型安全性: TypeScript の型チェックが完全に機能する

**テスト方法**:
- ビルドツール: pnpm build
- テストシナリオ: プラグイン追加後のビルド成功確認
- 合格基準: ビルドエラーなし、バンドルサイズの増加が適切

### セキュリティテスト

**NFR-101: プラグイン間の分離** 🟡

- [ ] データアクセス: 他プラグインのプライベートデータにアクセス不可
- [ ] API 制限: 定義された API 以外のシステムリソースアクセス不可
- [ ] スコープ分離: プラグイン間の名前空間衝突なし

**テスト方法**:
- 悪意のあるプラグインのシミュレーション
- プライベートプロパティへのアクセス試行
- 合格基準: すべてのアクセス試行が失敗

## ユーザビリティテスト基準

### UX/UIテスト

- [ ] 型補完: VSCode での TypeScript 型補完が機能 🟢
- [ ] エラーメッセージ: 最小限のエラー情報を提供 🟢
- [ ] ドキュメント: API リファレンスと実装例の提供 🟢
- [ ] デバッグ: ソースマップによるデバッグ対応 🟡

**テスト方法**:
- 開発者による実装体験評価
- エラーメッセージの分かりやすさ評価
- 合格基準: 開発者満足度 80% 以上

## Edgeケーステスト基準

### EDGE-001: 不完全な NodeTypeDefinition 登録の受け入れ基準 🟢

**テストシナリオ**:
- nodeType フィールドが未定義
- entityHandler が null
- 必須フィールドが欠落

**合格基準**:
- [ ] ビルド時に TypeScript エラー発生
- [ ] エラーメッセージに欠落フィールド明記
- [ ] 実行時エラーで詳細情報提供
- [ ] システムクラッシュなし

### EDGE-002: 存在しない nodeType 取得の受け入れ基準 🟢

**テストシナリオ**:
- 未登録の nodeType で getDefinition() 呼び出し
- null や undefined での検索

**合格基準**:
- [ ] 未登録の nodeType の場合は undefined を返す
- [ ] null/undefined の nodeType の場合は例外を投げる
- [ ] 適切なエラーメッセージを含む例外

### EDGE-003: ライフサイクルフック内例外の受け入れ基準 🟢

**テストシナリオ**:
- beforeCreate で警告発生
- beforeCreate でエラー発生
- 複数フックでの連続エラー

**合格基準**:
- [ ] 警告時: console.warn で出力し処理継続
- [ ] エラー時: 操作全体をロールバック
- [ ] エラー情報にフック名と nodeType 含む
- [ ] データ整合性が保たれる


## 統合テスト基準

### システム間連携テスト

- [ ] Dexie データベース連携: スキーマ自動マイグレーション確認 🟢
- [ ] React Router 統合: 動的ルート生成の確認 🟢
- [ ] Worker スレッド連携: API 呼び出しの非同期実行確認 🟢

### プラグイン間連携テスト

- [ ] Resources-Project 連携: ツリー間参照の動作確認 🟢
- [ ] propertyresolver 連携: GeoJSON 変換ルール適用確認 🟢
- [ ] 共通プラグイン: folder が両ツリーで動作確認 🟢

## リグレッションテスト基準

### 既存機能影響確認

- [ ] 基本ツリー操作: ノード作成・編集・削除の継続動作
- [ ] データ永続化: 既存データの読み込み可能
- [ ] UI 表示: 既存コンポーネントの表示崩れなし

### ホットリロード確認

- [ ] 開発サーバー: npm 依存モジュールとしてホットリロード動作
- [ ] プロダクション: ビルド後の静的統合確認

## 受け入れテスト実行チェックリスト

### テスト実行前

- [ ] TypeScript 5.0 以上のインストール確認
- [ ] Node.js 18 以上の環境確認
- [ ] テストデータベースの初期化
- [ ] モックプラグインの準備完了

### テスト実行中

- [ ] 全機能要件テスト（REQ-001～404）の実行
- [ ] 全非機能要件テスト（NFR-001～302）の実行
- [ ] Edge ケーステスト（EDGE-001～202）の実行
- [ ] 問題発見時の詳細ログ記録

### テスト完了後

- [ ] テスト結果レポートの生成
- [ ] カバレッジレポート（目標 80% 以上）
- [ ] パフォーマンス測定結果の記録
- [ ] 残存問題の優先度付けと対応計画

## 受け入れ判定基準

### 必須項目（Phase 1）
- 全 REQ-001～007, REQ-401～404 のテスト成功
- TypeScript ビルドエラーなし
- 基本的な CRUD 操作の動作

### 重要項目（Phase 2）
- REQ-101～105, REQ-201～203 のテスト成功
- パフォーマンス基準の 80% 達成
- エラーハンドリングの適切な実装

### 推奨項目（Phase 3）
- Edge ケースの 70% 以上成功
- ユーザビリティ評価 80% 以上
- ドキュメントの完備

## テスト自動化

```typescript
// Vitest による自動テストの例
describe('NodeTypeRegistry', () => {
  it('should return singleton instance', () => {
    const instance1 = NodeTypeRegistry.getInstance();
    const instance2 = NodeTypeRegistry.getInstance();
    expect(instance1).toBe(instance2);
  });

  it('should register UnifiedPluginDefinition', () => {
    const definition: UnifiedPluginDefinition = {
      nodeType: 'test' as TreeNodeType,
      // ... 必須フィールド
    };
    registry.registerPlugin(definition);
    expect(registry.getDefinition('test')).toBeDefined();
  });
});
```

## 変更履歴

- 2025-01-28: 初版作成（統合プラグインアーキテクチャ仕様に基づく）