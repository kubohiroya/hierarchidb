# plugin-stylemap 受け入れ基準

## 概要

このドキュメントは plugin-stylemap 機能の受け入れ基準とテスト項目を記載します。eria-cartograph の既存実装を詳細に分析し、hierarchidb フレームワークでの要件に基づいて作成されています。

## 機能テスト基準

### REQ-001: CSV/TSV ファイルからテーブルデータ読み込み の受け入れ基準

**Given（前提条件）**:
- hierarchidb プロジェクトが作成済み
- stylemap プラグインが有効化済み
- 有効なCSV/TSVファイルが準備済み

**When（実行条件）**:
- ユーザーがstylemap作成ダイアログを開く
- ファイル選択エリアにCSV/TSVファイルをドラッグ&ドロップまたは選択
- ファイルアップロード処理を実行

**Then（期待結果）**:
- ファイル内容が正常に解析される
- カラム構造が TableMetadataEntity として保存される
- RowEntity として各行データが格納される
- SHA3ハッシュによるファイル識別子が生成される

**テストケース**:
- [ ] 🟢 正常系: RFC 4180準拠のCSVファイル読み込み成功
- [ ] 🟢 正常系: タブ区切りTSVファイル読み込み成功
- [ ] 🟢 正常系: UTF-8エンコーディングファイル処理成功
- [ ] 🟢 異常系: 不正な文字エンコーディングファイルのエラーハンドリング
- [ ] 🟢 境界値: 空のCSVファイル（ヘッダーのみ）の処理
- [ ] 🟡 境界値: 大容量ファイル（10万行）の処理性能確認

### REQ-002: テーブルデータのキー・値ペアマッピング の受け入れ基準

**Given（前提条件）**:
- CSVファイルが正常に読み込み済み
- 複数のカラムを持つテーブルデータが存在
- カラム選択UIが表示済み

**When（実行条件）**:
- ユーザーがキーカラムを選択（地理識別子等）
- ユーザーが値カラムを選択（数値データ等）
- マッピング設定を保存

**Then（期待結果）**:
- StyleMapEntity の keyColumn/valueColumn が更新される
- 選択されたカラムペアでのデータマッピング処理が実行される
- プレビューでマッピング結果が確認可能

**テストケース**:
- [ ] 🟢 正常系: 文字列キー＋数値バリューの正常マッピング
- [ ] 🟢 正常系: 数値キー＋数値バリューの正常マッピング
- [ ] 🟢 異常系: 同一カラムのキー・値選択時のエラー表示
- [ ] 🟢 異常系: 非数値データを値カラムに選択時の警告表示
- [ ] 🟢 境界値: NULL値を含むデータの処理
- [ ] 🟢 境界値: 空文字列を含むデータの処理

### REQ-003: 数値データに基づくカラーマッピング設定管理 の受け入れ基準

**Given（前提条件）**:
- キー・値カラムが選択済み
- StyleMapConfiguration コンポーネントが表示済み
- 数値データの最小・最大値が算出済み

**When（実行条件）**:
- ユーザーがカラーマッピングアルゴリズムを選択（linear/logarithmic/quantile/categorical）
- カラー空間を選択（RGB/HSV）
- 色相範囲、彩度、明度を調整
- 対象MapLibreスタイルプロパティを選択

**Then（期待結果）**:
- StyleMapConfig オブジェクトが正常に生成される
- リアルタイムプレビューが更新される
- 設定内容が作業コピーに保存される

**テストケース**:
- [ ] 🟢 正常系: 線形アルゴリズムでのカラーマッピング設定
- [ ] 🟢 正常系: 対数アルゴリズムでのカラーマッピング設定
- [ ] 🟢 正常系: 分位数アルゴリズムでのカラーマッピング設定
- [ ] 🟢 正常系: カテゴリアルゴリズムでのカラーマッピング設定
- [ ] 🟢 正常系: HSVカラー空間での色相範囲設定
- [ ] 🟢 正常系: RGBカラー空間での基本色設定
- [ ] 🟢 境界値: 最小値＝最大値の場合の処理
- [ ] 🟡 境界値: 極端な数値範囲での色計算精度

### REQ-004: StyleMapEntity としての永続化 の受け入れ基準

**Given（前提条件）**:
- 全ての設定項目が有効な値で入力済み
- 作業コピーがEphemeralDBに存在
- ユーザーが保存操作を実行

**When（実行条件）**:
- StyleMapDialog でSubmitボタンをクリック
- 保存確認ダイアログで承認
- Worker層での永続化処理実行

**Then（期待結果）**:
- StyleMapEntity がCoreDBに保存される
- TableMetadataEntity とRowEntity が関連付けて保存される
- TreeNode として階層構造に追加される
- 作業コピーがEphemeralDBから削除される

**テストケース**:
- [ ] 🟢 正常系: 新規作成モードでの完全な永続化処理
- [ ] 🟢 正常系: 編集モードでの更新処理
- [ ] 🟢 正常系: ファイルキャッシュとの連携保存
- [ ] 🟢 異常系: 保存中のネットワークエラー時の回復処理
- [ ] 🟢 異常系: IndexedDB容量不足時のエラーハンドリング
- [ ] 🟡 境界値: 同名リソース作成時の重複回避処理

### REQ-005: MapLibre GL JS 対応スタイルプロパティ生成 の受け入れ基準

**Given（前提条件）**:
- StyleMapConfig が設定済み
- 有効なキー・値データが存在
- MapLibre GL JS v3.x 互換環境

**When（実行条件）**:
- スタイルプロパティ生成APIを呼び出し
- 指定されたtargetPropertyに対するスタイル計算実行
- 地図レイヤーでのスタイル適用

**Then（期待結果）**:
- MapLibre GL JS スタイル仕様に準拠したオブジェクトが生成される
- fill-color, line-width, circle-radius 等の適切な値が設定される
- 地図上でのビジュアライゼーションが正常に表示される

**テストケース**:
- [ ] 🟢 正常系: fill-color プロパティでのカラーマッピング
- [ ] 🟢 正常系: line-width プロパティでの数値マッピング
- [ ] 🟢 正常系: circle-radius プロパティでのサイズマッピング
- [ ] 🟢 正常系: 複数プロパティの組み合わせ適用
- [ ] 🟢 異常系: 未サポートプロパティ指定時のフォールバック
- [ ] 🟢 境界値: 色値の範囲外計算時の補正処理

### REQ-006: ファイルコンテンツのSHA3ハッシュベースキャッシュ管理 の受け入れ基準

**Given（前提条件）**:
- StyleMapFileCacheService が初期化済み
- Cache API が利用可能な環境
- 複数のファイルアップロード可能状態

**When（実行条件）**:
- 同一内容のファイルを異なるタイミングでアップロード
- キャッシュからのデータ取得処理実行
- キャッシュの有効期限管理処理実行

**Then（期待結果）**:
- SHA3ハッシュによる一意識別が実行される
- 重複ファイルの再解析処理がスキップされる
- Cache API からの高速データ取得が実現される
- 設定された有効期限でのキャッシュ削除が実行される

**テストケース**:
- [ ] 🟢 正常系: 同一ファイルのキャッシュヒット確認
- [ ] 🟢 正常系: SHA3ハッシュ計算の一意性確認
- [ ] 🟡 正常系: キャッシュ有効期限（24時間）での自動削除
- [ ] 🟢 異常系: Cache API 無効環境でのフォールバック処理
- [ ] 🟡 境界値: ストレージ容量上限でのキャッシュ削除処理
- [ ] 🟡 境界値: 大容量ファイルのキャッシュ処理性能

### REQ-007: 作業コピー機能によるアンドゥ/リドゥ操作サポート の受け入れ基準

**Given（前提条件）**:
- EphemeralDB が初期化済み
- 作業コピーパターンが実装済み
- 編集セッションが開始済み

**When（実行条件）**:
- ユーザーが設定変更を実行
- 作業コピーの状態更新処理実行
- アンドゥ/リドゥ操作実行
- 編集キャンセルまたは保存処理実行

**Then（期待結果）**:
- 各編集操作がEphemeralDBに記録される
- アンドゥ操作で前の状態に復帰可能
- リドゥ操作で次の状態に進行可能
- キャンセル時に作業コピーが破棄される
- 保存時に作業コピーがCoreDBに反映される

**テストケース**:
- [ ] 🟢 正常系: カラーマッピング設定変更のアンドゥ/リドゥ
- [ ] 🟢 正常系: フィルタ設定変更のアンドゥ/リドゥ
- [ ] 🟢 正常系: カラム選択変更のアンドゥ/リドゥ
- [ ] 🟢 正常系: 編集キャンセル時の完全な状態復帰
- [ ] 🟢 異常系: EphemeralDB異常時のエラーハンドリング
- [ ] 🟡 境界値: 大量の編集履歴での性能確認

## 非機能テスト基準

### パフォーマンステスト

**NFR-001: 10万行以下のCSVファイルを5秒以内に処理**

- [ ] 🟡 応答時間: 100,000行CSVファイルの読み込み完了時間 ≤ 5秒
- [ ] 🟡 応答時間: 50,000行CSVファイルの読み込み完了時間 ≤ 2.5秒
- [ ] 🟡 応答時間: 10,000行CSVファイルの読み込み完了時間 ≤ 1秒
- [ ] 🟡 スループット: 同時5ファイルアップロード処理の完了時間 ≤ 15秒

**テスト方法**:
- 負荷テストツール: Jest + @testing-library/react でのモックデータ処理
- テストシナリオ: 異なるサイズのCSVファイルでの処理時間測定
- 合格基準: 95%tile で指定時間内完了

**NFR-002: カラーマッピングプレビューを500ms以内に更新**

- [ ] 🟡 応答時間: スライダー操作後のプレビュー更新時間 ≤ 500ms
- [ ] 🟡 応答時間: カラーアルゴリズム変更後の再計算時間 ≤ 300ms
- [ ] 🟡 応答時間: フィルタ適用後のプレビュー更新時間 ≤ 800ms
- [ ] 🟡 リソース使用量: プレビュー更新時のCPU使用率 ≤ 70%

**テスト方法**:
- パフォーマンス測定: Chrome DevTools Performance API
- テストシナリオ: 連続的なUI操作での応答性測定
- 合格基準: ユーザーが体感する遅延なし（500ms以内）

### セキュリティテスト

**NFR-101: ファイル読み込み時にXSS攻撃を防止**

- [ ] 🟡 入力検証: HTMLタグを含むCSVデータの無害化処理
- [ ] 🟡 入力検証: JavaScriptコードを含むファイル名の安全処理
- [ ] 🟡 入力検証: SQLインジェクション攻撃パターンの検出・ブロック
- [ ] 🟡 出力エスケープ: ユーザー入力データの適切なエスケープ処理

**テスト方法**:
- セキュリティスキャン: OWASP ZAP による自動脆弱性検査
- ペネトレーションテスト: 悪意のあるファイルでの手動テスト
- 合格基準: OWASP Top 10 脆弱性の完全回避

**NFR-102: 機密情報のログ出力を禁止**

- [ ] 🟢 ログ監査: ファイル内容の平文ログ出力なし
- [ ] 🟢 ログ監査: ユーザー個人識別情報のログ出力なし
- [ ] 🟢 ログ監査: API トークンやキーの平文ログ出力なし
- [ ] 🟢 エラーハンドリング: スタックトレースでの機密情報漏洩防止

**テスト方法**:
- ログ解析: 本番ログでの機密情報検索（正規表現ベース）
- 静的解析: ESLint ルールでのログ出力パターン検査
- 合格基準: 機密情報の一切のログ出力なし

## ユーザビリティテスト基準

### UX/UIテスト

- [ ] 🟡 直感的操作性: 初回ユーザーのタスク完了率 ≥ 80%
- [ ] 🟢 レスポンシブデザイン: デスクトップ（1920×1080）での完全表示
- [ ] 🟢 レスポンシブデザイン: タブレット（1024×768）での適切表示
- [ ] 🟡 アクセシビリティ: WCAG 2.1 AA準拠（axe-core での自動検査）
- [ ] 🟢 エラーメッセージ: ユーザーフレンドリーなエラー表示（技術用語なし）

**テスト方法**:
- ユーザビリティテスト: 5名の被験者でのタスク実行観察
- A/Bテスト: 異なるUI デザインでの完了率比較
- アクセシビリティチェック: axe-core, Wave, Lighthouse での自動検査

### 多言語・国際化テスト

- [ ] 🟡 言語サポート: 日本語UIでの完全表示
- [ ] 🟡 言語サポート: 英語UIでの完全表示
- [ ] 🟡 文字エンコーディング: UTF-8 ファイルの正常処理
- [ ] 🟡 数値フォーマット: ロケール固有の数値表示（カンマ区切り等）

## Edgeケーステスト基準

### EDGE-001: ファイル形式不正時の適切なエラーハンドリング の受け入れ基準

**テストシナリオ**:
- Microsoft Excel ファイル (.xlsx) をアップロード
- 画像ファイル (.jpg, .png) をアップロード
- 圧縮ファイル (.zip) をアップロード
- 実行可能ファイル (.exe) をアップロード

**合格基準**:
- [ ] 🟢 システムがクラッシュしない
- [ ] 🟢 「サポートされていないファイル形式です。CSV または TSV ファイルをアップロードしてください。」等の明確なエラーメッセージが表示される
- [ ] 🟢 推奨ファイル形式への変換方法が案内される
- [ ] 🟢 ファイル選択状態がリセットされ、再選択可能な状態になる

### EDGE-002: ファイルサイズ制限超過時の警告表示 の受け入れ基準

**テストシナリオ**:
- 100MB超のCSVファイルをアップロード
- 1GB のテキストファイルをアップロード
- 複数ファイルの同時アップロードで合計容量制限超過

**合格基準**:
- [ ] 🟡 ファイルサイズ制限（100MB）を超えた場合の警告表示
- [ ] 🟡 「ファイルサイズが大きすぎます。100MB以下のファイルをアップロードしてください。」等の分かりやすいメッセージ
- [ ] 🟡 代替案（ファイル分割、データ削減）の提案
- [ ] 🟡 アップロード処理が適切にキャンセルされる

### EDGE-003: ネットワーク切断時のローカルキャッシュフォールバック の受け入れ基準

**テストシナリオ**:
- ファイルアップロード中のネットワーク切断
- 作業保存中のネットワーク切断
- キャッシュデータ取得中のネットワーク切断

**合格基準**:
- [ ] 🟡 ローカルキャッシュからのデータ復旧成功
- [ ] 🟡 「ネットワークが切断されました。ローカルキャッシュから復旧しています。」等の状況説明
- [ ] 🟡 ネットワーク復旧後の自動同期処理
- [ ] 🟡 データ整合性の保持（破損データの検出・修復）

### EDGE-004: Worker プロセス異常終了時の回復処理 の受け入れ基準

**テストシナリオ**:
- メモリ不足によるWorker プロセス終了
- Worker 内での例外発生による異常終了
- ブラウザタブの強制終了・復旧

**合格基準**:
- [ ] 🟡 Worker プロセスの自動再起動
- [ ] 🟡 作業状態の可能な限りの復旧
- [ ] 🟡 「システムエラーが発生しました。データを復旧しています。」等のユーザー通知
- [ ] 🟡 未保存データの警告と保存推奨メッセージ

## 統合テスト基準

### システム間連携テスト

- [ ] 🟢 hierarchidb コアシステムとの連携: NodeTypeRegistry への正常登録
- [ ] 🟢 Worker層との連携: Comlink RPC での双方向通信確認
- [ ] 🟢 IndexedDB との連携: 複数プラグインでの同時アクセス制御
- [ ] 🟢 MapLibre GL JS との連携: 生成スタイルの地図での正常表示

### プラグインアーキテクチャ適合テスト

- [ ] 🟢 NodeTypeDefinition 準拠: 必須フィールドの完全実装
- [ ] 🟢 EntityHandler 実装: CRUD操作の完全サポート
- [ ] 🟢 ライフサイクルフック: afterCreate, beforeDelete 等の正常動作
- [ ] 🟢 UI コンポーネント登録: dialogComponent, panelComponent の適切な表示

### データベース整合性テスト

- [ ] 🟢 データ正規化: 重複ファイルでの単一TableMetadataEntity 共有
- [ ] 🟢 外部キー制約: StyleMapEntity と TableMetadataEntity の適切な関連
- [ ] 🟢 参照カウント: TableMetadataEntity 削除時の関連データ整理
- [ ] 🟡 トランザクション整合性: 複数操作での ACID 特性保持

## リグレッションテスト基準

### 既存機能影響確認

- [ ] 🟢 他プラグイン機能: shapes, basemap プラグインの正常動作継続
- [ ] 🟢 コアシステム機能: プロジェクト作成・編集・削除の正常動作継続
- [ ] 🟢 UI システム機能: ダイアログシステム・ナビゲーションの正常動作継続
- [ ] 🟡 パフォーマンス劣化確認: 既存機能の処理時間に5%以上の劣化なし

### セキュリティ設定継続確認

- [ ] 🟢 認証・認可機能: プロジェクトアクセス制御の継続
- [ ] 🟢 データ暗号化: IndexedDB データの適切な保護継続
- [ ] 🟢 通信セキュリティ: Worker 間通信の安全性継続
- [ ] 🟢 ログ・監査機能: セキュリティログの適切な記録継続

## 受け入れテスト実行チェックリスト

### テスト実行前

- [ ] 🟡 テスト環境の準備完了
  - [ ] hierarchidb 開発環境のセットアップ
  - [ ] 必要なブラウザ（Chrome, Firefox, Safari）での動作確認環境
  - [ ] テストデータセット（各種サイズ・形式のCSV/TSVファイル）の準備
- [ ] 🟡 テストデータの準備完了
  - [ ] 正常系データ: 地理統計データCSV（国別人口、都道府県別経済指標等）
  - [ ] 異常系データ: 不正フォーマット、大容量、異常値を含むファイル
  - [ ] 境界値データ: 空ファイル、単一列、極端な数値範囲のファイル
- [ ] 🟡 テストツールの準備完了
  - [ ] Jest + @testing-library/react でのユニットテストセットアップ
  - [ ] Playwright での E2E テストセットアップ
  - [ ] Chrome DevTools Performance API でのパフォーマンス測定環境
- [ ] 🟡 実行担当者の確認完了
  - [ ] 機能テスト担当者（開発チーム）
  - [ ] 非機能テスト担当者（QAチーム）
  - [ ] ユーザビリティテスト担当者（UXチーム）
  - [ ] セキュリティテスト担当者（セキュリティチーム）

### テスト実行中

- [ ] 🟡 全機能テストの実行
  - [ ] REQ-001 〜 REQ-007 の全要件テスト完了
  - [ ] 正常系・異常系・境界値テストの実行
  - [ ] テスト結果の詳細記録（スクリーンショット・ログ含む）
- [ ] 🟡 全非機能テストの実行
  - [ ] パフォーマンステスト（NFR-001, NFR-002）実行
  - [ ] セキュリティテスト（NFR-101, NFR-102）実行
  - [ ] ユーザビリティテスト実行
- [ ] 🟡 問題発見時の記録
  - [ ] 不具合の詳細記録（再現手順・期待値・実際値）
  - [ ] 重要度・優先度の設定
  - [ ] 開発チームへの即座の報告
- [ ] 🟡 修正後の再テスト
  - [ ] バグ修正版でのリグレッションテスト
  - [ ] 修正内容の確認テスト
  - [ ] 関連機能への影響確認

### テスト完了後

- [ ] 🟡 テスト結果の記録
  - [ ] 全テストケースの実行結果サマリー
  - [ ] 合格率・不合格率の算出
  - [ ] パフォーマンス指標の測定結果
  - [ ] セキュリティチェック結果報告書
- [ ] 🟡 残存問題の整理
  - [ ] 未解決不具合の一覧化
  - [ ] 残存リスクの評価・影響度分析
  - [ ] 代替案・回避策の検討
- [ ] 🟡 受け入れ可否の判定
  - [ ] 必須要件（REQ-001〜REQ-007）の100%合格確認
  - [ ] 重要な非機能要件の合格確認
  - [ ] 残存問題の本番影響度評価
  - [ ] 総合的な受け入れ可否判断
- [ ] 🟡 ステークホルダーへの報告
  - [ ] プロダクトオーナーへのテスト結果報告
  - [ ] 開発チームへの最終確認事項共有
  - [ ] 運用チームへの注意事項・制限事項の伝達
  - [ ] 次期開発での改善点・要望事項の整理

## 自動化テスト要件

### ユニットテスト（Jest）

```typescript
// 🟢 StyleMapEntity の保存・取得テスト
describe('StyleMapDB', () => {
  test('should save and retrieve StyleMapEntity correctly', async () => {
    // Given: Valid StyleMapEntity
    // When: Save to database
    // Then: Retrieve same entity with all properties intact
  });
});

// 🟢 カラーマッピング計算テスト
describe('StyleMapConfiguration', () => {
  test('should calculate correct color values for linear algorithm', async () => {
    // Given: Linear algorithm with HSV color space
    // When: Calculate color for specific value
    // Then: Return correct RGB color value
  });
});
```

### E2E テスト（Playwright）

```typescript
// 🟢 完全なスタイルマップ作成フロー
test('Complete stylemap creation flow', async ({ page }) => {
  // Given: Project page is open
  // When: Create stylemap through all steps
  // Then: Stylemap is saved and displayed correctly
});

// 🟡 大容量ファイル処理テスト
test('Large file processing performance', async ({ page }) => {
  // Given: 100k rows CSV file
  // When: Upload and process
  // Then: Complete within 5 seconds
});
```

### 継続的インテグレーション要件

- [ ] 🟡 プルリクエスト時の自動テスト実行
- [ ] 🟡 テストカバレッジ 80%以上の維持
- [ ] 🟡 E2E テストの夜間自動実行
- [ ] 🟡 パフォーマンス回帰テストの週次実行

## 受け入れ基準適合宣言

**🟢 信頼性レベル高**: eria-cartograph 実装に基づく確実な要件
**🟡 信頼性レベル中**: 一般的なベストプラクティスに基づく妥当な推測
**🔴 信頼性レベル低**: 仕様が不明確で推測に依存する項目

本受け入れ基準は、eria-cartograph プロジェクトの詳細な実装分析に基づいて作成されており、hierarchidb フレームワークでの plugin-stylemap 実装において、機能的品質・非機能的品質の両面で高い信頼性を確保することを目的としています。