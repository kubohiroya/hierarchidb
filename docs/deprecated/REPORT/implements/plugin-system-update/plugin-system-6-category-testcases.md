# プラグインシステム6分類エンティティ対応 テストケース定義書

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript 5.x
  - **言語選択の理由**: 🟢 HierarchiDBの既存実装言語であり、型安全性を確保
  - **テストに適した機能**: 🟢 厳密な型チェック、async/await、デコレータサポート
- **テストフレームワーク**: Vitest
  - **フレームワーク選択の理由**: 🟢 Viteベースの高速実行、既存プロジェクトで採用済み
  - **テスト実行環境**: 🟢 Node.js環境、fake-indexeddbでのIndexedDBモック
- 🟢 この内容の信頼性レベル: 既存のpackage.jsonとvitest.config.tsから確認済み

## 1. 正常系テストケース（基本的な動作）

### 1.1 PeerEntityManager基本操作

- **テスト名**: PeerEntityの作成・取得・更新・削除
  - **何をテストするか**: TreeNodeと1:1対応するエンティティの基本CRUD操作
  - **期待される動作**: エンティティがTreeNodeと同期してライフサイクル管理される
- **入力値**: 
  ```typescript
  nodeId: 'node-001'
  data: { name: 'BaseMap Tokyo', center: [35.6762, 139.6503], zoom: 10 }
  ```
  - **入力データの意味**: BaseMapプラグインの典型的な設定データ
- **期待される結果**: 
  ```typescript
  { nodeId: 'node-001', name: 'BaseMap Tokyo', createdAt: 1234567890, version: 1 }
  ```
  - **期待結果の理由**: PeerEntityの基本プロパティが正しく設定される
- **テストの目的**: 1:1関係の基本動作確認
  - **確認ポイント**: TreeNode削除時の自動削除動作
- 🟢 このテストケースの信頼性レベル: docs/10-0-plugin-comprehensive-specification.mdから定義を参照

### 1.2 GroupEntityManager複数エンティティ管理

- **テスト名**: GroupEntityの一括作成と取得
  - **何をテストするか**: 1つのTreeNodeに対する複数エンティティの管理
  - **期待される動作**: グループIDで管理され、sortOrderで順序保持
- **入力値**: 
  ```typescript
  nodeId: 'node-002'
  tiles: [
    { zoom: 8, x: 227, y: 100, data: new Uint8Array(1024) },
    { zoom: 8, x: 227, y: 101, data: new Uint8Array(2048) }
  ]
  ```
  - **入力データの意味**: VectorTilesの典型的なタイルデータ
- **期待される結果**: 2つのGroupEntityが作成され、同一グループIDを持つ
  - **期待結果の理由**: 同じズームレベルのタイルは同一グループ
- **テストの目的**: 1:N関係の管理確認
  - **確認ポイント**: グループ単位での削除が正しく動作
- 🟢 このテストケースの信頼性レベル: packages/core/src/types/nodeDefinition.tsのGroupEntity定義を参照

### 1.3 RelationalEntityManager参照カウント管理

- **テスト名**: RelationalEntityの参照追加と自動削除
  - **何をテストするか**: N:N関係での参照カウント管理
  - **期待される動作**: 参照カウントが0になると自動削除
- **入力値**: 
  ```typescript
  entityId: 'table-001'
  nodeIds: ['node-003', 'node-004', 'node-005']
  ```
  - **入力データの意味**: 複数のStyleMapから共有されるTableMetadata
- **期待される結果**: 
  ```typescript
  { id: 'table-001', referenceCount: 3, referencingNodeIds: ['node-003', 'node-004', 'node-005'] }
  ```
  - **期待結果の理由**: 3つのノードから参照されているため参照カウント3
- **テストの目的**: N:N関係の参照管理
  - **確認ポイント**: 最後の参照削除時の自動削除
- 🟢 このテストケースの信頼性レベル: RelationalEntityManager仕様から導出

### 1.4 EphemeralEntityクリーンアップ

- **テスト名**: WorkingCopy削除時のEphemeralデータ自動削除
  - **何をテストするか**: WorkingCopyライフサイクルに連動した削除
  - **期待される動作**: WorkingCopy破棄時に関連するEphemeralEntityが削除
- **入力値**: 
  ```typescript
  workingCopyId: 'wc-001'
  ephemeralData: [
    { id: 'ed-001', workingCopyId: 'wc-001', stage: 'download' },
    { id: 'ed-002', workingCopyId: 'wc-001', stage: 'simplify1' }
  ]
  ```
  - **入力データの意味**: Shapesプラグインの処理中間データ
- **期待される結果**: WorkingCopy削除後、関連するEphemeralEntityがすべて削除
  - **期待結果の理由**: EphemeralEntityはWorkingCopyと同じライフサイクル
- **テストの目的**: 自動クリーンアップ機能の確認
  - **確認ポイント**: メモリリークの防止
- 🟢 このテストケースの信頼性レベル: 設計文書の自動ライフサイクル管理から導出

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 存在しないエンティティへのアクセス

- **テスト名**: 存在しないPeerEntityの取得
  - **エラーケースの概要**: 削除済みまたは未作成のエンティティへのアクセス
  - **エラー処理の重要性**: UIでの適切なエラー表示のため
- **入力値**: `nodeId: 'non-existent-node'`
  - **不正な理由**: データベースに存在しないID
  - **実際の発生シナリオ**: 別タブで削除された後のアクセス
- **期待される結果**: `undefined`を返却（例外をthrowしない）
  - **エラーメッセージの内容**: エラーではなくundefinedで処理
  - **システムの安全性**: クラッシュせずに継続動作
- **テストの目的**: 防御的プログラミングの確認
  - **品質保証の観点**: ユーザー操作の堅牢性
- 🟢 このテストケースの信頼性レベル: 一般的なエラーハンドリングパターン

### 2.2 参照カウント不整合の検出と修復

- **テスト名**: RelationalEntity参照カウント不整合の自動修復
  - **エラーケースの概要**: 参照カウントと実際の参照リストの不一致
  - **エラー処理の重要性**: データ整合性の維持
- **入力値**: 
  ```typescript
  { 
    id: 'table-002', 
    referenceCount: 5, // 不正な値
    referencingNodeIds: ['node-006', 'node-007'] // 実際は2つ
  }
  ```
  - **不正な理由**: カウントと配列長が一致しない
  - **実際の発生シナリオ**: 並行処理での更新競合
- **期待される結果**: 
  ```typescript
  { referenceCount: 2, referencingNodeIds: ['node-006', 'node-007'] }
  ```
  - **エラーメッセージの内容**: ログに警告を出力し自動修復
  - **システムの安全性**: データ不整合を自動修復
- **テストの目的**: 自己修復機能の確認
  - **品質保証の観点**: データ整合性の自動維持
- 🟡 このテストケースの信頼性レベル: 一般的なデータ整合性パターンから推測

### 2.3 メモリ不足時のEphemeralEntity削除

- **テスト名**: メモリ圧迫時の自動クリーンアップ
  - **エラーケースの概要**: メモリ使用量が閾値を超過
  - **エラー処理の重要性**: OutOfMemoryエラーの防止
- **入力値**: 
  ```typescript
  memoryUsage: 600 * 1024 * 1024, // 600MB
  threshold: 500 * 1024 * 1024 // 500MB
  ```
  - **不正な理由**: メモリ使用量が閾値超過
  - **実際の発生シナリオ**: 大量データ処理時
- **期待される結果**: 古いEphemeralEntityから順次削除
  - **エラーメッセージの内容**: メモリ最適化実行のログ
  - **システムの安全性**: メモリ枯渇前に予防的削除
- **テストの目的**: メモリ管理機能の確認
  - **品質保証の観点**: システムの安定性維持
- 🟡 このテストケースの信頼性レベル: パフォーマンス要件から推測

### 2.4 循環参照の検出

- **テスト名**: RelationalEntityの循環参照防止
  - **エラーケースの概要**: エンティティが自己参照を持つ
  - **エラー処理の重要性**: 無限ループの防止
- **入力値**: 
  ```typescript
  entityA.references = ['entityB']
  entityB.references = ['entityA'] // 循環参照
  ```
  - **不正な理由**: A→B→Aの循環参照
  - **実際の発生シナリオ**: 複雑な依存関係での設定ミス
- **期待される結果**: エラーをthrowして操作を拒否
  - **エラーメッセージの内容**: "Circular reference detected"
  - **システムの安全性**: 循環参照によるデッドロック防止
- **テストの目的**: 参照整合性の確認
  - **品質保証の観点**: システムの論理的整合性
- 🔴 このテストケースの信頼性レベル: 設計文書にない推測

## 3. 境界値テストケース（最小値、最大値、null等）

### 3.1 空のGroupEntity管理

- **テスト名**: GroupEntityが0個の場合の処理
  - **境界値の意味**: グループエンティティの最小個数
  - **境界値での動作保証**: 空でもクラッシュしない
- **入力値**: `nodeId: 'node-008', entities: []`
  - **境界値選択の根拠**: 配列の最小要素数
  - **実際の使用場面**: 初期作成直後の状態
- **期待される結果**: 空配列を返すが例外は発生しない
  - **境界での正確性**: 長さ0の配列として正しく処理
  - **一貫した動作**: 要素がある場合と同じインターフェース
- **テストの目的**: エッジケースの堅牢性
  - **堅牢性の確認**: 空データでも正常動作
- 🟢 このテストケースの信頼性レベル: 一般的な境界値テストパターン

### 3.2 最大参照カウント

- **テスト名**: RelationalEntityの参照カウント上限
  - **境界値の意味**: 実用的な参照数の上限
  - **境界値での動作保証**: 大量参照でもパフォーマンス維持
- **入力値**: 
  ```typescript
  referencingNodeIds: Array(1000).fill(0).map((_, i) => `node-${i}`)
  ```
  - **境界値選択の根拠**: 実用上の最大値として1000を想定
  - **実際の使用場面**: 共有リソースが多数から参照される
- **期待される結果**: 正常に処理され、参照カウント1000
  - **境界での正確性**: 配列操作のパフォーマンス維持
  - **一貫した動作**: 少数参照と同じ動作
- **テストの目的**: スケーラビリティの確認
  - **堅牢性の確認**: 大規模データでの動作保証
- 🟡 このテストケースの信頼性レベル: パフォーマンス要件から推測

### 3.3 nullおよびundefinedの処理

- **テスト名**: オプショナルフィールドのnull/undefined処理
  - **境界値の意味**: 欠損値の扱い
  - **境界値での動作保証**: 型安全性の維持
- **入力値**: 
  ```typescript
  { 
    nodeId: 'node-009',
    name: 'Test',
    description: undefined,
    metadata: null
  }
  ```
  - **境界値選択の根拠**: TypeScriptのオプショナル型
  - **実際の使用場面**: 部分的なデータ更新
- **期待される結果**: undefinedフィールドは無視、nullは保持
  - **境界での正確性**: TypeScript型定義に準拠
  - **一貫した動作**: オプショナルフィールドの標準的な扱い
- **テストの目的**: 型安全性の確認
  - **堅牢性の確認**: 欠損値での正常動作
- 🟢 このテストケースの信頼性レベル: TypeScript型定義から導出

### 3.4 タイムスタンプの境界

- **テスト名**: expiresAtタイムスタンプの境界値
  - **境界値の意味**: 有効期限の最小・最大値
  - **境界値での動作保証**: 時間計算の正確性
- **入力値**: 
  ```typescript
  expiresAt: Date.now() + 1 // 1ミリ秒後
  ```
  - **境界値選択の根拠**: 最小の有効期限
  - **実際の使用場面**: 即座に期限切れとなるデータ
- **期待される結果**: 1ミリ秒後にクリーンアップ対象となる
  - **境界での正確性**: タイミング精度の確認
  - **一貫した動作**: 長期間の期限と同じ処理
- **テストの目的**: タイマー処理の精度
  - **堅牢性の確認**: 極短時間での動作保証
- 🟡 このテストケースの信頼性レベル: 一般的なタイマー処理から推測

## 4. 統合テストケース

### 4.1 プラグイン登録と自動ライフサイクル

- **テスト名**: BaseMapプラグインの完全ライフサイクル
  - **何をテストするか**: プラグイン登録から削除までの一連の流れ
  - **期待される動作**: 6分類エンティティシステムに基づく自動管理
- **入力値**: BaseMapプラグイン定義オブジェクト
  - **入力データの意味**: 実際のプラグイン実装
- **期待される結果**: TreeNode作成→Entity作成→TreeNode削除→Entity自動削除
  - **期待結果の理由**: PeerEntityのライフサイクル管理
- **テストの目的**: エンドツーエンドの動作確認
  - **確認ポイント**: 自動ライフサイクル管理の完全性
- 🟢 このテストケースの信頼性レベル: 設計文書の実装例から導出

### 4.2 StyleMap複合エンティティ管理

- **テスト名**: StyleMapのPeerEntity+RelationalEntity統合
  - **何をテストするか**: 複数タイプのエンティティ協調動作
  - **期待される動作**: StyleMapEntityとTableMetadataEntityの連携
- **入力値**: StyleMapプラグインの6ステップウィザードデータ
  - **入力データの意味**: 実際のユーザー操作フロー
- **期待される結果**: 両エンティティが正しく作成・関連付け
  - **期待結果の理由**: 複合エンティティパターン
- **テストの目的**: 複数エンティティタイプの協調
  - **確認ポイント**: 参照整合性の維持
- 🟢 このテストケースの信頼性レベル: StyleMapプラグイン仕様から導出

## テストケース実装時の日本語コメント指針

### テストスイート構造

```typescript
describe('プラグインシステム6分類エンティティ対応', () => {
  // 【テストスイート目的】: 6分類エンティティシステムの包括的な動作検証
  // 【対象バージョン】: v1.0.0
  // 🟢 信頼性: 設計文書に基づく実装
  
  describe('PeerEntityManager', () => {
    // 【テストグループ】: TreeNodeと1:1対応するエンティティの管理
    
    beforeEach(() => {
      // 【テスト前準備】: データベースの初期化とマネージャーインスタンス作成
      // 【環境初期化】: IndexedDBモックのクリーンアップ
    });
    
    it('should create PeerEntity with TreeNode', async () => {
      // 【テスト目的】: PeerEntityがTreeNodeと同期して作成されることを確認
      // 【テスト内容】: BaseMapEntityの作成と基本プロパティの検証
      // 【期待される動作】: nodeIdが一致し、タイムスタンプが設定される
      // 🟢 信頼性: PeerEntity定義から導出
      
      // 【テストデータ準備】: BaseMapの典型的な設定データを用意
      const nodeId = 'test-node-001';
      const baseMapData = {
        name: 'Tokyo Map',
        center: [35.6762, 139.6503],
        zoom: 10
      };
      
      // 【実際の処理実行】: PeerEntityManagerのcreateメソッドを呼び出し
      const entity = await peerEntityManager.create(nodeId, baseMapData);
      
      // 【結果検証】: 作成されたエンティティのプロパティを確認
      expect(entity.nodeId).toBe(nodeId); // 【確認内容】: TreeNodeとの1:1対応
      expect(entity.createdAt).toBeDefined(); // 【確認内容】: タイムスタンプの自動設定
      expect(entity.version).toBe(1); // 【確認内容】: 初期バージョン番号
    });
    
    afterEach(() => {
      // 【テスト後処理】: データベースのクリーンアップ
      // 【状態復元】: 次のテストに影響しないよう初期状態に戻す
    });
  });
});
```

## 品質判定

### ✅ 高品質判定

- **テストケース分類**: ✅ 正常系（4件）・異常系（4件）・境界値（4件）が網羅されている
- **期待値定義**: ✅ 各テストケースの期待値が具体的かつ明確
- **技術選択**: ✅ TypeScript + Vitestが確定済み（既存環境）
- **実装可能性**: ✅ fake-indexeddbとVitestで全テストケース実現可能

### 判定結果
本テストケース定義は**高品質**と判定されました。6分類エンティティシステムの主要な動作パターンを網羅し、既存の技術スタックで実装可能な具体的なテストケースが定義されています。

---

**次のお勧めステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。