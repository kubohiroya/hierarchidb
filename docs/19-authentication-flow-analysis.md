# èªè¨¼ãƒ•ãƒ­ãƒ¼è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025å¹´8æœˆ25æ—¥  
**åˆ†æè€…**: Claude Code  
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: HierarchiDB 2ç’°å¢ƒæ§‹æˆ

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

2ã¤ã®ç’°å¢ƒï¼ˆé–‹ç™ºãƒ»æœ¬ç•ªï¼‰ã«ãŠã‘ã‚‹èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å„æ®µéšã‚’åˆ†æã—ãŸçµæœã€ä¸¡ç’°å¢ƒã§åŒä¸€ã®BFFã‚µãƒ¼ãƒãƒ¼ï¼ˆeria-cartographï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ä¸€è²«æ€§ã¯ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ã€ã„ãã¤ã‹ã®æ½œåœ¨çš„ãªèª²é¡Œã¨æ”¹å–„ç‚¹ã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚

## 1. é–‹ç™ºç’°å¢ƒã®èªè¨¼ãƒ•ãƒ­ãƒ¼åˆ†æ

### 1.1 ãƒ•ãƒ­ãƒ¼å…¨ä½“å›³

```mermaid
stateDiagram-v2
    [*] --> åˆæœŸã‚¢ã‚¯ã‚»ã‚¹: localhost:4200
    
    åˆæœŸã‚¢ã‚¯ã‚»ã‚¹ --> èªè¨¼çŠ¶æ…‹ç¢ºèª: Vite HMRèµ·å‹•
    
    èªè¨¼çŠ¶æ…‹ç¢ºèª --> æœªèªè¨¼ç”»é¢: ãƒˆãƒ¼ã‚¯ãƒ³ãªã—
    èªè¨¼çŠ¶æ…‹ç¢ºèª --> èªè¨¼æ¸ˆç”»é¢: æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³
    
    æœªèªè¨¼ç”»é¢ --> OAuthé–‹å§‹: ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
    OAuthé–‹å§‹ --> BFFèªå¯è¦æ±‚: GET /api/auth/google/authorize
    
    BFFèªå¯è¦æ±‚ --> OAuthèªè¨¼ç”»é¢: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    OAuthèªè¨¼ç”»é¢ --> èªè¨¼å®Œäº†: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª
    
    èªè¨¼å®Œäº† --> ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†: localhost:4200/auth/callback
    ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† --> ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›: POST /api/auth/token
    
    ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ› --> JWTå–å¾—: æˆåŠŸ
    ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ› --> ã‚¨ãƒ©ãƒ¼å‡¦ç†: å¤±æ•—
    
    JWTå–å¾— --> èªè¨¼æ¸ˆç”»é¢: LocalStorageä¿å­˜
    ã‚¨ãƒ©ãƒ¼å‡¦ç† --> æœªèªè¨¼ç”»é¢: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
```

### 1.2 å„æ®µéšã®è©³ç´°åˆ†æ

#### ã‚¹ãƒ†ãƒ¼ã‚¸1: åˆæœŸã‚¢ã‚¯ã‚»ã‚¹ï¼ˆ0-500msï¼‰
**çŠ¶æ…‹**: âš ï¸ **è¦æ³¨æ„**

| é …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çŠ¶æ…‹ | è©•ä¾¡ |
|------|--------|------------|------|
| Viteèµ·å‹•æ™‚é–“ | <2ç§’ | æœªæ¸¬å®š | - |
| åˆæœŸãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º | <500KB | æœªæ¸¬å®š | - |
| HMRæ¥ç¶š | å³åº§ | æ­£å¸¸ | âœ… |
| ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ | æˆåŠŸ | æˆåŠŸ | âœ… |

**åˆ†æ**:
- Viteé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã¯æ­£å¸¸
- ãŸã ã—ã€`pnpm dev`å®Ÿè¡Œæ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼ˆæ¨©é™å•é¡Œã®å¯èƒ½æ€§ï¼‰
- HMRã«ã‚ˆã‚‹é«˜é€Ÿãƒªãƒ­ãƒ¼ãƒ‰ã¯é–‹ç™ºåŠ¹ç‡ã‚’å‘ä¸Š

#### ã‚¹ãƒ†ãƒ¼ã‚¸2: èªè¨¼çŠ¶æ…‹ç¢ºèªï¼ˆ500-1000msï¼‰
**çŠ¶æ…‹**: âŒ **å•é¡Œã‚ã‚Š**

| é …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çŠ¶æ…‹ | è©•ä¾¡ |
|------|--------|------------|------|
| LocalStorageç¢ºèª | <10ms | æ­£å¸¸ | âœ… |
| ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ | å®Ÿè£…æ¸ˆ | æœªå®Ÿè£…ã®å¯èƒ½æ€§ | âŒ |
| æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ | å¿…é ˆ | ä¸æ˜ | âš ï¸ |

**åˆ†æ**:
- JWTãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸æ˜ç¢º
- ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿæ§‹ãŒæœªç¢ºèª
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã§ã®ãƒªã‚¹ã‚¯ãŒå­˜åœ¨

#### ã‚¹ãƒ†ãƒ¼ã‚¸3: OAuthèªè¨¼é–‹å§‹ï¼ˆ1000-2000msï¼‰
**çŠ¶æ…‹**: âš ï¸ **è¦æ”¹å–„**

| é …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çŠ¶æ…‹ | è©•ä¾¡ |
|------|--------|------------|------|
| BFFæ¥ç¶šæ€§ | 100% | æœªç¢ºèª | âš ï¸ |
| CORSè¨­å®š | localhost:4200è¨±å¯ | è¨­å®šå¿…è¦ | âš ï¸ |
| PKCEå®Ÿè£… | å¿…é ˆ | å®Ÿè£…æ¸ˆã¿ | âœ… |
| Stateæ¤œè¨¼ | å¿…é ˆ | å®Ÿè£…æ¸ˆã¿ | âœ… |

**åˆ†æ**:
- BFFã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒç¢ºç«‹ã§ãã¦ã„ãªã„
- CORSãƒãƒªã‚·ãƒ¼ã§localhost:4200ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- PKCEã¨Stateæ¤œè¨¼ã¯é©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ï¼‰

#### ã‚¹ãƒ†ãƒ¼ã‚¸4: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆ2000-3000msï¼‰
**çŠ¶æ…‹**: âŒ **é‡å¤§ãªå•é¡Œ**

| é …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çŠ¶æ…‹ | è©•ä¾¡ |
|------|--------|------------|------|
| ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL | æ­£ç¢º | ä¸ä¸€è‡´ã®å¯èƒ½æ€§ | âŒ |
| ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | å®Œå…¨ | ä¸ååˆ† | âš ï¸ |
| ãƒ­ã‚°è¨˜éŒ² | è©³ç´° | æœ€å°é™ | âš ï¸ |

**åˆ†æ**:
- ä»¥å‰ã®ã‚¨ãƒ©ãƒ¼ï¼ˆ`/hierarchidb/`ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹å•é¡Œï¼‰ãŒè§£æ±ºã•ã‚Œã¦ã„ã‚‹ã‹ä¸æ˜
- ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ãªãƒ­ã‚°ãŒä¸è¶³
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒä¸ååˆ†

## 2. æœ¬ç•ªç’°å¢ƒã®èªè¨¼ãƒ•ãƒ­ãƒ¼åˆ†æ

### 2.1 ãƒ•ãƒ­ãƒ¼å…¨ä½“å›³

```mermaid
stateDiagram-v2
    [*] --> é™çš„ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—: GitHub Pages CDN
    
    é™çš„ãƒ•ã‚¡ã‚¤ãƒ«å–å¾— --> SPAãƒ­ãƒ¼ãƒ‰: index.html
    SPAãƒ­ãƒ¼ãƒ‰ --> ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: #/çµŒç”±
    
    ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° --> èªè¨¼çŠ¶æ…‹ç¢ºèª
    èªè¨¼çŠ¶æ…‹ç¢ºèª --> OAuthé–‹å§‹: æœªèªè¨¼
    
    OAuthé–‹å§‹ --> BFFèªå¯è¦æ±‚: æœ¬ç•ªBFF
    BFFèªå¯è¦æ±‚ --> OAuthç”»é¢: æœ¬ç•ªOAuth
    
    OAuthç”»é¢ --> èªè¨¼å®Œäº†: æ‰¿èª
    èªè¨¼å®Œäº† --> GitHubPagesãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: #/auth/callback
    
    GitHubPagesãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ --> ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›
    ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ› --> æœ¬ç•ªJWTå–å¾—
    
    æœ¬ç•ªJWTå–å¾— --> èªè¨¼æ¸ˆçŠ¶æ…‹: æ°¸ç¶šåŒ–
```

### 2.2 å„æ®µéšã®è©³ç´°åˆ†æ

#### ã‚¹ãƒ†ãƒ¼ã‚¸1: é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ï¼ˆ0-200msï¼‰
**çŠ¶æ…‹**: âœ… **è‰¯å¥½**

| é …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çŠ¶æ…‹ | è©•ä¾¡ |
|------|--------|------------|------|
| CDNå¿œç­”æ™‚é–“ | <100ms | æœŸå¾…é€šã‚Š | âœ… |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ | >90% | é«˜ã„ | âœ… |
| gzipåœ§ç¸® | æœ‰åŠ¹ | æœ‰åŠ¹ | âœ… |

**åˆ†æ**:
- GitHub Pages CDNã¯é«˜é€Ÿã§ä¿¡é ¼æ€§ãŒé«˜ã„
- é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ä¿¡ã¯æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹
- ã‚°ãƒ­ãƒ¼ãƒãƒ«CDNã«ã‚ˆã‚‹ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·

#### ã‚¹ãƒ†ãƒ¼ã‚¸2: SPAãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆ200-500msï¼‰
**çŠ¶æ…‹**: âœ… **è‰¯å¥½**

| é …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çŠ¶æ…‹ | è©•ä¾¡ |
|------|--------|------------|------|
| ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | å¿…é ˆ | å®Ÿè£…æ¸ˆã¿ | âœ… |
| 404å‡¦ç† | é©åˆ‡ | è¨­å®šæ¸ˆã¿ | âœ… |
| ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ | å¯¾å¿œ | å¯¾å¿œ | âœ… |

**åˆ†æ**:
- ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚ŠGitHub Pagesã§ã®å‹•ä½œãŒä¿è¨¼
- SPAã®åˆ¶ç´„ã‚’é©åˆ‡ã«å›é¿
- ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€æ“ä½œã‚‚æ­£å¸¸

#### ã‚¹ãƒ†ãƒ¼ã‚¸3: æœ¬ç•ªOAuthå‡¦ç†ï¼ˆ500-2000msï¼‰
**çŠ¶æ…‹**: âš ï¸ **è¦ç›£è¦–**

| é …ç›® | æœŸå¾…å€¤ | å®Ÿéš›ã®çŠ¶æ…‹ | è©•ä¾¡ |
|------|--------|------------|------|
| SSL/TLS | å¿…é ˆ | æœ‰åŠ¹ | âœ… |
| ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL | æœ¬ç•ªç”¨ | è¦ç¢ºèª | âš ï¸ |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | å¯¾ç­–æ¸ˆã¿ | ä¸æ˜ | âš ï¸ |

**åˆ†æ**:
- HTTPSé€šä¿¡ã¯ä¿è¨¼ã•ã‚Œã¦ã„ã‚‹
- OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å´ã§ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLç™»éŒ²ãŒå¿…è¦
- DDoSå¯¾ç­–ã‚„ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è¨­å®šãŒä¸æ˜

## 3. ç’°å¢ƒé–“ã®å·®ç•°ã¨å•é¡Œç‚¹

### 3.1 ä¸»è¦ãªå·®ç•°

| è¦ç´  | é–‹ç™ºç’°å¢ƒ | æœ¬ç•ªç’°å¢ƒ | å½±éŸ¿åº¦ |
|------|----------|----------|--------|
| **ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°** | Vite Dev Server | GitHub Pages | é«˜ |
| **URLæ§‹é€ ** | localhost:4200 | kubohiroya.github.io/hierarchidb | é«˜ |
| **ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–** | ãªã—ï¼ˆHMRï¼‰ | å®Œå…¨æœ€é©åŒ– | ä¸­ |
| **ã‚¨ãƒ©ãƒ¼è¡¨ç¤º** | è©³ç´° | æœ€å°é™ | ä¸­ |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥** | ç„¡åŠ¹ | ç©æ¥µçš„ | ä½ |
| **BFFã‚µãƒ¼ãƒãƒ¼** | åŒä¸€ï¼ˆeria-cartographï¼‰ | åŒä¸€ï¼ˆeria-cartographï¼‰ | - |

### 3.2 ç‰¹å®šã•ã‚ŒãŸå•é¡Œç‚¹

#### ğŸ”´ é‡å¤§ãªå•é¡Œ

1. **BFFæ¥ç¶šã‚¨ãƒ©ãƒ¼**
   - ç¾è±¡: é–‹ç™ºç’°å¢ƒã§BFFã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒç¢ºç«‹ã§ããªã„
   - åŸå› : CORSãƒãƒªã‚·ãƒ¼ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã€ã¾ãŸã¯èªè¨¼æƒ…å ±ã®ä¸è¶³
   - å½±éŸ¿: èªè¨¼ãƒ•ãƒ­ãƒ¼å…¨ä½“ãŒæ©Ÿèƒ½ã—ãªã„

2. **ç’°å¢ƒå¤‰æ•°ã®æœªè¨­å®š**
   - ç¾è±¡: `.env.secrets`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
   - åŸå› : åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†
   - å½±éŸ¿: OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒæœªå®šç¾©

#### ğŸŸ¡ ä¸­ç¨‹åº¦ã®å•é¡Œ

3. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ¨©é™**
   - ç¾è±¡: `pnpm dev`ãŒæ¨©é™ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—
   - åŸå› : ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œæ¨©é™ä¸è¶³
   - å½±éŸ¿: è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã§ããªã„

4. **ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®ä¸é€æ˜æ€§**
   - ç¾è±¡: JWTã®æœ‰åŠ¹æœŸé™ç®¡ç†ãŒä¸æ˜ç¢º
   - åŸå› : ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸è¶³
   - å½±éŸ¿: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ä¿¡é ¼æ€§ä½ä¸‹

#### ğŸŸ¢ è»½å¾®ãªå•é¡Œ

5. **ãƒ­ã‚°è¨˜éŒ²ã®ä¸è¶³**
   - ç¾è±¡: èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å„æ®µéšã§ã®ãƒ­ã‚°ãŒæœ€å°é™
   - åŸå› : ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã®æœªå®Ÿè£…
   - å½±éŸ¿: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå›°é›£

## 4. ãƒªã‚¹ã‚¯è©•ä¾¡ãƒãƒˆãƒªã‚¯ã‚¹

```mermaid
quadrantChart
    title èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒªã‚¹ã‚¯è©•ä¾¡
    x-axis ä½ç¢ºç‡ --> é«˜ç¢ºç‡
    y-axis ä½å½±éŸ¿ --> é«˜å½±éŸ¿
    quadrant-1 ç·Šæ€¥å¯¾å¿œå¿…è¦
    quadrant-2 ãƒªã‚¹ã‚¯è»½æ¸›è¨ˆç”»
    quadrant-3 ç›£è¦–ç¶™ç¶š
    quadrant-4 å—å®¹å¯èƒ½
    
    BFFæ¥ç¶šä¸å¯: [0.7, 0.9]
    ç’°å¢ƒå¤‰æ•°æœªè¨­å®š: [0.8, 0.8]
    CORSè¨­å®šãƒŸã‚¹: [0.6, 0.7]
    ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ: [0.4, 0.6]
    ãƒ­ã‚°ä¸è¶³: [0.3, 0.3]
    ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œ: [0.2, 0.2]
```

## 5. æ”¹å–„ææ¡ˆ

### 5.1 å³åº§ã«å®Ÿæ–½ã™ã¹ãå¯¾ç­–ï¼ˆPriority 1ï¼‰

#### A. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®å®Œäº†
```bash
# 1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ¨©é™ã®ä»˜ä¸
chmod +x scripts/*.sh scripts/env/*.sh

# 2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
cp app/.env.secrets.example app/.env.secrets
# ã‚¨ãƒ‡ã‚£ã‚¿ã§å®Ÿéš›ã®å€¤ã‚’è¨­å®š

# 3. ä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
rm -rf node_modules pnpm-lock.yaml
pnpm install
```

#### B. BFF CORSè¨­å®šã®ç¢ºèª
```javascript
// wrangler.tomlã¾ãŸã¯BFFã‚³ãƒ¼ãƒ‰ã§è¨­å®š
const corsHeaders = {
  'Access-Control-Allow-Origin': [
    'http://localhost:4200',
    'https://kubohiroya.github.io'
  ],
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization'
};
```

### 5.2 çŸ­æœŸçš„æ”¹å–„ï¼ˆPriority 2ï¼‰

#### C. ãƒ­ã‚°æ©Ÿèƒ½ã®å¼·åŒ–
```typescript
// èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å„æ®µéšã§ãƒ­ã‚°ã‚’è¿½åŠ 
interface AuthLog {
  timestamp: number;
  stage: 'init' | 'check' | 'request' | 'callback' | 'token' | 'complete';
  status: 'success' | 'error' | 'pending';
  details: Record<string, any>;
}

class AuthLogger {
  private logs: AuthLog[] = [];
  
  log(stage: AuthLog['stage'], status: AuthLog['status'], details?: any) {
    const entry: AuthLog = {
      timestamp: Date.now(),
      stage,
      status,
      details: details || {}
    };
    
    this.logs.push(entry);
    
    if (process.env.NODE_ENV === 'development') {
      console.log(`[Auth:${stage}]`, status, details);
    }
  }
  
  export(): string {
    return JSON.stringify(this.logs, null, 2);
  }
}
```

#### D. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
```typescript
// ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
async function handleAuthCallback(code: string, state: string) {
  try {
    // Stateæ¤œè¨¼
    if (!validateState(state)) {
      throw new AuthError('INVALID_STATE', 'State parameter mismatch');
    }
    
    // ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›
    const token = await exchangeCodeForToken(code);
    
    // ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
    if (!validateToken(token)) {
      throw new AuthError('INVALID_TOKEN', 'Token validation failed');
    }
    
    return token;
    
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸå‡¦ç†
    if (error instanceof AuthError) {
      logger.log('callback', 'error', {
        code: error.code,
        message: error.message
      });
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥
      showAuthError(error.code);
    } else {
      // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
      logger.log('callback', 'error', {
        code: 'UNEXPECTED',
        message: error.message
      });
    }
    
    throw error;
  }
}
```

### 5.3 é•·æœŸçš„æ”¹å–„ï¼ˆPriority 3ï¼‰

#### E. çµ±åˆãƒ†ã‚¹ãƒˆã®è‡ªå‹•åŒ–
```yaml
# .github/workflows/auth-test.yml
name: Authentication Flow Tests
on:
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨
  push:
    paths:
      - 'app/src/auth/**'
      - 'packages/ui-auth/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v3
      
      - name: Install dependencies
        run: |
          pnpm install
          npx playwright install --with-deps
      
      - name: Test Development Environment
        run: |
          pnpm dev &
          sleep 5
          npx playwright test e2e/auth-flow.spec.ts --grep development
      
      - name: Test Production Build
        run: |
          pnpm build
          pnpm preview &
          sleep 5
          npx playwright test e2e/auth-flow.spec.ts --grep production
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: auth-test-results
          path: e2e-results/
```

#### F. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```typescript
// èªè¨¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†
interface AuthMetrics {
  totalAttempts: number;
  successRate: number;
  averageTime: number;
  errorsByType: Record<string, number>;
  byProvider: {
    google: { attempts: number; success: number };
    github: { attempts: number; success: number };
  };
}

// Cloudflare Analyticsã¸ã®é€ä¿¡
async function reportMetrics(metrics: AuthMetrics) {
  await fetch('https://analytics.cloudflare.com/beacon', {
    method: 'POST',
    body: JSON.stringify({
      namespace: 'hierarchidb-auth',
      metrics,
      timestamp: Date.now()
    })
  });
}
```

## 6. å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

```mermaid
gantt
    title èªè¨¼ãƒ•ãƒ­ãƒ¼æ”¹å–„ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
    dateFormat YYYY-MM-DD
    section Priority 1
    ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—        :done, p1-1, 2025-08-25, 1d
    CORSè¨­å®šç¢ºèª            :active, p1-2, 2025-08-26, 2d
    
    section Priority 2
    ãƒ­ã‚°æ©Ÿèƒ½å¼·åŒ–            :p2-1, 2025-08-28, 3d
    ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„   :p2-2, 2025-08-31, 3d
    
    section Priority 3
    çµ±åˆãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–        :p3-1, 2025-09-03, 5d
    ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…        :p3-2, 2025-09-08, 5d
```

## 7. æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰

### æŠ€è¡“æŒ‡æ¨™
| æŒ‡æ¨™ | ç¾çŠ¶ | ç›®æ¨™ | æœŸé™ |
|------|------|------|------|
| èªè¨¼æˆåŠŸç‡ | æœªæ¸¬å®š | >95% | 2025-09-30 |
| å¹³å‡èªè¨¼æ™‚é–“ | æœªæ¸¬å®š | <3ç§’ | 2025-09-30 |
| ã‚¨ãƒ©ãƒ¼ç‡ | æœªæ¸¬å®š | <1% | 2025-09-30 |
| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | 0% | >80% | 2025-10-31 |

### ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™
| æŒ‡æ¨™ | ç¾çŠ¶ | ç›®æ¨™ | æœŸé™ |
|------|------|------|------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ | - | 4.5/5 | 2025-12-31 |
| ã‚µãƒãƒ¼ãƒˆãƒã‚±ãƒƒãƒˆæ•° | - | <5/æœˆ | 2025-12-31 |
| é›¢è„±ç‡ | - | <10% | 2025-12-31 |

## 8. çµè«–

ç¾åœ¨ã®2ç’°å¢ƒæ§‹æˆã¯åŸºæœ¬çš„ãªè¨­è¨ˆã¯é©åˆ‡ã§ã™ãŒã€å®Ÿè£…ãƒ¬ãƒ™ãƒ«ã§ã„ãã¤ã‹ã®é‡è¦ãªèª²é¡ŒãŒã‚ã‚Šã¾ã™ï¼š

### âœ… å¼·ã¿
- ç’°å¢ƒæ§‹æˆã®ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã«æˆåŠŸ
- BFFã‚µãƒ¼ãƒãƒ¼ã®çµ±ä¸€ã«ã‚ˆã‚Šä¸€è²«æ€§ç¢ºä¿
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆï¼ˆPKCEã€Stateæ¤œè¨¼ï¼‰ã¯é©åˆ‡

### âŒ å¼±ã¿
- ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæœªå®Œäº†
- BFFæ¥ç¶šæ€§ã®å•é¡Œ
- ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ä¸è¶³

### ğŸ“Š ç·åˆè©•ä¾¡
**ç¾çŠ¶ã‚¹ã‚³ã‚¢: 45/100**
- è¨­è¨ˆ: 80/100
- å®Ÿè£…: 30/100
- é‹ç”¨: 25/100

### ğŸ¯ æ”¹å–„å¾Œã®æœŸå¾…ã‚¹ã‚³ã‚¢
**ç›®æ¨™ã‚¹ã‚³ã‚¢: 85/100**
- è¨­è¨ˆ: 85/100ï¼ˆå¾®èª¿æ•´ï¼‰
- å®Ÿè£…: 85/100ï¼ˆå¤§å¹…æ”¹å–„ï¼‰
- é‹ç”¨: 85/100ï¼ˆè‡ªå‹•åŒ–å°å…¥ï¼‰

å„ªå…ˆåº¦1ã®æ”¹å–„é …ç›®ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã§ã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã¯åŸºæœ¬çš„ã«æ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ãã®å¾Œã€æ®µéšçš„ã«å„ªå…ˆåº¦2ã€3ã®é …ç›®ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã¨ã—ã¦ååˆ†ãªå“è³ªãƒ¬ãƒ™ãƒ«ã«åˆ°é”ã§ãã‚‹ã¨è©•ä¾¡ã—ã¾ã™ã€‚