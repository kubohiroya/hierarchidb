## 5.2 クライアントサイドの構成 (Browser-First Application)

### 5.2.1 API / Worker / UI

クライアントサイドは UI 層・Worker 層・API（通信契約）の3要素で構成されます。役割分担は次のとおりです。

- API: Comlink を介した型安全な関数インターフェイス。UI→Worker の要求（コマンド・購読開始/終了・検索など）と、Worker→UI の通知（差分 publish・Undo/Redo 結果など）を定義する契約面。
- Worker: 実処理の実行主体。CoreDB/EphemeralDB を更新し、購読者へ差分のみを publish。Undo/Redo や購読管理、楽観ロックを担当。
- UI: 画面表示・操作。TreeViewState 等のローカル状態を保持し、API 経由で Worker を制御。購読ノードの差分更新を受け取って描画に反映。

基本フロー（例：ノード編集）
1) UI が API 経由で Worker にコマンドを送信
2) Worker が EphemeralDB に作業コピーを保存し検証→コミットで CoreDB を更新
3) Worker が変更差分のみを購読者（UI）に publish
4) UI が差分を取り込み再描画（必要に応じて即時フィードバック表示）


### 5.2.2 API層

#### 目的
- UI層とWorker層間の通信契約を定義する。
- Comlink経由で呼び出せる型安全な関数インターフェイスを提供。

#### 機能要件
- UI→Workerの要求関数（CRUDコマンド、購読開始/終了、検索など）。
- Worker→UIの通知関数（購読ノード更新、削除通知、Undo/Redo結果など）。
- 引数・戻り値はすべてcoreモジュールの型を利用。

#### 実装上のポイント
- API追加は後方互換を保つ形でのみ行う。
- 破壊的変更が必要な場合はメジャーバージョンアップ。
- 関数名は動詞+目的語の命名（例：`createNode`, `subscribeTree`）。

### 5.2.3 Worker層

#### 目的
- 実際のDB操作・コマンド処理を担当するバックエンド的役割。
- UI層からのAPI呼び出しを順序づけ、CoreDB/EphemeralDBを更新。

#### 機能要件
- コマンドの実行（物理コマンド、論理コマンドの展開）。
- Undo/Redo管理（グローバル一意seq、リングバッファ保持）。
- DB購読の開始/終了管理と差分通知。
- 楽観的ロックによる競合検出。

#### 実装上のポイント
- UI層から直接DB操作は禁止。すべてAPI経由で。
- DB更新後は差分のみを購読者に通知（changed fields最小化）。
- EphemeralDBは短期保存専用でスナップショットや一時データに利用。

### 5.2.4 UI層

#### 目的
- ブラウザ上でのユーザインターフェイスを提供し、操作から API を介した Worker 制御までを担うフロントエンド中核となる。
- クライアントサイド（UI/Worker）の起動・連携を成立させ、表示・操作・差分反映のライフサイクルを確立する。

#### 機能要件
- ブラウザ上でユーザインターフェイスを実現する。
- ユーザーによる操作をもとに、APIを介してWorker層を呼び出す。
- Worker層に対してSubscribeを実行したノードの状態を保持し、差分更新を受け取る。
- Workerを起動し、別スレッドにおいて初期化・実行する。
 
#### 実装上のポイント
- React Routerを用いたルーティングとページ遷移。
- Material UIを用いたコンポーネント設計とスタイル適用。
- TanStack Tableを用いたテーブル表示と操作。
- Comlinkを用いたWorkerとの非同期通信。
- ユーザ操作に対する即時フィードバック（ローディング、エラーメッセージなど）。
