# Plugin Shapes テストケース定義書

## 概要

plugin-shapes機能の実装に必要なテストケースを定義します。要件定義書（REQ-001～007、NFR-001～005）およびEdgeケース（EDGE-001～103）に基づいて網羅的にテストケースを作成しました。

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: hierarchidbフレームワーク全体がTypeScriptで実装されており、型安全性を確保
  - **テストに適した機能**: 型定義による静的検証、async/await対応、デコレータサポート
- **テストフレームワーク**: Vitest
  - **フレームワーク選択の理由**: hierarchidbで採用済み、高速実行、TypeScript完全対応
  - **テスト実行環境**: Node.js環境、jsdom によるDOM環境シミュレーション
- 🟢 この内容の信頼性レベル: package.jsonで確認済み

## 1. 正常系テストケース（基本的な動作）

### 1.1 エンティティCRUD操作

#### TEST-001: Shapesエンティティの新規作成
- **テスト名**: 新規Shapesエンティティ作成の正常動作確認
  - **何をテストするか**: ShapesEntityHandler.createEntity()の基本動作
  - **期待される動作**: 空のGeoJSON FeatureCollectionでエンティティが作成される
- **入力値**: 
  ```typescript
  {
    nodeId: "shapes-001",
    name: "Tokyo Districts",
    description: "東京都の行政区域"
  }
  ```
  - **入力データの意味**: 最小限の必須フィールドのみを指定した基本的なケース
- **期待される結果**:
  ```typescript
  {
    nodeId: "shapes-001",
    name: "Tokyo Districts",
    geojsonData: '{"type":"FeatureCollection","features":[]}',
    layerConfig: { visible: true, opacity: 0.8, zIndex: 1, interactive: true },
    defaultStyle: { polygon: { fillColor: "#3388ff", ... } },
    version: 1
  }
  ```
  - **期待結果の理由**: REQ-001に基づく初期値設定、デフォルトスタイル適用
- **テストの目的**: 基本的なエンティティ作成機能の確認
  - **確認ポイント**: デフォルト値の正確な設定、タイムスタンプの自動付与
- 🟢 このテストケースの信頼性レベル: 要件定義書REQ-001に明記

#### TEST-002: GeoJSONデータのインポート
- **テスト名**: 有効なGeoJSONファイルのインポート成功
  - **何をテストするか**: importGeoJSON()メソッドの正常処理
  - **期待される動作**: RFC 7946準拠のGeoJSONが正しく解析・保存される
- **入力値**:
  ```json
  {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[139.6917, 35.6595], [139.7044, 35.6595], [139.7044, 35.6762], [139.6917, 35.6762], [139.6917, 35.6595]]]
        },
        "properties": { "name": "Shibuya", "population": 230000 }
      }
    ]
  }
  ```
  - **入力データの意味**: 渋谷区の簡略化された境界ポリゴン、実用的なサンプル
- **期待される結果**: 
  - geojsonDataフィールドに正しく保存
  - メタデータ更新（featureCount: 1, totalVertices: 5）
  - updatedAtタイムスタンプ更新
  - **期待結果の理由**: REQ-002の要件を満たすGeoJSON処理
- **テストの目的**: GeoJSONインポート機能の基本動作確認
  - **確認ポイント**: 座標データの正確性、プロパティの保持
- 🟢 このテストケースの信頼性レベル: 要件定義書REQ-002に基づく

#### TEST-003: Working Copy作成と編集
- **テスト名**: Working Copyによる安全な編集機能
  - **何をテストするか**: createWorkingCopy()とcommitWorkingCopy()の連携
  - **期待される動作**: Draft状態での編集が正しくコミットされる
- **入力値**:
  ```typescript
  {
    originalNodeId: "shapes-001",
    changes: {
      name: "Updated Tokyo Districts",
      layerConfig: { opacity: 0.5 }
    }
  }
  ```
  - **入力データの意味**: 既存エンティティの部分的な更新
- **期待される結果**:
  - Working CopyがEphemeralDBに作成
  - isDirtyフラグがtrueに設定
  - コミット後、CoreDBに反映
  - バージョン番号がインクリメント
  - **期待結果の理由**: REQ-005のWorking Copy要件実現
- **テストの目的**: 編集の安全性とトランザクション整合性確認
  - **確認ポイント**: 編集履歴の記録、競合検出メカニズム
- 🟢 このテストケースの信頼性レベル: 要件定義書REQ-005、REQ-201に準拠

### 1.2 スタイル設定

#### TEST-004: デフォルトスタイルの適用
- **テスト名**: 図形タイプ別デフォルトスタイル設定
  - **何をテストするか**: ポリゴン、ライン、ポイントのスタイル設定
  - **期待される動作**: REQ-101に基づくデフォルトスタイル自動適用
- **入力値**:
  ```typescript
  {
    defaultStyle: {
      polygon: { fillColor: "#ff0000", fillOpacity: 0.7 },
      line: { color: "#00ff00", width: 3 },
      point: { radius: 8, fillColor: "#0000ff" }
    }
  }
  ```
  - **入力データの意味**: 各図形タイプの基本的なスタイル設定
- **期待される結果**:
  - 各図形タイプに応じたスタイル適用
  - MapLibre GL JS形式への正しい変換
  - **期待結果の理由**: REQ-004、REQ-101の要件充足
- **テストの目的**: スタイル管理機能の正常動作確認
  - **確認ポイント**: 色値の正確性、透明度の範囲（0.0-1.0）
- 🟢 このテストケースの信頼性レベル: 要件定義書REQ-004に明記

### 1.3 バッチ処理

#### TEST-005: 並行ダウンロード処理の成功
- **テスト名**: 複数URLからの同時データ取得
  - **何をテストするか**: WebWorkerによる並行処理（最大4並行）
  - **期待される動作**: 複数のGeoJSONソースが正しく統合される
- **入力値**:
  ```typescript
  {
    sources: [
      { id: "src1", url: "https://example.com/data1.geojson", format: "geojson" },
      { id: "src2", url: "https://example.com/data2.geojson", format: "geojson" }
    ],
    options: { concurrent: 2, timeout: 30000, retryCount: 3 }
  }
  ```
  - **入力データの意味**: 2つの外部データソースからの並行取得
- **期待される結果**:
  - 両方のデータが正常に取得
  - 進捗通知が適切に送信（0%, 50%, 100%）
  - 統合されたGeoJSONの作成
  - **期待結果の理由**: REQ-501、REQ-102の並行処理要件
- **テストの目的**: WebWorkerバッチ処理の基本動作確認
  - **確認ポイント**: 進捗の正確性、データ統合の整合性
- 🟡 このテストケースの信頼性レベル: 要件から妥当な推測

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 データ検証エラー

#### TEST-101: 不正なGeoJSON形式の検出
- **テスト名**: 無効なGeoJSONインポート時のエラー処理
  - **エラーケースの概要**: RFC 7946に準拠しないGeoJSONの拒否
  - **エラー処理の重要性**: データ整合性の保護、システムクラッシュ防止
- **入力値**:
  ```json
  {
    "type": "InvalidType",
    "features": "not-an-array"
  }
  ```
  - **不正な理由**: typeがFeatureCollectionでない、featuresが配列でない
  - **実際の発生シナリオ**: 手動編集されたファイル、異なる形式のファイル誤選択
- **期待される結果**:
  - エラーコード: `INVALID_GEOJSON`
  - メッセージ: "Invalid GeoJSON: Expected FeatureCollection"
  - 修正提案の提示
  - **エラーメッセージの内容**: ユーザーが問題を理解し修正できる具体的な内容
  - **システムの安全性**: インポート処理が中断され、既存データは保護される
- **テストの目的**: EDGE-001のエラーハンドリング確認
  - **品質保証の観点**: 不正データによるシステム障害の防止
- 🟢 このテストケースの信頼性レベル: EDGE-001に明記

#### TEST-102: ファイルサイズ超過エラー
- **テスト名**: 100MB超のファイルアップロード拒否
  - **エラーケースの概要**: メモリ制限超過の防止
  - **エラー処理の重要性**: システムリソースの保護
- **入力値**: 101MB のGeoJSONファイル
  - **不正な理由**: 設定された最大ファイルサイズ（100MB）を超過
  - **実際の発生シナリオ**: 大規模データセットのインポート試行
- **期待される結果**:
  - エラーコード: `FILE_TOO_LARGE`
  - メッセージ: "ファイルサイズが制限を超えています (最大: 100MB)"
  - **エラーメッセージの内容**: サイズ制限と現在のファイルサイズを明示
  - **システムの安全性**: アップロード前にチェックされ、メモリ消費を防止
- **テストの目的**: リソース制限の適切な実装確認
  - **品質保証の観点**: メモリ不足によるクラッシュ防止
- 🟢 このテストケースの信頼性レベル: 要件定義書に100MB制限明記

### 2.2 WebWorkerエラー

#### TEST-103: Workerクラッシュからの自動復旧
- **テスト名**: WebWorkerクラッシュ時の処理継続
  - **エラーケースの概要**: Worker異常終了時の自動再起動
  - **エラー処理の重要性**: 処理の継続性保証
- **入力値**: バッチ処理中にWorkerを強制終了
  - **不正な理由**: メモリ不足やスクリプトエラーによるWorker停止
  - **実際の発生シナリオ**: 大量データ処理時のメモリオーバーフロー
- **期待される結果**:
  - 新しいWorkerの自動起動
  - 処理状態の復元
  - ユーザーへの通知と処理継続
  - **エラーメッセージの内容**: "処理を再開しています..."
  - **システムの安全性**: データ損失なく処理を継続
- **テストの目的**: EDGE-002の復旧メカニズム確認
  - **品質保証の観点**: 高可用性の実現
- 🟢 このテストケースの信頼性レベル: EDGE-002に明記

#### TEST-104: ネットワークエラーとリトライ
- **テスト名**: ダウンロード失敗時の自動リトライ
  - **エラーケースの概要**: ネットワーク障害時の回復処理
  - **エラー処理の重要性**: 一時的な障害の自動回復
- **入力値**: タイムアウトするURL
  - **不正な理由**: ネットワーク接続の問題
  - **実際の発生シナリオ**: 不安定なネットワーク環境での利用
- **期待される結果**:
  - 最大3回の自動リトライ
  - 指数バックオフによる待機
  - 最終的な失敗時の適切なエラー報告
  - **エラーメッセージの内容**: "ネットワークエラー: 3回の再試行後も接続できませんでした"
  - **システムの安全性**: 他の処理は継続、部分的な成功を保持
- **テストの目的**: REQ-502のリトライメカニズム確認
  - **品質保証の観点**: ネットワーク障害への耐性
- 🟢 このテストケースの信頼性レベル: REQ-502に明記

### 2.3 Working Copy競合

#### TEST-105: 同時編集の競合検出
- **テスト名**: 複数ユーザーの同時編集防止
  - **エラーケースの概要**: Working Copy競合の検出と制御
  - **エラー処理の重要性**: データ整合性の保護
- **入力値**: 同一エンティティへの同時Working Copy作成要求
  - **不正な理由**: 既存のWorking Copyが存在する状態での新規作成
  - **実際の発生シナリオ**: チーム開発での同時編集試行
- **期待される結果**:
  - エラーコード: `WORKING_COPY_CONFLICT`
  - メッセージ: "他のユーザーが編集中です"
  - 読み取り専用アクセスの提供
  - **エラーメッセージの内容**: 編集中のユーザー情報と待機時間の目安
  - **システムの安全性**: データの競合状態を完全に防止
- **テストの目的**: REQ-203の同時編集防止確認
  - **品質保証の観点**: データ整合性の保証
- 🟢 このテストケースの信頼性レベル: REQ-203に明記

## 3. 境界値テストケース（最小値、最大値、null等）

### 3.1 データサイズ境界

#### TEST-201: 最大図形要素数（10,000個）の処理
- **テスト名**: 10,000個の図形要素を含むデータの処理
  - **境界値の意味**: NFR-101で定義されたシステム上限
  - **境界値での動作保証**: パフォーマンス劣化なく処理可能
- **入力値**: 10,000個のポリゴンを含むGeoJSON
  - **境界値選択の根拠**: NFR-101の最大サポート数
  - **実際の使用場面**: 大規模な行政区域データ、詳細な地形データ
- **期待される結果**:
  - 正常にインポート完了
  - 2秒以内の表示（NFR-001）
  - メモリ使用量5MB以内（REQ-404）
  - **境界での正確性**: 全図形が正確に保存・表示される
  - **一貫した動作**: 9,999個と10,000個で動作に差がない
- **テストの目的**: システム限界値での安定動作確認
  - **堅牢性の確認**: 最大負荷でもシステムが安定
- 🟢 このテストケースの信頼性レベル: NFR-101に明記

#### TEST-202: 空のGeoJSON処理
- **テスト名**: features配列が空のGeoJSON処理
  - **境界値の意味**: 最小のデータサイズ
  - **境界値での動作保証**: 空データでもエラーなく処理
- **入力値**:
  ```json
  {
    "type": "FeatureCollection",
    "features": []
  }
  ```
  - **境界値選択の根拠**: 有効な最小のGeoJSON構造
  - **実際の使用場面**: 新規作成時、全データ削除後
- **期待される結果**:
  - 正常に保存
  - メタデータ: featureCount = 0, totalVertices = 0
  - UIで空の状態を適切に表示
  - **境界での正確性**: nullやundefinedではなく空配列として保持
  - **一貫した動作**: 他の操作（エクスポート等）も正常動作
- **テストの目的**: 最小データでの動作確認
  - **堅牢性の確認**: エッジケースでの安定性
- 🟢 このテストケースの信頼性レベル: 基本的なGeoJSON仕様

### 3.2 座標値境界

#### TEST-203: 座標値の有効範囲チェック
- **テスト名**: 経度±180度、緯度±90度の境界値処理
  - **境界値の意味**: WGS84座標系の物理的限界
  - **境界値での動作保証**: 境界値でのクランプ処理
- **入力値**:
  ```json
  {
    "coordinates": [
      [180.0, 90.0],
      [-180.0, -90.0],
      [181.0, 91.0]
    ]
  }
  ```
  - **境界値選択の根拠**: EDGE-101で定義された座標範囲
  - **実際の使用場面**: 極地データ、日付変更線周辺のデータ
- **期待される結果**:
  - 有効範囲内: そのまま保存
  - 範囲外: クランプ処理（181.0→180.0, 91.0→90.0）
  - 警告メッセージの表示
  - **境界での正確性**: 数値精度の保持（小数点6桁）
  - **一貫した動作**: 変換後も図形の位相関係を保持
- **テストの目的**: EDGE-101の境界値処理確認
  - **堅牢性の確認**: 不正な座標値でもシステムクラッシュしない
- 🟢 このテストケースの信頼性レベル: EDGE-101に明記

### 3.3 パフォーマンス境界

#### TEST-204: ベクトルタイル最大ズームレベル（18）
- **テスト名**: ズームレベル18でのタイル生成
  - **境界値の意味**: REQ-405で定義された最大ズームレベル
  - **境界値での動作保証**: 最高解像度でのタイル生成
- **入力値**:
  ```typescript
  {
    minZoom: 0,
    maxZoom: 18,
    tileSize: 512
  }
  ```
  - **境界値選択の根拠**: REQ-405のズームレベル上限
  - **実際の使用場面**: 詳細な建物レベルの地図表示
- **期待される結果**:
  - ズームレベル18のタイル正常生成
  - 適切な図形簡素化の適用
  - メモリ使用量の制限内での処理
  - **境界での正確性**: タイル境界での図形クリッピング正確性
  - **一貫した動作**: ズーム17と18での表示の連続性
- **テストの目的**: REQ-405の最大ズーム対応確認
  - **堅牢性の確認**: 最高解像度でも安定動作
- 🟡 このテストケースの信頼性レベル: REQ-405から妥当な推測

#### TEST-205: null値・undefined値の処理
- **テスト名**: オプショナルフィールドのnull/undefined処理
  - **境界値の意味**: TypeScriptの型システム境界
  - **境界値での動作保証**: 型安全性の保証
- **入力値**:
  ```typescript
  {
    name: "Test",
    description: null,
    dataSource: undefined,
    processingOptions: null
  }
  ```
  - **境界値選択の根拠**: オプショナルフィールドの境界ケース
  - **実際の使用場面**: 部分的なデータ更新、デフォルト値の利用
- **期待される結果**:
  - null/undefinedは適切にスキップ
  - デフォルト値の適用
  - データベースでの正しい保存
  - **境界での正確性**: JSON.stringifyでの適切な処理
  - **一貫した動作**: 読み込み時も同じ状態を維持
- **テストの目的**: 型安全性とデータ整合性確認
  - **堅牢性の確認**: 不完全なデータでも安定動作
- 🟢 このテストケースの信頼性レベル: TypeScript型定義に基づく

## 4. 統合テストケース

### 4.1 BaseMap連携

#### TEST-301: ShapesレイヤーのBaseMap表示
- **テスト名**: BaseMapプラグインとの統合表示
  - **何をテストするか**: レイヤー追加・表示・更新の一連の流れ
  - **期待される動作**: ShapesデータがBaseMap上に正しく表示
- **入力値**: ShapesエンティティとBaseMapエンティティのID
- **期待される結果**:
  - MapLibre GL JSでの正常レンダリング
  - スタイル設定の反映
  - インタラクティブ機能の動作
- **テストの目的**: REQ-202、REQ-403の統合確認
- 🟡 このテストケースの信頼性レベル: 設計書から妥当な推測

### 4.2 E2Eシナリオ

#### TEST-302: 作成から編集、コミットまでの完全フロー
- **テスト名**: ユーザーシナリオ全体の動作確認
  - **何をテストするか**: Create → Edit → Save → Display の完全フロー
  - **期待される動作**: 全ステップがエラーなく完了
- **入力値**: ユーザー操作のシミュレーション
- **期待される結果**:
  - 各ステップでの適切な状態遷移
  - データの永続化
  - UI更新の正確性
- **テストの目的**: システム全体の統合動作確認
- 🟢 このテストケースの信頼性レベル: 基本的なCRUDフロー

## テストケース実装優先度

1. **最優先（Phase 1）**: TEST-001～005（基本CRUD、正常系）
2. **高優先（Phase 2）**: TEST-101～105（エラーハンドリング）
3. **中優先（Phase 3）**: TEST-201～205（境界値）
4. **低優先（Phase 4）**: TEST-301～302（統合テスト）

## 品質メトリクス目標

- **テストカバレッジ**: 80%以上
- **正常系カバー率**: 100%
- **異常系カバー率**: 90%以上
- **境界値カバー率**: 95%以上

## 次のステップ

テストケースの定義が完了しました。次は `/tdd-red` コマンドでRedフェーズ（失敗するテストの実装）を開始します。