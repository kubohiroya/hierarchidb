# 階層的プラグインルーティングシステム - テストケース定義

## 概要

プラグインルーティングシステム（8-plugin-routing-system）のTDDテストケース一覧です。
基盤となる既存実装（`packages/ui-routing/src/plugins/HierarchicalPluginRouter.tsx`）を元に、
包括的なテストカバレッジを提供します。

## 技術構成

- **プログラミング言語**: TypeScript
- **テストフレームワーク**: Vitest
- **テスト実行環境**: Node.js + jsdom（DOM操作が必要な場合）

## 1. 正常系テストケース

### 1.1 階層的URL解析の正常パターン
- **何をテストするか**: `parseHierarchicalUrl`関数が標準的な階層URLを正しく解析できること
- **期待される動作**: URL文字列から各パラメータが正確に抽出されること
- **入力値**: `/t/tree-123/node-456/node-789/basemap/edit`
- **入力データの意味**: 実際のプラグイン編集画面のURLパターンを代表
- **期待される結果**: 
  ```typescript
  {
    treeId: 'tree-123',
    pageTreeNodeId: 'node-456', 
    targetTreeNodeId: 'node-789',
    treeNodeType: 'basemap',
    action: 'edit'
  }
  ```
- **期待結果の理由**: ドキュメント8.2.1で定義された階層パターンに準拠
- **テストの目的**: 基本的なURL解析機能の動作確認
- **確認ポイント**: 各パラメータが正確に分離され、適切な型で返されること
- 🟢 既存実装と要件定義に完全に基づく高信頼性テスト

### 1.2 最小構成URL解析の正常パターン
- **何をテストするか**: 最小限のパラメータ（treeIdのみ）を持つURLの解析
- **期待される動作**: オプションパラメータが未定義として適切に処理されること
- **入力値**: `/t/tree-123`
- **入力データの意味**: 通常のツリー表示（プラグインなし）を代表
- **期待される結果**: `{ treeId: 'tree-123' }`（他のプロパティはundefined）
- **期待結果の理由**: ドキュメント8.2.2の基本使用例に合致
- **テストの目的**: オプションパラメータの正しい処理確認
- **確認ポイント**: 必須パラメータのみで動作し、オプション部分は適切にundefinedになること
- 🟢 既存実装で正常動作確認済みの高信頼性テスト

### 1.3 プラグインコンポーネントの動的ロード成功
- **何をテストするか**: 登録済みプラグインの動的ロードが正常に実行されること
- **期待される動作**: 指定されたプラグインタイプとアクションに対応するコンポーネントが返されること
- **入力値**: `nodeType: 'basemap', action: 'edit'`
- **入力データの意味**: 実際のプラグイン編集機能の呼び出しを代表
- **期待される結果**: 有効なReactコンポーネント（function or object）
- **期待結果の理由**: プラグインレジストリに登録されているアクションは正常ロードされるべき
- **テストの目的**: プラグイン動的ロード機能の動作確認
- **確認ポイント**: コンポーネントの型検証とロード時間の測定
- 🟢 既存のloadPluginComponent実装に基づく高信頼性テスト

### 1.4 階層データ統合処理の成功
- **何をテストするか**: `loadHierarchicalData`による複数データソースの統合
- **期待される動作**: ツリーコンテキスト、ターゲットノード、プラグインデータが統合されること
- **入力値**: 
  ```typescript
  {
    treeId: 'tree-123',
    pageTreeNodeId: 'node-456',
    targetTreeNodeId: 'node-789',
    treeNodeType: 'basemap'
  }
  ```
- **入力データの意味**: 典型的なプラグイン操作時のパラメータセット
- **期待される結果**: `HierarchicalRouteData`構造体で全データが統合された状態
- **期待結果の理由**: useLoaderDataで使用するため全データが一つの構造で提供されるべき
- **テストの目的**: データ統合処理の正確性確認
- **確認ポイント**: 各データソースが正しく統合され、型安全性が保たれること
- 🟢 既存のloadHierarchicalData実装に基づく高信頼性テスト

## 2. 異常系テストケース

### 2.1 無効なURL形式エラーハンドリング
- **エラーケースの概要**: 不正な形式のURLが入力された場合の適切なエラー処理
- **エラー処理の重要性**: URLパラメータの不正入力はセキュリティリスクとなるため
- **入力値**: `/invalid/url/pattern`, `null`, `undefined`, ``（空文字）
- **不正な理由**: 階層URLパターン `/t/:treeId/...` に適合しない
- **実際の発生シナリオ**: ユーザーの手動URL編集、外部リンクからの不正アクセス
- **期待される結果**: `Error('無効な階層URL形式です: ...')`
- **エラーメッセージの内容**: 日本語で分かりやすく、デバッグに有用な情報を含む
- **システムの安全性**: 不正URLでアプリケーションがクラッシュしない
- **テストの目的**: URL入力検証の堅牢性確認
- **品質保証の観点**: 入力値検証がセキュリティホールを防ぐ重要な防御線
- 🟢 既存のparseHierarchicalUrl実装のエラーハンドリングに基づく高信頼性テスト

### 2.2 存在しないプラグインアクセスエラー
- **エラーケースの概要**: 未登録のプラグインタイプへのアクセス時のエラー処理
- **エラー処理の重要性**: 不正なプラグイン呼び出しでシステムが不安定になることを防ぐ
- **入力値**: `nodeType: 'nonexistent-plugin', action: 'edit'`
- **不正な理由**: プラグインレジストリに登録されていない
- **実際の発生シナリオ**: 古いURL、削除されたプラグインへのアクセス、typoによる誤入力
- **期待される結果**: `Error('プラグインが見つかりません: nonexistent-plugin')`
- **エラーメッセージの内容**: プラグイン名を含む具体的なエラー情報
- **システムの安全性**: 404相当のエラーで適切にエラーページに遷移
- **テストの目的**: プラグイン存在確認ロジックの確認
- **品質保証の観点**: ユーザーに明確なエラー情報を提供し、混乱を避ける
- 🟢 既存のloadPluginComponent実装のエラーハンドリングに基づく高信頼性テスト

### 2.3 存在しないアクションへのアクセスエラー
- **エラーケースの概要**: 登録済みプラグインの未定義アクションへのアクセス
- **エラー処理の重要性**: プラグイン内の不正なアクション呼び出しを適切に処理する必要がある
- **入力値**: `nodeType: 'basemap', action: 'nonexistent-action'`
- **不正な理由**: basemapプラグインにはedit/viewアクションのみ存在
- **実際の発生シナリオ**: URL手動編集、古いブックマークからのアクセス
- **期待される結果**: `Error('アクションが見つかりません: basemap:nonexistent-action')`
- **エラーメッセージの内容**: プラグイン名とアクション名を含む詳細情報
- **システムの安全性**: 不正アクションでもアプリケーションが継続動作する
- **テストの目的**: アクション存在確認の確実性検証
- **品質保証の観点**: プラグインの拡張性を保ちつつ安全性を確保
- 🟢 既存のloadPluginComponent実装のエラーハンドリングに基づく高信頼性テスト

### 2.4 データロード失敗時のエラーハンドリング
- **エラーケースの概要**: 外部データソース（データベース、API）からのデータ取得失敗
- **エラー処理の重要性**: ネットワーク障害や一時的な接続問題に対する適切な対応が必要
- **入力値**: `{ treeId: 'nonexistent-tree', pageTreeNodeId: 'node-456' }`
- **不正な理由**: 指定されたツリーIDがデータベースに存在しない
- **実際の発生シナリオ**: データベース障害、削除されたツリーへのアクセス、ネットワーク接続問題
- **期待される結果**: `Error('指定されたツリーが見つかりません')`
- **エラーメッセージの内容**: ユーザーが理解しやすい日本語エラーメッセージ
- **システムの安全性**: データ不整合状態でもアプリケーションが安全に動作する
- **テストの目的**: 外部依存関係のエラーハンドリング確認
- **品質保証の観点**: 一時的な障害に対する適切なユーザー体験の提供
- 🟢 既存のloadHierarchicalData実装のエラーケースに基づく高信頼性テスト

## 3. 境界値テストケース

### 3.1 ルート解決時間パフォーマンス境界値テスト
- **境界値の意味**: 要件定義での「ルート解決時間 < 100ms」SLA基準
- **境界値での動作保証**: 100ms付近での一貫した動作とアラート機能確認
- **入力値**: 複雑なプラグインパラメータで意図的に99ms、101ms前後の処理時間を発生
- **境界値選択の根拠**: ドキュメント8.9.1で明記されたパフォーマンス要件
- **実際の使用場面**: 複雑なプラグインや大量データ処理時の応答性確保
- **期待される結果**: 99ms以下では警告なし、101ms以上で警告ログ出力
- **境界での正確性**: 時間測定の精度とアラート閾値の正確性
- **一貫した動作**: 同じ条件で実行した場合の測定値の安定性
- **テストの目的**: パフォーマンス監視機能の精度確認
- **堅牢性の確認**: 高負荷時でも要件を満たす応答性が保たれるか
- 🟢 既存のresolveRoute実装のパフォーマンス測定機能に基づく高信頼性テスト

### 3.2 URL長制限境界値テスト
- **境界値の意味**: ブラウザURL長制限（一般的に2048文字）に対する堅牢性
- **境界値での動作保証**: 極端に長いURLでもシステムが安定動作すること
- **入力値**: 2047文字、2048文字、2049文字のURL文字列
- **境界値選択の根拠**: ブラウザ標準の実用的制限値
- **実際の使用場面**: 深い階層構造や長いID文字列を持つプロジェクト
- **期待される結果**: 2048文字以下では正常処理、超過時は適切なエラー
- **境界での正確性**: 正確なバイト数計算と一貫したエラーハンドリング
- **一貫した動作**: 異なるブラウザでも同様の動作保証
- **テストの目的**: 実用的制限値での安定性確認
- **堅牢性の確認**: 極端な入力条件下でのシステム安定性
- 🟡 実装されていない制限だが、ブラウザ制限に基づく合理的な推測

### 3.3 プラグインレジストリ容量境界値テスト
- **境界値の意味**: 登録可能なプラグイン数の上限における動作確認
- **境界値での動作保証**: 大量のプラグイン登録時でもパフォーマンスが劣化しないこと
- **入力値**: 0個、1個、100個、1000個のプラグインを登録
- **境界値選択の根拠**: 実用的なプラグイン数の想定範囲
- **実際の使用場面**: 大規模なプラグインエコシステムでの運用
- **期待される結果**: 全ての範囲で線形的なパフォーマンス特性
- **境界での正確性**: プラグイン検索速度がO(1)で一定であること
- **一貫した動作**: プラグイン数に関係なく同じAPI動作
- **テストの目的**: スケーラビリティの確認
- **堅牢性の確認**: エンタープライズ環境での実用性確保
- 🟡 Map実装に基づく推測だが、スケーラビリティは実証が必要

### 3.4 階層パラメータnull/undefined境界値テスト
- **境界値の意味**: オプションパラメータの境界状態での型安全性確認
- **境界値での動作保証**: null/undefinedが混在してもTypeScriptの型推論が正しく動作すること
- **入力値**: `{ treeId: 'tree-123', pageTreeNodeId: null, targetTreeNodeId: undefined }`
- **境界値選択の根拠**: TypeScriptのstrictNullChecksモードでの動作保証
- **実際の使用場面**: 部分的なURLパラメータを持つ画面遷移
- **期待される結果**: 型エラーなく処理され、適切なデフォルト値が設定される
- **境界での正確性**: null/undefinedの区別とデフォルト値処理
- **一貫した動作**: 同様の条件で常に同じ結果が得られること
- **テストの目的**: 型安全性と実行時安全性の両立確認
- **堅牢性の確認**: JavaScriptの型変換による予期しない動作の防止
- 🟢 既存の型定義とオプションパラメータ実装に基づく高信頼性テスト

## テストの実装指針

### 共通セットアップ

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { HierarchicalPluginRouter, PluginRegistry, parseHierarchicalUrl } from '@hierarchidb/ui-routing';

beforeEach(() => {
  // 【テスト前準備】: 各テスト実行前にプラグインレジストリをクリーンな状態に初期化
  // 【環境初期化】: 前のテストの影響を排除し、一貫したテスト環境を提供
  PluginRegistry.clear();
});

afterEach(() => {
  // 【テスト後処理】: 各テスト実行後にリソースをクリーンアップ
  // 【状態復元】: 次のテストに影響しないよう状態を復元する
});
```

### テストケース実装時の日本語コメント例

```typescript
describe('階層的URL解析', () => {
  it('正常な階層URLを正しく解析できること', () => {
    // 【テスト目的】: parseHierarchicalUrl関数の基本的なURL解析機能を確認
    // 【テスト内容】: 標準的な階層URLパターンを入力して各パラメータが正確に抽出されることを検証
    // 【期待される動作】: 入力URLから treeId, pageTreeNodeId, targetTreeNodeId, treeNodeType, action が正しく分離される
    // 🟢 既存実装と要件定義に完全に基づく高信頼性テスト

    // 【テストデータ準備】: 実際のプラグイン編集画面のURLパターンを模擬
    // 【初期条件設定】: バリッドなURL形式を準備
    const testUrl = '/t/tree-123/node-456/node-789/basemap/edit';

    // 【実際の処理実行】: parseHierarchicalUrl関数を呼び出してURL解析を実行
    // 【処理内容】: URL文字列を階層パラメータオブジェクトに変換
    const result = parseHierarchicalUrl(testUrl);

    // 【結果検証】: 各パラメータが期待値と一致することを確認
    // 【期待値確認】: ドキュメント8.2.1で定義された階層パターンに準拠した結果
    expect(result.treeId).toBe('tree-123'); // 【確認内容】: ツリーIDが正確に抽出されること
    expect(result.pageTreeNodeId).toBe('node-456'); // 【確認内容】: ページノードIDが正確に抽出されること  
    expect(result.targetTreeNodeId).toBe('node-789'); // 【確認内容】: ターゲットノードIDが正確に抽出されること
    expect(result.treeNodeType).toBe('basemap'); // 【確認内容】: プラグインタイプが正確に抽出されること
    expect(result.action).toBe('edit'); // 【確認内容】: アクション名が正確に抽出されること
    // 🟢 全ての検証項目が既存実装に基づく高信頼性テスト
  });
});
```

## 品質保証

このテストケース定義は以下の品質基準を満たしています：

### ✅ 高品質基準達成
- **網羅性**: 正常系4件、異常系4件、境界値4件で主要機能をカバー
- **明確性**: 各テストケースの目的、入力、期待結果が具体的に定義
- **実装可能性**: 既存実装（HierarchicalPluginRouter.tsx）をベースとした現実的なテスト
- **保守性**: TypeScript型定義との整合性とVitest標準パターンの採用

### 信頼性レベル分布
- 🟢 高信頼性テスト: 10件（既存実装・要件定義ベース）
- 🟡 中信頼性テスト: 2件（合理的推測ベース）
- 🔴 低信頼性テスト: 0件

### 品質向上のための次ステップ
1. 🟡レベルのテストケースについて実装詳細の確認
2. 統合テストによる実際のReact Router環境での動作確認
3. パフォーマンステストの実測値による閾値調整

---

**作成日**: 2025年1月14日  
**対象システム**: 階層的プラグインルーティングシステム  
**実装ベース**: `packages/ui-routing/src/plugins/HierarchicalPluginRouter.tsx`