# 5.d UI 層

本章では UI モジュール群の分割方針、各モジュールの責務・代表機能、app モジュールとの結線、UI ガイドラインをまとめる。

## 5.d.1 分割方針（機能別モジュール化）
- 必要な機能のみを選択導入してバンドルを最適化。
- 共通コンポーネントとテーマは ui-core に集中、周辺機能は分離。

## 5.d.2 モジュール一覧

### ui-core
- 目的: 基本 UI、MUI ベースのコンポーネント、テーマ、通知。
- 含まれるもの: Button/Menu/Sidebar/Loading/ErrorBoundary、テーマ(/theme)、アイコン(/icons)、ユーティリティ(/utils)。

### ui-auth
- 目的: OAuth2/OIDC 認証 UI。
- 含まれるもの: AuthPanel/AuthProvider/AuthErrorBoundary、hooks（useAuthBFF/useAuthGoogle/useAuthOIDC など）。

### ui-routing
- 目的: React Router に基づくルーティング/ナビゲーション。
- 含まれるもの: ルート設定、NavLinkMenu/LinkButton 等。

### ui-i18n
- 目的: 国際化（i18next 設定/言語切替/検出/HTTP バックエンド）。
- 含まれるもの: LanguageProvider、i18next, react-i18next, i18next-browser-languagedetector, i18next-http-backend。

### ui-client
- 目的: Worker/API と UI を接続するクライアント層（Comlink、購読管理）。
- 機能: 接続ライフサイクル、React フック（useTreeQuery/useTreeMutation/useSubscription 等）、エラー/再試行/キャンセル制御。

### ui-layout
- 目的: AppShell/Sidebar/Header などレイアウトプリミティブ、レスポンシブ。

### ui-navigation
- 目的: メニュー/パンくず/リンク群。ui-routing と連携。

### ui-file
- 目的: ファイル入出力、外部 URL/ファイルのバリデーション、インポート/エクスポート UI。
- 含まれるもの: validation ユーティリティ、ドラッグ&ドロップ。

### ui-monitoring
- 目的: ログ/エラーレポート/簡易メトリクス収集。診断用ウィジェット。

### ui-tour
- 目的: 初回ガイド/ツアー。ステップ定義、強調表示、スキップ/再開。

## 5.d.3 app モジュール
- 役割: ルートエントリとして UI/worker/api/core と各 ui-* の初期化と結線を行う。
- 初期化順序: core → api → worker/ui → 拡張。
- 単一エントリーポイント（例: `entry.client.tsx`）。

## 5.d.4 UI ガイドライン（詳細）
- 制御/非制御を混在させない。フォームは react-hook-form 等で統一。
- アクセシビリティ確保（ラベル/ロール/キーボード操作）。
- 大量行は仮想化（Virtualizer）。
- CSS-in-JS は最小限。テーマトークンを利用し直値を避ける。
- エラーハンドリングは UI 層で一箇所に集約。ログに機微情報を残さない。
- i18n: 文言は辞書化（直書き禁止）。Intl API で日時/数値フォーマット。
- パフォーマンス: 計測ポイントを用意、useMemo/useCallback 適切運用、不要な Deep copy 回避。

## 5.d.5 ルーティングと購読の関係
- URL 例 `/t/:treeId/:pageTreeNodeId` により、ページ単位で部分木購読を行う。
- 同一ツリーを複数タブで同時購読可能。変更はリアルタイムで反映。

関連: 5-architecture.md, 5.c-api-worker.md（購読/フックの呼出し経路）。