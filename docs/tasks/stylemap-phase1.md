# StyleMap Plugin Phase 1: 基盤構築

## フェーズ概要

- **期間**: 1ヶ月 (20営業日)
- **目標**: StyleMapプラグイン基盤とデータ構造の完成
- **成果物**: プラグイン定義、エンティティ、データベース、基本ハンドラー
- **担当**: 開発チーム
- **前提条件**: TASK-0001〜0060 (Plugin Architecture) 完了済み

## 週次計画

### Week 1: データ構造・エンティティ設計
- **目標**: StyleMap関連データ構造の完成
- **成果物**: エンティティ定義、型システム

### Week 2: プラグイン定義・データベース設計  
- **目標**: プラグイン統合とデータベース基盤
- **成果物**: UnifiedPluginDefinition、データベーススキーマ

### Week 3: EntityHandler・Working Copy実装
- **目標**: データ操作とWorking Copy機能
- **成果物**: CRUD操作、編集パターン実装

### Week 4: 基盤テスト・調整
- **目標**: 基盤コードの品質確保
- **成果物**: 単体テスト、統合テスト

## 日次タスク

### Week 1: データ構造・エンティティ設計

#### Day 1 (TASK-0061): StyleMapEntity型定義

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-004 🟢
- **依存タスク**: TASK-0002 (BaseEntity型定義)
- **実装詳細**:
  - StyleMapEntity インターフェース定義
  - PrimaryResourceEntity継承
  - cacheKey, downloadUrl, filename フィールド
  - tableMetadataId, keyColumn, valueColumn
  - filterRules, styleMapConfig
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] TypeScript strict mode でエラーなし
  - [ ] BaseEntity継承が正しく動作
  - [ ] eria-cartograph実装との互換性確保
- **注意事項**: 🟢 eria-cartographの実装を正確に移植すること

#### Day 2 (TASK-0062): StyleMapConfig型定義

- [ ] **タスク完了**
- **推定工数**: 6時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-003, REQ-301, REQ-302 🟢
- **依存タスク**: TASK-0061
- **実装詳細**:
  - StyleMapConfig インターフェース定義
  - algorithm: "linear" | "logarithmic" | "quantile" | "categorical"
  - colorSpace: "rgb" | "hsv"
  - mapping設定 (min, max, hue, saturation, brightness)
  - targetProperty: MapLibreStyleProperty
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 全アルゴリズム種別がサポートされる
  - [ ] HSV/RGB色空間が正しく定義される
  - [ ] MapLibreStylePropertyとの連携確認
- **注意事項**: 🟢 eria-cartograph実装との完全互換性

#### Day 3 (TASK-0063): FilterRule・TableMetadata型定義

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-104, REQ-303 🟢
- **依存タスク**: TASK-0062
- **実装詳細**:
  - FilterRule インターフェース定義
  - action: "Include" | "Exclude" | "IncludePattern" | "ExcludePattern"
  - keyColumn, matchValue フィールド
  - TableMetadataEntity定義
  - RowEntity定義 (テーブルデータ格納)
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 4種類のフィルタアクションが定義される
  - [ ] 正規表現フィルタリング対応
  - [ ] テーブル構造の正規化設計
- **注意事項**: 🟢 eria-cartographパターン踏襲

#### Day 4 (TASK-0064): StyleMapWorkingCopy型定義

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-007 🟢
- **依存タスク**: TASK-0063
- **実装詳細**:
  - StyleMapWorkingCopy インターフェース定義
  - BaseWorkingCopy継承
  - 全StyleMapEntityフィールド + Working Copy制御
  - workingCopyId, workingCopyOf, copiedAt, isDirty
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] BaseWorkingCopyとの継承関係確立
  - [ ] hierarchidb Working Copyパターン準拠
  - [ ] 変更追跡機能が正しく動作
- **注意事項**: 🟡 hierarchidb固有のWorking Copy実装

#### Day 5 (TASK-0065): MapLibreStyleProperty型統合

- [ ] **タスク完了**
- **推定工数**: 6時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-005 🟢
- **依存タスク**: TASK-0064
- **実装詳細**:
  - MapLibreStyleProperty列挙型定義
  - Fill Properties: fill-color, fill-opacity, fill-outline-color
  - Line Properties: line-color, line-opacity, line-width
  - Circle Properties: circle-color, circle-radius, circle-stroke-*
  - プロパティ種別による値型制約
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 全対象プロパティが定義される
  - [ ] 型安全なプロパティ選択が可能
  - [ ] MapLibre GL v3.x互換性確保
- **注意事項**: 🟢 要件定義の互換性マトリックス準拠

### Week 2: プラグイン定義・データベース設計

#### Day 6 (TASK-0066): StyleMapDatabase実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-401, TECH-005 🟢
- **依存タスク**: TASK-0065, TASK-0031 (Dexie設定)
- **実装詳細**:
  - StyleMapDatabase クラス (Dexie継承)
  - テーブル定義: entities, workingCopies, tableMetadata, rows
  - インデックス設計: nodeId, cacheKey, tableMetadataId
  - バージョン管理・マイグレーション
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 全テーブルが正しく作成される
  - [ ] インデックスによる高速検索が可能
  - [ ] Singleton + Worker Instance対応
- **注意事項**: 🟢 BaseMapDatabaseパターンを参考実装

#### Day 7 (TASK-0067): データベーススキーマ最適化

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: TECH-004, TECH-006 🟡
- **依存タスク**: TASK-0066
- **実装詳細**:
  - 複合インデックス設計 (cacheKey + updatedAt)
  - 外部キー関係の最適化 (nodeId → tableMetadataId)
  - データ正規化による重複排除
  - パフォーマンス検証
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 大容量データでの高速クエリ実現
  - [ ] データ正規化による効率化
  - [ ] 外部キー制約による整合性確保
- **注意事項**: 🟡 パフォーマンス要件 (NFR-001) を考慮

#### Day 8 (TASK-0068): UnifiedPluginDefinition実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-501, REQ-502, REQ-503, REQ-504 🟢
- **依存タスク**: TASK-0067, TASK-0004 (UnifiedPluginDefinition型)
- **実装詳細**:
  - StyleMapUnifiedDefinition作成
  - nodeType: 'stylemap', displayName: 'Style Map'
  - database設定 (dbName, tableName, schema, version)
  - entityHandler設定 (後で実装)
  - ui設定 (dialogComponent, panelComponent等)
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] UnifiedPluginDefinitionに完全準拠
  - [ ] hierarchidbプラグインシステム統合
  - [ ] 設定値の妥当性確認
- **注意事項**: 🟢 BaseMapUnifiedDefinitionを参考

#### Day 9 (TASK-0069): ライフサイクルフック定義

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-503 🟢
- **依存タスク**: TASK-0068, TASK-0012 (ライフサイクルフック型)
- **実装詳細**:
  - StyleMapライフサイクルフック実装
  - beforeCreate: ファイルサイズ・形式検証
  - afterCreate: キャッシュキー生成
  - beforeUpdate: 変更内容検証
  - afterUpdate: プレビュー更新通知
  - beforeDelete/afterDelete: リソースクリーンアップ
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 全ライフサイクルフックが実装される
  - [ ] フック間の依存関係が正しい
  - [ ] エラー時の適切な処理
- **注意事項**: 🟢 BaseMapライフサイクルを参考実装

#### Day 10 (TASK-0070): バリデーションルール実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-102, REQ-403, REQ-404, REQ-405 🟢
- **依存タスク**: TASK-0069
- **実装詳細**:
  - CustomValidatorルール実装
  - validFileFormat: CSV/TSV形式検証
  - validColorMapping: カラーマッピング範囲検証
  - validFilterRules: フィルタルール妥当性
  - TypeScript strict mode準拠検証
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 不正ファイル形式を適切に検出
  - [ ] カラーマッピング設定の妥当性確認
  - [ ] TypeScript strict mode完全準拠
- **注意事項**: 🟢 eria-cartograph検証ロジック移植

### Week 3: EntityHandler・Working Copy実装

#### Day 11 (TASK-0071): StyleMapEntityHandler基本実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-502 🟢
- **依存タスク**: TASK-0070, TASK-0005 (EntityHandler型)
- **実装詳細**:
  - StyleMapEntityHandler クラス実装
  - EntityHandler インターフェース準拠
  - StyleMapDatabase インスタンス管理
  - 基本的なCRUD操作の骨格
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] EntityHandler継承が正しく動作
  - [ ] データベースとの接続確立
  - [ ] 基本的なエラー処理実装
- **注意事項**: 🟢 BaseMapHandlerパターン参考

#### Day 12 (TASK-0072): Create・Read操作実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-001, REQ-004 🟢
- **依存タスク**: TASK-0071
- **実装詳細**:
  - createEntity メソッド実装
  - getEntity メソッド実装  
  - デフォルト値設定 (ファイル名、作成日時等)
  - エンティティ整合性確保
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 正常なエンティティ作成が可能
  - [ ] 作成されたエンティティが取得可能
  - [ ] 適切なデフォルト値が設定される
- **注意事項**: 🟢 eria-cartograph作成ロジック参考

#### Day 13 (TASK-0073): Update・Delete操作実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-004 🟢
- **依存タスク**: TASK-0072
- **実装詳細**:
  - updateEntity メソッド実装
  - deleteEntity メソッド実装
  - バージョン管理 (updatedAt, version自動更新)
  - カスケード削除 (tableMetadata, rows)
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 正常なエンティティ更新が可能
  - [ ] 関連データの適切な削除
  - [ ] バージョン情報の自動更新
- **注意事項**: 🟢 関連テーブルとの整合性確保

#### Day 14 (TASK-0074): Working Copy管理実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-007 🟢
- **依存タスク**: TASK-0073, TASK-0019 (ワーキングコピー管理)
- **実装詳細**:
  - createWorkingCopy メソッド実装
  - commitWorkingCopy メソッド実装
  - discardWorkingCopy メソッド実装
  - isDirty フラグ管理
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] Working Copyの安全な作成・編集・保存
  - [ ] 変更検知機能の正常動作
  - [ ] hierarchidb Working Copyパターン準拠
- **注意事項**: 🟡 hierarchidb固有のWorking Copy実装

#### Day 15 (TASK-0075): 特殊操作実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-502 🟢
- **依存タスク**: TASK-0074
- **実装詳細**:
  - duplicate メソッド実装 (StyleMap複製)
  - backup メソッド実装 (エンティティバックアップ)
  - restore メソッド実装 (バックアップ復元)
  - cleanup メソッド実装 (リソース解放)
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 完全なエンティティ複製が可能
  - [ ] バックアップ・復元の整合性確保
  - [ ] リソースの適切な解放
- **注意事項**: 🟢 BaseMapHandler特殊操作参考

### Week 4: 基盤テスト・調整

#### Day 16 (TASK-0076): EntityHandler単体テスト完成

- [ ] **タスク完了**  
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: 品質基準 90%テストカバレッジ 🟡
- **依存タスク**: TASK-0075
- **実装詳細**:
  - 全CRUDメソッドの単体テスト
  - Working Copy操作の単体テスト
  - エラーケース・例外処理テスト
  - テストカバレッジ 90%以上達成
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] テストカバレッジ 90%以上
  - [ ] 全メソッドが正常動作
  - [ ] エラー処理の妥当性確認
- **注意事項**: 🟡 高い品質基準の達成

#### Day 17 (TASK-0077): プラグイン統合テスト

- [ ] **タスク完了**
- **推定工数**: 8時間  
- **タスクタイプ**: TDD
- **要件リンク**: REQ-501, REQ-504 🟢
- **依存タスク**: TASK-0076
- **実装詳細**:
  - NodeTypeRegistry統合テスト
  - プラグイン登録・取得テスト
  - ライフサイクルフック統合テスト
  - エラー伝播・処理テスト
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] プラグインの完全な統合動作
  - [ ] ライフサイクルフックの適切な実行
  - [ ] システム全体との整合性確保
- **注意事項**: 🟢 hierarchidbプラグインシステム準拠

#### Day 18 (TASK-0078): データベース統合テスト

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD  
- **要件リンク**: TECH-006, NFR-001 🟡
- **依存タスク**: TASK-0077
- **実装詳細**:
  - 大容量データでのパフォーマンステスト
  - トランザクション整合性テスト
  - 同時アクセス・競合状態テスト
  - メモリ使用量監視テスト
- **テスト要件**:
  - [ ] 型定義の整合性テスト
  - [ ] 必須フィールド検証
  - [ ] インデックス署名対応テスト
- **エラーハンドリング要件**:
  - [ ] 不正な型データの検出・例外処理
  - [ ] 必須フィールド欠如時の適切なエラーメッセージ
  - [ ] 型変換失敗時の回復処理
- **完了条件**:
  - [ ] 大容量データでの安定動作
  - [ ] 同時アクセスでの整合性確保
  - [ ] メモリ使用量の適切な管理
- **注意事項**: 🟡 パフォーマンス要件 (5秒以内処理)

#### Day 19 (TASK-0079): 基盤コード品質確保

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件リンク**: REQ-403, REQ-404, REQ-405 🟢
- **依存タスク**: TASK-0078
- **実装詳細**:
  - ESLint・Prettier設定確認
  - TypeScript strict mode完全準拠
  - any型・非null断言の完全排除
  - コードレビュー・リファクタリング
- **完了条件**:
  - [ ] ESLint・Prettierでエラーなし
  - [ ] TypeScript strict mode準拠
  - [ ] any型・非null断言使用なし
  - [ ] コード品質の統一確保
- **注意事項**: 🟢 hierarchidb開発ガイドライン準拠

#### Day 20 (TASK-0080): Phase 1統合確認・ドキュメント

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件リンク**: 全Phase 1要件 🟢
- **依存タスク**: TASK-0079
- **実装詳細**:
  - 全タスク完了確認・チェックリスト
  - API仕様書更新 (EntityHandler, Plugin)
  - 実装ドキュメント作成
  - Phase 2への引き継ぎ資料作成
- **完了条件**:
  - [ ] 全Phase 1タスクが完了
  - [ ] API仕様書が最新状態
  - [ ] 実装ドキュメントが整備
  - [ ] Phase 2開始準備完了
- **注意事項**: 🟢 完全な基盤確立の確認

## フェーズ完了基準

- [ ] 全タスクが完了している (20/20)
- [ ] StyleMapプラグイン基盤が動作する  
- [ ] EntityHandlerのCRUD操作が完全に動作
- [ ] Working Copy機能が正常に動作
- [ ] プラグインがNodeTypeRegistryに正しく統合
- [ ] 基盤コードのテストカバレッジが90%以上
- [ ] TypeScript strict mode完全準拠
- [ ] データベース設計が最適化済み

## 次フェーズへの引き継ぎ事項

### 🟢 完成した基盤機能
- StyleMapEntity・関連型の完全定義
- StyleMapEntityHandler (CRUD・Working Copy)
- StyleMapDatabaseスキーマ・インデックス
- UnifiedPluginDefinition統合
- ライフサイクルフック・バリデーション

### 🟡 Phase 2で実装予定
- CSV/TSVファイル処理ロジック
- カラーマッピングアルゴリズム
- フィルタリング機能
- ハッシュキャッシュシステム

### 📋 注意点
- eria-cartographパターンとの整合性維持
- hierarchidb固有のWorking Copy機能活用
- パフォーマンス要件への継続的配慮

## 振り返り

### 計画との差異
- {実装後に記録}

### 学習事項  
- {技術的な学習事項を記録}

### 改善点
- {Phase 2で改善すべき点を記録}