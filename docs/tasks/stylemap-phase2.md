# StyleMap Plugin Phase 2: コア機能

## フェーズ概要

- **期間**: 1ヶ月 (20営業日)
- **目標**: CSV処理とカラーマッピング機能の完成
- **成果物**: ファイル処理、カラーマッピング、フィルタリング、キャッシュ機能
- **担当**: 開発チーム
- **前提条件**: Phase 1 (TASK-0061〜0080) 完了済み

## 週次計画

### Week 1: ファイル処理・パース機能
- **目標**: CSV/TSVファイルの読み込み・解析
- **成果物**: ファイルパーサー、テーブルデータ変換

### Week 2: カラーマッピングアルゴリズム
- **目標**: 色空間・マッピングアルゴリズム実装
- **成果物**: HSV/RGB変換、線形・対数・分位数・カテゴリアルゴリズム

### Week 3: フィルタリング・キャッシュ機能
- **目標**: データフィルタとキャッシュシステム
- **成果物**: 動的フィルタリング、SHA3ハッシュキャッシュ

### Week 4: Worker API・統合テスト
- **目標**: Worker層統合とパフォーマンス最適化
- **成果物**: Comlink RPC、統合テスト、性能チューニング

## 日次タスク

### Week 1: ファイル処理・パース機能

#### Day 21 (TASK-0081): CSV/TSVパーサー基本実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-001, TECH-001 🟢
- **依存タスク**: TASK-0080 (Phase 1完了)
- **実装詳細**:
  - CSV/TSVパーサークラス実装
  - RFC 4180準拠のCSVパース
  - タブ区切り (TSV) 対応
  - エンコーディング自動検出 (UTF-8優先)
  - ヘッダー行・データ行の分離
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 標準的なCSV/TSVファイルが正しく解析される
  - [ ] RFC 4180の引用符・エスケープ処理対応
  - [ ] UTF-8エンコーディングの適切な処理
- **注意事項**: 🟢 eria-cartographパーサーロジック移植

#### Day 22 (TASK-0082): ファイル読み込み・バリデーション

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-102, EDGE-001, EDGE-101, EDGE-102 🟢
- **依存タスク**: TASK-0081
- **実装詳細**:
  - ファイル読み込みサービス実装
  - ファイル形式検証 (CSV/TSV以外拒否)
  - ファイルサイズ制限 (100MB上限) 🟡
  - 空ファイル・1列のみファイル処理
  - 文字エンコーディングエラー処理
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 不正形式ファイルを適切に拒否
  - [ ] ファイルサイズ制限の実装
  - [ ] エラーメッセージの適切な表示
- **注意事項**: 🟡 ファイルサイズ制限は推測補完要件

#### Day 23 (TASK-0083): テーブルデータ変換・正規化

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-002, TECH-005 🟢
- **依存タスク**: TASK-0082
- **実装詳細**:
  - パース結果からRowEntity配列生成
  - TableMetadataEntity作成 (カラム情報)
  - データ型推論 (string, number, date)
  - 重複データ排除・正規化
  - インデックス用フィールド生成
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] CSVデータが正しくRowEntityに変換
  - [ ] カラム情報がTableMetadataに格納
  - [ ] データ重複の適切な排除
- **注意事項**: 🟢 eria-cartographテーブル変換ロジック参考

#### Day 24 (TASK-0084): SHA3ハッシュ・キャッシュキー生成

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-006, TECH-002 🟢
- **依存タスク**: TASK-0083
- **実装詳細**:
  - SHA3-256ハッシュライブラリ統合
  - ファイルコンテンツからキャッシュキー生成
  - キャッシュキーの一意性確保
  - キャッシュAPI統合準備
  - ハッシュ計算の非同期実行
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 同一ファイルから同一ハッシュ生成
  - [ ] 異なるファイルから異なるハッシュ生成
  - [ ] 高速なハッシュ計算実現
- **注意事項**: 🟢 仕様書通りSHA3-256使用

#### Day 25 (TASK-0085): ファイル処理統合・パフォーマンス調整

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: NFR-001 🟡
- **依存タスク**: TASK-0084
- **実装詳細**:
  - ファイル処理フロー統合
  - メモリ効率的なストリーミング処理
  - 大容量ファイル対応 (チャンク処理)
  - プログレス表示機能
  - エラー回復・リトライ機能
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 10万行CSV 5秒以内処理 🟡
  - [ ] メモリ使用量 100MB以内
  - [ ] プログレス表示の実装
- **注意事項**: 🟡 パフォーマンス要件の達成

### Week 2: カラーマッピングアルゴリズム

#### Day 26 (TASK-0086): HSV・RGB色空間変換

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-302 🟢
- **依存タスク**: TASK-0085
- **実装詳細**:
  - HSVColorクラス実装 (hue, saturation, value)
  - RGBColorクラス実装 (red, green, blue)
  - HSV ↔ RGB相互変換アルゴリズム
  - カラー値の正規化・検証
  - カラー文字列生成 (#RRGGBB形式)
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 色空間変換の数学的正確性
  - [ ] カラー値の範囲検証
  - [ ] MapLibre GL対応色文字列生成
- **注意事項**: 🟢 eria-cartograph色空間変換ロジック移植

#### Day 27 (TASK-0087): 線形・対数アルゴリズム実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-301 🟢
- **依存タスク**: TASK-0086
- **実装詳細**:
  - LinearMappingアルゴリズム実装
  - LogarithmicMappingアルゴリズム実装
  - 数値データの正規化 (min-max scaling)
  - 色相範囲での線形補間
  - 対数スケールでの色相マッピング
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 線形マッピングの数学的正確性
  - [ ] 対数マッピングの適切なスケーリング
  - [ ] 境界値での安定動作
- **注意事項**: 🟢 数学的アルゴリズムの正確な実装

#### Day 28 (TASK-0088): 分位数・カテゴリアルゴリズム実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-301 🟢
- **依存タスク**: TASK-0087
- **実装詳細**:
  - QuantileMappingアルゴリズム実装
  - CategoricalMappingアルゴリズム実装
  - パーセンタイル計算・ソート処理
  - カテゴリ値の自動検出・色割り当て
  - 統計的分布に基づく色相配分
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 分位数に基づく適切な色分け
  - [ ] カテゴリ値の自動検出・配色
  - [ ] 統計的に妥当な色相配分
- **注意事項**: 🟢 統計処理の数学的正確性確保

#### Day 29 (TASK-0089): MapLibreスタイルプロパティ生成

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-005 🟢
- **依存タスク**: TASK-0088
- **実装詳細**:
  - MapLibreスタイルプロパティ生成器
  - データ駆動スタイリング式生成
  - Expression形式でのマッピングルール
  - Fill/Line/Circle各プロパティ対応
  - 条件分岐スタイリング対応
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 正しいMapLibreスタイル生成
  - [ ] データ駆動式の適切な構文
  - [ ] 全対象プロパティの対応
- **注意事項**: 🟢 MapLibre GL v3.x互換性確保

#### Day 30 (TASK-0090): カラーマッピング統合・最適化

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-105, NFR-002 🟡
- **依存タスク**: TASK-0089
- **実装詳細**:
  - カラーマッピングサービス統合
  - アルゴリズム動的選択機能
  - プレビュー高速生成 (500ms以内) 🟡
  - キャッシュ機能によるマッピング高速化
  - メモリ効率的な色計算
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 4つのアルゴリズムが統合動作
  - [ ] 500ms以内のプレビュー更新 🟡
  - [ ] 効率的なメモリ使用
- **注意事項**: 🟡 パフォーマンス要件への配慮

### Week 3: フィルタリング・キャッシュ機能

#### Day 31 (TASK-0091): フィルタルール処理エンジン

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-104, REQ-303 🟢
- **依存タスク**: TASK-0090
- **実装詳細**:
  - FilterRuleProcessor実装
  - Include/Exclude基本フィルタ
  - Pattern系フィルタ (正規表現)
  - フィルタチェーン実行
  - パフォーマンス最適化
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 4種類のフィルタアクションが動作
  - [ ] 正規表現による柔軟なフィルタリング
  - [ ] 複数フィルタの適切な組み合わせ
- **注意事項**: 🟢 eria-cartographフィルタロジック移植

#### Day 32 (TASK-0092): 動的フィルタリング・リアルタイム更新

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-104, REQ-105 🟢
- **依存タスク**: TASK-0091
- **実装詳細**:
  - リアルタイムフィルタリング機能
  - フィルタ変更時の自動再計算
  - デバウンス機能 (300ms) 🟡
  - フィルタ結果のキャッシュ
  - UI更新通知システム
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] フィルタ変更時の即座な反映
  - [ ] デバウンスによるパフォーマンス最適化
  - [ ] キャッシュによる高速化
- **注意事項**: 🟡 UI応答性の確保

#### Day 33 (TASK-0093): キャッシュシステム実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-103, REQ-006, TECH-003 🟢
- **依存タスク**: TASK-0092
- **実装詳細**:
  - StyleMapCacheService実装
  - SHA3ハッシュベースキャッシュ
  - キャッシュ有効期限管理 (24時間) 🟡
  - LRU (Least Recently Used) キャッシュ
  - キャッシュサイズ制限・自動削除
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 同一ハッシュでのキャッシュ再利用
  - [ ] 24時間有効期限の適切な管理
  - [ ] メモリ制限内でのキャッシュ運用
- **注意事項**: 🟡 キャッシュ有効期限は設計要件

#### Day 34 (TASK-0094): データ同期・整合性確保

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-002, TECH-005 🟢
- **依存タスク**: TASK-0093
- **実装詳細**:
  - StyleMapEntity・TableMetadata・Row間同期
  - 外部キー制約による整合性確保
  - トランザクション境界の適切な設定
  - データ不整合検出・修復機能
  - 同時更新競合解決
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 関連データの完全同期
  - [ ] トランザクション境界の適切な設定
  - [ ] データ不整合の自動検出・修復
- **注意事項**: 🟢 データ正規化設計の活用

#### Day 35 (TASK-0095): コア機能統合テスト

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: 全Phase 2要件 🟢
- **依存タスク**: TASK-0094
- **実装詳細**:
  - エンドツーエンドコア機能テスト
  - CSV読み込み → カラーマッピング → スタイル生成
  - フィルタリング → リアルタイム更新
  - キャッシュ → 高速再読み込み
  - パフォーマンス総合テスト
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 全コア機能の連携動作確認
  - [ ] パフォーマンス要件達成確認
  - [ ] エラー処理の適切な連携
- **注意事項**: 🟢 Phase 2機能の完全統合確認

### Week 4: Worker API・統合テスト

#### Day 36 (TASK-0096): Worker API拡張実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-505, REQ-506 🟢
- **依存タスク**: TASK-0095, TASK-0026 (WorkerAPIRegistry)
- **実装詳細**:
  - StyleMapWorkerAPI実装
  - processFileUpload メソッド
  - generateColorMapping メソッド
  - applyFilters メソッド
  - getStyleMapPreview メソッド
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 全Worker APIメソッドが動作
  - [ ] Comlink経由での正常通信
  - [ ] エラーの適切な伝播
- **注意事項**: 🟢 Comlink RPCシリアライゼーション対応

#### Day 37 (TASK-0097): Client API拡張実装

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: REQ-506 🟢
- **依存タスク**: TASK-0096
- **実装詳細**:
  - StyleMapClientAPI実装
  - uploadFile クライアントメソッド
  - updateColorMapping クライアントメソッド
  - toggleFilter クライアントメソッド
  - 型安全なAPI呼び出し
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 全Client APIメソッドが動作
  - [ ] TypeScript型安全性確保
  - [ ] UI層からの適切な呼び出し
- **注意事項**: 🟢 hierarchidb API拡張パターン準拠

#### Day 38 (TASK-0098): 非同期処理・エラーハンドリング

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: EDGE-003, EDGE-004 🟡
- **依存タスク**: TASK-0097
- **実装詳細**:
  - 非同期処理のタイムアウト管理
  - Workerプロセス異常終了時の回復
  - ネットワーク切断時の処理
  - プログレス通知システム
  - 段階的なエラー回復
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] タイムアウトの適切な処理
  - [ ] Worker異常時の自動回復
  - [ ] ネットワークエラーの適切な処理
- **注意事項**: 🟡 推測補完要件・可用性の確保

#### Day 39 (TASK-0099): パフォーマンス最適化・メモリ管理

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件リンク**: NFR-001, NFR-003 🟡
- **依存タスク**: TASK-0098
- **実装詳細**:
  - メモリプール・オブジェクト再利用
  - ガベージコレクション最適化
  - ストリーミング処理による省メモリ化
  - 並列処理によるCPU活用
  - パフォーマンス監視・プロファイリング
- **テスト要件**:
  - [ ] RFC 4180準拠テスト
  - [ ] TSVファイルパーステスト
  - [ ] エンコーディングテスト
- **エラーハンドリング要件**:
  - [ ] 不正フォーマットファイルの適切な拒否
  - [ ] エンコーディングエラー時の回復処理
  - [ ] メモリ不足時の段階的処理
- **完了条件**:
  - [ ] 10万行CSV 5秒以内処理達成
  - [ ] メモリ使用量100MB以内
  - [ ] キャッシュによるリロード50%短縮
- **注意事項**: 🟡 非機能要件の達成確認

#### Day 40 (TASK-0100): Phase 2統合確認・品質保証

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件リンク**: 全Phase 2要件 🟢
- **依存タスク**: TASK-0099
- **実装詳細**:
  - 全タスク完了確認・チェックリスト
  - テストカバレッジ90%以上確認
  - パフォーマンス要件達成確認
  - コード品質・セキュリティ監査
  - Phase 3への引き継ぎ資料作成
- **完了条件**:
  - [ ] 全Phase 2タスクが完了
  - [ ] テストカバレッジ90%以上達成
  - [ ] パフォーマンス要件全達成
  - [ ] コード品質基準クリア
  - [ ] Phase 3開始準備完了
- **注意事項**: 🟢 完全なコア機能完成の確認

## フェーズ完了基準

- [ ] 全タスクが完了している (20/20)
- [ ] CSV/TSVファイル処理が完全に動作
- [ ] 4つのカラーマッピングアルゴリズムが動作
- [ ] フィルタリング・リアルタイム更新が動作
- [ ] SHA3ハッシュキャッシュシステムが動作
- [ ] Worker・Client API拡張が統合済み
- [ ] パフォーマンス要件 (10万行5秒以内) を達成
- [ ] テストカバレッジが90%以上
- [ ] メモリ使用量が適切に管理されている

## 次フェーズへの引き継ぎ事項

### 🟢 完成したコア機能
- CSV/TSVファイルパーサー・変換機能
- カラーマッピング4アルゴリズム実装
- HSV/RGB色空間変換システム
- 動的フィルタリング機能
- SHA3ハッシュキャッシュシステム
- Worker・Client API拡張

### 🟡 Phase 3で実装予定
- React UIコンポーネント
- ステップ式ダイアログ
- リアルタイムプレビュー画面
- ユーザー操作インターフェース

### 📋 注意点
- パフォーマンス要件の継続的な維持
- メモリ使用量の監視継続
- UI応答性の確保

## 振り返り

### 計画との差異
- {実装後に記録}

### 学習事項
- {技術的な学習事項を記録}

### 改善点
- {Phase 3で改善すべき点を記録}