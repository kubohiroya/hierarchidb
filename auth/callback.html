<!doctype html>
<html>
  <head>
    <title>Authentication Callback</title>
    <meta charset="utf-8" />
    <script>
      console.log('[auth-callback] Processing OAuth callback from BFF');

      // Helper function to extract app path from current URL
      function getAppPath() {
        const currentPath = window.location.pathname;
        // Remove /auth/callback.html from the path
        return currentPath.replace(/\/auth\/callback\.html$/, '');
      }

      // Helper function to build the SPA redirect URL
      function buildSPACallbackUrl(appPath, search, hash) {
        const baseUrl = window.location.origin;
        // Redirect to the React Router auth/callback route
        return `${baseUrl}${appPath}/auth/callback${search}${hash}`;
      }

      // Apply theme based on stored preference or system preference
      (function applyTheme() {
        try {
          // Wait for document.body to be available
          if (!document.body) {
            // If body is not ready, wait and try again
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', applyTheme);
              return;
            }
            console.warn('[auth-callback] document.body is null, skipping theme application');
            return;
          }

          // Check for stored theme preference
          const storedTheme = localStorage.getItem('app-theme-mode');

          if (storedTheme === 'dark') {
            document.body.classList.add('theme-dark');
          } else if (storedTheme === 'light') {
            document.body.classList.remove('theme-dark');
          } else if (storedTheme === 'system' || !storedTheme) {
            // Use system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              document.body.classList.add('theme-dark');
            }
          }
        } catch (error) {
          console.log('[auth-callback] Theme application failed:', error);
        }
      })();

      // Process the OAuth callback
      (function () {
        try {
          console.log('[auth-callback] Current URL:', window.location.href);

          // Get OAuth parameters from URL
          const currentSearch = window.location.search;
          const currentHash = window.location.hash;
          const appPath = getAppPath();

          // Check for OAuth errors
          const urlParams = new URLSearchParams(currentSearch);
          const error = urlParams.get('error');

          if (error) {
            console.error('[auth-callback] OAuth error:', error);
            const errorDescription = urlParams.get('error_description') || 'Authentication failed';
            console.error('[auth-callback] Error description:', errorDescription);
          }

          // Check if we're already at the SPA callback route to prevent loops
          // But if we're in callback.html, we should always redirect to the SPA route
          const currentPath = window.location.pathname;
          const isStaticCallback = currentPath.endsWith('/callback.html');
          const isSPACallback =
            currentPath.endsWith('/auth/callback') && !currentPath.endsWith('.html');

          if (isSPACallback && !isStaticCallback) {
            console.log('[auth-callback] Already at SPA callback route, skipping redirect');
            return;
          }

          console.log('[auth-callback] In static callback, proceeding to redirect to SPA route');

          // Add a flag to prevent redirect loops
          const redirectKey = 'auth_callback_redirect_' + Date.now();
          if (sessionStorage.getItem(redirectKey)) {
            console.log('[auth-callback] Redirect loop detected, skipping');
            return;
          }
          sessionStorage.setItem(redirectKey, 'true');
          // Clean up after a short delay
          setTimeout(() => sessionStorage.removeItem(redirectKey), 5000);

          // Build the SPA callback URL
          const spaCallbackUrl = buildSPACallbackUrl(appPath, currentSearch, currentHash);

          console.log('[auth-callback] App path detected:', appPath);
          console.log('[auth-callback] Redirecting to SPA callback:', spaCallbackUrl);

          // For GitHub Pages, we need to ensure we're using the correct routing
          // If hash routing is enabled, redirect to hash-based route
          const useHashRouter = window.location.hash.includes('#/');
          if (useHashRouter) {
            const hashCallbackUrl = `${window.location.origin}${appPath}/#/auth/callback${currentSearch}`;
            console.log('[auth-callback] Using hash router, redirecting to:', hashCallbackUrl);
            window.location.replace(hashCallbackUrl);
          } else {
            // Redirect to the React app's auth callback route
            window.location.replace(spaCallbackUrl);
          }
        } catch (error) {
          console.error('[auth-callback] Error during OAuth processing:', error);

          // Fallback: redirect to main app root
          const appPath = getAppPath();
          const baseUrl = window.location.origin;
          const fallbackUrl = `${baseUrl}${appPath}/`;
          console.log('[auth-callback] Fallback redirect to:', fallbackUrl);
          window.location.replace(fallbackUrl);
        }
      })();
    </script>
    <style>
      :root {
        --bg-light: #fafafa;
        --bg-dark: #121212;
        --text-light: rgba(0, 0, 0, 0.87);
        --text-dark: rgba(255, 255, 255, 0.87);
        --container-bg-light: white;
        --container-bg-dark: #1e1e1e;
        --spinner-track-light: #f3f3f3;
        --spinner-track-dark: #333333;
        --spinner-color: #3498db;
      }

      /* Light theme (default) */
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background-color: var(--bg-light);
        color: var(--text-light);
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      .container {
        text-align: center;
        padding: 2rem;
        background: var(--container-bg-light);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition:
          background-color 0.3s ease,
          box-shadow 0.3s ease;
      }

      .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--spinner-track-light);
        border-top: 4px solid var(--spinner-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
        transition: border-color 0.3s ease;
      }

      /* Dark theme */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: var(--bg-dark);
          color: var(--text-dark);
        }

        .container {
          background: var(--container-bg-dark);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .spinner {
          border: 4px solid var(--spinner-track-dark);
          border-top: 4px solid var(--spinner-color);
        }
      }

      /* Check for stored theme preference */
      body.theme-dark {
        background-color: var(--bg-dark);
        color: var(--text-dark);
      }

      body.theme-dark .container {
        background: var(--container-bg-dark);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      body.theme-dark .spinner {
        border: 4px solid var(--spinner-track-dark);
        border-top: 4px solid var(--spinner-color);
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <h2>Completing authentication...</h2>
      <p>Please wait while we process your login.</p>
    </div>
  </body>
</html>
