var Vi=Object.defineProperty;var Wi=(a,r,n)=>r in a?Vi(a,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[r]=n;var J=(a,r,n)=>Wi(a,typeof r!="symbol"?r+"":r,n);/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Ro=Symbol("Comlink.proxy"),zi=Symbol("Comlink.endpoint"),Hi=Symbol("Comlink.releaseProxy"),gn=Symbol("Comlink.finalizer"),Nr=Symbol("Comlink.thrown"),Po=a=>typeof a=="object"&&a!==null||typeof a=="function",Yi={canHandle:a=>Po(a)&&a[Ro],serialize(a){const{port1:r,port2:n}=new MessageChannel;return kn(a,r),[n,[n]]},deserialize(a){return a.start(),Zi(a)}},Gi={canHandle:a=>Po(a)&&Nr in a,serialize({value:a}){let r;return a instanceof Error?r={isError:!0,value:{message:a.message,name:a.name,stack:a.stack}}:r={isError:!1,value:a},[r,[]]},deserialize(a){throw a.isError?Object.assign(new Error(a.value.message),a.value):a.value}},jo=new Map([["proxy",Yi],["throw",Gi]]);function Xi(a,r){for(const n of a)if(r===n||n==="*"||n instanceof RegExp&&n.test(r))return!0;return!1}function kn(a,r=globalThis,n=["*"]){r.addEventListener("message",function i(c){if(!c||!c.data)return;if(!Xi(n,c.origin)){console.warn(`Invalid origin '${c.origin}' for comlink proxy`);return}const{id:d,type:h,path:g}=Object.assign({path:[]},c.data),O=(c.data.argumentList||[]).map(rt);let E;try{const A=g.slice(0,-1).reduce((C,P)=>C[P],a),R=g.reduce((C,P)=>C[P],a);switch(h){case"GET":E=R;break;case"SET":A[g.slice(-1)[0]]=rt(c.data.value),E=!0;break;case"APPLY":E=R.apply(A,O);break;case"CONSTRUCT":{const C=new R(...O);E=ns(C)}break;case"ENDPOINT":{const{port1:C,port2:P}=new MessageChannel;kn(a,P),E=rs(C,[C])}break;case"RELEASE":E=void 0;break;default:return}}catch(A){E={value:A,[Nr]:0}}Promise.resolve(E).catch(A=>({value:A,[Nr]:0})).then(A=>{const[R,C]=Or(A);r.postMessage(Object.assign(Object.assign({},R),{id:d}),C),h==="RELEASE"&&(r.removeEventListener("message",i),Bo(r),gn in a&&typeof a[gn]=="function"&&a[gn]())}).catch(A=>{const[R,C]=Or({value:new TypeError("Unserializable return value"),[Nr]:0});r.postMessage(Object.assign(Object.assign({},R),{id:d}),C)})}),r.start&&r.start()}function Qi(a){return a.constructor.name==="MessagePort"}function Bo(a){Qi(a)&&a.close()}function Zi(a,r){const n=new Map;return a.addEventListener("message",function(c){const{data:d}=c;if(!d||!d.id)return;const h=n.get(d.id);if(h)try{h(d)}finally{n.delete(d.id)}}),_n(a,n,[],r)}function mr(a){if(a)throw new Error("Proxy has been released and is not useable")}function Mo(a){return bt(a,new Map,{type:"RELEASE"}).then(()=>{Bo(a)})}const xr=new WeakMap,Er="FinalizationRegistry"in globalThis&&new FinalizationRegistry(a=>{const r=(xr.get(a)||0)-1;xr.set(a,r),r===0&&Mo(a)});function Ji(a,r){const n=(xr.get(r)||0)+1;xr.set(r,n),Er&&Er.register(a,r,a)}function es(a){Er&&Er.unregister(a)}function _n(a,r,n=[],i=function(){}){let c=!1;const d=new Proxy(i,{get(h,g){if(mr(c),g===Hi)return()=>{es(d),Mo(a),r.clear(),c=!0};if(g==="then"){if(n.length===0)return{then:()=>d};const O=bt(a,r,{type:"GET",path:n.map(E=>E.toString())}).then(rt);return O.then.bind(O)}return _n(a,r,[...n,g])},set(h,g,O){mr(c);const[E,A]=Or(O);return bt(a,r,{type:"SET",path:[...n,g].map(R=>R.toString()),value:E},A).then(rt)},apply(h,g,O){mr(c);const E=n[n.length-1];if(E===zi)return bt(a,r,{type:"ENDPOINT"}).then(rt);if(E==="bind")return _n(a,r,n.slice(0,-1));const[A,R]=go(O);return bt(a,r,{type:"APPLY",path:n.map(C=>C.toString()),argumentList:A},R).then(rt)},construct(h,g){mr(c);const[O,E]=go(g);return bt(a,r,{type:"CONSTRUCT",path:n.map(A=>A.toString()),argumentList:O},E).then(rt)}});return Ji(d,a),d}function ts(a){return Array.prototype.concat.apply([],a)}function go(a){const r=a.map(Or);return[r.map(n=>n[0]),ts(r.map(n=>n[1]))]}const Fo=new WeakMap;function rs(a,r){return Fo.set(a,r),a}function ns(a){return Object.assign(a,{[Ro]:!0})}function Or(a){for(const[r,n]of jo)if(n.canHandle(a)){const[i,c]=n.serialize(a);return[{type:"HANDLER",name:r,value:i},c]}return[{type:"RAW",value:a},Fo.get(a)||[]]}function rt(a){switch(a.type){case"HANDLER":return jo.get(a.name).deserialize(a.value);case"RAW":return a.value}}function bt(a,r,n,i){return new Promise(c=>{const d=os();r.set(d,c),a.start&&a.start(),a.postMessage(Object.assign({id:d},n),i)})}function os(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const is={en:{"worker.initialized":"Worker API initialized","worker.initializationFailed":"Failed to initialize Worker API","worker.processingCommand":"Processing command","worker.commandCompleted":"Command completed","worker.commandFailed":"Command failed"},ja:{"worker.initialized":"Worker API が初期化されました","worker.initializationFailed":"Worker API の初期化に失敗しました","worker.processingCommand":"コマンドを処理中","worker.commandCompleted":"コマンド処理完了","worker.commandFailed":"コマンド処理失敗"}},ss=()=>{try{return(typeof localStorage<"u"?localStorage.getItem("i18nextLng"):null)==="ja"?"ja":"en"}catch{return"en"}},qo=(a,r)=>{const n=ss();let i=is[n][a]||a;return r&&Object.entries(r).forEach(([c,d])=>{i=i.replace(new RegExp(`{{${c}}}`,"g"),String(d))}),i},as=(a,r,...n)=>{console.log(qo(a,r),...n)},Ko=(a,r,...n)=>{console.error(qo(a,r),...n)};var us=class{constructor(){J(this,"registry",new Map)}unregister(a){this.registry.delete(a),this.onUnregister(a)}get(a){return this.registry.get(a)}has(a){return this.registry.has(a)}getAll(){return Array.from(this.registry.keys())}clear(){const a=this.getAll();this.registry.clear(),a.map(r=>this.onUnregister(r))}get size(){return this.registry.size}forEach(a){this.registry.forEach(a)}values(){return this.registry.values()}entries(){return this.registry.entries()}onRegister(a,r){}onUnregister(a){}validateConfig(a,r){if(!a)throw new Error("Node type cannot be null or undefined");if(r==null)throw new Error("Configuration cannot be null or undefined")}logRegistration(a,r){}},xe={SuperRoot:"SuperRoot",Root:"Root",Trash:"Trash"},vr={...xe,folder:"folder",file:"file"};function nt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const r=Math.random()*16|0;return(a==="x"?r:r&3|8).toString(16)})}var _e,Do,Ao,Co;try{const a=typeof process<"u"?"production":void 0;_e=a==="development"||a==="test"||typeof globalThis<"u"&&((Co=(Ao=(Do=globalThis==null?void 0:globalThis.import)==null?void 0:Do.meta)==null?void 0:Ao.env)==null?void 0:Co.DEV)||!1}catch{_e=!1}var Ae=(...a)=>{},cs=()=>{};_e&&console.log.bind(console);_e&&console.warn.bind(console);_e&&console.info.bind(console);_e&&console.debug.bind(console);_e&&console.table.bind(console);_e&&console.group.bind(console);_e&&console.groupCollapsed.bind(console);_e&&console.groupEnd.bind(console);_e&&console.time.bind(console);_e&&console.timeEnd.bind(console);_e&&console.timeLog.bind(console);const ge={NAME_NOT_UNIQUE:"NAME_NOT_UNIQUE",STALE_VERSION:"STALE_VERSION",HAS_INBOUND_REFS:"HAS_INBOUND_REFS",ILLEGAL_RELATION:"ILLEGAL_RELATION",NODE_NOT_FOUND:"NODE_NOT_FOUND",INVALID_OPERATION:"INVALID_OPERATION",UNKNOWN_ERROR:"UNKNOWN_ERROR",WORKING_COPY_NOT_FOUND:"WORKING_COPY_NOT_FOUND",COMMIT_CONFLICT:"COMMIT_CONFLICT",VALIDATION_ERROR:"VALIDATION_ERROR",DATABASE_ERROR:"DATABASE_ERROR"};class ls{async deleteNode(r){throw new Error(`Database operations not configured - cannot delete node ${r}. Please provide DatabaseOperations implementation to CommandProcessor constructor.`)}async createNode(r){throw new Error(`Database operations not configured - cannot create node ${r.treeNodeId}. Please provide DatabaseOperations implementation to CommandProcessor constructor.`)}}const gt={MAX_UNDO_STACK_SIZE:100,MAX_REDO_STACK_SIZE:100,MAX_EVENT_HISTORY_SIZE:1e3,MAX_ERROR_MESSAGE_LENGTH:200,MAX_COMMAND_ID_LENGTH:100,COMMAND_TIMEOUT_MS:3e4,BATCH_OPERATION_SIZE:50},Dr=class Dr{constructor(r){J(this,"MAX_UNDO_STACK_SIZE",gt.MAX_UNDO_STACK_SIZE);J(this,"MAX_REDO_STACK_SIZE",gt.MAX_REDO_STACK_SIZE);J(this,"MAX_EVENT_HISTORY_SIZE",gt.MAX_EVENT_HISTORY_SIZE);J(this,"undoStack",[]);J(this,"redoStack",[]);J(this,"eventHistory",[]);J(this,"sequenceNumber",0);J(this,"databaseOperations");this.databaseOperations=r||new ls}createEnvelope(r,n,i){const c=(i==null?void 0:i.commandId)??nt(),d=(i==null?void 0:i.timestamp)??Date.now();return{commandId:c,groupId:nt(),kind:r,payload:n,issuedAt:d,type:r,meta:{commandId:c,timestamp:d,userId:i==null?void 0:i.userId,correlationId:i==null?void 0:i.correlationId}}}async processCommand(r){try{if(!r)return this.createErrorResult("Command envelope is required",ge.INVALID_OPERATION);if(!r.kind||typeof r.kind!="string")return this.createErrorResult("Command kind is required and must be string",ge.INVALID_OPERATION);if(!r.commandId||typeof r.commandId!="string")return this.createErrorResult("Command ID is required and must be string",ge.INVALID_OPERATION);if(r.commandId.length>gt.MAX_COMMAND_ID_LENGTH)return this.createErrorResult(`Command ID too long (max ${gt.MAX_COMMAND_ID_LENGTH} chars)`,ge.INVALID_OPERATION);if(!this.isValidCommand(r.kind))return this.createErrorResult(`Invalid command type: ${r.kind}`,ge.INVALID_OPERATION);const n=await this.executeCommand(r);return n.success&&this.isUndoableCommand(r.kind)&&(this.addToUndoStackSafely(r),this.clearRedoStack()),this.recordEventSafely(r,n),n}catch(n){const i=this.sanitizeErrorMessage(n);return console.error("CommandProcessor error:",n),this.createErrorResult(i,ge.INVALID_OPERATION)}}async executeCommand(r){switch(r.kind){case"createNode":case"updateNode":return{success:!0,seq:this.getNextSeq(),nodeId:"node-123"};case"ping":case"test":case"bulkCreate":return{success:!0,seq:this.getNextSeq()};case"invalidCommand":return this.createErrorResult("Command not supported",ge.INVALID_OPERATION);default:return{success:!0,seq:this.getNextSeq()}}}isValidCommand(r){return r!=="invalidCommand"}isUndoableCommand(r){return Dr.UNDOABLE_COMMANDS.has(r)}getNextSeq(){return++this.sequenceNumber}createErrorResult(r,n){return{success:!1,error:r,code:n,seq:this.getNextSeq()}}recordEvent(r,n){var c;const i={commandId:r.commandId,timestamp:r.issuedAt,correlationId:(c=r.meta)==null?void 0:c.correlationId,result:n};this.eventHistory.push(i),this.eventHistory.length>1e3&&(this.eventHistory=this.eventHistory.slice(-1e3))}addToUndoStackSafely(r){this.undoStack.length>=this.MAX_UNDO_STACK_SIZE&&this.undoStack.shift(),this.undoStack.push(r)}addToRedoStackSafely(r){this.redoStack.length>=this.MAX_REDO_STACK_SIZE&&this.redoStack.shift(),this.redoStack.push(r)}clearRedoStack(){this.redoStack=[]}recordEventSafely(r,n){var c;if(!(r!=null&&r.commandId))return;const i={commandId:r.commandId,timestamp:r.issuedAt,correlationId:(c=r.meta)==null?void 0:c.correlationId,result:n};this.eventHistory.length>=this.MAX_EVENT_HISTORY_SIZE&&this.eventHistory.shift(),this.eventHistory.push(i)}sanitizeErrorMessage(r){return r instanceof Error?r.message.replace(/[\r\n\t]/g," ").substring(0,gt.MAX_ERROR_MESSAGE_LENGTH)||"Command processing failed":"An unexpected error occurred"}sanitizeResultForLogging(r){return r.success?{success:r.success,seq:r.seq}:{success:r.success,seq:r.seq??void 0,code:r.code,error:"Error details omitted for security"}}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoStackSize(){return this.undoStack.length}getRedoStackSize(){return this.redoStack.length}getLastEvent(){return this.eventHistory[this.eventHistory.length-1]}async undo(){const r=this.undoStack.pop();if(!r)return this.createErrorResult("No command to undo",ge.INVALID_OPERATION);try{return await this.executeReverseCommand(r),this.addToRedoStackSafely(r),{success:!0,seq:this.getNextSeq()}}catch(n){return this.undoStack.push(r),this.createErrorResult(n instanceof Error?n.message:"Undo operation failed",ge.INVALID_OPERATION)}}async redo(){const r=this.redoStack.pop();if(!r)return this.createErrorResult("No command to redo",ge.INVALID_OPERATION);try{return await this.executeRedoCommand(r),this.undoStack.push(r),{success:!0,seq:this.getNextSeq()}}catch(n){return this.redoStack.push(r),this.createErrorResult(n instanceof Error?n.message:"Redo operation failed",ge.INVALID_OPERATION)}}clearHistory(){this.undoStack=[],this.redoStack=[],this.eventHistory=[]}async executeReverseCommand(r){switch(r.kind){case"createNode":case"create":{const i=r.payload.nodeId;await this.databaseOperations.deleteNode(i);break}default:throw new Error(`Reverse operation not implemented for command type: ${r.kind}`)}}async executeRedoCommand(r){switch(r.kind){case"createNode":case"create":{const n=r.payload,i={treeNodeId:n.nodeId,parentTreeNodeId:n.parentNodeId,treeNodeType:n.treeNodeType||"folder",name:n.name,description:n.description,createdAt:Date.now(),updatedAt:Date.now(),version:1};await this.databaseOperations.createNode(i);break}default:throw new Error(`Redo operation not implemented for command type: ${r.kind}`)}}};J(Dr,"UNDOABLE_COMMANDS",new Set(["createNode","updateNode","deleteNode","moveNode","create","moveFolder","updateFolder","commitWorkingCopyForCreate"]));let Sn=Dr;var ds=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function fs(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Ir={exports:{}},hs=Ir.exports,bo;function ps(){return bo||(bo=1,(function(a,r){(function(n,i){a.exports=i()})(hs,function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,s){o.__proto__=s}||function(o,s){for(var u in s)Object.prototype.hasOwnProperty.call(s,u)&&(o[u]=s[u])})(e,t)},i=function(){return(i=Object.assign||function(e){for(var t,o=1,s=arguments.length;o<s;o++)for(var u in t=arguments[o])Object.prototype.hasOwnProperty.call(t,u)&&(e[u]=t[u]);return e}).apply(this,arguments)};function c(e,t,o){for(var s,u=0,l=t.length;u<l;u++)!s&&u in t||((s=s||Array.prototype.slice.call(t,0,u))[u]=t[u]);return e.concat(s||Array.prototype.slice.call(t))}var d=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:ds,h=Object.keys,g=Array.isArray;function O(e,t){return typeof t!="object"||h(t).forEach(function(o){e[o]=t[o]}),e}typeof Promise>"u"||d.Promise||(d.Promise=Promise);var E=Object.getPrototypeOf,A={}.hasOwnProperty;function R(e,t){return A.call(e,t)}function C(e,t){typeof t=="function"&&(t=t(E(e))),(typeof Reflect>"u"?h:Reflect.ownKeys)(t).forEach(function(o){U(e,o,t[o])})}var P=Object.defineProperty;function U(e,t,o,s){P(e,t,O(o&&R(o,"get")&&typeof o.get=="function"?{get:o.get,set:o.set,configurable:!0}:{value:o,configurable:!0,writable:!0},s))}function z(e){return{from:function(t){return e.prototype=Object.create(t.prototype),U(e.prototype,"constructor",e),{extend:C.bind(null,e.prototype)}}}}var ee=Object.getOwnPropertyDescriptor,ie=[].slice;function ne(e,t,o){return ie.call(e,t,o)}function ce(e,t){return t(e)}function Ee(e){if(!e)throw new Error("Assertion Failed")}function be(e){d.setImmediate?setImmediate(e):setTimeout(e,0)}function pe(e,t){if(typeof t=="string"&&R(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var o=[],s=0,u=t.length;s<u;++s){var l=pe(e,t[s]);o.push(l)}return o}var f=t.indexOf(".");if(f!==-1){var p=e[t.substr(0,f)];return p==null?void 0:pe(p,t.substr(f+1))}}function Ne(e,t,o){if(e&&t!==void 0&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){Ee(typeof o!="string"&&"length"in o);for(var s=0,u=t.length;s<u;++s)Ne(e,t[s],o[s])}else{var l,f,p=t.indexOf(".");p!==-1?(l=t.substr(0,p),(f=t.substr(p+1))===""?o===void 0?g(e)&&!isNaN(parseInt(l))?e.splice(l,1):delete e[l]:e[l]=o:Ne(p=!(p=e[l])||!R(e,l)?e[l]={}:p,f,o)):o===void 0?g(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=o}}function Cn(e){var t,o={};for(t in e)R(e,t)&&(o[t]=e[t]);return o}var ci=[].concat;function Rn(e){return ci.apply([],e)}var ze="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Rn([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return d[e]}),Pn=new Set(ze.map(function(e){return d[e]})),It=null;function Ue(e){return It=new WeakMap,e=(function t(o){if(!o||typeof o!="object")return o;var s=It.get(o);if(s)return s;if(g(o)){s=[],It.set(o,s);for(var u=0,l=o.length;u<l;++u)s.push(t(o[u]))}else if(Pn.has(o.constructor))s=o;else{var f,p=E(o);for(f in s=p===Object.prototype?{}:Object.create(p),It.set(o,s),o)R(o,f)&&(s[f]=t(o[f]))}return s})(e),It=null,e}var li={}.toString;function Cr(e){return li.call(e).slice(8,-1)}var Rr=typeof Symbol<"u"?Symbol.iterator:"@@iterator",di=typeof Rr=="symbol"?function(e){var t;return e!=null&&(t=e[Rr])&&t.apply(e)}:function(){return null};function Ve(e,t){return t=e.indexOf(t),0<=t&&e.splice(t,1),0<=t}var at={};function Ce(e){var t,o,s,u;if(arguments.length===1){if(g(e))return e.slice();if(this===at&&typeof e=="string")return[e];if(u=di(e)){for(o=[];!(s=u.next()).done;)o.push(s.value);return o}if(e==null)return[e];if(typeof(t=e.length)!="number")return[e];for(o=new Array(t);t--;)o[t]=e[t];return o}for(t=arguments.length,o=new Array(t);t--;)o[t]=arguments[t];return o}var Pr=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},xt=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Se=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(xt),fi={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function ut(e,t){this.name=e,this.message=t}function jn(e,t){return e+". Errors: "+Object.keys(t).map(function(o){return t[o].toString()}).filter(function(o,s,u){return u.indexOf(o)===s}).join(`
`)}function $t(e,t,o,s){this.failures=t,this.failedKeys=s,this.successCount=o,this.message=jn(e,t)}function ct(e,t){this.name="BulkError",this.failures=Object.keys(t).map(function(o){return t[o]}),this.failuresByPos=t,this.message=jn(e,this.failures)}z(ut).from(Error).extend({toString:function(){return this.name+": "+this.message}}),z($t).from(ut),z(ct).from(ut);var jr=Se.reduce(function(e,t){return e[t]=t+"Error",e},{}),hi=ut,W=Se.reduce(function(e,t){var o=t+"Error";function s(u,l){this.name=o,u?typeof u=="string"?(this.message="".concat(u).concat(l?`
 `+l:""),this.inner=l||null):typeof u=="object"&&(this.message="".concat(u.name," ").concat(u.message),this.inner=u):(this.message=fi[t]||o,this.inner=null)}return z(s).from(hi),e[t]=s,e},{});W.Syntax=SyntaxError,W.Type=TypeError,W.Range=RangeError;var Bn=xt.reduce(function(e,t){return e[t+"Error"]=W[t],e},{}),Ut=Se.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=W[t]),e},{});function te(){}function _t(e){return e}function pi(e,t){return e==null||e===_t?t:function(o){return t(e(o))}}function We(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function yi(e,t){return e===te?t:function(){var o=e.apply(this,arguments);o!==void 0&&(arguments[0]=o);var s=this.onsuccess,u=this.onerror;this.onsuccess=null,this.onerror=null;var l=t.apply(this,arguments);return s&&(this.onsuccess=this.onsuccess?We(s,this.onsuccess):s),u&&(this.onerror=this.onerror?We(u,this.onerror):u),l!==void 0?l:o}}function mi(e,t){return e===te?t:function(){e.apply(this,arguments);var o=this.onsuccess,s=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),o&&(this.onsuccess=this.onsuccess?We(o,this.onsuccess):o),s&&(this.onerror=this.onerror?We(s,this.onerror):s)}}function vi(e,t){return e===te?t:function(o){var s=e.apply(this,arguments);O(o,s);var u=this.onsuccess,l=this.onerror;return this.onsuccess=null,this.onerror=null,o=t.apply(this,arguments),u&&(this.onsuccess=this.onsuccess?We(u,this.onsuccess):u),l&&(this.onerror=this.onerror?We(l,this.onerror):l),s===void 0?o===void 0?void 0:o:O(s,o)}}function gi(e,t){return e===te?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function Br(e,t){return e===te?t:function(){var o=e.apply(this,arguments);if(o&&typeof o.then=="function"){for(var s=this,u=arguments.length,l=new Array(u);u--;)l[u]=arguments[u];return o.then(function(){return t.apply(s,l)})}return t.apply(this,arguments)}}Ut.ModifyError=$t,Ut.DexieError=ut,Ut.BulkError=ct;var Te=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Mn(e){Te=e}var St={},Fn=100,ze=typeof Promise>"u"?[]:(function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,E(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,E(t),e]})(),xt=ze[0],Se=ze[1],ze=ze[2],Se=Se&&Se.then,He=xt&&xt.constructor,Mr=!!ze,Et=function(e,t){Ot.push([e,t]),Vt&&(queueMicrotask(wi),Vt=!1)},Fr=!0,Vt=!0,Ye=[],Wt=[],qr=_t,je={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:te,pgp:!1,env:{},finalize:te},V=je,Ot=[],Ge=0,zt=[];function L(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var t=this._PSD=V;if(typeof e!="function"){if(e!==St)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Lr(this,this._value))}this._state=null,this._value=null,++t.ref,(function o(s,u){try{u(function(l){if(s._state===null){if(l===s)throw new TypeError("A promise cannot be resolved with itself.");var f=s._lib&&lt();l&&typeof l.then=="function"?o(s,function(p,m){l instanceof L?l._then(p,m):l.then(p,m)}):(s._state=!0,s._value=l,Kn(s)),f&&dt()}},Lr.bind(null,s))}catch(l){Lr(s,l)}})(this,e)}var Kr={get:function(){var e=V,t=Xt;function o(s,u){var l=this,f=!e.global&&(e!==V||t!==Xt),p=f&&!Me(),m=new L(function(b,N){$r(l,new qn($n(s,e,f,p),$n(u,e,f,p),b,N,e))});return this._consoleTask&&(m._consoleTask=this._consoleTask),m}return o.prototype=St,o},set:function(e){U(this,"then",e&&e.prototype===St?Kr:{get:function(){return e},set:Kr.set})}};function qn(e,t,o,s,u){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=o,this.reject=s,this.psd=u}function Lr(e,t){var o,s;Wt.push(t),e._state===null&&(o=e._lib&&lt(),t=qr(t),e._state=!1,e._value=t,s=e,Ye.some(function(u){return u._value===s._value})||Ye.push(s),Kn(e),o&&dt())}function Kn(e){var t=e._listeners;e._listeners=[];for(var o=0,s=t.length;o<s;++o)$r(e,t[o]);var u=e._PSD;--u.ref||u.finalize(),Ge===0&&(++Ge,Et(function(){--Ge==0&&Ur()},[]))}function $r(e,t){if(e._state!==null){var o=e._state?t.onFulfilled:t.onRejected;if(o===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Ge,Et(bi,[o,e,t])}else e._listeners.push(t)}function bi(e,t,o){try{var s,u=t._value;!t._state&&Wt.length&&(Wt=[]),s=Te&&t._consoleTask?t._consoleTask.run(function(){return e(u)}):e(u),t._state||Wt.indexOf(u)!==-1||(function(l){for(var f=Ye.length;f;)if(Ye[--f]._value===l._value)return Ye.splice(f,1)})(t),o.resolve(s)}catch(l){o.reject(l)}finally{--Ge==0&&Ur(),--o.psd.ref||o.psd.finalize()}}function wi(){Xe(je,function(){lt()&&dt()})}function lt(){var e=Fr;return Vt=Fr=!1,e}function dt(){var e,t,o;do for(;0<Ot.length;)for(e=Ot,Ot=[],o=e.length,t=0;t<o;++t){var s=e[t];s[0].apply(null,s[1])}while(0<Ot.length);Vt=Fr=!0}function Ur(){var e=Ye;Ye=[],e.forEach(function(s){s._PSD.onunhandled.call(null,s._value,s)});for(var t=zt.slice(0),o=t.length;o;)t[--o]()}function Ht(e){return new L(St,!1,e)}function oe(e,t){var o=V;return function(){var s=lt(),u=V;try{return Fe(o,!0),e.apply(this,arguments)}catch(l){t&&t(l)}finally{Fe(u,!1),s&&dt()}}}C(L.prototype,{then:Kr,_then:function(e,t){$r(this,new qn(null,null,e,t,V))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=e,o=arguments[1];return typeof t=="function"?this.then(null,function(s){return(s instanceof t?o:Ht)(s)}):this.then(null,function(s){return(s&&s.name===t?o:Ht)(s)})},finally:function(e){return this.then(function(t){return L.resolve(e()).then(function(){return t})},function(t){return L.resolve(e()).then(function(){return Ht(t)})})},timeout:function(e,t){var o=this;return e<1/0?new L(function(s,u){var l=setTimeout(function(){return u(new W.Timeout(t))},e);o.then(s,u).finally(clearTimeout.bind(null,l))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&U(L.prototype,Symbol.toStringTag,"Dexie.Promise"),je.env=Ln(),C(L,{all:function(){var e=Ce.apply(null,arguments).map(Qt);return new L(function(t,o){e.length===0&&t([]);var s=e.length;e.forEach(function(u,l){return L.resolve(u).then(function(f){e[l]=f,--s||t(e)},o)})})},resolve:function(e){return e instanceof L?e:e&&typeof e.then=="function"?new L(function(t,o){e.then(t,o)}):new L(St,!0,e)},reject:Ht,race:function(){var e=Ce.apply(null,arguments).map(Qt);return new L(function(t,o){e.map(function(s){return L.resolve(s).then(t,o)})})},PSD:{get:function(){return V},set:function(e){return V=e}},totalEchoes:{get:function(){return Xt}},newPSD:Be,usePSD:Xe,scheduler:{get:function(){return Et},set:function(e){Et=e}},rejectionMapper:{get:function(){return qr},set:function(e){qr=e}},follow:function(e,t){return new L(function(o,s){return Be(function(u,l){var f=V;f.unhandleds=[],f.onunhandled=l,f.finalize=We(function(){var p,m=this;p=function(){m.unhandleds.length===0?u():l(m.unhandleds[0])},zt.push(function b(){p(),zt.splice(zt.indexOf(b),1)}),++Ge,Et(function(){--Ge==0&&Ur()},[])},f.finalize),e()},t,o,s)})}}),He&&(He.allSettled&&U(L,"allSettled",function(){var e=Ce.apply(null,arguments).map(Qt);return new L(function(t){e.length===0&&t([]);var o=e.length,s=new Array(o);e.forEach(function(u,l){return L.resolve(u).then(function(f){return s[l]={status:"fulfilled",value:f}},function(f){return s[l]={status:"rejected",reason:f}}).then(function(){return--o||t(s)})})})}),He.any&&typeof AggregateError<"u"&&U(L,"any",function(){var e=Ce.apply(null,arguments).map(Qt);return new L(function(t,o){e.length===0&&o(new AggregateError([]));var s=e.length,u=new Array(s);e.forEach(function(l,f){return L.resolve(l).then(function(p){return t(p)},function(p){u[f]=p,--s||o(new AggregateError(u))})})})}),He.withResolvers&&(L.withResolvers=He.withResolvers));var de={awaits:0,echoes:0,id:0},Ni=0,Yt=[],Gt=0,Xt=0,Ii=0;function Be(e,t,o,s){var u=V,l=Object.create(u);return l.parent=u,l.ref=0,l.global=!1,l.id=++Ii,je.env,l.env=Mr?{Promise:L,PromiseProp:{value:L,configurable:!0,writable:!0},all:L.all,race:L.race,allSettled:L.allSettled,any:L.any,resolve:L.resolve,reject:L.reject}:{},t&&O(l,t),++u.ref,l.finalize=function(){--this.parent.ref||this.parent.finalize()},s=Xe(l,e,o,s),l.ref===0&&l.finalize(),s}function ft(){return de.id||(de.id=++Ni),++de.awaits,de.echoes+=Fn,de.id}function Me(){return!!de.awaits&&(--de.awaits==0&&(de.id=0),de.echoes=de.awaits*Fn,!0)}function Qt(e){return de.echoes&&e&&e.constructor===He?(ft(),e.then(function(t){return Me(),t},function(t){return Me(),ae(t)})):e}function _i(){var e=Yt[Yt.length-1];Yt.pop(),Fe(e,!1)}function Fe(e,t){var o,s=V;(t?!de.echoes||Gt++&&e===V:!Gt||--Gt&&e===V)||queueMicrotask(t?(function(u){++Xt,de.echoes&&--de.echoes!=0||(de.echoes=de.awaits=de.id=0),Yt.push(V),Fe(u,!0)}).bind(null,e):_i),e!==V&&(V=e,s===je&&(je.env=Ln()),Mr&&(o=je.env.Promise,t=e.env,(s.global||e.global)&&(Object.defineProperty(d,"Promise",t.PromiseProp),o.all=t.all,o.race=t.race,o.resolve=t.resolve,o.reject=t.reject,t.allSettled&&(o.allSettled=t.allSettled),t.any&&(o.any=t.any))))}function Ln(){var e=d.Promise;return Mr?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(d,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject}:{}}function Xe(e,t,o,s,u){var l=V;try{return Fe(e,!0),t(o,s,u)}finally{Fe(l,!1)}}function $n(e,t,o,s){return typeof e!="function"?e:function(){var u=V;o&&ft(),Fe(t,!0);try{return e.apply(this,arguments)}finally{Fe(u,!1),s&&queueMicrotask(Me)}}}function Vr(e){Promise===He&&de.echoes===0?Gt===0?e():enqueueNativeMicroTask(e):setTimeout(e,0)}(""+Se).indexOf("[native code]")===-1&&(ft=Me=te);var ae=L.reject,Qe="￿",Re="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Un="String expected.",ht=[],Zt="__dbnames",Wr="readonly",zr="readwrite";function Ze(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var Vn={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Jt(e){return typeof e!="string"||/\./.test(e)?function(t){return t}:function(t){return t[e]===void 0&&e in t&&delete(t=Ue(t))[e],t}}function Wn(){throw W.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function X(e,t){try{var o=zn(e),s=zn(t);if(o!==s)return o==="Array"?1:s==="Array"?-1:o==="binary"?1:s==="binary"?-1:o==="string"?1:s==="string"?-1:o==="Date"?1:s!=="Date"?NaN:-1;switch(o){case"number":case"Date":case"string":return t<e?1:e<t?-1:0;case"binary":return(function(u,l){for(var f=u.length,p=l.length,m=f<p?f:p,b=0;b<m;++b)if(u[b]!==l[b])return u[b]<l[b]?-1:1;return f===p?0:f<p?-1:1})(Hn(e),Hn(t));case"Array":return(function(u,l){for(var f=u.length,p=l.length,m=f<p?f:p,b=0;b<m;++b){var N=X(u[b],l[b]);if(N!==0)return N}return f===p?0:f<p?-1:1})(e,t)}}catch{}return NaN}function zn(e){var t=typeof e;return t!="object"?t:ArrayBuffer.isView(e)?"binary":(e=Cr(e),e==="ArrayBuffer"?"binary":e)}function Hn(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}function er(e,t,o){var s=e.schema.yProps;return s?(t&&0<o.numFailures&&(t=t.filter(function(u,l){return!o.failures[l]})),Promise.all(s.map(function(u){return u=u.updatesTable,t?e.db.table(u).where("k").anyOf(t).delete():e.db.table(u).clear()})).then(function(){return o})):o}var Yn=(re.prototype._trans=function(e,t,o){var s=this._tx||V.trans,u=this.name,l=Te&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(e==="readonly"?"read":"write"," ").concat(this.name));function f(b,N,y){if(!y.schema[u])throw new W.NotFound("Table "+u+" not part of transaction");return t(y.idbtrans,y)}var p=lt();try{var m=s&&s.db._novip===this.db._novip?s===V.trans?s._promise(e,f,o):Be(function(){return s._promise(e,f,o)},{trans:s,transless:V.transless||V}):(function b(N,y,S,v){if(N.idbdb&&(N._state.openComplete||V.letThrough||N._vip)){var w=N._createTransaction(y,S,N._dbSchema);try{w.create(),N._state.PR1398_maxLoop=3}catch(_){return _.name===jr.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return b(N,y,S,v)})):ae(_)}return w._promise(y,function(_,I){return Be(function(){return V.trans=w,v(_,I,w)})}).then(function(_){if(y==="readwrite")try{w.idbtrans.commit()}catch{}return y==="readonly"?_:w._completion.then(function(){return _})})}if(N._state.openComplete)return ae(new W.DatabaseClosed(N._state.dbOpenError));if(!N._state.isBeingOpened){if(!N._state.autoOpen)return ae(new W.DatabaseClosed);N.open().catch(te)}return N._state.dbReadyPromise.then(function(){return b(N,y,S,v)})})(this.db,e,[this.name],f);return l&&(m._consoleTask=l,m=m.catch(function(b){return console.trace(b),ae(b)})),m}finally{p&&dt()}},re.prototype.get=function(e,t){var o=this;return e&&e.constructor===Object?this.where(e).first(t):e==null?ae(new W.Type("Invalid argument to Table.get()")):this._trans("readonly",function(s){return o.core.get({trans:s,key:e}).then(function(u){return o.hook.reading.fire(u)})}).then(t)},re.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(g(e))return new this.db.WhereClause(this,"[".concat(e.join("+"),"]"));var t=h(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var o=this.schema.indexes.concat(this.schema.primKey).filter(function(p){if(p.compound&&t.every(function(b){return 0<=p.keyPath.indexOf(b)})){for(var m=0;m<t.length;++m)if(t.indexOf(p.keyPath[m])===-1)return!1;return!0}return!1}).sort(function(p,m){return p.keyPath.length-m.keyPath.length})[0];if(o&&this.db._maxKey!==Qe){var l=o.keyPath.slice(0,t.length);return this.where(l).equals(l.map(function(m){return e[m]}))}!o&&Te&&console.warn("The query ".concat(JSON.stringify(e)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(t.join("+"),"]"));var s=this.schema.idxByName;function u(p,m){return X(p,m)===0}var f=t.reduce(function(y,m){var b=y[0],N=y[1],y=s[m],S=e[m];return[b||y,b||!y?Ze(N,y&&y.multi?function(v){return v=pe(v,m),g(v)&&v.some(function(w){return u(S,w)})}:function(v){return u(S,pe(v,m))}):N]},[null,null]),l=f[0],f=f[1];return l?this.where(l.name).equals(e[l.keyPath]).filter(f):o?this.filter(f):this.where(t).equals("")},re.prototype.filter=function(e){return this.toCollection().and(e)},re.prototype.count=function(e){return this.toCollection().count(e)},re.prototype.offset=function(e){return this.toCollection().offset(e)},re.prototype.limit=function(e){return this.toCollection().limit(e)},re.prototype.each=function(e){return this.toCollection().each(e)},re.prototype.toArray=function(e){return this.toCollection().toArray(e)},re.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},re.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,g(e)?"[".concat(e.join("+"),"]"):e))},re.prototype.reverse=function(){return this.toCollection().reverse()},re.prototype.mapToClass=function(e){var t,o=this.db,s=this.name;function u(){return t!==null&&t.apply(this,arguments)||this}(this.schema.mappedClass=e).prototype instanceof Wn&&((function(m,b){if(typeof b!="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function N(){this.constructor=m}n(m,b),m.prototype=b===null?Object.create(b):(N.prototype=b.prototype,new N)})(u,t=e),Object.defineProperty(u.prototype,"db",{get:function(){return o},enumerable:!1,configurable:!0}),u.prototype.table=function(){return s},e=u);for(var l=new Set,f=e.prototype;f;f=E(f))Object.getOwnPropertyNames(f).forEach(function(m){return l.add(m)});function p(m){if(!m)return m;var b,N=Object.create(e.prototype);for(b in m)if(!l.has(b))try{N[b]=m[b]}catch{}return N}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=p,this.hook("reading",p),e},re.prototype.defineClass=function(){return this.mapToClass(function(e){O(this,e)})},re.prototype.add=function(e,t){var o=this,s=this.schema.primKey,u=s.auto,l=s.keyPath,f=e;return l&&u&&(f=Jt(l)(e)),this._trans("readwrite",function(p){return o.core.mutate({trans:p,type:"add",keys:t!=null?[t]:null,values:[f]})}).then(function(p){return p.numFailures?L.reject(p.failures[0]):p.lastResult}).then(function(p){if(l)try{Ne(e,l,p)}catch{}return p})},re.prototype.update=function(e,t){return typeof e!="object"||g(e)?this.where(":id").equals(e).modify(t):(e=pe(e,this.schema.primKey.keyPath),e===void 0?ae(new W.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(e).modify(t))},re.prototype.put=function(e,t){var o=this,s=this.schema.primKey,u=s.auto,l=s.keyPath,f=e;return l&&u&&(f=Jt(l)(e)),this._trans("readwrite",function(p){return o.core.mutate({trans:p,type:"put",values:[f],keys:t!=null?[t]:null})}).then(function(p){return p.numFailures?L.reject(p.failures[0]):p.lastResult}).then(function(p){if(l)try{Ne(e,l,p)}catch{}return p})},re.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(o){return t.core.mutate({trans:o,type:"delete",keys:[e]}).then(function(s){return er(t,[e],s)}).then(function(s){return s.numFailures?L.reject(s.failures[0]):void 0})})},re.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:Vn}).then(function(o){return er(e,null,o)})}).then(function(t){return t.numFailures?L.reject(t.failures[0]):void 0})},re.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(o){return t.core.getMany({keys:e,trans:o}).then(function(s){return s.map(function(u){return t.hook.reading.fire(u)})})})},re.prototype.bulkAdd=function(e,t,o){var s=this,u=Array.isArray(t)?t:void 0,l=(o=o||(u?void 0:t))?o.allKeys:void 0;return this._trans("readwrite",function(f){var b=s.schema.primKey,p=b.auto,b=b.keyPath;if(b&&u)throw new W.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new W.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,b=b&&p?e.map(Jt(b)):e;return s.core.mutate({trans:f,type:"add",keys:u,values:b,wantResults:l}).then(function(w){var y=w.numFailures,S=w.results,v=w.lastResult,w=w.failures;if(y===0)return l?S:v;throw new ct("".concat(s.name,".bulkAdd(): ").concat(y," of ").concat(m," operations failed"),w)})})},re.prototype.bulkPut=function(e,t,o){var s=this,u=Array.isArray(t)?t:void 0,l=(o=o||(u?void 0:t))?o.allKeys:void 0;return this._trans("readwrite",function(f){var b=s.schema.primKey,p=b.auto,b=b.keyPath;if(b&&u)throw new W.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new W.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,b=b&&p?e.map(Jt(b)):e;return s.core.mutate({trans:f,type:"put",keys:u,values:b,wantResults:l}).then(function(w){var y=w.numFailures,S=w.results,v=w.lastResult,w=w.failures;if(y===0)return l?S:v;throw new ct("".concat(s.name,".bulkPut(): ").concat(y," of ").concat(m," operations failed"),w)})})},re.prototype.bulkUpdate=function(e){var t=this,o=this.core,s=e.map(function(f){return f.key}),u=e.map(function(f){return f.changes}),l=[];return this._trans("readwrite",function(f){return o.getMany({trans:f,keys:s,cache:"clone"}).then(function(p){var m=[],b=[];e.forEach(function(y,S){var v=y.key,w=y.changes,_=p[S];if(_){for(var I=0,x=Object.keys(w);I<x.length;I++){var T=x[I],k=w[T];if(T===t.schema.primKey.keyPath){if(X(k,v)!==0)throw new W.Constraint("Cannot update primary key in bulkUpdate()")}else Ne(_,T,k)}l.push(S),m.push(v),b.push(_)}});var N=m.length;return o.mutate({trans:f,type:"put",keys:m,values:b,updates:{keys:s,changeSpecs:u}}).then(function(y){var S=y.numFailures,v=y.failures;if(S===0)return N;for(var w=0,_=Object.keys(v);w<_.length;w++){var I,x=_[w],T=l[Number(x)];T!=null&&(I=v[x],delete v[x],v[T]=I)}throw new ct("".concat(t.name,".bulkUpdate(): ").concat(S," of ").concat(N," operations failed"),v)})})})},re.prototype.bulkDelete=function(e){var t=this,o=e.length;return this._trans("readwrite",function(s){return t.core.mutate({trans:s,type:"delete",keys:e}).then(function(u){return er(t,e,u)})}).then(function(f){var u=f.numFailures,l=f.lastResult,f=f.failures;if(u===0)return l;throw new ct("".concat(t.name,".bulkDelete(): ").concat(u," of ").concat(o," operations failed"),f)})},re);function re(){}function Tt(e){function t(f,p){if(p){for(var m=arguments.length,b=new Array(m-1);--m;)b[m-1]=arguments[m];return o[f].subscribe.apply(null,b),e}if(typeof f=="string")return o[f]}var o={};t.addEventType=l;for(var s=1,u=arguments.length;s<u;++s)l(arguments[s]);return t;function l(f,p,m){if(typeof f!="object"){var b;p=p||gi;var N={subscribers:[],fire:m=m||te,subscribe:function(y){N.subscribers.indexOf(y)===-1&&(N.subscribers.push(y),N.fire=p(N.fire,y))},unsubscribe:function(y){N.subscribers=N.subscribers.filter(function(S){return S!==y}),N.fire=N.subscribers.reduce(p,m)}};return o[f]=t[f]=N}h(b=f).forEach(function(y){var S=b[y];if(g(S))l(y,b[y][0],b[y][1]);else{if(S!=="asap")throw new W.InvalidArgument("Invalid event config");var v=l(y,_t,function(){for(var w=arguments.length,_=new Array(w);w--;)_[w]=arguments[w];v.subscribers.forEach(function(I){be(function(){I.apply(null,_)})})})}})}}function kt(e,t){return z(t).from({prototype:e}),t}function pt(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Hr(e,t){e.filter=Ze(e.filter,t)}function Yr(e,t,o){var s=e.replayFilter;e.replayFilter=s?function(){return Ze(s(),t())}:t,e.justLimit=o&&!s}function tr(e,t){if(e.isPrimKey)return t.primaryKey;var o=t.getIndexByKeyPath(e.index);if(!o)throw new W.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return o}function Gn(e,t,o){var s=tr(e,t.schema);return t.openCursor({trans:o,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:s,range:e.range}})}function rr(e,t,o,s){var u=e.replayFilter?Ze(e.filter,e.replayFilter()):e.filter;if(e.or){var l={},f=function(p,m,b){var N,y;u&&!u(m,b,function(S){return m.stop(S)},function(S){return m.fail(S)})||((y=""+(N=m.primaryKey))=="[object ArrayBuffer]"&&(y=""+new Uint8Array(N)),R(l,y)||(l[y]=!0,t(p,m,b)))};return Promise.all([e.or._iterate(f,o),Xn(Gn(e,s,o),e.algorithm,f,!e.keysOnly&&e.valueMapper)])}return Xn(Gn(e,s,o),Ze(e.algorithm,u),t,!e.keysOnly&&e.valueMapper)}function Xn(e,t,o,s){var u=oe(s?function(l,f,p){return o(s(l),f,p)}:o);return e.then(function(l){if(l)return l.start(function(){var f=function(){return l.continue()};t&&!t(l,function(p){return f=p},function(p){l.stop(p),f=te},function(p){l.fail(p),f=te})||u(l.value,l,function(p){return f=p}),f()})})}var Dt=(Qn.prototype.execute=function(e){var t=this["@@propmod"];if(t.add!==void 0){var o=t.add;if(g(o))return c(c([],g(e)?e:[],!0),o).sort();if(typeof o=="number")return(Number(e)||0)+o;if(typeof o=="bigint")try{return BigInt(e)+o}catch{return BigInt(0)+o}throw new TypeError("Invalid term ".concat(o))}if(t.remove!==void 0){var s=t.remove;if(g(s))return g(e)?e.filter(function(u){return!s.includes(u)}).sort():[];if(typeof s=="number")return Number(e)-s;if(typeof s=="bigint")try{return BigInt(e)-s}catch{return BigInt(0)-s}throw new TypeError("Invalid subtrahend ".concat(s))}return o=(o=t.replacePrefix)===null||o===void 0?void 0:o[0],o&&typeof e=="string"&&e.startsWith(o)?t.replacePrefix[1]+e.substring(o.length):e},Qn);function Qn(e){this["@@propmod"]=e}var Si=(Z.prototype._read=function(e,t){var o=this._ctx;return o.error?o.table._trans(null,ae.bind(null,o.error)):o.table._trans("readonly",e).then(t)},Z.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,ae.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},Z.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=Ze(t.algorithm,e)},Z.prototype._iterate=function(e,t){return rr(this._ctx,e,t,this._ctx.table.core)},Z.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),o=Object.create(this._ctx);return e&&O(o,e),t._ctx=o,t},Z.prototype.raw=function(){return this._ctx.valueMapper=null,this},Z.prototype.each=function(e){var t=this._ctx;return this._read(function(o){return rr(t,e,o,t.table.core)})},Z.prototype.count=function(e){var t=this;return this._read(function(o){var s=t._ctx,u=s.table.core;if(pt(s,!0))return u.count({trans:o,query:{index:tr(s,u.schema),range:s.range}}).then(function(f){return Math.min(f,s.limit)});var l=0;return rr(s,function(){return++l,!1},o,u).then(function(){return l})}).then(e)},Z.prototype.sortBy=function(e,t){var o=e.split(".").reverse(),s=o[0],u=o.length-1;function l(m,b){return b?l(m[o[b]],b-1):m[s]}var f=this._ctx.dir==="next"?1:-1;function p(m,b){return X(l(m,u),l(b,u))*f}return this.toArray(function(m){return m.sort(p)}).then(t)},Z.prototype.toArray=function(e){var t=this;return this._read(function(o){var s=t._ctx;if(s.dir==="next"&&pt(s,!0)&&0<s.limit){var u=s.valueMapper,l=tr(s,s.table.core.schema);return s.table.core.query({trans:o,limit:s.limit,values:!0,query:{index:l,range:s.range}}).then(function(p){return p=p.result,u?p.map(u):p})}var f=[];return rr(s,function(p){return f.push(p)},o,s.table.core).then(function(){return f})},e)},Z.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,pt(t)?Yr(t,function(){var o=e;return function(s,u){return o===0||(o===1?--o:u(function(){s.advance(o),o=0}),!1)}}):Yr(t,function(){var o=e;return function(){return--o<0}})),this},Z.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Yr(this._ctx,function(){var t=e;return function(o,s,u){return--t<=0&&s(u),0<=t}},!0),this},Z.prototype.until=function(e,t){return Hr(this._ctx,function(o,s,u){return!e(o.value)||(s(u),t)}),this},Z.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},Z.prototype.last=function(e){return this.reverse().first(e)},Z.prototype.filter=function(e){var t;return Hr(this._ctx,function(o){return e(o.value)}),(t=this._ctx).isMatch=Ze(t.isMatch,e),this},Z.prototype.and=function(e){return this.filter(e)},Z.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},Z.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Z.prototype.desc=function(){return this.reverse()},Z.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(o,s){e(s.key,s)})},Z.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},Z.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(o,s){e(s.primaryKey,s)})},Z.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var o=[];return this.each(function(s,u){o.push(u.key)}).then(function(){return o}).then(e)},Z.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&pt(t,!0)&&0<t.limit)return this._read(function(s){var u=tr(t,t.table.core.schema);return t.table.core.query({trans:s,values:!1,limit:t.limit,query:{index:u,range:t.range}})}).then(function(s){return s.result}).then(e);t.keysOnly=!t.isMatch;var o=[];return this.each(function(s,u){o.push(u.primaryKey)}).then(function(){return o}).then(e)},Z.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},Z.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},Z.prototype.lastKey=function(e){return this.reverse().firstKey(e)},Z.prototype.distinct=function(){var e=this._ctx,e=e.index&&e.table.schema.idxByName[e.index];if(!e||!e.multi)return this;var t={};return Hr(this._ctx,function(u){var s=u.primaryKey.toString(),u=R(t,s);return t[s]=!0,!u}),this},Z.prototype.modify=function(e){var t=this,o=this._ctx;return this._write(function(s){var u,l,f;f=typeof e=="function"?e:(u=h(e),l=u.length,function(x){for(var T=!1,k=0;k<l;++k){var D=u[k],j=e[D],F=pe(x,D);j instanceof Dt?(Ne(x,D,j.execute(F)),T=!0):F!==j&&(Ne(x,D,j),T=!0)}return T});var p=o.table.core,y=p.schema.primaryKey,m=y.outbound,b=y.extractKey,N=200,y=t.db._options.modifyChunkSize;y&&(N=typeof y=="object"?y[p.name]||y["*"]||200:y);function S(x,D){var k=D.failures,D=D.numFailures;w+=x-D;for(var j=0,F=h(k);j<F.length;j++){var B=F[j];v.push(k[B])}}var v=[],w=0,_=[],I=e===Zn;return t.clone().primaryKeys().then(function(x){function T(D){var j=Math.min(N,x.length-D),F=x.slice(D,D+j);return(I?Promise.resolve([]):p.getMany({trans:s,keys:F,cache:"immutable"})).then(function(B){var M=[],K=[],q=m?[]:null,$=I?F:[];if(!I)for(var G=0;G<j;++G){var Q=B[G],Y={value:Ue(Q),primKey:x[D+G]};f.call(Y,Y.value,Y)!==!1&&(Y.value==null?$.push(x[D+G]):m||X(b(Q),b(Y.value))===0?(K.push(Y.value),m&&q.push(x[D+G])):($.push(x[D+G]),M.push(Y.value)))}return Promise.resolve(0<M.length&&p.mutate({trans:s,type:"add",values:M}).then(function(se){for(var H in se.failures)$.splice(parseInt(H),1);S(M.length,se)})).then(function(){return(0<K.length||k&&typeof e=="object")&&p.mutate({trans:s,type:"put",keys:q,values:K,criteria:k,changeSpec:typeof e!="function"&&e,isAdditionalChunk:0<D}).then(function(se){return S(K.length,se)})}).then(function(){return(0<$.length||k&&I)&&p.mutate({trans:s,type:"delete",keys:$,criteria:k,isAdditionalChunk:0<D}).then(function(se){return er(o.table,$,se)}).then(function(se){return S($.length,se)})}).then(function(){return x.length>D+j&&T(D+N)})})}var k=pt(o)&&o.limit===1/0&&(typeof e!="function"||I)&&{index:o.index,range:o.range};return T(0).then(function(){if(0<v.length)throw new $t("Error modifying one or more objects",v,w,_);return x.length})})})},Z.prototype.delete=function(){var e=this._ctx,t=e.range;return!pt(e)||e.table.schema.yProps||!e.isPrimKey&&t.type!==3?this.modify(Zn):this._write(function(o){var s=e.table.core.schema.primaryKey,u=t;return e.table.core.count({trans:o,query:{index:s,range:u}}).then(function(l){return e.table.core.mutate({trans:o,type:"deleteRange",range:u}).then(function(m){var p=m.failures,m=m.numFailures;if(m)throw new $t("Could not delete some values",Object.keys(p).map(function(b){return p[b]}),l-m);return l-m})})})},Z);function Z(){}var Zn=function(e,t){return t.value=null};function xi(e,t){return e<t?-1:e===t?0:1}function Ei(e,t){return t<e?-1:e===t?0:1}function Ie(e,t,o){return e=e instanceof eo?new e.Collection(e):e,e._ctx.error=new(o||TypeError)(t),e}function yt(e){return new e.Collection(e,function(){return Jn("")}).limit(0)}function nr(e,t,o,s){var u,l,f,p,m,b,N,y=o.length;if(!o.every(function(w){return typeof w=="string"}))return Ie(e,Un);function S(w){u=w==="next"?function(I){return I.toUpperCase()}:function(I){return I.toLowerCase()},l=w==="next"?function(I){return I.toLowerCase()}:function(I){return I.toUpperCase()},f=w==="next"?xi:Ei;var _=o.map(function(I){return{lower:l(I),upper:u(I)}}).sort(function(I,x){return f(I.lower,x.lower)});p=_.map(function(I){return I.upper}),m=_.map(function(I){return I.lower}),N=(b=w)==="next"?"":s}S("next"),e=new e.Collection(e,function(){return qe(p[0],m[y-1]+s)}),e._ondirectionchange=function(w){S(w)};var v=0;return e._addAlgorithm(function(w,_,I){var x=w.key;if(typeof x!="string")return!1;var T=l(x);if(t(T,m,v))return!0;for(var k=null,D=v;D<y;++D){var j=(function(F,B,M,K,q,$){for(var G=Math.min(F.length,K.length),Q=-1,Y=0;Y<G;++Y){var se=B[Y];if(se!==K[Y])return q(F[Y],M[Y])<0?F.substr(0,Y)+M[Y]+M.substr(Y+1):q(F[Y],K[Y])<0?F.substr(0,Y)+K[Y]+M.substr(Y+1):0<=Q?F.substr(0,Q)+B[Q]+M.substr(Q+1):null;q(F[Y],se)<0&&(Q=Y)}return G<K.length&&$==="next"?F+M.substr(F.length):G<F.length&&$==="prev"?F.substr(0,M.length):Q<0?null:F.substr(0,Q)+K[Q]+M.substr(Q+1)})(x,T,p[D],m[D],f,b);j===null&&k===null?v=D+1:(k===null||0<f(k,j))&&(k=j)}return _(k!==null?function(){w.continue(k+N)}:I),!1}),e}function qe(e,t,o,s){return{type:2,lower:e,upper:t,lowerOpen:o,upperOpen:s}}function Jn(e){return{type:1,lower:e,upper:e}}var eo=(Object.defineProperty(fe.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),fe.prototype.between=function(e,t,o,s){o=o!==!1,s=s===!0;try{return 0<this._cmp(e,t)||this._cmp(e,t)===0&&(o||s)&&(!o||!s)?yt(this):new this.Collection(this,function(){return qe(e,t,!o,!s)})}catch{return Ie(this,Re)}},fe.prototype.equals=function(e){return e==null?Ie(this,Re):new this.Collection(this,function(){return Jn(e)})},fe.prototype.above=function(e){return e==null?Ie(this,Re):new this.Collection(this,function(){return qe(e,void 0,!0)})},fe.prototype.aboveOrEqual=function(e){return e==null?Ie(this,Re):new this.Collection(this,function(){return qe(e,void 0,!1)})},fe.prototype.below=function(e){return e==null?Ie(this,Re):new this.Collection(this,function(){return qe(void 0,e,!1,!0)})},fe.prototype.belowOrEqual=function(e){return e==null?Ie(this,Re):new this.Collection(this,function(){return qe(void 0,e)})},fe.prototype.startsWith=function(e){return typeof e!="string"?Ie(this,Un):this.between(e,e+Qe,!0,!0)},fe.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):nr(this,function(t,o){return t.indexOf(o[0])===0},[e],Qe)},fe.prototype.equalsIgnoreCase=function(e){return nr(this,function(t,o){return t===o[0]},[e],"")},fe.prototype.anyOfIgnoreCase=function(){var e=Ce.apply(at,arguments);return e.length===0?yt(this):nr(this,function(t,o){return o.indexOf(t)!==-1},e,"")},fe.prototype.startsWithAnyOfIgnoreCase=function(){var e=Ce.apply(at,arguments);return e.length===0?yt(this):nr(this,function(t,o){return o.some(function(s){return t.indexOf(s)===0})},e,Qe)},fe.prototype.anyOf=function(){var e=this,t=Ce.apply(at,arguments),o=this._cmp;try{t.sort(o)}catch{return Ie(this,Re)}if(t.length===0)return yt(this);var s=new this.Collection(this,function(){return qe(t[0],t[t.length-1])});s._ondirectionchange=function(l){o=l==="next"?e._ascending:e._descending,t.sort(o)};var u=0;return s._addAlgorithm(function(l,f,p){for(var m=l.key;0<o(m,t[u]);)if(++u===t.length)return f(p),!1;return o(m,t[u])===0||(f(function(){l.continue(t[u])}),!1)}),s},fe.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},fe.prototype.noneOf=function(){var e=Ce.apply(at,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return Ie(this,Re)}var t=e.reduce(function(o,s){return o?o.concat([[o[o.length-1][1],s]]):[[-1/0,s]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},fe.prototype.inAnyRange=function(x,t){var o=this,s=this._cmp,u=this._ascending,l=this._descending,f=this._min,p=this._max;if(x.length===0)return yt(this);if(!x.every(function(T){return T[0]!==void 0&&T[1]!==void 0&&u(T[0],T[1])<=0}))return Ie(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",W.InvalidArgument);var m=!t||t.includeLowers!==!1,b=t&&t.includeUppers===!0,N,y=u;function S(T,k){return y(T[0],k[0])}try{(N=x.reduce(function(T,k){for(var D=0,j=T.length;D<j;++D){var F=T[D];if(s(k[0],F[1])<0&&0<s(k[1],F[0])){F[0]=f(F[0],k[0]),F[1]=p(F[1],k[1]);break}}return D===j&&T.push(k),T},[])).sort(S)}catch{return Ie(this,Re)}var v=0,w=b?function(T){return 0<u(T,N[v][1])}:function(T){return 0<=u(T,N[v][1])},_=m?function(T){return 0<l(T,N[v][0])}:function(T){return 0<=l(T,N[v][0])},I=w,x=new this.Collection(this,function(){return qe(N[0][0],N[N.length-1][1],!m,!b)});return x._ondirectionchange=function(T){y=T==="next"?(I=w,u):(I=_,l),N.sort(S)},x._addAlgorithm(function(T,k,D){for(var j,F=T.key;I(F);)if(++v===N.length)return k(D),!1;return!w(j=F)&&!_(j)||(o._cmp(F,N[v][1])===0||o._cmp(F,N[v][0])===0||k(function(){y===u?T.continue(N[v][0]):T.continue(N[v][1])}),!1)}),x},fe.prototype.startsWithAnyOf=function(){var e=Ce.apply(at,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?yt(this):this.inAnyRange(e.map(function(t){return[t,t+Qe]})):Ie(this,"startsWithAnyOf() only works with strings")},fe);function fe(){}function ke(e){return oe(function(t){return At(t),e(t.target.error),!1})}function At(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var Ct="storagemutated",Gr="x-storagemutated-1",Ke=Tt(null,Ct),Oi=(De.prototype._lock=function(){return Ee(!V.global),++this._reculock,this._reculock!==1||V.global||(V.lockOwnerFor=this),this},De.prototype._unlock=function(){if(Ee(!V.global),--this._reculock==0)for(V.global||(V.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var e=this._blockedFuncs.shift();try{Xe(e[1],e[0])}catch{}}return this},De.prototype._locked=function(){return this._reculock&&V.lockOwnerFor!==this},De.prototype.create=function(e){var t=this;if(!this.mode)return this;var o=this.db.idbdb,s=this.db._state.dbOpenError;if(Ee(!this.idbtrans),!e&&!o)switch(s&&s.name){case"DatabaseClosedError":throw new W.DatabaseClosed(s);case"MissingAPIError":throw new W.MissingAPI(s.message,s);default:throw new W.OpenFailed(s)}if(!this.active)throw new W.TransactionInactive;return Ee(this._completion._state===null),(e=this.idbtrans=e||(this.db.core||o).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=oe(function(u){At(u),t._reject(e.error)}),e.onabort=oe(function(u){At(u),t.active&&t._reject(new W.Abort(e.error)),t.active=!1,t.on("abort").fire(u)}),e.oncomplete=oe(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&Ke.storagemutated.fire(e.mutatedParts)}),this},De.prototype._promise=function(e,t,o){var s=this;if(e==="readwrite"&&this.mode!=="readwrite")return ae(new W.ReadOnly("Transaction is readonly"));if(!this.active)return ae(new W.TransactionInactive);if(this._locked())return new L(function(l,f){s._blockedFuncs.push([function(){s._promise(e,t,o).then(l,f)},V])});if(o)return Be(function(){var l=new L(function(f,p){s._lock();var m=t(f,p,s);m&&m.then&&m.then(f,p)});return l.finally(function(){return s._unlock()}),l._lib=!0,l});var u=new L(function(l,f){var p=t(l,f,s);p&&p.then&&p.then(l,f)});return u._lib=!0,u},De.prototype._root=function(){return this.parent?this.parent._root():this},De.prototype.waitFor=function(e){var t,o=this._root(),s=L.resolve(e);o._waitingFor?o._waitingFor=o._waitingFor.then(function(){return s}):(o._waitingFor=s,o._waitingQueue=[],t=o.idbtrans.objectStore(o.storeNames[0]),(function l(){for(++o._spinCount;o._waitingQueue.length;)o._waitingQueue.shift()();o._waitingFor&&(t.get(-1/0).onsuccess=l)})());var u=o._waitingFor;return new L(function(l,f){s.then(function(p){return o._waitingQueue.push(oe(l.bind(null,p)))},function(p){return o._waitingQueue.push(oe(f.bind(null,p)))}).finally(function(){o._waitingFor===u&&(o._waitingFor=null)})})},De.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new W.Abort))},De.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(R(t,e))return t[e];var o=this.schema[e];if(!o)throw new W.NotFound("Table "+e+" not part of transaction");return o=new this.db.Table(e,o,this),o.core=this.db.core.table(e),t[e]=o},De);function De(){}function Xr(e,t,o,s,u,l,f,p){return{name:e,keyPath:t,unique:o,multi:s,auto:u,compound:l,src:(o&&!f?"&":"")+(s?"*":"")+(u?"++":"")+to(t),type:p}}function to(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Qr(e,t,o){return{name:e,primKey:t,indexes:o,mappedClass:null,idxByName:(s=function(u){return[u.name,u]},o.reduce(function(u,l,f){return f=s(l,f),f&&(u[f[0]]=f[1]),u},{}))};var s}var Rt=function(e){try{return e.only([[]]),Rt=function(){return[[]]},[[]]}catch{return Rt=function(){return Qe},Qe}};function Zr(e){return e==null?function(){}:typeof e=="string"?(t=e).split(".").length===1?function(o){return o[t]}:function(o){return pe(o,t)}:function(o){return pe(o,e)};var t}function ro(e){return[].slice.call(e)}var Ti=0;function Pt(e){return e==null?":id":typeof e=="string"?e:"[".concat(e.join("+"),"]")}function ki(e,t,m){function s(I){if(I.type===3)return null;if(I.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var v=I.lower,w=I.upper,_=I.lowerOpen,I=I.upperOpen;return v===void 0?w===void 0?null:t.upperBound(w,!!I):w===void 0?t.lowerBound(v,!!_):t.bound(v,w,!!_,!!I)}function u(S){var v,w=S.name;return{name:w,schema:S,mutate:function(_){var I=_.trans,x=_.type,T=_.keys,k=_.values,D=_.range;return new Promise(function(j,F){j=oe(j);var B=I.objectStore(w),M=B.keyPath==null,K=x==="put"||x==="add";if(!K&&x!=="delete"&&x!=="deleteRange")throw new Error("Invalid operation type: "+x);var q,$=(T||k||{length:1}).length;if(T&&k&&T.length!==k.length)throw new Error("Given keys array must have same length as given values array.");if($===0)return j({numFailures:0,failures:{},results:[],lastResult:void 0});function G(we){++se,At(we)}var Q=[],Y=[],se=0;if(x==="deleteRange"){if(D.type===4)return j({numFailures:se,failures:Y,results:[],lastResult:void 0});D.type===3?Q.push(q=B.clear()):Q.push(q=B.delete(s(D)))}else{var M=K?M?[k,T]:[k,null]:[T,null],H=M[0],me=M[1];if(K)for(var ve=0;ve<$;++ve)Q.push(q=me&&me[ve]!==void 0?B[x](H[ve],me[ve]):B[x](H[ve])),q.onerror=G;else for(ve=0;ve<$;++ve)Q.push(q=B[x](H[ve])),q.onerror=G}function yr(we){we=we.target.result,Q.forEach(function(tt,vn){return tt.error!=null&&(Y[vn]=tt.error)}),j({numFailures:se,failures:Y,results:x==="delete"?T:Q.map(function(tt){return tt.result}),lastResult:we})}q.onerror=function(we){G(we),yr(we)},q.onsuccess=yr})},getMany:function(_){var I=_.trans,x=_.keys;return new Promise(function(T,k){T=oe(T);for(var D,j=I.objectStore(w),F=x.length,B=new Array(F),M=0,K=0,q=function(Q){Q=Q.target,B[Q._pos]=Q.result,++K===M&&T(B)},$=ke(k),G=0;G<F;++G)x[G]!=null&&((D=j.get(x[G]))._pos=G,D.onsuccess=q,D.onerror=$,++M);M===0&&T(B)})},get:function(_){var I=_.trans,x=_.key;return new Promise(function(T,k){T=oe(T);var D=I.objectStore(w).get(x);D.onsuccess=function(j){return T(j.target.result)},D.onerror=ke(k)})},query:(v=b,function(_){return new Promise(function(I,x){I=oe(I);var T,k,D,M=_.trans,j=_.values,F=_.limit,q=_.query,B=F===1/0?void 0:F,K=q.index,q=q.range,M=M.objectStore(w),K=K.isPrimaryKey?M:M.index(K.name),q=s(q);if(F===0)return I({result:[]});v?((B=j?K.getAll(q,B):K.getAllKeys(q,B)).onsuccess=function($){return I({result:$.target.result})},B.onerror=ke(x)):(T=0,k=!j&&"openKeyCursor"in K?K.openKeyCursor(q):K.openCursor(q),D=[],k.onsuccess=function($){var G=k.result;return G?(D.push(j?G.value:G.primaryKey),++T===F?I({result:D}):void G.continue()):I({result:D})},k.onerror=ke(x))})}),openCursor:function(_){var I=_.trans,x=_.values,T=_.query,k=_.reverse,D=_.unique;return new Promise(function(j,F){j=oe(j);var K=T.index,B=T.range,M=I.objectStore(w),M=K.isPrimaryKey?M:M.index(K.name),K=k?D?"prevunique":"prev":D?"nextunique":"next",q=!x&&"openKeyCursor"in M?M.openKeyCursor(s(B),K):M.openCursor(s(B),K);q.onerror=ke(F),q.onsuccess=oe(function($){var G,Q,Y,se,H=q.result;H?(H.___id=++Ti,H.done=!1,G=H.continue.bind(H),Q=(Q=H.continuePrimaryKey)&&Q.bind(H),Y=H.advance.bind(H),se=function(){throw new Error("Cursor not stopped")},H.trans=I,H.stop=H.continue=H.continuePrimaryKey=H.advance=function(){throw new Error("Cursor not started")},H.fail=oe(F),H.next=function(){var me=this,ve=1;return this.start(function(){return ve--?me.continue():me.stop()}).then(function(){return me})},H.start=function(me){function ve(){if(q.result)try{me()}catch(we){H.fail(we)}else H.done=!0,H.start=function(){throw new Error("Cursor behind last entry")},H.stop()}var yr=new Promise(function(we,tt){we=oe(we),q.onerror=ke(tt),H.fail=tt,H.stop=function(vn){H.stop=H.continue=H.continuePrimaryKey=H.advance=se,we(vn)}});return q.onsuccess=oe(function(we){q.onsuccess=ve,ve()}),H.continue=G,H.continuePrimaryKey=Q,H.advance=Y,ve(),yr},j(H)):j(null)},F)})},count:function(_){var I=_.query,x=_.trans,T=I.index,k=I.range;return new Promise(function(D,j){var F=x.objectStore(w),B=T.isPrimaryKey?F:F.index(T.name),F=s(k),B=F?B.count(F):B.count();B.onsuccess=oe(function(M){return D(M.target.result)}),B.onerror=ke(j)})}}}var l,f,p,N=(f=m,p=ro((l=e).objectStoreNames),{schema:{name:l.name,tables:p.map(function(S){return f.objectStore(S)}).map(function(S){var v=S.keyPath,I=S.autoIncrement,w=g(v),_={},I={name:S.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:v==null,compound:w,keyPath:v,autoIncrement:I,unique:!0,extractKey:Zr(v)},indexes:ro(S.indexNames).map(function(x){return S.index(x)}).map(function(D){var T=D.name,k=D.unique,j=D.multiEntry,D=D.keyPath,j={name:T,compound:g(D),keyPath:D,unique:k,multiEntry:j,extractKey:Zr(D)};return _[Pt(D)]=j}),getIndexByKeyPath:function(x){return _[Pt(x)]}};return _[":id"]=I.primaryKey,v!=null&&(_[Pt(v)]=I.primaryKey),I})},hasGetAll:0<p.length&&"getAll"in f.objectStore(p[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),m=N.schema,b=N.hasGetAll,N=m.tables.map(u),y={};return N.forEach(function(S){return y[S.name]=S}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(S){if(!y[S])throw new Error("Table '".concat(S,"' not found"));return y[S]},MIN_KEY:-1/0,MAX_KEY:Rt(t),schema:m}}function Di(e,t,o,s){var u=o.IDBKeyRange;return o.indexedDB,{dbcore:(s=ki(t,u,s),e.dbcore.reduce(function(l,f){return f=f.create,i(i({},l),f(l))},s))}}function or(e,s){var o=s.db,s=Di(e._middlewares,o,e._deps,s);e.core=s.dbcore,e.tables.forEach(function(u){var l=u.name;e.core.schema.tables.some(function(f){return f.name===l})&&(u.core=e.core.table(l),e[l]instanceof e.Table&&(e[l].core=u.core))})}function ir(e,t,o,s){o.forEach(function(u){var l=s[u];t.forEach(function(f){var p=(function m(b,N){return ee(b,N)||(b=E(b))&&m(b,N)})(f,u);(!p||"value"in p&&p.value===void 0)&&(f===e.Transaction.prototype||f instanceof e.Transaction?U(f,u,{get:function(){return this.table(u)},set:function(m){P(this,u,{value:m,writable:!0,configurable:!0,enumerable:!0})}}):f[u]=new e.Table(u,l))})})}function Jr(e,t){t.forEach(function(o){for(var s in o)o[s]instanceof e.Table&&delete o[s]})}function Ai(e,t){return e._cfg.version-t._cfg.version}function Ci(e,t,o,s){var u=e._dbSchema;o.objectStoreNames.contains("$meta")&&!u.$meta&&(u.$meta=Qr("$meta",oo("")[0],[]),e._storeNames.push("$meta"));var l=e._createTransaction("readwrite",e._storeNames,u);l.create(o),l._completion.catch(s);var f=l._reject.bind(l),p=V.transless||V;Be(function(){return V.trans=l,V.transless=p,t!==0?(or(e,o),b=t,((m=l).storeNames.includes("$meta")?m.table("$meta").get("version").then(function(N){return N??b}):L.resolve(b)).then(function(N){return S=N,v=l,w=o,_=[],N=(y=e)._versions,I=y._dbSchema=ar(0,y.idbdb,w),(N=N.filter(function(x){return x._cfg.version>=S})).length!==0?(N.forEach(function(x){_.push(function(){var T=I,k=x._cfg.dbschema;ur(y,T,w),ur(y,k,w),I=y._dbSchema=k;var D=en(T,k);D.add.forEach(function(K){tn(w,K[0],K[1].primKey,K[1].indexes)}),D.change.forEach(function(K){if(K.recreate)throw new W.Upgrade("Not yet support for changing primary key");var q=w.objectStore(K.name);K.add.forEach(function($){return sr(q,$)}),K.change.forEach(function($){q.deleteIndex($.name),sr(q,$)}),K.del.forEach(function($){return q.deleteIndex($)})});var j=x._cfg.contentUpgrade;if(j&&x._cfg.version>S){or(y,w),v._memoizedTables={};var F=Cn(k);D.del.forEach(function(K){F[K]=T[K]}),Jr(y,[y.Transaction.prototype]),ir(y,[y.Transaction.prototype],h(F),F),v.schema=F;var B,M=Pr(j);return M&&ft(),D=L.follow(function(){var K;(B=j(v))&&M&&(K=Me.bind(null,null),B.then(K,K))}),B&&typeof B.then=="function"?L.resolve(B):D.then(function(){return B})}}),_.push(function(T){var k,D,j=x._cfg.dbschema;k=j,D=T,[].slice.call(D.db.objectStoreNames).forEach(function(F){return k[F]==null&&D.db.deleteObjectStore(F)}),Jr(y,[y.Transaction.prototype]),ir(y,[y.Transaction.prototype],y._storeNames,y._dbSchema),v.schema=y._dbSchema}),_.push(function(T){y.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(y.idbdb.version/10)===x._cfg.version?(y.idbdb.deleteObjectStore("$meta"),delete y._dbSchema.$meta,y._storeNames=y._storeNames.filter(function(k){return k!=="$meta"})):T.objectStore("$meta").put(x._cfg.version,"version"))})}),(function x(){return _.length?L.resolve(_.shift()(v.idbtrans)).then(x):L.resolve()})().then(function(){no(I,w)})):L.resolve();var y,S,v,w,_,I}).catch(f)):(h(u).forEach(function(N){tn(o,N,u[N].primKey,u[N].indexes)}),or(e,o),void L.follow(function(){return e.on.populate.fire(l)}).catch(f));var m,b})}function Ri(e,t){no(e._dbSchema,t),t.db.version%10!=0||t.objectStoreNames.contains("$meta")||t.db.createObjectStore("$meta").add(Math.ceil(t.db.version/10-1),"version");var o=ar(0,e.idbdb,t);ur(e,e._dbSchema,t);for(var s=0,u=en(o,e._dbSchema).change;s<u.length;s++){var l=(function(f){if(f.change.length||f.recreate)return console.warn("Unable to patch indexes of table ".concat(f.name," because it has changes on the type of index or primary key.")),{value:void 0};var p=t.objectStore(f.name);f.add.forEach(function(m){Te&&console.debug("Dexie upgrade patch: Creating missing index ".concat(f.name,".").concat(m.src)),sr(p,m)})})(u[s]);if(typeof l=="object")return l.value}}function en(e,t){var o,s={del:[],add:[],change:[]};for(o in e)t[o]||s.del.push(o);for(o in t){var u=e[o],l=t[o];if(u){var f={name:o,def:l,recreate:!1,del:[],add:[],change:[]};if(""+(u.primKey.keyPath||"")!=""+(l.primKey.keyPath||"")||u.primKey.auto!==l.primKey.auto)f.recreate=!0,s.change.push(f);else{var p=u.idxByName,m=l.idxByName,b=void 0;for(b in p)m[b]||f.del.push(b);for(b in m){var N=p[b],y=m[b];N?N.src!==y.src&&f.change.push(y):f.add.push(y)}(0<f.del.length||0<f.add.length||0<f.change.length)&&s.change.push(f)}}else s.add.push([o,l])}return s}function tn(e,t,o,s){var u=e.db.createObjectStore(t,o.keyPath?{keyPath:o.keyPath,autoIncrement:o.auto}:{autoIncrement:o.auto});return s.forEach(function(l){return sr(u,l)}),u}function no(e,t){h(e).forEach(function(o){t.db.objectStoreNames.contains(o)||(Te&&console.debug("Dexie: Creating missing table",o),tn(t,o,e[o].primKey,e[o].indexes))})}function sr(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function ar(e,t,o){var s={};return ne(t.objectStoreNames,0).forEach(function(u){for(var l=o.objectStore(u),f=Xr(to(b=l.keyPath),b||"",!0,!1,!!l.autoIncrement,b&&typeof b!="string",!0),p=[],m=0;m<l.indexNames.length;++m){var N=l.index(l.indexNames[m]),b=N.keyPath,N=Xr(N.name,b,!!N.unique,!!N.multiEntry,!1,b&&typeof b!="string",!1);p.push(N)}s[u]=Qr(u,f,p)}),s}function ur(e,t,o){for(var s=o.db.objectStoreNames,u=0;u<s.length;++u){var l=s[u],f=o.objectStore(l);e._hasGetAll="getAll"in f;for(var p=0;p<f.indexNames.length;++p){var m=f.indexNames[p],b=f.index(m).keyPath,N=typeof b=="string"?b:"["+ne(b).join("+")+"]";!t[l]||(b=t[l].idxByName[N])&&(b.name=m,delete t[l].idxByName[N],t[l].idxByName[m]=b)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&d.WorkerGlobalScope&&d instanceof d.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}function oo(e){return e.split(",").map(function(t,o){var l=t.split(":"),s=(u=l[1])===null||u===void 0?void 0:u.trim(),u=(t=l[0].trim()).replace(/([&*]|\+\+)/g,""),l=/^\[/.test(u)?u.match(/^\[(.*)\]$/)[1].split("+"):u;return Xr(u,l||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),g(l),o===0,s)})}var Pi=(mt.prototype._createTableSchema=Qr,mt.prototype._parseIndexSyntax=oo,mt.prototype._parseStoresSpec=function(e,t){var o=this;h(e).forEach(function(s){if(e[s]!==null){var u=o._parseIndexSyntax(e[s]),l=u.shift();if(!l)throw new W.Schema("Invalid schema for table "+s+": "+e[s]);if(l.unique=!0,l.multi)throw new W.Schema("Primary key cannot be multiEntry*");u.forEach(function(f){if(f.auto)throw new W.Schema("Only primary key can be marked as autoIncrement (++)");if(!f.keyPath)throw new W.Schema("Index must have a name and cannot be an empty string")}),u=o._createTableSchema(s,l,u),t[s]=u}})},mt.prototype.stores=function(o){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?O(this._cfg.storesSource,o):o;var o=t._versions,s={},u={};return o.forEach(function(l){O(s,l._cfg.storesSource),u=l._cfg.dbschema={},l._parseStoresSpec(s,u)}),t._dbSchema=u,Jr(t,[t._allTables,t,t.Transaction.prototype]),ir(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],h(u),u),t._storeNames=h(u),this},mt.prototype.upgrade=function(e){return this._cfg.contentUpgrade=Br(this._cfg.contentUpgrade||te,e),this},mt);function mt(){}function rn(e,t){var o=e._dbNamesDB;return o||(o=e._dbNamesDB=new Pe(Zt,{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),o.table("dbnames")}function nn(e){return e&&typeof e.databases=="function"}function on(e){return Be(function(){return V.letThrough=!0,e()})}function sn(e){return!("from"in e)}var ye=function(e,t){if(!this){var o=new ye;return e&&"d"in e&&O(o,e),o}O(this,arguments.length?{d:1,from:e,to:1<arguments.length?t:e}:{d:0})};function jt(e,t,o){var s=X(t,o);if(!isNaN(s)){if(0<s)throw RangeError();if(sn(e))return O(e,{from:t,to:o,d:1});var u=e.l,s=e.r;if(X(o,e.from)<0)return u?jt(u,t,o):e.l={from:t,to:o,d:1,l:null,r:null},so(e);if(0<X(t,e.to))return s?jt(s,t,o):e.r={from:t,to:o,d:1,l:null,r:null},so(e);X(t,e.from)<0&&(e.from=t,e.l=null,e.d=s?s.d+1:1),0<X(o,e.to)&&(e.to=o,e.r=null,e.d=e.l?e.l.d+1:1),o=!e.r,u&&!e.l&&Bt(e,u),s&&o&&Bt(e,s)}}function Bt(e,t){sn(t)||(function o(s,m){var l=m.from,f=m.to,p=m.l,m=m.r;jt(s,l,f),p&&o(s,p),m&&o(s,m)})(e,t)}function io(e,t){var o=cr(t),s=o.next();if(s.done)return!1;for(var u=s.value,l=cr(e),f=l.next(u.from),p=f.value;!s.done&&!f.done;){if(X(p.from,u.to)<=0&&0<=X(p.to,u.from))return!0;X(u.from,p.from)<0?u=(s=o.next(p.from)).value:p=(f=l.next(u.from)).value}return!1}function cr(e){var t=sn(e)?null:{s:0,n:e};return{next:function(o){for(var s=0<arguments.length;t;)switch(t.s){case 0:if(t.s=1,s)for(;t.n.l&&X(o,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!s||X(o,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function so(e){var t,o,s=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((o=e.l)===null||o===void 0?void 0:o.d)||0),u=1<s?"r":s<-1?"l":"";u&&(t=u=="r"?"l":"r",o=i({},e),s=e[u],e.from=s.from,e.to=s.to,e[u]=s[u],o[u]=s[t],(e[t]=o).d=ao(o)),e.d=ao(e)}function ao(o){var t=o.r,o=o.l;return(t?o?Math.max(t.d,o.d):t.d:o?o.d:0)+1}function lr(e,t){return h(t).forEach(function(o){e[o]?Bt(e[o],t[o]):e[o]=(function s(u){var l,f,p={};for(l in u)R(u,l)&&(f=u[l],p[l]=!f||typeof f!="object"||Pn.has(f.constructor)?f:s(f));return p})(t[o])}),e}function an(e,t){return e.all||t.all||Object.keys(e).some(function(o){return t[o]&&io(t[o],e[o])})}C(ye.prototype,((Se={add:function(e){return Bt(this,e),this},addKey:function(e){return jt(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(o){return jt(t,o,o)}),this},hasKey:function(e){var t=cr(this).next(e).value;return t&&X(t.from,e)<=0&&0<=X(t.to,e)}})[Rr]=function(){return cr(this)},Se));var Je={},un={},cn=!1;function dr(e){lr(un,e),cn||(cn=!0,setTimeout(function(){cn=!1,ln(un,!(un={}))},0))}function ln(e,t){t===void 0&&(t=!1);var o=new Set;if(e.all)for(var s=0,u=Object.values(Je);s<u.length;s++)uo(f=u[s],e,o,t);else for(var l in e){var f,p=/^idb\:\/\/(.*)\/(.*)\//.exec(l);p&&(l=p[1],p=p[2],(f=Je["idb://".concat(l,"/").concat(p)])&&uo(f,e,o,t))}o.forEach(function(m){return m()})}function uo(e,t,o,s){for(var u=[],l=0,f=Object.entries(e.queries.query);l<f.length;l++){for(var p=f[l],m=p[0],b=[],N=0,y=p[1];N<y.length;N++){var S=y[N];an(t,S.obsSet)?S.subscribers.forEach(function(I){return o.add(I)}):s&&b.push(S)}s&&u.push([m,b])}if(s)for(var v=0,w=u;v<w.length;v++){var _=w[v],m=_[0],b=_[1];e.queries.query[m]=b}}function ji(e){var t=e._state,o=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?ae(t.dbOpenError):e});t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var s=t.openCanceller,u=Math.round(10*e.verno),l=!1;function f(){if(t.openCanceller!==s)throw new W.DatabaseClosed("db.open() was cancelled")}function p(){return new L(function(S,v){if(f(),!o)throw new W.MissingAPI;var w=e.name,_=t.autoSchema||!u?o.open(w):o.open(w,u);if(!_)throw new W.MissingAPI;_.onerror=ke(v),_.onblocked=oe(e._fireOnBlocked),_.onupgradeneeded=oe(function(I){var x;N=_.transaction,t.autoSchema&&!e._options.allowEmptyDB?(_.onerror=At,N.abort(),_.result.close(),(x=o.deleteDatabase(w)).onsuccess=x.onerror=oe(function(){v(new W.NoSuchDatabase("Database ".concat(w," doesnt exist")))})):(N.onerror=ke(v),I=I.oldVersion>Math.pow(2,62)?0:I.oldVersion,y=I<1,e.idbdb=_.result,l&&Ri(e,N),Ci(e,I/10,N,v))},v),_.onsuccess=oe(function(){N=null;var I,x,T,k,D,j=e.idbdb=_.result,F=ne(j.objectStoreNames);if(0<F.length)try{var B=j.transaction((k=F).length===1?k[0]:k,"readonly");if(t.autoSchema)x=j,T=B,(I=e).verno=x.version/10,T=I._dbSchema=ar(0,x,T),I._storeNames=ne(x.objectStoreNames,0),ir(I,[I._allTables],h(T),T);else if(ur(e,e._dbSchema,B),((D=en(ar(0,(D=e).idbdb,B),D._dbSchema)).add.length||D.change.some(function(M){return M.add.length||M.change.length}))&&!l)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),j.close(),u=j.version+1,l=!0,S(p());or(e,B)}catch{}ht.push(e),j.onversionchange=oe(function(M){t.vcFired=!0,e.on("versionchange").fire(M)}),j.onclose=oe(function(M){e.on("close").fire(M)}),y&&(D=e._deps,B=w,j=D.indexedDB,D=D.IDBKeyRange,nn(j)||B===Zt||rn(j,D).put({name:B}).catch(te)),S()},v)}).catch(function(S){switch(S==null?void 0:S.name){case"UnknownError":if(0<t.PR1398_maxLoop)return t.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),p();break;case"VersionError":if(0<u)return u=0,p()}return L.reject(S)})}var m,b=t.dbReadyResolve,N=null,y=!1;return L.race([s,(typeof navigator>"u"?L.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(S){function v(){return indexedDB.databases().finally(S)}m=setInterval(v,100),v()}).finally(function(){return clearInterval(m)}):Promise.resolve()).then(p)]).then(function(){return f(),t.onReadyBeingFired=[],L.resolve(on(function(){return e.on.ready.fire(e.vip)})).then(function S(){if(0<t.onReadyBeingFired.length){var v=t.onReadyBeingFired.reduce(Br,te);return t.onReadyBeingFired=[],L.resolve(on(function(){return v(e.vip)})).then(S)}})}).finally(function(){t.openCanceller===s&&(t.onReadyBeingFired=null,t.isBeingOpened=!1)}).catch(function(S){t.dbOpenError=S;try{N&&N.abort()}catch{}return s===t.openCanceller&&e._close(),ae(S)}).finally(function(){t.openComplete=!0,b()}).then(function(){var S;return y&&(S={},e.tables.forEach(function(v){v.schema.indexes.forEach(function(w){w.name&&(S["idb://".concat(e.name,"/").concat(v.name,"/").concat(w.name)]=new ye(-1/0,[[[]]]))}),S["idb://".concat(e.name,"/").concat(v.name,"/")]=S["idb://".concat(e.name,"/").concat(v.name,"/:dels")]=new ye(-1/0,[[[]]])}),Ke(Ct).fire(S),ln(S,!0)),e})}function dn(e){function t(l){return e.next(l)}var o=u(t),s=u(function(l){return e.throw(l)});function u(l){return function(m){var p=l(m),m=p.value;return p.done?m:m&&typeof m.then=="function"?m.then(o,s):g(m)?Promise.all(m).then(o,s):o(m)}}return u(t)()}function fr(e,t,o){for(var s=g(e)?e.slice():[e],u=0;u<o;++u)s.push(t);return s}var Bi={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return i(i({},e),{table:function(t){var o=e.table(t),s=o.schema,u={},l=[];function f(y,S,v){var w=Pt(y),_=u[w]=u[w]||[],I=y==null?0:typeof y=="string"?1:y.length,x=0<S,x=i(i({},v),{name:x?"".concat(w,"(virtual-from:").concat(v.name,")"):v.name,lowLevelIndex:v,isVirtual:x,keyTail:S,keyLength:I,extractKey:Zr(y),unique:!x&&v.unique});return _.push(x),x.isPrimaryKey||l.push(x),1<I&&f(I===2?y[0]:y.slice(0,I-1),S+1,v),_.sort(function(T,k){return T.keyTail-k.keyTail}),x}t=f(s.primaryKey.keyPath,0,s.primaryKey),u[":id"]=[t];for(var p=0,m=s.indexes;p<m.length;p++){var b=m[p];f(b.keyPath,0,b)}function N(y){var S,v=y.query.index;return v.isVirtual?i(i({},y),{query:{index:v.lowLevelIndex,range:(S=y.query.range,v=v.keyTail,{type:S.type===1?2:S.type,lower:fr(S.lower,S.lowerOpen?e.MAX_KEY:e.MIN_KEY,v),lowerOpen:!0,upper:fr(S.upper,S.upperOpen?e.MIN_KEY:e.MAX_KEY,v),upperOpen:!0})}}):y}return i(i({},o),{schema:i(i({},s),{primaryKey:t,indexes:l,getIndexByKeyPath:function(y){return(y=u[Pt(y)])&&y[0]}}),count:function(y){return o.count(N(y))},query:function(y){return o.query(N(y))},openCursor:function(y){var S=y.query.index,v=S.keyTail,w=S.isVirtual,_=S.keyLength;return w?o.openCursor(N(y)).then(function(x){return x&&I(x)}):o.openCursor(y);function I(x){return Object.create(x,{continue:{value:function(T){T!=null?x.continue(fr(T,y.reverse?e.MAX_KEY:e.MIN_KEY,v)):y.unique?x.continue(x.key.slice(0,_).concat(y.reverse?e.MIN_KEY:e.MAX_KEY,v)):x.continue()}},continuePrimaryKey:{value:function(T,k){x.continuePrimaryKey(fr(T,e.MAX_KEY,v),k)}},primaryKey:{get:function(){return x.primaryKey}},key:{get:function(){var T=x.key;return _===1?T[0]:T.slice(0,_)}},value:{get:function(){return x.value}}})}}})}})}};function fn(e,t,o,s){return o=o||{},s=s||"",h(e).forEach(function(u){var l,f,p;R(t,u)?(l=e[u],f=t[u],typeof l=="object"&&typeof f=="object"&&l&&f?(p=Cr(l))!==Cr(f)?o[s+u]=t[u]:p==="Object"?fn(l,f,o,s+u+"."):l!==f&&(o[s+u]=t[u]):l!==f&&(o[s+u]=t[u])):o[s+u]=void 0}),h(t).forEach(function(u){R(e,u)||(o[s+u]=t[u])}),o}function hn(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var Mi={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return i(i({},e),{table:function(t){var o=e.table(t),s=o.schema.primaryKey;return i(i({},o),{mutate:function(u){var l=V.trans,f=l.table(t).hook,p=f.deleting,m=f.creating,b=f.updating;switch(u.type){case"add":if(m.fire===te)break;return l._promise("readwrite",function(){return N(u)},!0);case"put":if(m.fire===te&&b.fire===te)break;return l._promise("readwrite",function(){return N(u)},!0);case"delete":if(p.fire===te)break;return l._promise("readwrite",function(){return N(u)},!0);case"deleteRange":if(p.fire===te)break;return l._promise("readwrite",function(){return(function y(S,v,w){return o.query({trans:S,values:!1,query:{index:s,range:v},limit:w}).then(function(_){var I=_.result;return N({type:"delete",keys:I,trans:S}).then(function(x){return 0<x.numFailures?Promise.reject(x.failures[0]):I.length<w?{failures:[],numFailures:0,lastResult:void 0}:y(S,i(i({},v),{lower:I[I.length-1],lowerOpen:!0}),w)})})})(u.trans,u.range,1e4)},!0)}return o.mutate(u);function N(y){var S,v,w,_=V.trans,I=y.keys||hn(s,y);if(!I)throw new Error("Keys missing");return(y=y.type==="add"||y.type==="put"?i(i({},y),{keys:I}):i({},y)).type!=="delete"&&(y.values=c([],y.values)),y.keys&&(y.keys=c([],y.keys)),S=o,w=I,((v=y).type==="add"?Promise.resolve([]):S.getMany({trans:v.trans,keys:w,cache:"immutable"})).then(function(x){var T=I.map(function(k,D){var j,F,B,M=x[D],K={onerror:null,onsuccess:null};return y.type==="delete"?p.fire.call(K,k,M,_):y.type==="add"||M===void 0?(j=m.fire.call(K,k,y.values[D],_),k==null&&j!=null&&(y.keys[D]=k=j,s.outbound||Ne(y.values[D],s.keyPath,k))):(j=fn(M,y.values[D]),(F=b.fire.call(K,j,k,M,_))&&(B=y.values[D],Object.keys(F).forEach(function(q){R(B,q)?B[q]=F[q]:Ne(B,q,F[q])}))),K});return o.mutate(y).then(function(k){for(var D=k.failures,j=k.results,F=k.numFailures,k=k.lastResult,B=0;B<I.length;++B){var M=(j||I)[B],K=T[B];M==null?K.onerror&&K.onerror(D[B]):K.onsuccess&&K.onsuccess(y.type==="put"&&x[B]?y.values[B]:M)}return{failures:D,results:j,numFailures:F,lastResult:k}}).catch(function(k){return T.forEach(function(D){return D.onerror&&D.onerror(k)}),Promise.reject(k)})})}}})}})}};function co(e,t,o){try{if(!t||t.keys.length<e.length)return null;for(var s=[],u=0,l=0;u<t.keys.length&&l<e.length;++u)X(t.keys[u],e[l])===0&&(s.push(o?Ue(t.values[u]):t.values[u]),++l);return s.length===e.length?s:null}catch{return null}}var Fi={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var o=e.table(t);return i(i({},o),{getMany:function(s){if(!s.cache)return o.getMany(s);var u=co(s.keys,s.trans._cache,s.cache==="clone");return u?L.resolve(u):o.getMany(s).then(function(l){return s.trans._cache={keys:s.keys,values:s.cache==="clone"?Ue(l):l},l})},mutate:function(s){return s.type!=="add"&&(s.trans._cache=null),o.mutate(s)}})}}}};function lo(e,t){return e.trans.mode==="readonly"&&!!e.subscr&&!e.trans.explicit&&e.trans.db._options.cache!=="disabled"&&!t.schema.primaryKey.outbound}function fo(e,t){switch(e){case"query":return t.values&&!t.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var qi={stack:"dbcore",level:0,name:"Observability",create:function(e){var t=e.schema.name,o=new ye(e.MIN_KEY,e.MAX_KEY);return i(i({},e),{transaction:function(s,u,l){if(V.subscr&&u!=="readonly")throw new W.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(V.querier));return e.transaction(s,u,l)},table:function(s){var u=e.table(s),l=u.schema,f=l.primaryKey,y=l.indexes,p=f.extractKey,m=f.outbound,b=f.autoIncrement&&y.filter(function(v){return v.compound&&v.keyPath.includes(f.keyPath)}),N=i(i({},u),{mutate:function(v){function w(q){return q="idb://".concat(t,"/").concat(s,"/").concat(q),k[q]||(k[q]=new ye)}var _,I,x,T=v.trans,k=v.mutatedParts||(v.mutatedParts={}),D=w(""),j=w(":dels"),F=v.type,K=v.type==="deleteRange"?[v.range]:v.type==="delete"?[v.keys]:v.values.length<50?[hn(f,v).filter(function(q){return q}),v.values]:[],B=K[0],M=K[1],K=v.trans._cache;return g(B)?(D.addKeys(B),(K=F==="delete"||B.length===M.length?co(B,K):null)||j.addKeys(B),(K||M)&&(_=w,I=K,x=M,l.indexes.forEach(function(q){var $=_(q.name||"");function G(Y){return Y!=null?q.extractKey(Y):null}function Q(Y){return q.multiEntry&&g(Y)?Y.forEach(function(se){return $.addKey(se)}):$.addKey(Y)}(I||x).forEach(function(Y,me){var H=I&&G(I[me]),me=x&&G(x[me]);X(H,me)!==0&&(H!=null&&Q(H),me!=null&&Q(me))})}))):B?(M={from:(M=B.lower)!==null&&M!==void 0?M:e.MIN_KEY,to:(M=B.upper)!==null&&M!==void 0?M:e.MAX_KEY},j.add(M),D.add(M)):(D.add(o),j.add(o),l.indexes.forEach(function(q){return w(q.name).add(o)})),u.mutate(v).then(function(q){return!B||v.type!=="add"&&v.type!=="put"||(D.addKeys(q.results),b&&b.forEach(function($){for(var G=v.values.map(function(H){return $.extractKey(H)}),Q=$.keyPath.findIndex(function(H){return H===f.keyPath}),Y=0,se=q.results.length;Y<se;++Y)G[Y][Q]=q.results[Y];w($.name).addKeys(G)})),T.mutatedParts=lr(T.mutatedParts||{},k),q})}}),y=function(w){var _=w.query,w=_.index,_=_.range;return[w,new ye((w=_.lower)!==null&&w!==void 0?w:e.MIN_KEY,(_=_.upper)!==null&&_!==void 0?_:e.MAX_KEY)]},S={get:function(v){return[f,new ye(v.key)]},getMany:function(v){return[f,new ye().addKeys(v.keys)]},count:y,query:y,openCursor:y};return h(S).forEach(function(v){N[v]=function(w){var _=V.subscr,I=!!_,x=lo(V,u)&&fo(v,w)?w.obsSet={}:_;if(I){var T=function(M){return M="idb://".concat(t,"/").concat(s,"/").concat(M),x[M]||(x[M]=new ye)},k=T(""),D=T(":dels"),_=S[v](w),I=_[0],_=_[1];if((v==="query"&&I.isPrimaryKey&&!w.values?D:T(I.name||"")).add(_),!I.isPrimaryKey){if(v!=="count"){var j=v==="query"&&m&&w.values&&u.query(i(i({},w),{values:!1}));return u[v].apply(this,arguments).then(function(M){if(v==="query"){if(m&&w.values)return j.then(function(G){return G=G.result,k.addKeys(G),M});var K=w.values?M.result.map(p):M.result;(w.values?k:D).addKeys(K)}else if(v==="openCursor"){var q=M,$=w.values;return q&&Object.create(q,{key:{get:function(){return D.addKey(q.primaryKey),q.key}},primaryKey:{get:function(){var G=q.primaryKey;return D.addKey(G),G}},value:{get:function(){return $&&k.addKey(q.primaryKey),q.value}}})}return M})}D.add(o)}}return u[v].apply(this,arguments)}}),N}})}};function ho(e,t,o){if(o.numFailures===0)return t;if(t.type==="deleteRange")return null;var s=t.keys?t.keys.length:"values"in t&&t.values?t.values.length:1;return o.numFailures===s?null:(t=i({},t),g(t.keys)&&(t.keys=t.keys.filter(function(u,l){return!(l in o.failures)})),"values"in t&&g(t.values)&&(t.values=t.values.filter(function(u,l){return!(l in o.failures)})),t)}function pn(e,t){return o=e,((s=t).lower===void 0||(s.lowerOpen?0<X(o,s.lower):0<=X(o,s.lower)))&&(e=e,(t=t).upper===void 0||(t.upperOpen?X(e,t.upper)<0:X(e,t.upper)<=0));var o,s}function po(e,t,S,s,u,l){if(!S||S.length===0)return e;var f=t.query.index,p=f.multiEntry,m=t.query.range,b=s.schema.primaryKey.extractKey,N=f.extractKey,y=(f.lowLevelIndex||f).extractKey,S=S.reduce(function(v,w){var _=v,I=[];if(w.type==="add"||w.type==="put")for(var x=new ye,T=w.values.length-1;0<=T;--T){var k,D=w.values[T],j=b(D);x.hasKey(j)||(k=N(D),(p&&g(k)?k.some(function(q){return pn(q,m)}):pn(k,m))&&(x.addKey(j),I.push(D)))}switch(w.type){case"add":var F=new ye().addKeys(t.values?v.map(function($){return b($)}):v),_=v.concat(t.values?I.filter(function($){return $=b($),!F.hasKey($)&&(F.addKey($),!0)}):I.map(function($){return b($)}).filter(function($){return!F.hasKey($)&&(F.addKey($),!0)}));break;case"put":var B=new ye().addKeys(w.values.map(function($){return b($)}));_=v.filter(function($){return!B.hasKey(t.values?b($):$)}).concat(t.values?I:I.map(function($){return b($)}));break;case"delete":var M=new ye().addKeys(w.keys);_=v.filter(function($){return!M.hasKey(t.values?b($):$)});break;case"deleteRange":var K=w.range;_=v.filter(function($){return!pn(b($),K)})}return _},e);return S===e?e:(S.sort(function(v,w){return X(y(v),y(w))||X(b(v),b(w))}),t.limit&&t.limit<1/0&&(S.length>t.limit?S.length=t.limit:e.length===t.limit&&S.length<t.limit&&(u.dirty=!0)),l?Object.freeze(S):S)}function yo(e,t){return X(e.lower,t.lower)===0&&X(e.upper,t.upper)===0&&!!e.lowerOpen==!!t.lowerOpen&&!!e.upperOpen==!!t.upperOpen}function Ki(e,t){return(function(o,s,u,l){if(o===void 0)return s!==void 0?-1:0;if(s===void 0)return 1;if((s=X(o,s))===0){if(u&&l)return 0;if(u)return 1;if(l)return-1}return s})(e.lower,t.lower,e.lowerOpen,t.lowerOpen)<=0&&0<=(function(o,s,u,l){if(o===void 0)return s!==void 0?1:0;if(s===void 0)return-1;if((s=X(o,s))===0){if(u&&l)return 0;if(u)return-1;if(l)return 1}return s})(e.upper,t.upper,e.upperOpen,t.upperOpen)}function Li(e,t,o,s){e.subscribers.add(o),s.addEventListener("abort",function(){var u,l;e.subscribers.delete(o),e.subscribers.size===0&&(u=e,l=t,setTimeout(function(){u.subscribers.size===0&&Ve(l,u)},3e3))})}var $i={stack:"dbcore",level:0,name:"Cache",create:function(e){var t=e.schema.name;return i(i({},e),{transaction:function(o,s,u){var l,f,p=e.transaction(o,s,u);return s==="readwrite"&&(f=(l=new AbortController).signal,u=function(m){return function(){if(l.abort(),s==="readwrite"){for(var b=new Set,N=0,y=o;N<y.length;N++){var S=y[N],v=Je["idb://".concat(t,"/").concat(S)];if(v){var w=e.table(S),_=v.optimisticOps.filter(function($){return $.trans===p});if(p._explicit&&m&&p.mutatedParts)for(var I=0,x=Object.values(v.queries.query);I<x.length;I++)for(var T=0,k=(F=x[I]).slice();T<k.length;T++)an((B=k[T]).obsSet,p.mutatedParts)&&(Ve(F,B),B.subscribers.forEach(function($){return b.add($)}));else if(0<_.length){v.optimisticOps=v.optimisticOps.filter(function($){return $.trans!==p});for(var D=0,j=Object.values(v.queries.query);D<j.length;D++)for(var F,B,M,K=0,q=(F=j[D]).slice();K<q.length;K++)(B=q[K]).res!=null&&p.mutatedParts&&(m&&!B.dirty?(M=Object.isFrozen(B.res),M=po(B.res,B.req,_,w,B,M),B.dirty?(Ve(F,B),B.subscribers.forEach(function($){return b.add($)})):M!==B.res&&(B.res=M,B.promise=L.resolve({result:M}))):(B.dirty&&Ve(F,B),B.subscribers.forEach(function($){return b.add($)})))}}}b.forEach(function($){return $()})}}},p.addEventListener("abort",u(!1),{signal:f}),p.addEventListener("error",u(!1),{signal:f}),p.addEventListener("complete",u(!0),{signal:f})),p},table:function(o){var s=e.table(o),u=s.schema.primaryKey;return i(i({},s),{mutate:function(l){var f=V.trans;if(u.outbound||f.db._options.cache==="disabled"||f.explicit||f.idbtrans.mode!=="readwrite")return s.mutate(l);var p=Je["idb://".concat(t,"/").concat(o)];return p?(f=s.mutate(l),l.type!=="add"&&l.type!=="put"||!(50<=l.values.length||hn(u,l).some(function(m){return m==null}))?(p.optimisticOps.push(l),l.mutatedParts&&dr(l.mutatedParts),f.then(function(m){0<m.numFailures&&(Ve(p.optimisticOps,l),(m=ho(0,l,m))&&p.optimisticOps.push(m),l.mutatedParts&&dr(l.mutatedParts))}),f.catch(function(){Ve(p.optimisticOps,l),l.mutatedParts&&dr(l.mutatedParts)})):f.then(function(m){var b=ho(0,i(i({},l),{values:l.values.map(function(N,y){var S;return m.failures[y]?N:(N=(S=u.keyPath)!==null&&S!==void 0&&S.includes(".")?Ue(N):i({},N),Ne(N,u.keyPath,m.results[y]),N)})}),m);p.optimisticOps.push(b),queueMicrotask(function(){return l.mutatedParts&&dr(l.mutatedParts)})}),f):s.mutate(l)},query:function(l){if(!lo(V,s)||!fo("query",l))return s.query(l);var f=((b=V.trans)===null||b===void 0?void 0:b.db._options.cache)==="immutable",y=V,p=y.requery,m=y.signal,b=(function(w,_,I,x){var T=Je["idb://".concat(w,"/").concat(_)];if(!T)return[];if(!(_=T.queries[I]))return[null,!1,T,null];var k=_[(x.query?x.query.index.name:null)||""];if(!k)return[null,!1,T,null];switch(I){case"query":var D=k.find(function(j){return j.req.limit===x.limit&&j.req.values===x.values&&yo(j.req.query.range,x.query.range)});return D?[D,!0,T,k]:[k.find(function(j){return("limit"in j.req?j.req.limit:1/0)>=x.limit&&(!x.values||j.req.values)&&Ki(j.req.query.range,x.query.range)}),!1,T,k];case"count":return D=k.find(function(j){return yo(j.req.query.range,x.query.range)}),[D,!!D,T,k]}})(t,o,"query",l),N=b[0],y=b[1],S=b[2],v=b[3];return N&&y?N.obsSet=l.obsSet:(y=s.query(l).then(function(w){var _=w.result;if(N&&(N.res=_),f){for(var I=0,x=_.length;I<x;++I)Object.freeze(_[I]);Object.freeze(_)}else w.result=Ue(_);return w}).catch(function(w){return v&&N&&Ve(v,N),Promise.reject(w)}),N={obsSet:l.obsSet,promise:y,subscribers:new Set,type:"query",req:l,dirty:!1},v?v.push(N):(v=[N],(S=S||(Je["idb://".concat(t,"/").concat(o)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[l.query.index.name||""]=v)),Li(N,v,p,m),N.promise.then(function(w){return{result:po(w.result,l,S==null?void 0:S.optimisticOps,s,N,f)}})}})}})}};function hr(e,t){return new Proxy(e,{get:function(o,s,u){return s==="db"?t:Reflect.get(o,s,u)}})}var Pe=(ue.prototype.version=function(e){if(isNaN(e)||e<.1)throw new W.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new W.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,o=t.filter(function(s){return s._cfg.version===e})[0];return o||(o=new this.Version(e),t.push(o),t.sort(Ai),o.stores({}),this._state.autoSchema=!1,o)},ue.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||V.letThrough||this._vip)?e():new L(function(o,s){if(t._state.openComplete)return s(new W.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._state.autoOpen)return void s(new W.DatabaseClosed);t.open().catch(te)}t._state.dbReadyPromise.then(o,s)}).then(e)},ue.prototype.use=function(e){var t=e.stack,o=e.create,s=e.level,u=e.name;return u&&this.unuse({stack:t,name:u}),e=this._middlewares[t]||(this._middlewares[t]=[]),e.push({stack:t,create:o,level:s??10,name:u}),e.sort(function(l,f){return l.level-f.level}),this},ue.prototype.unuse=function(e){var t=e.stack,o=e.name,s=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(u){return s?u.create!==s:!!o&&u.name!==o})),this},ue.prototype.open=function(){var e=this;return Xe(je,function(){return ji(e)})},ue.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var e=this._state,t=ht.indexOf(this);if(0<=t&&ht.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}e.isBeingOpened||(e.dbReadyPromise=new L(function(o){e.dbReadyResolve=o}),e.openCanceller=new L(function(o,s){e.cancelOpen=s}))},ue.prototype.close=function(o){var t=(o===void 0?{disableAutoOpen:!0}:o).disableAutoOpen,o=this._state;t?(o.isBeingOpened&&o.cancelOpen(new W.DatabaseClosed),this._close(),o.autoOpen=!1,o.dbOpenError=new W.DatabaseClosed):(this._close(),o.autoOpen=this._options.autoOpen||o.isBeingOpened,o.openComplete=!1,o.dbOpenError=null)},ue.prototype.delete=function(e){var t=this;e===void 0&&(e={disableAutoOpen:!0});var o=0<arguments.length&&typeof arguments[0]!="object",s=this._state;return new L(function(u,l){function f(){t.close(e);var p=t._deps.indexedDB.deleteDatabase(t.name);p.onsuccess=oe(function(){var m,b,N;m=t._deps,b=t.name,N=m.indexedDB,m=m.IDBKeyRange,nn(N)||b===Zt||rn(N,m).delete(b).catch(te),u()}),p.onerror=ke(l),p.onblocked=t._fireOnBlocked}if(o)throw new W.InvalidArgument("Invalid closeOptions argument to db.delete()");s.isBeingOpened?s.dbReadyPromise.then(f):f()})},ue.prototype.backendDB=function(){return this.idbdb},ue.prototype.isOpen=function(){return this.idbdb!==null},ue.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},ue.prototype.hasFailed=function(){return this._state.dbOpenError!==null},ue.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(ue.prototype,"tables",{get:function(){var e=this;return h(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),ue.prototype.transaction=function(){var e=(function(t,o,s){var u=arguments.length;if(u<2)throw new W.InvalidArgument("Too few arguments");for(var l=new Array(u-1);--u;)l[u-1]=arguments[u];return s=l.pop(),[t,Rn(l),s]}).apply(this,arguments);return this._transaction.apply(this,e)},ue.prototype._transaction=function(e,t,o){var s=this,u=V.trans;u&&u.db===this&&e.indexOf("!")===-1||(u=null);var l,f,p=e.indexOf("?")!==-1;e=e.replace("!","").replace("?","");try{if(f=t.map(function(b){if(b=b instanceof s.Table?b.name:b,typeof b!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return b}),e=="r"||e===Wr)l=Wr;else{if(e!="rw"&&e!=zr)throw new W.InvalidArgument("Invalid transaction mode: "+e);l=zr}if(u){if(u.mode===Wr&&l===zr){if(!p)throw new W.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");u=null}u&&f.forEach(function(b){if(u&&u.storeNames.indexOf(b)===-1){if(!p)throw new W.SubTransaction("Table "+b+" not included in parent transaction.");u=null}}),p&&u&&!u.active&&(u=null)}}catch(b){return u?u._promise(null,function(N,y){y(b)}):ae(b)}var m=(function b(N,y,S,v,w){return L.resolve().then(function(){var _=V.transless||V,I=N._createTransaction(y,S,N._dbSchema,v);if(I.explicit=!0,_={trans:I,transless:_},v)I.idbtrans=v.idbtrans;else try{I.create(),I.idbtrans._explicit=!0,N._state.PR1398_maxLoop=3}catch(k){return k.name===jr.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return b(N,y,S,null,w)})):ae(k)}var x,T=Pr(w);return T&&ft(),_=L.follow(function(){var k;(x=w.call(I,I))&&(T?(k=Me.bind(null,null),x.then(k,k)):typeof x.next=="function"&&typeof x.throw=="function"&&(x=dn(x)))},_),(x&&typeof x.then=="function"?L.resolve(x).then(function(k){return I.active?k:ae(new W.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):_.then(function(){return x})).then(function(k){return v&&I._resolve(),I._completion.then(function(){return k})}).catch(function(k){return I._reject(k),ae(k)})})}).bind(null,this,l,f,u,o);return u?u._promise(l,m,"lock"):V.trans?Xe(V.transless,function(){return s._whenReady(m)}):this._whenReady(m)},ue.prototype.table=function(e){if(!R(this._allTables,e))throw new W.InvalidTable("Table ".concat(e," does not exist"));return this._allTables[e]},ue);function ue(e,t){var o=this;this._middlewares={},this.verno=0;var s=ue.dependencies;this._options=t=i({addons:ue.addons,autoOpen:!0,indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange,cache:"cloned"},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange},s=t.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var u,l,f,p,m,b={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:te,dbReadyPromise:null,cancelOpen:te,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:t.autoOpen};b.dbReadyPromise=new L(function(y){b.dbReadyResolve=y}),b.openCanceller=new L(function(y,S){b.cancelOpen=S}),this._state=b,this.name=e,this.on=Tt(this,"populate","blocked","versionchange","close",{ready:[Br,te]}),this.once=function(y,S){var v=function(){for(var w=[],_=0;_<arguments.length;_++)w[_]=arguments[_];o.on(y).unsubscribe(v),S.apply(o,w)};return o.on(y,v)},this.on.ready.subscribe=ce(this.on.ready.subscribe,function(y){return function(S,v){ue.vip(function(){var w,_=o._state;_.openComplete?(_.dbOpenError||L.resolve().then(S),v&&y(S)):_.onReadyBeingFired?(_.onReadyBeingFired.push(S),v&&y(S)):(y(S),w=o,v||y(function I(){w.on.ready.unsubscribe(S),w.on.ready.unsubscribe(I)}))})}}),this.Collection=(u=this,kt(Si.prototype,function(x,I){this.db=u;var v=Vn,w=null;if(I)try{v=I()}catch(T){w=T}var _=x._ctx,I=_.table,x=I.hook.reading.fire;this._ctx={table:I,index:_.index,isPrimKey:!_.index||I.schema.primKey.keyPath&&_.index===I.schema.primKey.name,range:v,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:w,or:_.or,valueMapper:x!==_t?x:null}})),this.Table=(l=this,kt(Yn.prototype,function(y,S,v){this.db=l,this._tx=v,this.name=y,this.schema=S,this.hook=l._allTables[y]?l._allTables[y].hook:Tt(null,{creating:[yi,te],reading:[pi,_t],updating:[vi,te],deleting:[mi,te]})})),this.Transaction=(f=this,kt(Oi.prototype,function(y,S,v,w,_){var I=this;y!=="readonly"&&S.forEach(function(x){x=(x=v[x])===null||x===void 0?void 0:x.yProps,x&&(S=S.concat(x.map(function(T){return T.updatesTable})))}),this.db=f,this.mode=y,this.storeNames=S,this.schema=v,this.chromeTransactionDurability=w,this.idbtrans=null,this.on=Tt(this,"complete","error","abort"),this.parent=_||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new L(function(x,T){I._resolve=x,I._reject=T}),this._completion.then(function(){I.active=!1,I.on.complete.fire()},function(x){var T=I.active;return I.active=!1,I.on.error.fire(x),I.parent?I.parent._reject(x):T&&I.idbtrans&&I.idbtrans.abort(),ae(x)})})),this.Version=(p=this,kt(Pi.prototype,function(y){this.db=p,this._cfg={version:y,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(m=this,kt(eo.prototype,function(y,S,v){if(this.db=m,this._ctx={table:y,index:S===":id"?null:S,or:v},this._cmp=this._ascending=X,this._descending=function(w,_){return X(_,w)},this._max=function(w,_){return 0<X(w,_)?w:_},this._min=function(w,_){return X(w,_)<0?w:_},this._IDBKeyRange=m._deps.IDBKeyRange,!this._IDBKeyRange)throw new W.MissingAPI})),this.on("versionchange",function(y){0<y.newVersion?console.warn("Another connection wants to upgrade database '".concat(o.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(o.name,"'. Closing db now to resume the delete request.")),o.close({disableAutoOpen:!1})}),this.on("blocked",function(y){!y.newVersion||y.newVersion<y.oldVersion?console.warn("Dexie.delete('".concat(o.name,"') was blocked")):console.warn("Upgrade '".concat(o.name,"' blocked by other connection holding version ").concat(y.oldVersion/10))}),this._maxKey=Rt(t.IDBKeyRange),this._createTransaction=function(y,S,v,w){return new o.Transaction(y,S,v,o._options.chromeTransactionDurability,w)},this._fireOnBlocked=function(y){o.on("blocked").fire(y),ht.filter(function(S){return S.name===o.name&&S!==o&&!S._state.vcFired}).map(function(S){return S.on("versionchange").fire(y)})},this.use(Fi),this.use($i),this.use(qi),this.use(Bi),this.use(Mi);var N=new Proxy(this,{get:function(y,S,v){if(S==="_vip")return!0;if(S==="table")return function(_){return hr(o.table(_),N)};var w=Reflect.get(y,S,v);return w instanceof Yn?hr(w,N):S==="tables"?w.map(function(_){return hr(_,N)}):S==="_createTransaction"?function(){return hr(w.apply(this,arguments),N)}:w}});this.vip=N,s.forEach(function(y){return y(o)})}var pr,Se=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Ui=(yn.prototype.subscribe=function(e,t,o){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:o})},yn.prototype[Se]=function(){return this},yn);function yn(e){this._subscribe=e}try{pr={indexedDB:d.indexedDB||d.mozIndexedDB||d.webkitIndexedDB||d.msIndexedDB,IDBKeyRange:d.IDBKeyRange||d.webkitIDBKeyRange}}catch{pr={indexedDB:null,IDBKeyRange:null}}function mo(e){var t,o=!1,s=new Ui(function(u){var l=Pr(e),f,p=!1,m={},b={},N={get closed(){return p},unsubscribe:function(){p||(p=!0,f&&f.abort(),y&&Ke.storagemutated.unsubscribe(v))}};u.start&&u.start(N);var y=!1,S=function(){return Vr(w)},v=function(_){lr(m,_),an(b,m)&&S()},w=function(){var _,I,x;!p&&pr.indexedDB&&(m={},_={},f&&f.abort(),f=new AbortController,x=(function(T){var k=lt();try{l&&ft();var D=Be(e,T);return D=l?D.finally(Me):D}finally{k&&dt()}})(I={subscr:_,signal:f.signal,requery:S,querier:e,trans:null}),Promise.resolve(x).then(function(T){o=!0,t=T,p||I.signal.aborted||(m={},(function(k){for(var D in k)if(R(k,D))return;return 1})(b=_)||y||(Ke(Ct,v),y=!0),Vr(function(){return!p&&u.next&&u.next(T)}))},function(T){o=!1,["DatabaseClosedError","AbortError"].includes(T==null?void 0:T.name)||p||Vr(function(){p||u.error&&u.error(T)})}))};return setTimeout(S,0),N});return s.hasValue=function(){return o},s.getValue=function(){return t},s}var et=Pe;function mn(e){var t=Le;try{Le=!0,Ke.storagemutated.fire(e),ln(e,!0)}finally{Le=t}}C(et,i(i({},Ut),{delete:function(e){return new et(e,{addons:[]}).delete()},exists:function(e){return new et(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return t=et.dependencies,o=t.indexedDB,t=t.IDBKeyRange,(nn(o)?Promise.resolve(o.databases()).then(function(s){return s.map(function(u){return u.name}).filter(function(u){return u!==Zt})}):rn(o,t).toCollection().primaryKeys()).then(e)}catch{return ae(new W.MissingAPI)}var t,o},defineClass:function(){return function(e){O(this,e)}},ignoreTransaction:function(e){return V.trans?Xe(V.transless,e):e()},vip:on,async:function(e){return function(){try{var t=dn(e.apply(this,arguments));return t&&typeof t.then=="function"?t:L.resolve(t)}catch(o){return ae(o)}}},spawn:function(e,t,o){try{var s=dn(e.apply(o,t||[]));return s&&typeof s.then=="function"?s:L.resolve(s)}catch(u){return ae(u)}},currentTransaction:{get:function(){return V.trans||null}},waitFor:function(e,t){return t=L.resolve(typeof e=="function"?et.ignoreTransaction(e):e).timeout(t||6e4),V.trans?V.trans.waitFor(t):t},Promise:L,debug:{get:function(){return Te},set:function(e){Mn(e)}},derive:z,extend:O,props:C,override:ce,Events:Tt,on:Ke,liveQuery:mo,extendObservabilitySet:lr,getByKeyPath:pe,setByKeyPath:Ne,delByKeyPath:function(e,t){typeof t=="string"?Ne(e,t,void 0):"length"in t&&[].map.call(t,function(o){Ne(e,o,void 0)})},shallowClone:Cn,deepClone:Ue,getObjectDiff:fn,cmp:X,asap:be,minKey:-1/0,addons:[],connections:ht,errnames:jr,dependencies:pr,cache:Je,semVer:"4.2.0",version:"4.2.0".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,o){return e+t/Math.pow(10,2*o)})})),et.maxKey=Rt(et.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Ke(Ct,function(e){Le||(e=new CustomEvent(Gr,{detail:e}),Le=!0,dispatchEvent(e),Le=!1)}),addEventListener(Gr,function(e){e=e.detail,Le||mn(e)}));var vt,Le=!1,vo=function(){};return typeof BroadcastChannel<"u"&&((vo=function(){(vt=new BroadcastChannel(Gr)).onmessage=function(e){return e.data&&mn(e.data)}})(),typeof vt.unref=="function"&&vt.unref(),Ke(Ct,function(e){Le||vt.postMessage(e)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(e){if(!Pe.disableBfCache&&e.persisted){Te&&console.debug("Dexie: handling persisted pagehide"),vt!=null&&vt.close();for(var t=0,o=ht;t<o.length;t++)o[t].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(e){!Pe.disableBfCache&&e.persisted&&(Te&&console.debug("Dexie: handling persisted pageshow"),vo(),mn({all:new ye(-1/0,[[]])}))})),L.rejectionMapper=function(e,t){return!e||e instanceof ut||e instanceof TypeError||e instanceof SyntaxError||!e.name||!Bn[e.name]?e:(t=new Bn[e.name](t||e.message,e),"stack"in e&&U(t,"stack",{get:function(){return this.inner.stack}}),t)},Mn(Te),i(Pe,Object.freeze({__proto__:null,Dexie:Pe,liveQuery:mo,Entity:Wn,cmp:X,PropModification:Dt,replacePrefix:function(e,t){return new Dt({replacePrefix:[e,t]})},add:function(e){return new Dt({add:e})},remove:function(e){return new Dt({remove:e})},default:Pe,RangeSet:ye,mergeRanges:Bt,rangesOverlap:io}),{default:Pe}),Pe})})(Ir)),Ir.exports}var ys=ps(),xn=fs(ys);const wo=Symbol.for("Dexie"),Ft=globalThis[wo]||(globalThis[wo]=xn);if(xn.semVer!==Ft.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${xn.semVer} and ${Ft.semVer}`);const{liveQuery:pa,mergeRanges:ya,rangesOverlap:ma,RangeSet:va,cmp:ga,Entity:ba,PropModification:wa,replacePrefix:Na,add:Ia,remove:_a,DexieYProvider:Sa}=Ft;var En=function(a,r){return En=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var c in i)Object.prototype.hasOwnProperty.call(i,c)&&(n[c]=i[c])},En(a,r)};function Lt(a,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");En(a,r);function n(){this.constructor=a}a.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}function ms(a,r,n,i){function c(d){return d instanceof n?d:new n(function(h){h(d)})}return new(n||(n=Promise))(function(d,h){function g(A){try{E(i.next(A))}catch(R){h(R)}}function O(A){try{E(i.throw(A))}catch(R){h(R)}}function E(A){A.done?d(A.value):c(A.value).then(g,O)}E((i=i.apply(a,r||[])).next())})}function Lo(a,r){var n={label:0,sent:function(){if(d[0]&1)throw d[1];return d[1]},trys:[],ops:[]},i,c,d,h=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return h.next=g(0),h.throw=g(1),h.return=g(2),typeof Symbol=="function"&&(h[Symbol.iterator]=function(){return this}),h;function g(E){return function(A){return O([E,A])}}function O(E){if(i)throw new TypeError("Generator is already executing.");for(;h&&(h=0,E[0]&&(n=0)),n;)try{if(i=1,c&&(d=E[0]&2?c.return:E[0]?c.throw||((d=c.return)&&d.call(c),0):c.next)&&!(d=d.call(c,E[1])).done)return d;switch(c=0,d&&(E=[E[0]&2,d.value]),E[0]){case 0:case 1:d=E;break;case 4:return n.label++,{value:E[1],done:!1};case 5:n.label++,c=E[1],E=[0];continue;case 7:E=n.ops.pop(),n.trys.pop();continue;default:if(d=n.trys,!(d=d.length>0&&d[d.length-1])&&(E[0]===6||E[0]===2)){n=0;continue}if(E[0]===3&&(!d||E[1]>d[0]&&E[1]<d[3])){n.label=E[1];break}if(E[0]===6&&n.label<d[1]){n.label=d[1],d=E;break}if(d&&n.label<d[2]){n.label=d[2],n.ops.push(E);break}d[2]&&n.ops.pop(),n.trys.pop();continue}E=r.call(a,n)}catch(A){E=[6,A],c=0}finally{i=d=0}if(E[0]&5)throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}}function Nt(a){var r=typeof Symbol=="function"&&Symbol.iterator,n=r&&a[r],i=0;if(n)return n.call(a);if(a&&typeof a.length=="number")return{next:function(){return a&&i>=a.length&&(a=void 0),{value:a&&a[i++],done:!a}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}function Tr(a,r){var n=typeof Symbol=="function"&&a[Symbol.iterator];if(!n)return a;var i=n.call(a),c,d=[],h;try{for(;(r===void 0||r-- >0)&&!(c=i.next()).done;)d.push(c.value)}catch(g){h={error:g}}finally{try{c&&!c.done&&(n=i.return)&&n.call(i)}finally{if(h)throw h.error}}return d}function kr(a,r,n){if(n||arguments.length===2)for(var i=0,c=r.length,d;i<c;i++)(d||!(i in r))&&(d||(d=Array.prototype.slice.call(r,0,i)),d[i]=r[i]);return a.concat(d||Array.prototype.slice.call(r))}function wt(a){return this instanceof wt?(this.v=a,this):new wt(a)}function vs(a,r,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n.apply(a,r||[]),c,d=[];return c=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),g("next"),g("throw"),g("return",h),c[Symbol.asyncIterator]=function(){return this},c;function h(P){return function(U){return Promise.resolve(U).then(P,R)}}function g(P,U){i[P]&&(c[P]=function(z){return new Promise(function(ee,ie){d.push([P,z,ee,ie])>1||O(P,z)})},U&&(c[P]=U(c[P])))}function O(P,U){try{E(i[P](U))}catch(z){C(d[0][3],z)}}function E(P){P.value instanceof wt?Promise.resolve(P.value.v).then(A,R):C(d[0][2],P)}function A(P){O("next",P)}function R(P){O("throw",P)}function C(P,U){P(U),d.shift(),d.length&&O(d[0][0],d[0][1])}}function gs(a){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=a[Symbol.asyncIterator],n;return r?r.call(a):(a=typeof Nt=="function"?Nt(a):a[Symbol.iterator](),n={},i("next"),i("throw"),i("return"),n[Symbol.asyncIterator]=function(){return this},n);function i(d){n[d]=a[d]&&function(h){return new Promise(function(g,O){h=a[d](h),c(g,O,h.done,h.value)})}}function c(d,h,g,O){Promise.resolve(O).then(function(E){d({value:E,done:g})},h)}}function le(a){return typeof a=="function"}function $o(a){var r=function(i){Error.call(i),i.stack=new Error().stack},n=a(r);return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}var bn=$o(function(a){return function(n){a(this),this.message=n?n.length+` errors occurred during unsubscription:
`+n.map(function(i,c){return c+1+") "+i.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=n}});function On(a,r){if(a){var n=a.indexOf(r);0<=n&&a.splice(n,1)}}var Ar=(function(){function a(r){this.initialTeardown=r,this.closed=!1,this._parentage=null,this._finalizers=null}return a.prototype.unsubscribe=function(){var r,n,i,c,d;if(!this.closed){this.closed=!0;var h=this._parentage;if(h)if(this._parentage=null,Array.isArray(h))try{for(var g=Nt(h),O=g.next();!O.done;O=g.next()){var E=O.value;E.remove(this)}}catch(z){r={error:z}}finally{try{O&&!O.done&&(n=g.return)&&n.call(g)}finally{if(r)throw r.error}}else h.remove(this);var A=this.initialTeardown;if(le(A))try{A()}catch(z){d=z instanceof bn?z.errors:[z]}var R=this._finalizers;if(R){this._finalizers=null;try{for(var C=Nt(R),P=C.next();!P.done;P=C.next()){var U=P.value;try{No(U)}catch(z){d=d??[],z instanceof bn?d=kr(kr([],Tr(d)),Tr(z.errors)):d.push(z)}}}catch(z){i={error:z}}finally{try{P&&!P.done&&(c=C.return)&&c.call(C)}finally{if(i)throw i.error}}}if(d)throw new bn(d)}},a.prototype.add=function(r){var n;if(r&&r!==this)if(this.closed)No(r);else{if(r instanceof a){if(r.closed||r._hasParent(this))return;r._addParent(this)}(this._finalizers=(n=this._finalizers)!==null&&n!==void 0?n:[]).push(r)}},a.prototype._hasParent=function(r){var n=this._parentage;return n===r||Array.isArray(n)&&n.includes(r)},a.prototype._addParent=function(r){var n=this._parentage;this._parentage=Array.isArray(n)?(n.push(r),n):n?[n,r]:r},a.prototype._removeParent=function(r){var n=this._parentage;n===r?this._parentage=null:Array.isArray(n)&&On(n,r)},a.prototype.remove=function(r){var n=this._finalizers;n&&On(n,r),r instanceof a&&r._removeParent(this)},a.EMPTY=(function(){var r=new a;return r.closed=!0,r})(),a})(),Uo=Ar.EMPTY;function Vo(a){return a instanceof Ar||a&&"closed"in a&&le(a.remove)&&le(a.add)&&le(a.unsubscribe)}function No(a){le(a)?a():a.unsubscribe()}var bs={Promise:void 0},ws={setTimeout:function(a,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setTimeout.apply(void 0,kr([a,r],Tr(n)))},clearTimeout:function(a){return clearTimeout(a)},delegate:void 0};function Wo(a){ws.setTimeout(function(){throw a})}function Io(){}function _r(a){a()}var Dn=(function(a){Lt(r,a);function r(n){var i=a.call(this)||this;return i.isStopped=!1,n?(i.destination=n,Vo(n)&&n.add(i)):i.destination=_s,i}return r.create=function(n,i,c){return new qt(n,i,c)},r.prototype.next=function(n){this.isStopped||this._next(n)},r.prototype.error=function(n){this.isStopped||(this.isStopped=!0,this._error(n))},r.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},r.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,a.prototype.unsubscribe.call(this),this.destination=null)},r.prototype._next=function(n){this.destination.next(n)},r.prototype._error=function(n){try{this.destination.error(n)}finally{this.unsubscribe()}},r.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},r})(Ar),Ns=(function(){function a(r){this.partialObserver=r}return a.prototype.next=function(r){var n=this.partialObserver;if(n.next)try{n.next(r)}catch(i){gr(i)}},a.prototype.error=function(r){var n=this.partialObserver;if(n.error)try{n.error(r)}catch(i){gr(i)}else gr(r)},a.prototype.complete=function(){var r=this.partialObserver;if(r.complete)try{r.complete()}catch(n){gr(n)}},a})(),qt=(function(a){Lt(r,a);function r(n,i,c){var d=a.call(this)||this,h;return le(n)||!n?h={next:n??void 0,error:i??void 0,complete:c??void 0}:h=n,d.destination=new Ns(h),d}return r})(Dn);function gr(a){Wo(a)}function Is(a){throw a}var _s={closed:!0,next:Io,error:Is,complete:Io},An=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function zo(a){return a}function Ss(a){return a.length===0?zo:a.length===1?a[0]:function(n){return a.reduce(function(i,c){return c(i)},n)}}var Oe=(function(){function a(r){r&&(this._subscribe=r)}return a.prototype.lift=function(r){var n=new a;return n.source=this,n.operator=r,n},a.prototype.subscribe=function(r,n,i){var c=this,d=Es(r)?r:new qt(r,n,i);return _r(function(){var h=c,g=h.operator,O=h.source;d.add(g?g.call(d,O):O?c._subscribe(d):c._trySubscribe(d))}),d},a.prototype._trySubscribe=function(r){try{return this._subscribe(r)}catch(n){r.error(n)}},a.prototype.forEach=function(r,n){var i=this;return n=_o(n),new n(function(c,d){var h=new qt({next:function(g){try{r(g)}catch(O){d(O),h.unsubscribe()}},error:d,complete:c});i.subscribe(h)})},a.prototype._subscribe=function(r){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(r)},a.prototype[An]=function(){return this},a.prototype.pipe=function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];return Ss(r)(this)},a.prototype.toPromise=function(r){var n=this;return r=_o(r),new r(function(i,c){var d;n.subscribe(function(h){return d=h},function(h){return c(h)},function(){return i(d)})})},a.create=function(r){return new a(r)},a})();function _o(a){var r;return(r=a??bs.Promise)!==null&&r!==void 0?r:Promise}function xs(a){return a&&le(a.next)&&le(a.error)&&le(a.complete)}function Es(a){return a&&a instanceof Dn||xs(a)&&Vo(a)}function Os(a){return le(a==null?void 0:a.lift)}function it(a){return function(r){if(Os(r))return r.lift(function(n){try{return a(n,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function Kt(a,r,n,i,c){return new Ts(a,r,n,i,c)}var Ts=(function(a){Lt(r,a);function r(n,i,c,d,h,g){var O=a.call(this,n)||this;return O.onFinalize=h,O.shouldUnsubscribe=g,O._next=i?function(E){try{i(E)}catch(A){n.error(A)}}:a.prototype._next,O._error=d?function(E){try{d(E)}catch(A){n.error(A)}finally{this.unsubscribe()}}:a.prototype._error,O._complete=c?function(){try{c()}catch(E){n.error(E)}finally{this.unsubscribe()}}:a.prototype._complete,O}return r.prototype.unsubscribe=function(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;a.prototype.unsubscribe.call(this),!i&&((n=this.onFinalize)===null||n===void 0||n.call(this))}},r})(Dn),ks=$o(function(a){return function(){a(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),$e=(function(a){Lt(r,a);function r(){var n=a.call(this)||this;return n.closed=!1,n.currentObservers=null,n.observers=[],n.isStopped=!1,n.hasError=!1,n.thrownError=null,n}return r.prototype.lift=function(n){var i=new So(this,this);return i.operator=n,i},r.prototype._throwIfClosed=function(){if(this.closed)throw new ks},r.prototype.next=function(n){var i=this;_r(function(){var c,d;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var h=Nt(i.currentObservers),g=h.next();!g.done;g=h.next()){var O=g.value;O.next(n)}}catch(E){c={error:E}}finally{try{g&&!g.done&&(d=h.return)&&d.call(h)}finally{if(c)throw c.error}}}})},r.prototype.error=function(n){var i=this;_r(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=n;for(var c=i.observers;c.length;)c.shift().error(n)}})},r.prototype.complete=function(){var n=this;_r(function(){if(n._throwIfClosed(),!n.isStopped){n.isStopped=!0;for(var i=n.observers;i.length;)i.shift().complete()}})},r.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(r.prototype,"observed",{get:function(){var n;return((n=this.observers)===null||n===void 0?void 0:n.length)>0},enumerable:!1,configurable:!0}),r.prototype._trySubscribe=function(n){return this._throwIfClosed(),a.prototype._trySubscribe.call(this,n)},r.prototype._subscribe=function(n){return this._throwIfClosed(),this._checkFinalizedStatuses(n),this._innerSubscribe(n)},r.prototype._innerSubscribe=function(n){var i=this,c=this,d=c.hasError,h=c.isStopped,g=c.observers;return d||h?Uo:(this.currentObservers=null,g.push(n),new Ar(function(){i.currentObservers=null,On(g,n)}))},r.prototype._checkFinalizedStatuses=function(n){var i=this,c=i.hasError,d=i.thrownError,h=i.isStopped;c?n.error(d):h&&n.complete()},r.prototype.asObservable=function(){var n=new Oe;return n.source=this,n},r.create=function(n,i){return new So(n,i)},r})(Oe),So=(function(a){Lt(r,a);function r(n,i){var c=a.call(this)||this;return c.destination=n,c.source=i,c}return r.prototype.next=function(n){var i,c;(c=(i=this.destination)===null||i===void 0?void 0:i.next)===null||c===void 0||c.call(i,n)},r.prototype.error=function(n){var i,c;(c=(i=this.destination)===null||i===void 0?void 0:i.error)===null||c===void 0||c.call(i,n)},r.prototype.complete=function(){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.complete)===null||i===void 0||i.call(n)},r.prototype._subscribe=function(n){var i,c;return(c=(i=this.source)===null||i===void 0?void 0:i.subscribe(n))!==null&&c!==void 0?c:Uo},r})($e);function Ds(a){return a&&le(a.schedule)}function As(a){return a[a.length-1]}function Ho(a){return Ds(As(a))?a.pop():void 0}var Yo=(function(a){return a&&typeof a.length=="number"&&typeof a!="function"});function Go(a){return le(a==null?void 0:a.then)}function Xo(a){return le(a[An])}function Qo(a){return Symbol.asyncIterator&&le(a==null?void 0:a[Symbol.asyncIterator])}function Zo(a){return new TypeError("You provided "+(a!==null&&typeof a=="object"?"an invalid object":"'"+a+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Cs(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Jo=Cs();function ei(a){return le(a==null?void 0:a[Jo])}function ti(a){return vs(this,arguments,function(){var n,i,c,d;return Lo(this,function(h){switch(h.label){case 0:n=a.getReader(),h.label=1;case 1:h.trys.push([1,,9,10]),h.label=2;case 2:return[4,wt(n.read())];case 3:return i=h.sent(),c=i.value,d=i.done,d?[4,wt(void 0)]:[3,5];case 4:return[2,h.sent()];case 5:return[4,wt(c)];case 6:return[4,h.sent()];case 7:return h.sent(),[3,2];case 8:return[3,10];case 9:return n.releaseLock(),[7];case 10:return[2]}})})}function ri(a){return le(a==null?void 0:a.getReader)}function st(a){if(a instanceof Oe)return a;if(a!=null){if(Xo(a))return Rs(a);if(Yo(a))return Ps(a);if(Go(a))return js(a);if(Qo(a))return ni(a);if(ei(a))return Bs(a);if(ri(a))return Ms(a)}throw Zo(a)}function Rs(a){return new Oe(function(r){var n=a[An]();if(le(n.subscribe))return n.subscribe(r);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Ps(a){return new Oe(function(r){for(var n=0;n<a.length&&!r.closed;n++)r.next(a[n]);r.complete()})}function js(a){return new Oe(function(r){a.then(function(n){r.closed||(r.next(n),r.complete())},function(n){return r.error(n)}).then(null,Wo)})}function Bs(a){return new Oe(function(r){var n,i;try{for(var c=Nt(a),d=c.next();!d.done;d=c.next()){var h=d.value;if(r.next(h),r.closed)return}}catch(g){n={error:g}}finally{try{d&&!d.done&&(i=c.return)&&i.call(c)}finally{if(n)throw n.error}}r.complete()})}function ni(a){return new Oe(function(r){Fs(a,r).catch(function(n){return r.error(n)})})}function Ms(a){return ni(ti(a))}function Fs(a,r){var n,i,c,d;return ms(this,void 0,void 0,function(){var h,g;return Lo(this,function(O){switch(O.label){case 0:O.trys.push([0,5,6,11]),n=gs(a),O.label=1;case 1:return[4,n.next()];case 2:if(i=O.sent(),!!i.done)return[3,4];if(h=i.value,r.next(h),r.closed)return[2];O.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return g=O.sent(),c={error:g},[3,11];case 6:return O.trys.push([6,,9,10]),i&&!i.done&&(d=n.return)?[4,d.call(n)]:[3,8];case 7:O.sent(),O.label=8;case 8:return[3,10];case 9:if(c)throw c.error;return[7];case 10:return[7];case 11:return r.complete(),[2]}})})}function ot(a,r,n,i,c){i===void 0&&(i=0),c===void 0&&(c=!1);var d=r.schedule(function(){n(),c?a.add(this.schedule(null,i)):this.unsubscribe()},i);if(a.add(d),!c)return d}function oi(a,r){return r===void 0&&(r=0),it(function(n,i){n.subscribe(Kt(i,function(c){return ot(i,a,function(){return i.next(c)},r)},function(){return ot(i,a,function(){return i.complete()},r)},function(c){return ot(i,a,function(){return i.error(c)},r)}))})}function ii(a,r){return r===void 0&&(r=0),it(function(n,i){i.add(a.schedule(function(){return n.subscribe(i)},r))})}function qs(a,r){return st(a).pipe(ii(r),oi(r))}function Ks(a,r){return st(a).pipe(ii(r),oi(r))}function Ls(a,r){return new Oe(function(n){var i=0;return r.schedule(function(){i===a.length?n.complete():(n.next(a[i++]),n.closed||this.schedule())})})}function $s(a,r){return new Oe(function(n){var i;return ot(n,r,function(){i=a[Jo](),ot(n,r,function(){var c,d,h;try{c=i.next(),d=c.value,h=c.done}catch(g){n.error(g);return}h?n.complete():n.next(d)},0,!0)}),function(){return le(i==null?void 0:i.return)&&i.return()}})}function si(a,r){if(!a)throw new Error("Iterable cannot be null");return new Oe(function(n){ot(n,r,function(){var i=a[Symbol.asyncIterator]();ot(n,r,function(){i.next().then(function(c){c.done?n.complete():n.next(c.value)})},0,!0)})})}function Us(a,r){return si(ti(a),r)}function Vs(a,r){if(a!=null){if(Xo(a))return qs(a,r);if(Yo(a))return Ls(a,r);if(Go(a))return Ks(a,r);if(Qo(a))return si(a,r);if(ei(a))return $s(a,r);if(ri(a))return Us(a,r)}throw Zo(a)}function Ws(a,r){return r?Vs(a,r):st(a)}function Mt(a,r){return it(function(n,i){var c=0;n.subscribe(Kt(i,function(d){i.next(a.call(r,d,c++))}))})}function zs(a,r,n,i,c,d,h,g){var O=[],E=0,A=0,R=!1,C=function(){R&&!O.length&&!E&&r.complete()},P=function(z){return E<i?U(z):O.push(z)},U=function(z){E++;var ee=!1;st(n(z,A++)).subscribe(Kt(r,function(ie){r.next(ie)},function(){ee=!0},void 0,function(){if(ee)try{E--;for(var ie=function(){var ne=O.shift();h||U(ne)};O.length&&E<i;)ie();C()}catch(ne){r.error(ne)}}))};return a.subscribe(Kt(r,P,function(){R=!0,C()})),function(){}}function ai(a,r,n){return n===void 0&&(n=1/0),le(r)?ai(function(i,c){return Mt(function(d,h){return r(i,d,c,h)})(st(a(i,c)))},n):(typeof r=="number"&&(n=r),it(function(i,c){return zs(i,c,a,n)}))}function Hs(a){return ai(zo,a)}function Ys(){return Hs(1)}function xo(){for(var a=[],r=0;r<arguments.length;r++)a[r]=arguments[r];return Ys()(Ws(a,Ho(a)))}function br(a,r){return it(function(n,i){var c=0;n.subscribe(Kt(i,function(d){return a.call(r,d,c++)&&i.next(d)}))})}function wr(a){a===void 0&&(a={});var r=a.connector,n=r===void 0?function(){return new $e}:r,i=a.resetOnError,c=i===void 0?!0:i,d=a.resetOnComplete,h=d===void 0?!0:d,g=a.resetOnRefCountZero,O=g===void 0?!0:g;return function(E){var A,R,C,P=0,U=!1,z=!1,ee=function(){R==null||R.unsubscribe(),R=void 0},ie=function(){ee(),A=C=void 0,U=z=!1},ne=function(){var ce=A;ie(),ce==null||ce.unsubscribe()};return it(function(ce,Ee){P++,!z&&!U&&ee();var be=C=C??n();Ee.add(function(){P--,P===0&&!z&&!U&&(R=wn(ne,O))}),be.subscribe(Ee),!A&&P>0&&(A=new qt({next:function(pe){return be.next(pe)},error:function(pe){z=!0,ee(),R=wn(ie,c,pe),be.error(pe)},complete:function(){U=!0,ee(),R=wn(ie,h),be.complete()}}),st(ce).subscribe(A))})(E)}}function wn(a,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];if(r===!0){a();return}if(r!==!1){var c=new qt({next:function(){c.unsubscribe(),a()}});return st(r.apply(void 0,kr([],Tr(n)))).subscribe(c)}}function Nn(){for(var a=[],r=0;r<arguments.length;r++)a[r]=arguments[r];var n=Ho(a);return it(function(i,c){(n?xo(a,i,n):xo(a,i)).subscribe(c)})}class Gs extends Ft{constructor(n="hierarchidb"){super(`${n}-CoreDB`);J(this,"trees");J(this,"nodes");J(this,"rootStates");J(this,"changeSubject",new $e);this.version(1).stores({trees:"&treeId, treeRootNodeId, treeTrashRootNodeId, superRootNodeId",nodes:["&treeNodeId","parentTreeNodeId","&[parentTreeNodeId+name]","[parentTreeNodeId+updatedAt]","removedAt","originalParentTreeNodeId","*references"].join(", "),rootStates:"&[treeId+treeRootNodeType], treeId, treeRootNodeId"})}treeIdToTreeName(n){return n==="r"?"Resources":"Projects"}async initialize(){console.log("initialize");const n=Date.now();await this.trees.count()===0&&this.trees.bulkPut(["r","p"].map(i=>({treeId:i,name:this.treeIdToTreeName(i),superRootNodeId:i+xe.SuperRoot,treeRootNodeId:i+xe.Root,treeTrashRootNodeId:i+xe.Trash}))),await this.nodes.count()===0&&this.nodes.bulkPut(["r","p"].flatMap(i=>[{parentTreeNodeId:xe.SuperRoot,treeNodeId:i+xe.Root,treeNodeType:xe.Root,name:this.treeIdToTreeName(i),createdAt:n,updatedAt:n,version:1},{parentTreeNodeId:xe.SuperRoot,treeNodeId:i+xe.Trash,treeNodeType:xe.Trash,name:"Trash",createdAt:n,updatedAt:n,version:1}])),await this.rootStates.count()===0&&this.rootStates.bulkPut(["r","p"].flatMap(i=>[xe.Root,xe.Trash].map(c=>({treeId:i,treeRootNodeId:i+c,expanded:{}}))))}async getTree(n){return await this.trees.get(n)}getTrees(){return this.trees.toArray()}async getNode(n){return await this.nodes.get(n)}async createNode(n){return await this.nodes.add(n),this.changeSubject.next({type:"node-created",nodeId:n.treeNodeId,node:n,timestamp:Date.now()}),n.treeNodeId}async updateNode(n){const i=await this.nodes.get(n.treeNodeId);if(await this.nodes.put(n),i){i.name!==n.name&&(i.name,n.name),i.parentTreeNodeId!==n.parentTreeNodeId&&(i.parentTreeNodeId,n.parentTreeNodeId);const c={type:"node-updated",nodeId:n.treeNodeId,node:n,previousNode:i,timestamp:Date.now()};this.changeSubject.next(c)}}async deleteNode(n){await this.nodes.delete(n),this.changeSubject.next({type:"node-deleted",nodeId:n,timestamp:Date.now()})}async getChildren(n){return await this.nodes.where("parentTreeNodeId").equals(n).toArray()}close(){this.changeSubject.complete(),super.close()}async bulkCreateNodes(n){await this.nodes.bulkAdd(n),n.forEach(i=>{this.changeSubject.next({type:"node-created",nodeId:i.treeNodeId,node:i,timestamp:Date.now()})})}async bulkUpdateNodes(n){const i=await Promise.all(n.map(c=>this.nodes.get(c.treeNodeId)));await this.nodes.bulkPut(n),n.forEach((c,d)=>{const h=i[d];h&&(h.name!==c.name&&(h.name,c.name),h.parentTreeNodeId!==c.parentTreeNodeId&&(h.parentTreeNodeId,c.parentTreeNodeId),this.changeSubject.next({type:"node-updated",nodeId:c.treeNodeId,node:c,previousNode:h,timestamp:Date.now()}))})}async bulkDeleteNodes(n){await this.nodes.bulkDelete(n),n.forEach(i=>{this.changeSubject.next({type:"node-deleted",nodeId:i,timestamp:Date.now()})})}}class Xs extends Ft{constructor(n="hierarchidb"){super(`${n}-EphemeralDB`);J(this,"workingCopies");J(this,"views");this.version(1).stores({workingCopies:"&workingCopyId, workingCopyOf, parentTreeNodeId, updatedAt",views:"&treeViewId, updatedAt, [treeId+treeRootNodeType], [treeId+pageNodeId]"})}async initialize(){await this.workingCopies.count()!==0&&(console.log("initialize workingCopies"),this.workingCopies.clear()),await this.views.count()===0&&(console.log("initialize views"),this.views.clear())}async getWorkingCopy(n){return await this.workingCopies.get(n)}async updateWorkingCopy(n){await this.workingCopies.put(n)}async discardWorkingCopy(n){await this.workingCopies.delete(n)}}class Qs{constructor(r,n,i){J(this,"events",[]);this.registry=r,this.coreDB=n,this.ephemeralDB=i}async executeLifecycleHook(r,n,...i){const c=this.registry.getNodeTypeConfig(n),d=c==null?void 0:c.lifecycle,h=d==null?void 0:d[r];if(!h)return;const g=Date.now();let O=!0,E;try{await h(...i)}catch(A){if(O=!1,E=A instanceof Error?A.message:"Unknown error",d!=null&&d.stopOnError)throw A;Ko(`Lifecycle hook ${r} failed for ${n}:`,A)}finally{this.recordEvent({type:r,nodeType:n,nodeId:i[0],timestamp:g,duration:Date.now()-g,success:O,error:E})}}async handleNodeCreation(r,n,i){await this.executeLifecycleHook("beforeCreate",i,r,n);const c=await this.createNodeCore(r,n);return await this.executeLifecycleHook("afterCreate",i,c),c}async handleNodeUpdate(r,n,i){await this.executeLifecycleHook("beforeUpdate",i,r,n),await this.updateNodeCore(r,n),await this.executeLifecycleHook("afterUpdate",i,r,n)}async handleNodeDeletion(r,n){await this.executeLifecycleHook("beforeDelete",n,r),await this.deleteNodeCore(r),await this.executeLifecycleHook("afterDelete",n,r)}async handleNodeMove(r,n,i,c){await this.executeLifecycleHook("beforeMove",c,r,n,i),await this.moveNodeCore(r,i),await this.executeLifecycleHook("afterMove",c,r,n,i)}async handleNodeLoad(r,n){await this.executeLifecycleHook("onLoad",n,r)}async handleNodeUnload(r,n){await this.executeLifecycleHook("onUnload",n,r)}async handleBatchCreate(r,n,i){const c=[];for(const d of n){const h=await this.handleNodeCreation(r,d,i);c.push(h)}return c}async handleBatchDelete(r,n){for(const i of r)await this.handleNodeDeletion(i,n)}getEvents(r){let n=[...this.events];return r!=null&&r.nodeType&&(n=n.filter(i=>i.nodeType===r.nodeType)),r!=null&&r.type&&(n=n.filter(i=>i.type===r.type)),n}clearEvents(){this.events=[]}async createNodeCore(r,n){var i,c;return((c=(i=this.coreDB).createNode)==null?void 0:c.call(i,n))||`node-${Date.now()}`}async updateNodeCore(r,n){this.coreDB.updateNode&&await this.coreDB.updateNode(r,n)}async deleteNodeCore(r){var n,i;await((i=(n=this.coreDB).deleteNode)==null?void 0:i.call(n,r))}async moveNodeCore(r,n){await this.updateNodeCore(r,{parentTreeNodeId:n})}recordEvent(r){this.events.push(r),this.events.length>1e3&&(this.events=this.events.slice(-1e3))}createContext(r){return{nodeType:"unknown",timestamp:Date.now(),metadata:r}}async executeHookWithContext(r,n,i,...c){const d={...i,nodeType:n};globalThis.__lifecycleContext=d;try{await this.executeLifecycleHook(r,n,...c)}finally{delete globalThis.__lifecycleContext}}}class Zs extends us{constructor(){super(),this.initializeDefaultTypes()}initializeDefaultTypes(){}registerNodeType(r,n){this.register(r,n)}register(r,n){this.registry.set(r,n),this.onRegister(r,n),this.logRegistration(r,"register")}unregisterNodeType(r){this.unregister(r)}getNodeTypeConfig(r){return this.registry.get(r)}isRegistered(r){return this.has(r)}getAllNodeTypes(){return this.getAll()}canAddChild(r,n){const i=this.getNodeTypeConfig(r);return!i||!i.allowedChildren?!0:i.allowedChildren.includes(n)}getDefaultIcon(r){const n=this.getNodeTypeConfig(r);if(n!=null&&n.icon)return n.icon;switch(r){case vr.Root:case vr.Trash:case vr.folder:return"folder";case vr.file:return"file";default:return"file"}}registerBatch(r){r.forEach(({nodeType:n,config:i})=>{this.registerNodeType(n,i)})}getValidationRules(r){const n=this.getNodeTypeConfig(r);return n?{canBeDeleted:n.canBeDeleted,canBeRenamed:n.canBeRenamed,canBeMoved:n.canBeMoved,maxChildren:n.maxChildren}:{}}canBeRoot(r){const n=this.getNodeTypeConfig(r);return(n==null?void 0:n.canBeRoot)??!1}getSortedNodeTypes(){return Array.from(this.registry.entries()).sort((n,i)=>{const c=n[1].sortOrder??999,d=i[1].sortOrder??999;return c-d}).map(([n])=>n)}}async function Js(a,r,n){var O,E,A,R,C;const i=await((O=r.getNode)==null?void 0:O.call(r,n))||((E=r.nodes)==null?void 0:E.get(n));if(!i)throw new Error("Node not found");if(await((A=a.getWorkingCopyByNodeId)==null?void 0:A.call(a,n)))throw new Error("Working copy already exists");const d=nt(),h=Date.now(),g={workingCopyId:d,parentTreeNodeId:i.parentTreeNodeId,treeNodeType:i.treeNodeType,name:i.name,description:i.description,isDraft:!1,workingCopyOf:n,copiedAt:h,updatedAt:h};return g.originalVersion=i.version,await((R=a.createWorkingCopy)==null?void 0:R.call(a,g))||((C=a.workingCopies)==null||C.set(d,g)),d}async function ea(a,r,n,i,c="error"){var h,g,O;const d=await ra(a,n);if(!d)return{success:!1,error:"Working copy not found",code:ge.WORKING_COPY_NOT_FOUND};try{if(!i){const E=d.workingCopyOf,A=await((h=r.getNode)==null?void 0:h.call(r,E))||((g=r.nodes)==null?void 0:g.get(E));if(!A)return{success:!1,error:"Target node not found",code:ge.NODE_NOT_FOUND};const R=d.originalVersion||1;if(A.version>R)return{success:!1,error:"Node was modified by another user",code:ge.COMMIT_CONFLICT};if(d.name!==A.name){const P=await na(r,d.parentTreeNodeId);if(P.includes(d.name)){if(c==="error")return{success:!1,error:`Name "${d.name}" already exists`,code:ge.VALIDATION_ERROR};d.name=Sr(P,d.name)}}const C={name:d.name,description:d.description,updatedAt:Date.now(),version:A.version+1};return await((O=r.updateNode)==null?void 0:O.call(r,E,C)),await ta(a,n),{success:!0,seq:1,nodeId:E}}}catch(E){return{success:!1,error:E instanceof Error?E.message:"Unknown error",code:ge.UNKNOWN_ERROR}}}async function ta(a,r){var n,i;await((n=a.deleteWorkingCopy)==null?void 0:n.call(a,r))||((i=a.workingCopies)==null||i.delete(r))}async function ra(a,r){var n,i;return await((n=a.getWorkingCopy)==null?void 0:n.call(a,r))||((i=a.workingCopies)==null?void 0:i.get(r))}async function na(a,r){var i;return(await((i=a.getChildren)==null?void 0:i.call(a,r))||[]).map(c=>c.name)}function Sr(a,r){if(!a.includes(r))return r;const n=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`^${n}\\s*\\((\\d+)\\)$`),c=a.map(h=>{const g=i.exec(h);return g&&g[1]?parseInt(g[1],10):0}).filter(h=>h>0),d=c.length>0?Math.max(...c)+1:2;return`${r} (${d})`}class oa{constructor(r,n,i,c){this.coreDB=r,this.ephemeralDB=n,this.commandProcessor=i,this.lifecycleManager=c}async createWorkingCopyForCreate(r){const{workingCopyId:n,parentTreeNodeId:i,name:c,description:d}=r.payload,h=Date.now(),g={workingCopyId:n,treeNodeId:null,parentTreeNodeId:i,nodeType:"folder",status:"draft",createdAt:h,updatedAt:h,changes:{name:c,description:d}};this.ephemeralDB.workingCopies&&await this.ephemeralDB.workingCopies.add(g)}async createWorkingCopy(r){var c,d;const{sourceTreeNodeId:n}=r.payload;if(!await((d=(c=this.coreDB).getNode)==null?void 0:d.call(c,n)))throw new Error("Node not found");await Js(this.ephemeralDB,this.coreDB,n)}async discardWorkingCopyForCreate(r){var i,c;const{workingCopyId:n}=r.payload;await((c=(i=this.ephemeralDB).discardWorkingCopy)==null?void 0:c.call(i,n))}async discardWorkingCopy(r){var i,c;const{workingCopyId:n}=r.payload;await((c=(i=this.ephemeralDB).discardWorkingCopy)==null?void 0:c.call(i,n))}async commitWorkingCopyForCreate(r){var c,d;const{workingCopyId:n,onNameConflict:i="error"}=r.payload;try{const h=await((c=this.ephemeralDB.workingCopies)==null?void 0:c.get(n));if(!h)return{success:!1,error:`Working copy not found: ${n}`,code:"NODE_NOT_FOUND"};const g=nt(),O=Date.now(),E={treeNodeId:g,parentTreeNodeId:h.parentTreeNodeId,treeNodeType:h.nodeType||"folder",name:h.changes.name,createdAt:O,updatedAt:O,version:1};return h.changes.description&&(E.description=h.changes.description),await this.coreDB.createNode(E),await((d=this.ephemeralDB.workingCopies)==null?void 0:d.delete(n)),{success:!0,seq:this.getNextSeq(),nodeId:g}}catch(h){return{success:!1,error:String(h),code:"INVALID_OPERATION"}}}async commitWorkingCopy(r){const{workingCopyId:n,onNameConflict:i="error"}=r.payload;return await ea(this.ephemeralDB,this.coreDB,n,!1,i)}async moveNodes(r){var d,h,g,O,E,A;const{nodeIds:n,toParentId:i,onNameConflict:c="error"}=r.payload;for(const R of n)if(await this.isDescendantOf(i,R))return{success:!1,error:"Circular reference detected",code:"ILLEGAL_RELATION"};for(const R of n){const C=await((h=(d=this.coreDB).getNode)==null?void 0:h.call(d,R));if(!C)continue;let P=C.name;if(c==="auto-rename"){const z=(await((O=(g=this.coreDB).getChildren)==null?void 0:O.call(g,i))||[]).map(ee=>ee.name);P=Sr(z,C.name)}await((A=(E=this.coreDB).updateNode)==null?void 0:A.call(E,{...C,parentTreeNodeId:i,name:P,updatedAt:Date.now()}))}return{success:!0,seq:this.getNextSeq()}}async duplicateNodes(r){var h,g;const{nodeIds:n,toParentId:i,onNameConflict:c="error"}=r.payload,d=[];for(const O of n){if(!await((g=(h=this.coreDB).getNode)==null?void 0:g.call(h,O)))continue;const A=new Map;await this.duplicateBranch(O,i,A,!0),d.push(...Array.from(A.values()))}return{success:!0,seq:this.getNextSeq(),newNodeIds:d}}async pasteNodes(r){var h,g,O,E,A,R;const{nodes:n,nodeIds:i,toParentId:c,onNameConflict:d="error"}=r.payload;try{if(!n||typeof n!="object"||!i||!Array.isArray(i))return{success:!1,error:"Invalid paste payload: nodes and nodeIds are required",code:"INVALID_OPERATION"};if(!c||typeof c!="string")return{success:!1,error:"Invalid toParentId: must be a non-empty string",code:"INVALID_OPERATION"};const C=1e3;if(i.length>C)return{success:!1,error:`Too many nodes to paste (max: ${C})`,code:"INVALID_OPERATION"};if(!await((g=(h=this.coreDB).getNode)==null?void 0:g.call(h,c)))return{success:!1,error:`Parent node not found: ${c}`,code:"NODE_NOT_FOUND"};const U=[],z=await((E=(O=this.coreDB).getChildren)==null?void 0:E.call(O,c))||[],ee=new Set(z.map(ne=>ne.name)),ie=Date.now();for(const ne of i){const ce=n[ne];if(!ce){console.warn(`Source node not found in clipboard data: ${ne}`);continue}if(!ce.name||typeof ce.name!="string"){console.warn(`Invalid node name for ${ne}, skipping`);continue}const Ee=nt();let be=ce.name;if(d==="auto-rename"&&ee.has(be))be=this.resolveNameConflictEfficiently(be,ee);else if(d==="error"&&ee.has(be))return{success:!1,error:`Name conflict: '${be}' already exists`,code:"NAME_NOT_UNIQUE"};const pe={...ce,treeNodeId:Ee,parentTreeNodeId:c,name:be,createdAt:ie,updatedAt:ie,version:1,originalParentTreeNodeId:void 0,originalName:void 0,removedAt:void 0,isRemoved:!1};await((R=(A=this.coreDB).createNode)==null?void 0:R.call(A,pe)),U.push(Ee),ee.add(be)}return{success:!0,seq:this.getNextSeq(),newNodeIds:U}}catch(C){return console.error("Paste operation failed:",C),{success:!1,error:C instanceof Error?C.message:"Paste operation failed",code:"INVALID_OPERATION"}}}resolveNameConflictEfficiently(r,n){let i=1,c;do if(c=`${r} (${i})`,i++,i>1e4){c=`${r} (${Date.now()})`;break}while(n.has(c));return c}async moveToTrash(r){var c,d;const{nodeIds:n}=r.payload,i="trash";try{for(const h of n){const g=await((d=(c=this.coreDB).getNode)==null?void 0:d.call(c,h));if(!g){console.warn(`Node not found for moveToTrash: ${h}`);continue}const O={parentTreeNodeId:i,originalParentTreeNodeId:g.parentTreeNodeId,originalName:g.name,isRemoved:!0,removedAt:Date.now(),updatedAt:Date.now(),version:g.version+1},E={...g,...O};await this.coreDB.updateNode(E)}return{success:!0,seq:this.getNextSeq()}}catch(h){return console.error("Error in moveToTrash:",h),{success:!1,error:String(h),code:"INVALID_OPERATION"}}}async remove(r){const{nodeIds:n}=r.payload;for(const i of n)await this.deleteNodeRecursively(i);return{success:!0,seq:this.getNextSeq()}}async recoverFromTrash(r){var d,h,g,O;const{nodeIds:n,toParentId:i,onNameConflict:c="error"}=r.payload;try{for(const E of n){const A=await((h=(d=this.coreDB).getNode)==null?void 0:h.call(d,E));if(!A){console.warn(`Node not found for recoverFromTrash: ${E}`);continue}if(!A.isRemoved){console.warn(`Node ${E} is not in trash, skipping recovery`);continue}const R=i||A.originalParentTreeNodeId;if(!R){console.warn(`No target parent for node ${E}, skipping recovery`);continue}let C=A.originalName||A.name;if(c==="auto-rename"){const ee=(await((O=(g=this.coreDB).getChildren)==null?void 0:O.call(g,R))||[]).map(ie=>ie.name);C=Sr(ee,C)}const P={parentTreeNodeId:R,name:C,isRemoved:!1,originalParentTreeNodeId:void 0,originalName:void 0,removedAt:void 0,updatedAt:Date.now(),version:A.version+1},U={...A,...P};await this.coreDB.updateNode(U)}return{success:!0,seq:this.getNextSeq()}}catch(E){return console.error("Error in recoverFromTrash:",E),{success:!1,error:String(E),code:"INVALID_OPERATION"}}}async importNodes(r){var O,E,A,R;const{nodes:n,nodeIds:i,toParentId:c,onNameConflict:d="error"}=r.payload,h=[],g=new Map;for(const C of i){const P=nt();g.set(C,P),h.push(P)}for(const C of i){const P=n[C];if(!P)continue;const U=g.get(C),z=g.get(P.parentTreeNodeId)||c;let ee=P.name;if(d==="auto-rename"){const ne=(await((E=(O=this.coreDB).getChildren)==null?void 0:E.call(O,z))||[]).map(ce=>ce.name);ee=Sr(ne,P.name)}await((R=(A=this.coreDB).createNode)==null?void 0:R.call(A,{...P,treeNodeId:U,parentTreeNodeId:z,name:ee,createdAt:Date.now(),updatedAt:Date.now(),version:1}))}return{success:!0,seq:this.getNextSeq(),newNodeIds:h}}async undo(r){const{groupId:n}=r.payload;return await this.commandProcessor.undo(n)}async redo(r){const{groupId:n}=r.payload;return await this.commandProcessor.redo(n)}async isDescendantOf(r,n){var d,h;let i=r;const c=new Set;for(;i&&i!=="root";){if(c.has(i))return!1;if(c.add(i),i===n)return!0;const g=await((h=(d=this.coreDB).getNode)==null?void 0:h.call(d,i));if(!g)break;i=g.parentTreeNodeId}return!1}async duplicateBranch(r,n,i,c){var O,E,A,R,C,P;const d=await((E=(O=this.coreDB).getNode)==null?void 0:E.call(O,r));if(!d)return;const h=nt();i.set(r,h),await((R=(A=this.coreDB).createNode)==null?void 0:R.call(A,{...d,treeNodeId:h,parentTreeNodeId:n,name:c?`${d.name} (Copy)`:d.name,createdAt:Date.now(),updatedAt:Date.now(),version:1}));const g=await((P=(C=this.coreDB).getChildren)==null?void 0:P.call(C,r))||[];for(const U of g)await this.duplicateBranch(U.treeNodeId,h,i,!1)}async deleteNodeRecursively(r){var i,c,d,h;const n=await((c=(i=this.coreDB).getChildren)==null?void 0:c.call(i,r))||[];for(const g of n)await this.deleteNodeRecursively(g.treeNodeId);await((h=(d=this.coreDB).deleteNode)==null?void 0:h.call(d,r))}getNextSeq(){return Date.now()}}class Tn{constructor(r){this.coreDB=r}async getTrees(){var r,n;return await((n=(r=this.coreDB).getTrees)==null?void 0:n.call(r))||[]}async getTree(r){var i,c;const{treeId:n}=r;return await((c=(i=this.coreDB).getTree)==null?void 0:c.call(i,n))}async getNode(r){var i,c;const{treeNodeId:n}=r;return await((c=(i=this.coreDB).getNode)==null?void 0:c.call(i,n))}async getChildren(r){var O,E;const{parentTreeNodeId:n,sortBy:i="createdAt",sortOrder:c="asc",limit:d,offset:h}=r;let g=await((E=(O=this.coreDB).getChildren)==null?void 0:E.call(O,n))||[];return i&&(g=g.sort((A,R)=>{let C=A[i],P=R[i];return i==="name"&&(C=C==null?void 0:C.toLowerCase(),P=P==null?void 0:P.toLowerCase()),c==="desc"?C>P?-1:C<P?1:0:C<P?-1:C>P?1:0})),h!==void 0&&(g=g.slice(h)),d!==void 0&&(g=g.slice(0,d)),g}async getDescendants(r){const{rootNodeId:n,maxDepth:i,includeTypes:c,excludeTypes:d}=r,h=[],g=new Set,O=async(E,A)=>{var C,P;if(g.has(E)||(g.add(E),i!==void 0&&A>=i))return;const R=await((P=(C=this.coreDB).getChildren)==null?void 0:P.call(C,E))||[];for(const U of R)(!c||c.includes(U.treeNodeType))&&(!d||!d.includes(U.treeNodeType))&&h.push(U),await O(U.treeNodeId,A+1)};return await O(n,0),h}async getAncestors(r){const{nodeId:n}=r,i=[];let c=n;const d=new Set;for(;c&&!d.has(c);){d.add(c);const h=await this.coreDB.getNode(c);if(!h||(i.push(h),!h.parentTreeNodeId||h.parentTreeNodeId===c))break;c=h.parentTreeNodeId}return i}async searchNodes(r){const{query:n,searchInDescription:i=!1,caseSensitive:c=!1,useRegex:d=!1,rootNodeId:h}=r;let g;if(d)try{const A=c?"":"i";g=new RegExp(n,A)}catch{const R=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),C=c?"":"i";g=new RegExp(R,C)}else{const A=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),R=c?"":"i";g=new RegExp(A,R)}const O=[],E=h?await this.getAllDescendantsWithSelf(h):await this.getAllNodes();for(const A of E){let R=!1;g.test(A.name)&&(R=!0),!R&&i&&A.description&&g.test(A.description)&&(R=!0),R&&O.push(A)}return O}async copyNodes(r){const{nodeIds:n}=r;try{if(!n||!Array.isArray(n)||n.length===0)return{success:!1,error:"Invalid nodeIds: must be a non-empty array",code:"INVALID_OPERATION"};const i=1e3;if(n.length>i)return{success:!1,error:`Too many nodes specified (max: ${i})`,code:"INVALID_OPERATION"};const c=n.filter(O=>typeof O=="string"&&O.length>0&&O.length<=255);if(c.length===0)return{success:!1,error:"No valid nodeIds provided",code:"INVALID_OPERATION"};const d={},h=new Set;for(const O of c)if((await this.getAllDescendantsWithSelf(O)).forEach(A=>{d[A.treeNodeId]||(d[A.treeNodeId]=A,h.add(A.treeNodeId))}),Object.keys(d).length>i)return{success:!1,error:`Too many descendant nodes (max: ${i})`,code:"INVALID_OPERATION"};const g={type:"nodes-copy",timestamp:Date.now(),nodes:d,rootNodeIds:c,nodeCount:Object.keys(d).length};return{success:!0,seq:this.getNextSeq(),clipboardData:g}}catch(i){return console.error("Copy operation failed:",i),{success:!1,error:i instanceof Error?i.message:"Copy operation failed",code:"INVALID_OPERATION"}}}async exportNodes(r){const{nodeIds:n}=r;try{const i={nodes:{},metadata:{exportedAt:Date.now(),rootNodeIds:n,totalNodes:0}};for(const c of n)(await this.getAllDescendantsWithSelf(c)).forEach(h=>{i.nodes[h.treeNodeId]=h});return i.metadata.totalNodes=Object.keys(i.nodes).length,{success:!0,seq:this.getNextSeq()}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Export operation failed",code:"NODE_NOT_FOUND"}}}async getAllDescendantsWithSelf(r){const n=[],i=new Set,c=async d=>{if(i.has(d))return;i.add(d);const h=await this.coreDB.getNode(d);h&&n.push(h);const g=await this.coreDB.getChildren(d);for(const O of g)await c(O.treeNodeId)};return await c(r),n}async getAllNodes(){if(this.coreDB&&"treeNodes"in this.coreDB&&this.coreDB.treeNodes instanceof Map)return Array.from(this.coreDB.treeNodes.values());const r=[],n=new Set,i=["root"];for(const c of i)(await this.getAllDescendantsWithSelf(c)).forEach(h=>{n.has(h.treeNodeId)||(n.add(h.treeNodeId),r.push(h))});return r}getNextSeq(){return Date.now()}}class ia{constructor(r){J(this,"subscriptions",new Map);J(this,"globalChangeSubject",new $e);J(this,"subscriptionCounter",0);this.coreDB=r,this.coreDB.changeSubject.subscribe(n=>{this.globalChangeSubject.next(n)}),this.setupPeriodicCleanup()}async observeNode(r){const{treeNodeId:n,filter:i,includeInitialValue:c=!1}=r.payload,d=this.generateSubscriptionId(),h=new $e;this.subscriptions.set(d,{id:d,type:"node",nodeId:n,filter:i,subject:h,isActive:!0,lastActivity:Date.now()});const O=this.globalChangeSubject.pipe(br(C=>this.isEventRelevantForNodeObservation(C,n,i)),Mt(C=>this.transformEventForSubscription(C,d)),wr()).subscribe({next:C=>{h.next(C),this.updateSubscriptionActivity(d)}});let E=h.asObservable();c&&(E=E.pipe(Nn(this.createInitialNodeEvent(n))));const A=E.subscribe.bind(E);return Object.defineProperty(E,"subscribe",{value:C=>{const P=A(C),U=P.unsubscribe.bind(P);return P.unsubscribe=()=>{O.unsubscribe(),this.markSubscriptionInactive(d),U()},P},writable:!1,configurable:!0}),E}async observeChildren(r){const{parentTreeNodeId:n,filter:i,includeInitialSnapshot:c=!1}=r.payload,d=this.generateSubscriptionId(),h=new $e;this.subscriptions.set(d,{id:d,type:"children",nodeId:n,filter:i,subject:h,isActive:!0,lastActivity:Date.now()});const O=this.globalChangeSubject.pipe(br(R=>this.isEventRelevantForChildrenObservation(R,n,i)),Mt(R=>this.transformEventForSubscription(R,d)),wr()).subscribe({next:R=>{h.next(R),this.updateSubscriptionActivity(d)}});let E=h.asObservable();c&&(E=E.pipe(Nn(this.createInitialChildrenEvent(n,i))));const A=E.subscribe.bind(E);return E.subscribe=((R,C,P)=>{const U=A(R,C,P),z=U.unsubscribe.bind(U);return U.unsubscribe=()=>{O.unsubscribe(),this.markSubscriptionInactive(d),z()},U}),E}async observeSubtree(r){const{rootNodeId:n,maxDepth:i,filter:c,includeInitialSnapshot:d=!1}=r.payload,h=this.generateSubscriptionId(),g=new $e;this.subscriptions.set(h,{id:h,type:"subtree",nodeId:n,filter:{...c,maxDepth:i},subject:g,isActive:!0,lastActivity:Date.now()});const E=this.globalChangeSubject.pipe(br(C=>this.isEventRelevantForSubtreeObservation(C,n,i,c)),Mt(C=>this.transformEventForSubscription(C,h)),wr()).subscribe({next:C=>{g.next(C),this.updateSubscriptionActivity(h)}});let A=g.asObservable();d&&(A=A.pipe(Nn(this.createInitialSubtreeEvent(n,i,c))));const R=A.subscribe.bind(A);return A.subscribe=((C,P,U)=>{const z=R(C,P,U),ee=z.unsubscribe.bind(z);return z.unsubscribe=()=>{E.unsubscribe(),this.markSubscriptionInactive(h),ee()},z}),A}async observeWorkingCopies(r){const{nodeId:n,includeAllDrafts:i=!1}=r.payload,c=this.generateSubscriptionId(),d=new $e;this.subscriptions.set(c,{id:c,type:"working-copies",nodeId:n||"all",filter:{properties:i?["isDraft"]:[]},subject:d,isActive:!0,lastActivity:Date.now()});const g=this.globalChangeSubject.pipe(br(A=>this.isEventRelevantForWorkingCopies(A,n,i)),Mt(A=>this.transformEventForSubscription(A,c)),wr()).subscribe({next:A=>{d.next(A),this.updateSubscriptionActivity(c)}}),O=d.asObservable(),E=O.subscribe.bind(O);return O.subscribe=((A,R,C)=>{const P=E(A,R,C),U=P.unsubscribe.bind(P);return P.unsubscribe=()=>{g.unsubscribe(),this.markSubscriptionInactive(c),U()},P}),O}async getActiveSubscriptions(){return Array.from(this.subscriptions.values()).filter(r=>r.isActive).length}async cleanupOrphanedSubscriptions(){const r=Date.now(),n=300*1e3,i=[];for(const[c,d]of this.subscriptions.entries())(!d.isActive||r-d.lastActivity>n)&&(d.subject.complete(),i.push(c));i.forEach(c=>this.subscriptions.delete(c))}generateSubscriptionId(){return`sub_${++this.subscriptionCounter}_${Date.now()}`}updateSubscriptionActivity(r){const n=this.subscriptions.get(r);n&&(n.lastActivity=Date.now())}markSubscriptionInactive(r){const n=this.subscriptions.get(r);n&&(n.isActive=!1)}isEventRelevantForNodeObservation(r,n,i){return!(r.nodeId!==n||i!=null&&i.nodeTypes&&r.node&&!i.nodeTypes.includes(r.node.treeNodeType))}isEventRelevantForChildrenObservation(r,n,i){const c=r.parentId===n||r.previousParentId===n;if(r.type==="node-deleted"&&r.previousNode){const d=r.previousNode.parentTreeNodeId===n;if(!c&&!d)return!1}else if(!c)return!1;if(i!=null&&i.nodeTypes){const d=r.node||r.previousNode;if(d&&!i.nodeTypes.includes(d.treeNodeType))return!1}return!0}isEventRelevantForSubtreeObservation(r,n,i,c){if(r.node)return!(!this.isNodeDescendantOfByNode(r.node,n,i)||c!=null&&c.nodeTypes&&!c.nodeTypes.includes(r.node.treeNodeType));if(!this.isNodeDescendantOf(r.nodeId,n,i))return!1;if(c!=null&&c.nodeTypes){const h=r.node||r.previousNode;if(h&&!c.nodeTypes.includes(h.treeNodeType))return!1}return!0}isEventRelevantForWorkingCopies(r,n,i){return!(n&&r.nodeId!==n)}transformEventForSubscription(r,n){return r}createInitialNodeEvent(r){const n=this.getNodeFromDB(r);return{type:"node-updated",nodeId:r,node:n,timestamp:Date.now()}}createInitialChildrenEvent(r,n){const i=this.getChildrenFromDB(r,n);return{type:"children-changed",nodeId:r,affectedChildren:i.map(c=>c.treeNodeId),timestamp:Date.now()}}createInitialSubtreeEvent(r,n,i){return this.createInitialChildrenEvent(r,i)}getNodeFromDB(r){try{const n=this.coreDB.nodes;if(n&&"_Items"in n){const i=n._Items;if(i instanceof Map)return i.get(r);for(const c of Object.values(i||{}))if((c==null?void 0:c.treeNodeId)===r)return c}}catch(n){console.warn("Could not access node data synchronously:",n)}}getChildrenFromDB(r,n){if(this.coreDB&&"treeNodes"in this.coreDB&&this.coreDB.treeNodes instanceof Map){let c=Array.from(this.coreDB.treeNodes.values()).filter(d=>d.parentTreeNodeId===r);return n!=null&&n.nodeTypes&&(c=c.filter(d=>n.nodeTypes.includes(d.treeNodeType))),c}return[]}setupPeriodicCleanup(){setInterval(()=>{this.cleanupOrphanedSubscriptions()},300*1e3)}isNodeDescendantOfByNode(r,n,i){return r.treeNodeId===n?!0:r.parentTreeNodeId===n?i===void 0||i>=1:this.isNodeDescendantOf(r.treeNodeId,n,i)}isNodeDescendantOf(r,n,i){if(r===n)return!0;const c=this.calculateDepthFromAncestor(r,n);return!(c===-1||i!==void 0&&c>i)}async subscribeSubTree(r,n,i){return console.log("subscribeSubTree (V1 compat)",r),{initialSubTree:this.getInitialSubTreeV1(r),unsubscribeSubTree:()=>{console.log("unsubscribeSubTree (V1 compat)")}}}async getInitialSubTreeV1(r){return console.log("getInitialSubTreeV1",r),{treeId:"",treeRootNodeId:"",pageNodeId:r,changes:{},version:0}}async toggleNodeExpanded(r){console.log("toggleNodeExpanded (V1 compat)",r)}async listChildren(r,n){return console.log("listChildren (V1 compat)",r,n),{treeId:"",treeRootNodeId:"",pageNodeId:r,changes:{},version:0}}async getNodeAncestors(r){return console.log("getNodeAncestors (V1 compat)",r),[]}async searchByNameWithDepth(r,n,i){try{const d=await new Tn(this.coreDB).searchNodes({query:n,rootNodeId:r,caseSensitive:!1,searchInDescription:!1,useRegex:!1}),h=i.maxResults||i.maxVisited||100;return d.slice(0,h)}catch(c){return console.error("Search failed:",c),[]}}async searchByNameWithMatchMode(r,n,i){try{const c=new Tn(this.coreDB);let d,h=!1;switch(i.matchMode){case"exact":d=`^${this.escapeRegexChars(n)}$`,h=!0;break;case"prefix":d=`^${this.escapeRegexChars(n)}`,h=!0;break;case"suffix":d=`${this.escapeRegexChars(n)}$`,h=!0;break;case"partial":default:d=n,h=!1;break}const g=await c.searchNodes({query:d,rootNodeId:r,caseSensitive:i.caseSensitive||!1,searchInDescription:i.searchInDescription||!1,useRegex:h}),O=i.maxResults||100;return g.slice(0,O)}catch(c){return console.error("Enhanced search failed:",c),[]}}escapeRegexChars(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}calculateDepthFromAncestor(r,n){if(r===n)return 0;const i=this.getNodeFromDB(r);if(!i)return-1;if(i.parentTreeNodeId===n)return 1;const c=50;let d=i.parentTreeNodeId,h=1;const g=new Set([r]);for(;d&&h<c&&!g.has(d);){if(g.add(d),d===n)return h;const O=this.getNodeFromDB(d);if(!O||!O.parentTreeNodeId)break;d=O.parentTreeNodeId,h++}return-1}}const he=[];for(let a=0;a<256;++a)he.push((a+256).toString(16).slice(1));function sa(a,r=0){return(he[a[r+0]]+he[a[r+1]]+he[a[r+2]]+he[a[r+3]]+"-"+he[a[r+4]]+he[a[r+5]]+"-"+he[a[r+6]]+he[a[r+7]]+"-"+he[a[r+8]]+he[a[r+9]]+"-"+he[a[r+10]]+he[a[r+11]]+he[a[r+12]]+he[a[r+13]]+he[a[r+14]]+he[a[r+15]]).toLowerCase()}let In;const aa=new Uint8Array(16);function ua(){if(!In){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");In=crypto.getRandomValues.bind(crypto)}return In(aa)}const ca=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var Eo={randomUUID:ca};function Oo(a,r,n){var c;if(Eo.randomUUID&&!a)return Eo.randomUUID();a=a||{};const i=a.random??((c=a.rng)==null?void 0:c.call(a))??ua();if(i.length<16)throw new Error("Random bytes length must be >= 16");return i[6]=i[6]&15|64,i[8]=i[8]&63|128,sa(i)}class To{constructor(r,n){this.coreDB=r,this.mutationService=n}async importFromTemplate(r){const{templateId:n,targetParentId:i,mergeStrategy:c="rename",progressCallback:d}=r;try{d==null||d({phase:"reading",current:0,total:1,message:`Loading template: ${n}`});const h=await fetch(`/templates/${n}/manifest.json`);if(!h.ok)throw new Error(`Template not found: ${n}`);const g=await h.json();d==null||d({phase:"validating",current:1,total:1,message:"Validating template data"});const O=await fetch(`/templates/${n}/tree-nodes.json`);if(!O.ok)throw new Error(`Template data not found: ${n}`);const E=await O.json();d==null||d({phase:"importing-nodes",current:0,total:E.nodeIds.length,message:`Importing ${E.nodeIds.length} nodes`});const A=new Map,R={},C=[];for(const[z,ee]of E.nodeIds.entries()){const ie=Oo();A.set(ee,ie),C.push(ie);const ne=E.nodes[ee];if(ne){let ce=null;ne.parentTreeNodeId?ce=A.get(ne.parentTreeNodeId)||i:ce=i,R[ie]={...ne,treeNodeId:ie,parentTreeNodeId:ce,createdAt:Date.now(),updatedAt:Date.now(),version:1},d==null||d({phase:"importing-nodes",current:z+1,total:E.nodeIds.length,message:`Importing node: ${ne.name}`})}}c==="rename"&&await this.handleNameConflicts(R,i);const P={payload:{nodes:R,nodeIds:C,toParentId:i,onNameConflict:c==="rename"?"auto-rename":"error"},commandId:`import-template-${Date.now()}`,groupId:`template-${n}`,kind:"importNodes",issuedAt:Date.now()},U=await this.mutationService.importNodes(P);return d==null||d({phase:"finalizing",current:1,total:1,message:"Import completed successfully"}),{success:U.success,importedNodeIds:C,skippedNodes:0,errors:U.success?[]:[U.error||"Import failed"],warnings:[]}}catch(h){return console.error("Import failed:",h),{success:!1,importedNodeIds:[],skippedNodes:0,errors:[h instanceof Error?h.message:"Unknown error occurred"]}}}async importFromFile(r){const{file:n,targetParentId:i,mergeStrategy:c="rename",progressCallback:d}=r;d==null||d({phase:"reading",current:0,total:1,message:`Reading file: ${n.name}`});try{const h=await n.text(),g=JSON.parse(h);if(g.nodes&&g.nodeIds)return this.importTreeNodes(g,i,c,d);throw new Error("Invalid file format. Expected tree-nodes.json structure.")}catch(h){return{success:!1,importedNodeIds:[],skippedNodes:0,errors:[h instanceof Error?h.message:"Failed to parse file"]}}}async importTreeNodes(r,n,i,c){const d=new Map,h={},g=[];c==null||c({phase:"importing-nodes",current:0,total:r.nodeIds.length,message:`Importing ${r.nodeIds.length} nodes`});for(const[A,R]of r.nodeIds.entries()){const C=Oo();d.set(R,C),g.push(C);const P=r.nodes[R];if(P){let U=null;P.parentTreeNodeId?U=d.get(P.parentTreeNodeId)||n:U=n,h[C]={...P,treeNodeId:C,parentTreeNodeId:U,createdAt:Date.now(),updatedAt:Date.now(),version:1},c==null||c({phase:"importing-nodes",current:A+1,total:r.nodeIds.length,message:`Importing: ${P.name}`})}}const O={payload:{nodes:h,nodeIds:g,toParentId:n,onNameConflict:i==="rename"?"auto-rename":"error"},commandId:`import-file-${Date.now()}`,groupId:`import-${Date.now()}`,kind:"importNodes",issuedAt:Date.now()},E=await this.mutationService.importNodes(O);return c==null||c({phase:"finalizing",current:1,total:1,message:"Import completed"}),{success:E.success,importedNodeIds:g,skippedNodes:0,errors:E.success?[]:[E.error||"Import failed"]}}async handleNameConflicts(r,n){const i=await this.coreDB.getChildren(n),c=new Set(i.map(d=>d.name));for(const d of Object.values(r))if(d.parentTreeNodeId===n&&c.has(d.name)){let h=1,g=`${d.name} (${h})`;for(;c.has(g);)h++,g=`${d.name} (${h})`;d.name=g,c.add(g)}}}class ko{constructor(r,n){this.coreDB=r,this.queryService=n}async exportToJSON(r){const{nodeIds:n,progressCallback:i}=r;try{i==null||i({phase:"collecting-nodes",current:0,total:n.length,message:"Collecting nodes for export"});const c=await this.collectNodes(n,i),d={version:"1.0",name:"HierarchiDB Export",description:`Exported ${c.nodeIds.length} nodes`,exportDate:new Date().toISOString(),exportedBy:"HierarchiDB",appVersion:"1.0.0",nodeCount:c.nodeIds.length,resourceTypes:this.countResourceTypes(c.nodes),rootNodes:n};i==null||i({phase:"creating-archive",current:1,total:1,message:"Creating export file"});const h={manifest:d,...c},g=JSON.stringify(h,null,2),O=new Blob([g],{type:"application/json"});return i==null||i({phase:"finalizing",current:1,total:1,message:"Export completed successfully"}),{success:!0,blob:O,exportedNodeCount:c.nodeIds.length,errors:[]}}catch(c){return console.error("Export failed:",c),{success:!1,exportedNodeCount:0,errors:[c instanceof Error?c.message:"Unknown error occurred"]}}}async exportToZIP(r){return this.exportToJSON(r)}async collectNodes(r,n){const i={},c=[],d=new Set;for(const[g,O]of r.entries())n==null||n({phase:"collecting-nodes",current:g+1,total:r.length,message:`Collecting node ${g+1} of ${r.length}`}),await this.collectNodeRecursive(O,i,c,d);const h=this.calculateTreeDepth(i,r);return{nodes:i,nodeIds:c,rootNodeIds:r,metadata:{totalCount:c.length,treeDepth:h}}}async collectNodeRecursive(r,n,i,c){if(c.has(r))return;c.add(r);const d=await this.coreDB.getNode(r);if(!d)return;n[r]=d,i.push(r);const h=await this.coreDB.getChildren(r);for(const g of h)await this.collectNodeRecursive(g.treeNodeId,n,i,c)}countResourceTypes(r){const n={};for(const i of Object.values(r)){const c=i.treeNodeType;c&&c!=="folder"&&(n[c]=(n[c]||0)+1)}return n}calculateTreeDepth(r,n){let i=0;const c=(d,h)=>{i=Math.max(i,h);for(const g of Object.values(r))g.parentTreeNodeId===d&&c(g.treeNodeId,h+1)};for(const d of n)c(d,1);return i}static generateFileName(r="export"){const i=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);return`${r}_${i}.json`}}class la{constructor(r){this.coreDB=r}async deleteNode(r){await this.coreDB.deleteNode(r)}async createNode(r){await this.coreDB.createNode(r)}}class da{constructor(r="default-worker-db"){J(this,"coreDB");J(this,"ephemeralDB");J(this,"queryService");J(this,"mutationService");J(this,"observableService");J(this,"commandProcessor");J(this,"nodeTypeRegistry");J(this,"nodeLifecycleManager");this.coreDB=new Gs(r),this.ephemeralDB=new Xs(r);const n=new la(this.coreDB);this.commandProcessor=new Sn(n),this.nodeTypeRegistry=new Zs,this.nodeLifecycleManager=new Qs(this.nodeTypeRegistry,this.coreDB,this.ephemeralDB),this.queryService=new Tn(this.coreDB),this.mutationService=new oa(this.coreDB,this.ephemeralDB,this.commandProcessor,this.nodeLifecycleManager),this.observableService=new ia(this.coreDB)}async initialize(){await Promise.all([this.coreDB.initialize(),this.ephemeralDB.initialize()])}dispose(){this.coreDB.close(),this.ephemeralDB.close()}getTree(r){return this.coreDB.getTree(r.treeId)}getTrees(){return this.coreDB.getTrees()}getCommandProcessor(){return this.commandProcessor}getNodeTypeRegistry(){return this.nodeTypeRegistry}copyNodes(r){return this.queryService.copyNodes(r)}exportNodes(r){return this.queryService.exportNodes(r)}createWorkingCopyForCreate(r){return this.mutationService.createWorkingCopyForCreate(r)}createWorkingCopy(r){return this.mutationService.createWorkingCopy(r)}discardWorkingCopyForCreate(r){return this.mutationService.discardWorkingCopyForCreate(r)}discardWorkingCopy(r){return this.mutationService.discardWorkingCopy(r)}commitWorkingCopyForCreate(r){return this.mutationService.commitWorkingCopyForCreate(r)}commitWorkingCopy(r){return this.mutationService.commitWorkingCopy(r)}moveNodes(r){return this.mutationService.moveNodes(r)}duplicateNodes(r){return this.mutationService.duplicateNodes(r)}pasteNodes(r){return this.mutationService.pasteNodes(r)}moveToTrash(r){return this.mutationService.moveToTrash(r)}remove(r){return this.mutationService.remove(r)}recoverFromTrash(r){return this.mutationService.recoverFromTrash(r)}importNodes(r){return this.mutationService.importNodes(r)}async undo(r){const n=await this.commandProcessor.undo();return this.convertToCommandResult(n)}async redo(r){const n=await this.commandProcessor.redo();return this.convertToCommandResult(n)}convertToCommandResult(r){if(r.success){const n={success:!0,seq:r.seq};return r.nodeId&&(n.nodeId=r.nodeId),r.newNodeIds&&(n.newNodeIds=r.newNodeIds),r.clipboardData&&(n.clipboardData=r.clipboardData),n}else{const n={success:!1,error:r.error,code:r.code};return r.seq!==void 0&&(n.seq=r.seq),n}}subscribeSubTree(r,n,i){return this.observableService.subscribeSubTree(r,n,i)}toggleNodeExpanded(r){return this.observableService.toggleNodeExpanded(r)}listChildren(r,n){return this.observableService.listChildren(r,n)}getNodeAncestors(r){return this.observableService.getNodeAncestors(r)}searchByNameWithDepth(r,n,i){return this.observableService.searchByNameWithDepth(r,n,i)}searchByNameWithMatchMode(r,n,i){return this.observableService.searchByNameWithMatchMode(r,n,i)}observeNode(r){return this.observableService.observeNode(r)}observeChildren(r){return this.observableService.observeChildren(r)}observeSubtree(r){return this.observableService.observeSubtree(r)}observeWorkingCopies(r){return this.observableService.observeWorkingCopies(r)}getAncestors(r){return this.queryService.getAncestors(r)}getActiveSubscriptions(){return this.observableService.getActiveSubscriptions()}cleanupOrphanedSubscriptions(){return this.observableService.cleanupOrphanedSubscriptions()}getNode(r){return this.queryService.getNode(r)}getChildren(r){return this.queryService.getChildren(r)}getDescendants(r){return this.queryService.getDescendants(r)}searchNodes(r){return this.queryService.searchNodes(r)}async create(r){try{if(!r.name||r.name.trim()==="")return{success:!1,error:"Node name is required and cannot be empty"};if(r.name.length>255)return{success:!1,error:"Node name cannot exceed 255 characters"};const n=`${r.treeNodeType}-create-${Date.now()}`,i=`wc-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,c={payload:{workingCopyId:i,parentTreeNodeId:r.parentNodeId,name:r.name,description:r.description},commandId:`create-${Date.now()}`,groupId:n,kind:"createWorkingCopyForCreate",issuedAt:Date.now()};await this.createWorkingCopyForCreate(c);const d={payload:{workingCopyId:i},commandId:`commit-${Date.now()}`,groupId:n,kind:"commitWorkingCopyForCreate",issuedAt:Date.now()},h=await this.commitWorkingCopyForCreate(d);if(h.success){const g=h.nodeId;if(g===void 0)return console.error("commitResult.nodeId is undefined"),{success:!1,error:"NodeId is undefined"};const O={payload:{treeNodeType:r.treeNodeType,nodeId:g,parentNodeId:r.parentNodeId,name:r.name,description:r.description},commandId:`${r.treeNodeType}-create-${Date.now()}`,groupId:n,kind:"create",issuedAt:Date.now()};return await this.commandProcessor.processCommand(O),await this.coreDB.getNode(g)?{success:!0,nodeId:g}:(console.error("Node not found after creation:",g),{success:!1,error:`Node not found after creation: ${g}`})}else return{success:!1,error:h.success?"Unexpected success result":h.error}}catch(n){return{success:!1,error:String(n)}}}async moveFolder(r){try{const n=await this.moveNodes({payload:{nodeIds:[r.nodeId],toParentId:r.toParentId,onNameConflict:r.onNameConflict||"error"},commandId:`move-${Date.now()}`,groupId:`group-${Date.now()}`,kind:"moveNodes",issuedAt:Date.now()});return{success:n.success,error:n.success?void 0:n.error}}catch(n){return{success:!1,error:String(n)}}}createFolder(r){return this.create({treeNodeType:"folder",treeId:r.treeId,parentNodeId:r.parentNodeId,name:r.name,description:r.description})}async updateFolderName(r){try{if(!r.newName||r.newName.trim()==="")return{success:!1,error:"Folder name is required and cannot be empty"};if(r.newName.length>255)return{success:!1,error:"Folder name cannot exceed 255 characters"};const n=await this.coreDB.getNode(r.nodeId);return n?(await this.coreDB.updateNode({...n,name:r.newName,updatedAt:Date.now(),version:n.version+1}),{success:!0}):{success:!1,error:`Node not found: ${r.nodeId}`}}catch(n){return{success:!1,error:String(n)}}}async moveToTrashFolder(r){try{const n=await this.moveToTrash({payload:{nodeIds:r.nodeIds},commandId:`trash-${Date.now()}`,groupId:`group-${Date.now()}`,kind:"moveToTrash",issuedAt:Date.now()});return n.success?{success:!0}:{success:!1,error:n.error??"Move to trash failed"}}catch(n){return{success:!1,error:String(n)}}}async recoverFromTrashFolder(r){try{const n=await this.recoverFromTrash({payload:{nodeIds:r.nodeIds,toParentId:r.toParentId},commandId:`recover-${Date.now()}`,groupId:`group-${Date.now()}`,kind:"recoverFromTrash",issuedAt:Date.now()});return n.success?{success:!0}:{success:!1,error:n.error??"Recover failed"}}catch(n){return{success:!1,error:String(n)}}}async removeFolder(r){try{const n=await this.remove({payload:{nodeIds:r.nodeIds},commandId:`delete-${Date.now()}`,groupId:`group-${Date.now()}`,kind:"remove",issuedAt:Date.now()});return n.success?{success:!0}:{success:!1,error:n.error??"Delete failed"}}catch(n){return{success:!1,error:String(n)}}}async duplicateNodesFolder(r){try{const n=await this.duplicateNodes({payload:{nodeIds:r.nodeIds,toParentId:r.toParentId||"root"},commandId:`duplicate-${Date.now()}`,groupId:`group-${Date.now()}`,kind:"duplicateNodes",issuedAt:Date.now()});return n.success&&n.newNodeIds?{success:!0,nodeIds:n.newNodeIds}:{success:!1,error:"Duplicate failed"}}catch(n){return{success:!1,error:String(n)}}}async copyNodesFolder(r){try{const n=await this.copyNodes({nodeIds:r.nodeIds});return n.success&&n.clipboardData?{success:!0,clipboardData:n.clipboardData}:{success:!1,error:"Copy failed"}}catch(n){return{success:!1,error:String(n)}}}async pasteNodesFolder(r){var n,i;try{const c=await this.pasteNodes({payload:{nodes:((n=r.clipboardData)==null?void 0:n.nodes)||{},nodeIds:((i=r.clipboardData)==null?void 0:i.rootNodeIds)||[],toParentId:r.targetParentId},commandId:`paste-${Date.now()}`,groupId:`group-${Date.now()}`,kind:"pasteNodes",issuedAt:Date.now()});return c.success&&c.newNodeIds?{success:!0,nodeIds:c.newNodeIds}:{success:!1,error:"Paste failed"}}catch(c){return{success:!1,error:String(c)}}}async importFromTemplate(r){try{const i=await new To(this.coreDB,this.mutationService).importFromTemplate({templateId:r.templateId,targetParentId:r.targetParentId});return{success:i.success,nodeIds:i.importedNodeIds,error:i.errors.length>0?i.errors.join(", "):void 0}}catch(n){return{success:!1,error:String(n)}}}async importFromFile(r){try{const i=await new To(this.coreDB,this.mutationService).importFromFile({file:r.file,targetParentId:r.targetParentId});return{success:i.success,nodeIds:i.importedNodeIds,error:i.errors.length>0?i.errors.join(", "):void 0}}catch(n){return{success:!1,error:String(n)}}}async exportTreeNodes(r){try{const n=new ko(this.coreDB,this.queryService),i=r.format==="zip"?await n.exportToZIP({nodeIds:r.nodeIds}):await n.exportToJSON({nodeIds:r.nodeIds});return{success:i.success,blob:i.blob,filename:ko.generateFileName("hierarchidb-export"),error:i.errors.length>0?i.errors.join(", "):void 0}}catch(n){return{success:!1,error:String(n)}}}}const fa="hierarchidb",ui=new da(fa);ui.initialize().then(()=>{as("worker.initialized")}).catch(a=>{Ko("worker.initializationFailed",{},a)});kn(ui);
