<!doctype html>
<html>
  <head>
    <title>OAuth Redirect</title>
    <script>
      console.log('[oauth-redirect] Processing OAuth callback for react-oidc-context');

      // Helper function to extract src path from current URL
      function getAppPath() {
        const currentPath = window.location.pathname;
        return currentPath.replace(/\/oauth-redirect\.html$/, '');
      }

      // Helper function to build redirect URL
      function buildRedirectUrl(appPath, search, hash) {
        const baseUrl = window.location.origin;
        // Use the regular path pattern for React Router v7 (no hash routing)
        return `${baseUrl}${appPath}/redirect${search}${hash}`;
      }

      // This page needs to communicate with the parent window for react-oidc-context
      (function () {
        try {
          // Check if we're in a popup (for popup auth mode)
          if (window.opener) {
            console.log('[oauth-redirect] In popup mode, posting message to parent');
            // For popup mode, post message to parent window
            const targetOrigin = window.location.origin;
            window.opener.postMessage(
              {
                type: 'oauth-callback',
                url: window.location.href,
              },
              targetOrigin
            );
            window.close();
          } else {
            console.log('[oauth-redirect] In redirect mode, redirecting to main app');
            // For redirect mode, redirect to the main src with OAuth parameters
            const currentSearch = window.location.search;
            const currentHash = window.location.hash;
            const appPath = getAppPath();
            const redirectUrl = buildRedirectUrl(appPath, currentSearch, currentHash);

            console.log('[oauth-redirect] App path detected:', appPath);
            console.log('[oauth-redirect] Redirecting to:', redirectUrl);
            window.location.replace(redirectUrl);
          }
        } catch (error) {
          console.error('[oauth-redirect] Error during OAuth processing:', error);
          // Fallback: redirect to main src root
          const appPath = getAppPath();
          const baseUrl = window.location.origin;
          const fallbackUrl = `${baseUrl}${appPath}/`;
          console.log('[oauth-redirect] Fallback redirect to:', fallbackUrl);
          window.location.replace(fallbackUrl);
        }
      })();
    </script>
  </head>
  <body>
    <p>Processing OAuth authentication...</p>
  </body>
</html>
